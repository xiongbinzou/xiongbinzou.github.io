<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>Django-Vue搭建个人博客(3)：后端功能完善 | 小邹同学</title><meta name="keywords" content="Django,Django REST framework,Vue,前后端分离"><meta name="author" content="小邹同学"><meta name="copyright" content="小邹同学"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="本教程是一个以前后端分离模式开发个人博客的教程，目的是快速搭建现代化个人博客网站。"><meta property="og:type" content="article"><meta property="og:title" content="Django-Vue搭建个人博客(3)：后端功能完善"><meta property="og:url" content="https://xiongbinzou.github.io/posts/16431.html"><meta property="og:site_name" content="小邹同学"><meta property="og:description" content="本教程是一个以前后端分离模式开发个人博客的教程，目的是快速搭建现代化个人博客网站。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://xiongbinzou.github.io/pics/avatar.jpg"><meta property="article:published_time" content="2023-04-05T13:00:00.000Z"><meta property="article:modified_time" content="2023-04-10T10:29:06.901Z"><meta property="article:author" content="小邹同学"><meta property="article:tag" content="Django"><meta property="article:tag" content="Django REST framework"><meta property="article:tag" content="Vue"><meta property="article:tag" content="前后端分离"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://xiongbinzou.github.io/pics/avatar.jpg"><link rel="shortcut icon" href="/pics/favicon.png"><link rel="canonical" href="https://xiongbinzou.github.io/posts/16431"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.xml",preload:!1,languages:{hits_empty:"找不到您查询的内容：${query}"}},translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:!1},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"天",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{limitCount:300,languages:{author:"作者: 小邹同学",link:"链接: ",source:"来源: 小邹同学",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},lightbox:"fancybox",Snackbar:{chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#49b1f5",bgDark:"#121212",position:"top-right"},source:{justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js",css:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css"}},isPhotoFigcaption:!0,islazyload:!1,isAnchor:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"Django-Vue搭建个人博客(3)：后端功能完善",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2023-04-10 18:29:06"}</script><noscript><style>#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,o){if(0===o)return;const a=864e5*o,c={value:t,expiry:(new Date).getTime()+a};localStorage.setItem(e,JSON.stringify(c))},get:function(e){const t=localStorage.getItem(e);if(!t)return;const o=JSON.parse(t);if(!((new Date).getTime()>o.expiry))return o.value;localStorage.removeItem(e)}},e.getScript=e=>new Promise(((t,o)=>{const a=document.createElement("script");a.src=e,a.async=!0,a.onerror=o,a.onload=a.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)})),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};const t=saveToLocal.get("theme"),o=window.matchMedia("(prefers-color-scheme: dark)").matches,a=window.matchMedia("(prefers-color-scheme: light)").matches,c=window.matchMedia("(prefers-color-scheme: no-preference)").matches,n=!o&&!a&&!c;if(void 0===t){if(a)activateLightMode();else if(o)activateDarkMode();else if(c||n){const e=(new Date).getHours();e<=6||e>=18?activateDarkMode():activateLightMode()}window.matchMedia("(prefers-color-scheme: dark)").addListener((function(e){void 0===saveToLocal.get("theme")&&(e.matches?activateDarkMode():activateLightMode())}))}else"light"===t?activateLightMode():activateDarkMode();const i=saveToLocal.get("aside-status");void 0!==i&&("hide"===i?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><meta name="generator" content="Hexo 5.4.2"><style>.github-emoji{position:relative;display:inline-block;width:1.2em;min-height:1.2em;overflow:hidden;vertical-align:top;color:transparent}.github-emoji>span{position:relative;z-index:10}.github-emoji .fancybox,.github-emoji img{margin:0!important;padding:0!important;border:none!important;outline:0!important;text-decoration:none!important;user-select:none!important;cursor:auto!important}.github-emoji img{height:1.2em!important;width:1.2em!important;position:absolute!important;left:50%!important;top:50%!important;transform:translate(-50%,-50%)!important;user-select:none!important;cursor:auto!important}.github-emoji-fallback{color:inherit}.github-emoji-fallback img{opacity:0!important}</style></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/pics/avatar.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">21</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">40</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-graduation-cap"></i> <span>博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-archive"></i> <span>归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-folder-open"></i> <span>分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i> <span>标签</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i> <span>生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/photos/"><i class="fa-fw fa fa-camera-retro"></i> <span>相册</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i> <span>音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i> <span>影视</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fa fa-gamepad"></i> <span>游戏</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i> <span>友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">小邹同学</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i> <span>搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-graduation-cap"></i> <span>博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-archive"></i> <span>归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-folder-open"></i> <span>分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i> <span>标签</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i> <span>生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/photos/"><i class="fa-fw fa fa-camera-retro"></i> <span>相册</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i> <span>音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i> <span>影视</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fa fa-gamepad"></i> <span>游戏</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i> <span>友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Django-Vue搭建个人博客(3)：后端功能完善</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-04-05T13:00:00.000Z" title="发表于 2023-04-05 21:00:00">2023-04-05</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-04-10T10:29:06.901Z" title="更新于 2023-04-10 18:29:06">2023-04-10</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Django-Vue/">Django &amp; Vue</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">10.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>48分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="1-过滤文章">1. 过滤文章</h2><p>用户需要某个特定范围的文章时，后端需要把返回的数据进行过滤。最简单的过滤方法是修改视图集中的<code>queryset</code>属性：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># article/views.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> viewsets</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> article.permissions <span class="keyword">import</span> IsAdminUserOrReadOnly</span><br><span class="line"><span class="keyword">from</span> article.models <span class="keyword">import</span> Article</span><br><span class="line"><span class="keyword">from</span> article.serializers <span class="keyword">import</span> ArticleSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleViewSet</span>(<span class="params">viewsets.ModelViewSet</span>):</span></span><br><span class="line">    queryset = Article.objects.<span class="built_in">filter</span>(author__username=<span class="string">'admin'</span>)</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line">    permission_classes = [IsAdminUserOrReadOnly]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save(author=self.request.user)</span><br><span class="line">        </span><br></pre></td></tr></tbody></table></figure><p>这样会导致原本正常的列表也都过滤了</p><h3 id="1-1-参数过滤">1.1 参数过滤</h3><p>假设有如下带有参数 GET 的请求：</p><blockquote><p><a target="_blank" rel="noopener" href="http://127.0.0.1:8000/api/article/?username=admin">http://127.0.0.1:8000/api/article/?username=admin</a></p></blockquote><p>可以通过覆写<code>get_queryset()</code>的方式实现过滤：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># article/views.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> viewsets</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> article.permissions <span class="keyword">import</span> IsAdminUserOrReadOnly</span><br><span class="line"><span class="keyword">from</span> article.models <span class="keyword">import</span> Article</span><br><span class="line"><span class="keyword">from</span> article.serializers <span class="keyword">import</span> ArticleSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleViewSet</span>(<span class="params">viewsets.ModelViewSet</span>):</span></span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line">    permission_classes = [IsAdminUserOrReadOnly]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save(author=self.request.user)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span>(<span class="params">self</span>):</span></span><br><span class="line">        queryset = self.queryset</span><br><span class="line">        username = self.request.query_params.get(<span class="string">'username'</span>, <span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> username <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            queryset = queryset.<span class="built_in">filter</span>(author__username=username)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> queryset</span><br><span class="line">    </span><br></pre></td></tr></tbody></table></figure><h3 id="1-2-通用过滤">1.2 通用过滤</h3><p><code>django-filter</code>库可以用于通用过滤，要使用这个库，首先执行<code>pip install django-filter==23.1</code>安装，然后修改配置文件：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># backend/settings.py</span></span><br><span class="line">...</span><br><span class="line">INSTALLED_APPS = [</span><br><span class="line">    <span class="string">'django.contrib.admin'</span>,</span><br><span class="line">    <span class="string">'django.contrib.auth'</span>,</span><br><span class="line">    <span class="string">'django.contrib.contenttypes'</span>,</span><br><span class="line">    <span class="string">'django.contrib.sessions'</span>,</span><br><span class="line">    <span class="string">'django.contrib.messages'</span>,</span><br><span class="line">    <span class="string">'django.contrib.staticfiles'</span>,</span><br><span class="line">    <span class="string">'rest_framework'</span>,</span><br><span class="line">    <span class="string">'article'</span>,</span><br><span class="line">    <span class="string">'user_info'</span>,</span><br><span class="line">    <span class="string">'django_filters'</span>,</span><br><span class="line">]</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">REST_FRAMEWORK = {</span><br><span class="line">    <span class="string">'DEFAULT_PAGINATION_CLASS'</span>: <span class="string">'rest_framework.pagination.PageNumberPagination'</span>,</span><br><span class="line">    <span class="string">'PAGE_SIZE'</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="string">'DEFAULT_FILTER_BACKENDS'</span>: [<span class="string">'django-filter.rest_framework.DjangoFilterBackend'</span>],</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># article/views.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> viewsets</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> article.permissions <span class="keyword">import</span> IsAdminUserOrReadOnly</span><br><span class="line"><span class="keyword">from</span> article.models <span class="keyword">import</span> Article</span><br><span class="line"><span class="keyword">from</span> article.serializers <span class="keyword">import</span> ArticleSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleViewSet</span>(<span class="params">viewsets.ModelViewSet</span>):</span></span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line">    permission_classes = [IsAdminUserOrReadOnly]</span><br><span class="line">    </span><br><span class="line">    filterset_fields = [<span class="string">'author__username'</span>, <span class="string">'title'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save(author=self.request.user)</span><br><span class="line">    </span><br></pre></td></tr></tbody></table></figure><p>也可以将其单独配置在特定的视图中，不在<code>setting.py</code>中配置 REST_FRAMEWORK 相关内容：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># article/views.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> viewsets</span><br><span class="line"><span class="keyword">from</span> django_filters.rest_framework <span class="keyword">import</span> DjangoFilterBackend</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> article.permissions <span class="keyword">import</span> IsAdminUserOrReadOnly</span><br><span class="line"><span class="keyword">from</span> article.models <span class="keyword">import</span> Article</span><br><span class="line"><span class="keyword">from</span> article.serializers <span class="keyword">import</span> ArticleSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleViewSet</span>(<span class="params">viewsets.ModelViewSet</span>):</span></span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line">    permission_classes = [IsAdminUserOrReadOnly]</span><br><span class="line">    </span><br><span class="line">    filter_backends = [DjangoFilterBackend]</span><br><span class="line">    filterset_fields = [<span class="string">'author__username'</span>, <span class="string">'title'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save(author=self.request.user)</span><br><span class="line">    </span><br></pre></td></tr></tbody></table></figure><p>完全匹配示例url：<a target="_blank" rel="noopener" href="http://127.0.0.1:8000/api/article/?author__username=dusai&amp;title=newtest">http://127.0.0.1:8000/api/article/?author__username=dusai&amp;title=newtest</a></p><p>如果要实现模糊搜索，可以使用<code>SearchFilter</code>来做。</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># article/views.py</span></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> filters, viewsets</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> article.permissions <span class="keyword">import</span> IsAdminUserOrReadOnly</span><br><span class="line"><span class="keyword">from</span> article.models <span class="keyword">import</span> Article</span><br><span class="line"><span class="keyword">from</span> article.serializers <span class="keyword">import</span> ArticleSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleViewSet</span>(<span class="params">viewsets.ModelViewSet</span>):</span></span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line">    permission_classes = [IsAdminUserOrReadOnly]</span><br><span class="line"></span><br><span class="line">    filter_backends = [filters.SearchFilter]</span><br><span class="line">    search_fields = [<span class="string">'title'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save(author=self.request.user)</span><br><span class="line">    </span><br></pre></td></tr></tbody></table></figure><p>模糊搜索示例url：<a target="_blank" rel="noopener" href="http://127.0.0.1:8000/api/article/?search=post">http://127.0.0.1:8000/api/article/?search=post</a></p><h2 id="2-文章分类">2. 文章分类</h2><p>博客文章通常需要分类，方便用户快速识别文章的类型，或者进行某种关联操作。</p><h3 id="2-1-增加模型">2.1 增加模型</h3><p>首先在<code>article/models.py</code>增加一个分类的模型，并且将其和博文称为一对多的外键：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># article/models.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> django.utils <span class="keyword">import</span> timezone</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Category</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    文章分类</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">100</span>)</span><br><span class="line">    created = models.DateTimeField(default=timezone.now</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        ordering = [<span class="string">'-created'</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.title</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    博客文章</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">100</span>)              <span class="comment"># 标题</span></span><br><span class="line">    category = models.ForeignKey(</span><br><span class="line">        Category,</span><br><span class="line">        null=<span class="literal">True</span>,</span><br><span class="line">        blank=<span class="literal">True</span>,</span><br><span class="line">        on_delete=models.SET_NULL,</span><br><span class="line">        related_name=<span class="string">'articles'</span></span><br><span class="line">    )                                                     <span class="comment"># 分类</span></span><br><span class="line">    author = models.ForeignKey(</span><br><span class="line">        User,</span><br><span class="line">        null=<span class="literal">True</span>,</span><br><span class="line">        on_delete=models.CASCADE,</span><br><span class="line">        related_name=<span class="string">"articles"</span></span><br><span class="line">    )                                                     <span class="comment"># 作者</span></span><br><span class="line">    body = models.TextField()                             <span class="comment"># 正文</span></span><br><span class="line">    created = models.DateTimeField(default=timezone.now)  <span class="comment"># 创建时间</span></span><br><span class="line">    updated = models.DateTimeField(auto_now=<span class="literal">True</span>)         <span class="comment"># 更新时间</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        ordering = [<span class="string">'-created'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.title</span><br><span class="line">    </span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>进行数据迁移：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line">(venv) &gt; python manage.py makemigrations</span><br><span class="line">(venv) &gt; python manage.py migrate</span><br></pre></td></tr></tbody></table></figure><blockquote><p><em>教程把分类的 model 放到 article app中了。实际项目应根据情况考虑是否需要另起一个单独的分类 app。</em></p></blockquote><h3 id="2-2-序列化器">2.2 序列化器</h3><p>编写和修改序列化器：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># article/serializers.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> article.models <span class="keyword">import</span> Article, Category</span><br><span class="line"><span class="keyword">from</span> user_info.serializers <span class="keyword">import</span> UserDescSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategorySerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    分类序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    url = serializers.HyperlinkedIdentityField(view_name=<span class="string">'category-detail'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Category</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line">        read_only_fields = [<span class="string">'created'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleSerializer</span>(<span class="params">serializers.HyperlinkedModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    文章序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    author = UserDescSerializer(read_only=<span class="literal">True</span>)</span><br><span class="line">    category = CategorySerializer(read_only=<span class="literal">True</span>)</span><br><span class="line">    category_id = serializers.IntegerField(write_only=<span class="literal">True</span>, allow_null=<span class="literal">True</span>, required=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_category_id</span>(<span class="params">self, value</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> Category.objects.<span class="built_in">filter</span>(<span class="built_in">id</span>=value).exists() <span class="keyword">and</span> value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> serializers.ValidationError(<span class="string">f"Category with id <span class="subst">{value}</span> not exits."</span>)</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Article</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p><code>CategorySerializer</code> ：</p><ul><li><code>HyperlinkedIdentityField</code> 前面章节有讲过，作用是将路由间的表示转换为超链接。<code>view_name</code> 参数是路由名，你必须显示指定。 <code>category-detail</code> 是自动注册路由时，<code>Router</code> 默认帮你设置的详情页面的名称，类似的还有 <code>category-list</code> 等，更多规则参考<a target="_blank" rel="noopener" href="https://www.django-rest-framework.org/api-guide/routers/#defaultrouter">文档</a>。</li><li>创建日期不需要后期修改，所以设置为 <code>read_only_fields</code>。</li></ul><p><code>ArticleSerializer</code>：</p><ul><li>文章接口不仅仅只返回分类的 id ，需要显式指定 <code>category</code> ，将其变成一个嵌套数据，与之前的 <code>author</code> 类似。</li><li>DRF 框架原生没有实现<strong>可写的嵌套数据</strong>，想<strong>创建/更新</strong>文章和分类的外键关系时：一种方法是自己去实现序列化器的 <code>create()/update()</code> 方法；另一种就是 DRF 框架提供的修改外键的快捷方式，即显式指定 <code>category_id</code> 字段，则此字段会自动链接到 <code>category</code> 外键，以便你更新外键关系。</li><li>再看 <code>category_id</code> 内部。<code>write_only</code> 表示此字段仅需要可写；<code>allow_null</code> 表示允许将其设置为空；<code>required</code> 表示在<strong>创建/更新</strong>时可以不设置此字段。</li></ul><p>如果用户提交了一个不存在的分类外键，后端会返回外键数据不存在的 500 错误，解决方法就是对数据预先进行<strong>验证</strong>。</p><p>验证方式又有如下几种：</p><ul><li>覆写序列化器的 <code>.validate(...)</code> 方法。这是个全局的验证器，其接收的唯一参数是所有字段值的字典。当你需要同时对多个字段进行验证时，这是个很好的选择。</li><li>另一种就是教程用到的，即 <code>.validate_{field_name}(...)</code> 方法，它会只验证某个特定的字段，比如 <code>category_id</code> 。</li></ul><p><code>validate_category_id</code> 检查了两样东西：</p><ul><li>数据库中是否包含了对应 id 值的数据。</li><li>传入值是否为 None。这是为了能够将已有的外键置空。</li></ul><h3 id="2-3-视图与路由">2.3 视图与路由</h3><p>编写视图：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># article/views.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> viewsets, filters</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> article.permissions <span class="keyword">import</span> IsAdminUserOrReadOnly</span><br><span class="line"><span class="keyword">from</span> article.models <span class="keyword">import</span> Article, Category</span><br><span class="line"><span class="keyword">from</span> article.serializers <span class="keyword">import</span> ArticleSerializer, CategorySerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategoryViewSet</span>(<span class="params">viewsets.ModelViewSet</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    分类视图集</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    queryset = Category.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = CategorySerializer</span><br><span class="line">    permission_classes = [IsAdminUserOrReadOnly]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleViewSet</span>(<span class="params">viewsets.ModelViewSet</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    文章视图集</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line">    permission_classes = [IsAdminUserOrReadOnly]</span><br><span class="line"></span><br><span class="line">    filter_backends = [filters.SearchFilter]</span><br><span class="line">    search_fields = [<span class="string">'title'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save(author=self.request.user)</span><br><span class="line">    </span><br></pre></td></tr></tbody></table></figure><p>编写路由：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># backend/urls.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line"><span class="keyword">from</span> rest_framework.routers <span class="keyword">import</span> DefaultRouter</span><br><span class="line"><span class="keyword">from</span> article <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router = DefaultRouter()</span><br><span class="line">router.register(<span class="string">r'article'</span>, views.ArticleViewSet)</span><br><span class="line">router.register(<span class="string">r'category'</span>, views.CategoryViewSet)</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">'api/'</span>, include(router.urls)),</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="2-4-测试">2.4 测试</h3><figure class="highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 1.创建分类</span></span><br><span class="line">(venv) &gt; http <span class="literal">-a</span> admin:admin POST http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8000</span>/api/category/ title=Django      </span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">201</span> Created</span><br><span class="line">Allow: GET, POST, HEAD, OPTIONS</span><br><span class="line">Connection: close</span><br><span class="line">Content<span class="literal">-Length</span>: <span class="number">116</span></span><br><span class="line">Content<span class="literal">-Type</span>: application/json</span><br><span class="line">Cross<span class="literal">-Origin</span><span class="literal">-Opener</span><span class="literal">-Policy</span>: same<span class="literal">-origin</span></span><br><span class="line">Date: Mon, <span class="number">27</span> Mar <span class="number">2023</span> <span class="number">15</span>:<span class="number">52</span>:<span class="number">17</span> GMT</span><br><span class="line">Location: http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8000</span>/api/category/<span class="number">2</span>/</span><br><span class="line">Referrer<span class="literal">-Policy</span>: same<span class="literal">-origin</span></span><br><span class="line">Server: WSGIServer/<span class="number">0.2</span> CPython/<span class="number">3.10</span>.<span class="number">6</span></span><br><span class="line">Vary: Accept, Cookie</span><br><span class="line">X<span class="literal">-Content</span><span class="literal">-Type</span><span class="literal">-Options</span>: nosniff</span><br><span class="line">X<span class="literal">-Frame</span><span class="literal">-Options</span>: DENY</span><br><span class="line"></span><br><span class="line">{</span><br><span class="line">    <span class="string">"created"</span>: <span class="string">"2023-03-27T23:52:17.604118+08:00"</span>,</span><br><span class="line">    <span class="string">"id"</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="string">"title"</span>: <span class="string">"Django"</span>,</span><br><span class="line">    <span class="string">"url"</span>: <span class="string">"http://127.0.0.1:8000/api/category/2/"</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.更新已有分类</span></span><br><span class="line">(venv) &gt; http <span class="literal">-a</span> admin:admin PUT http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8000</span>/api/category/<span class="number">2</span>/ title=Flask</span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Allow: GET, PUT, PATCH, DELETE, HEAD, OPTIONS</span><br><span class="line">Connection: close</span><br><span class="line">Content<span class="literal">-Length</span>: <span class="number">115</span></span><br><span class="line">Content<span class="literal">-Type</span>: application/json</span><br><span class="line">Cross<span class="literal">-Origin</span><span class="literal">-Opener</span><span class="literal">-Policy</span>: same<span class="literal">-origin</span></span><br><span class="line">Date: Mon, <span class="number">27</span> Mar <span class="number">2023</span> <span class="number">15</span>:<span class="number">53</span>:<span class="number">12</span> GMT</span><br><span class="line">Referrer<span class="literal">-Policy</span>: same<span class="literal">-origin</span></span><br><span class="line">Server: WSGIServer/<span class="number">0.2</span> CPython/<span class="number">3.10</span>.<span class="number">6</span></span><br><span class="line">Vary: Accept, Cookie</span><br><span class="line">X<span class="literal">-Content</span><span class="literal">-Type</span><span class="literal">-Options</span>: nosniff</span><br><span class="line">X<span class="literal">-Frame</span><span class="literal">-Options</span>: DENY</span><br><span class="line"></span><br><span class="line">{</span><br><span class="line">    <span class="string">"created"</span>: <span class="string">"2023-03-27T23:52:17.604118+08:00"</span>,</span><br><span class="line">    <span class="string">"id"</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="string">"title"</span>: <span class="string">"Flask"</span>,</span><br><span class="line">    <span class="string">"url"</span>: <span class="string">"http://127.0.0.1:8000/api/category/2/"</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.创建文章时指定分类</span></span><br><span class="line">(venv) &gt; http <span class="literal">-a</span> admin:admin POST http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8000</span>/api/article/ category_id=<span class="number">2</span> title=ILoveDRF body=WishYouToo!</span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">201</span> Created</span><br><span class="line">Allow: GET, POST, HEAD, OPTIONS</span><br><span class="line">Connection: close</span><br><span class="line">Content<span class="literal">-Length</span>: <span class="number">437</span></span><br><span class="line">Content<span class="literal">-Type</span>: application/json</span><br><span class="line">Cross<span class="literal">-Origin</span><span class="literal">-Opener</span><span class="literal">-Policy</span>: same<span class="literal">-origin</span></span><br><span class="line">Date: Mon, <span class="number">27</span> Mar <span class="number">2023</span> <span class="number">15</span>:<span class="number">54</span>:<span class="number">05</span> GMT</span><br><span class="line">Location: http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8000</span>/api/article/<span class="number">9</span>/</span><br><span class="line">Referrer<span class="literal">-Policy</span>: same<span class="literal">-origin</span></span><br><span class="line">Server: WSGIServer/<span class="number">0.2</span> CPython/<span class="number">3.10</span>.<span class="number">6</span></span><br><span class="line">Vary: Accept, Cookie</span><br><span class="line">X<span class="literal">-Content</span><span class="literal">-Type</span><span class="literal">-Options</span>: nosniff</span><br><span class="line">X<span class="literal">-Frame</span><span class="literal">-Options</span>: DENY</span><br><span class="line"></span><br><span class="line">{</span><br><span class="line">    <span class="string">"author"</span>: {</span><br><span class="line">        <span class="string">"date_joined"</span>: <span class="string">"2023-03-27T02:08:41.097951+08:00"</span>,</span><br><span class="line">        <span class="string">"id"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">"last_login"</span>: <span class="string">"2023-03-27T23:24:54.504055+08:00"</span>,</span><br><span class="line">        <span class="string">"username"</span>: <span class="string">"admin"</span></span><br><span class="line">    },</span><br><span class="line">    <span class="string">"body"</span>: <span class="string">"WishYouToo!"</span>,</span><br><span class="line">    <span class="string">"category"</span>: {</span><br><span class="line">        <span class="string">"created"</span>: <span class="string">"2023-03-27T23:52:17.604118+08:00"</span>,</span><br><span class="line">        <span class="string">"id"</span>: <span class="number">2</span>,</span><br><span class="line">        <span class="string">"title"</span>: <span class="string">"Flask"</span>,</span><br><span class="line">        <span class="string">"url"</span>: <span class="string">"http://127.0.0.1:8000/api/category/2/"</span></span><br><span class="line">    },</span><br><span class="line">    <span class="string">"created"</span>: <span class="string">"2023-03-27T23:54:05.550915+08:00"</span>,</span><br><span class="line">    <span class="string">"title"</span>: <span class="string">"ILoveDRF"</span>,</span><br><span class="line">    <span class="string">"updated"</span>: <span class="string">"2023-03-27T23:54:05.550915+08:00"</span>,</span><br><span class="line">    <span class="string">"url"</span>: <span class="string">"http://127.0.0.1:8000/api/article/9/"</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.把已有的分类置空</span></span><br><span class="line">(venv) &gt; http <span class="literal">-a</span> admin:admin PATCH http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8000</span>/api/article/<span class="number">9</span>/ category_id:=null</span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Allow: GET, PUT, PATCH, DELETE, HEAD, OPTIONS</span><br><span class="line">Connection: close</span><br><span class="line">Content<span class="literal">-Length</span>: <span class="number">326</span></span><br><span class="line">Content<span class="literal">-Type</span>: application/json</span><br><span class="line">Cross<span class="literal">-Origin</span><span class="literal">-Opener</span><span class="literal">-Policy</span>: same<span class="literal">-origin</span></span><br><span class="line">Date: Mon, <span class="number">27</span> Mar <span class="number">2023</span> <span class="number">15</span>:<span class="number">55</span>:<span class="number">26</span> GMT</span><br><span class="line">Referrer<span class="literal">-Policy</span>: same<span class="literal">-origin</span></span><br><span class="line">Server: WSGIServer/<span class="number">0.2</span> CPython/<span class="number">3.10</span>.<span class="number">6</span></span><br><span class="line">Vary: Accept, Cookie</span><br><span class="line">X<span class="literal">-Content</span><span class="literal">-Type</span><span class="literal">-Options</span>: nosniff</span><br><span class="line">X<span class="literal">-Frame</span><span class="literal">-Options</span>: DENY</span><br><span class="line"></span><br><span class="line">{</span><br><span class="line">    <span class="string">"author"</span>: {</span><br><span class="line">        <span class="string">"date_joined"</span>: <span class="string">"2023-03-27T02:08:41.097951+08:00"</span>,</span><br><span class="line">        <span class="string">"id"</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="string">"last_login"</span>: <span class="string">"2023-03-27T23:24:54.504055+08:00"</span>,</span><br><span class="line">        <span class="string">"username"</span>: <span class="string">"admin"</span></span><br><span class="line">    },</span><br><span class="line">    <span class="string">"body"</span>: <span class="string">"WishYouToo!"</span>,</span><br><span class="line">    <span class="string">"category"</span>: null,</span><br><span class="line">    <span class="string">"created"</span>: <span class="string">"2023-03-27T23:54:05.550915+08:00"</span>,</span><br><span class="line">    <span class="string">"title"</span>: <span class="string">"ILoveDRF"</span>,</span><br><span class="line">    <span class="string">"updated"</span>: <span class="string">"2023-03-27T23:55:26.915902+08:00"</span>,</span><br><span class="line">    <span class="string">"url"</span>: <span class="string">"http://127.0.0.1:8000/api/article/9/"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>在更新资源时用到了 <code>POST</code> 、<code>PUT</code> 、 <code>PATCH</code> 三种请求方法</p><ul><li><code>POST</code> ：创建新的资源。</li><li><code>PUT</code> ： 整体更新特定资源，默认情况下你需要完整给出所有必须的字段。</li><li><code>PATCH</code>： 部分更新特定资源，仅需要给出需要更新的字段，未给出的字段默认不更改。</li></ul><h3 id="2-5-完善分类详情">2.5 完善分类详情</h3><p>现在希望分类的<strong>列表页面</strong>不显示其链接的文章，以保持数据简洁，但是详情页面则展示出链接的所有文章，方便接口的使用。因此就需要同一个视图集用到两个不同的序列化器，可以使用 <code>get_serializer_class()</code> 。</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># article/serializers.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> article.models <span class="keyword">import</span> Article, Category</span><br><span class="line"><span class="keyword">from</span> user_info.serializers <span class="keyword">import</span> UserDescSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategorySerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    分类序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    url = serializers.HyperlinkedIdentityField(view_name=<span class="string">'category-detail'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Category</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line">        read_only_fields = [<span class="string">'created'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleSerializer</span>(<span class="params">serializers.HyperlinkedModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    文章序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    author = UserDescSerializer(read_only=<span class="literal">True</span>)</span><br><span class="line">    category = CategorySerializer(read_only=<span class="literal">True</span>)</span><br><span class="line">    category_id = serializers.IntegerField(write_only=<span class="literal">True</span>, allow_null=<span class="literal">True</span>, required=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_category_id</span>(<span class="params">self, value</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> Category.objects.<span class="built_in">filter</span>(<span class="built_in">id</span>=value).exists() <span class="keyword">and</span> value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> serializers.ValidationError(<span class="string">f"Category with id <span class="subst">{value}</span> not exits."</span>)</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Article</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleCategoryDetailSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    给分类详情的文章嵌套序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    url = serializers.HyperlinkedIdentityField(view_name=<span class="string">'article-detail'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Category</span><br><span class="line">        fields = [</span><br><span class="line">            <span class="string">'url'</span>,</span><br><span class="line">            <span class="string">'title'</span>,</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategoryDetailSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    分类详情</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    articles = ArticleCategoryDetailSerializer(many=<span class="literal">True</span>, read_only=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Category</span><br><span class="line">        fields = [</span><br><span class="line">            <span class="string">'id'</span>,</span><br><span class="line">            <span class="string">'title'</span>,</span><br><span class="line">            <span class="string">'created'</span>,</span><br><span class="line">            <span class="string">'articles'</span>,</span><br><span class="line">        ]</span><br><span class="line">        </span><br></pre></td></tr></tbody></table></figure><p>然后修改视图：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># article/views.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> viewsets, filters</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> article.permissions <span class="keyword">import</span> IsAdminUserOrReadOnly</span><br><span class="line"><span class="keyword">from</span> article.models <span class="keyword">import</span> Article, Category</span><br><span class="line"><span class="keyword">from</span> article.serializers <span class="keyword">import</span> ArticleSerializer, CategorySerializer, CategoryDetailSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategoryViewSet</span>(<span class="params">viewsets.ModelViewSet</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    分类视图集</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    queryset = Category.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = CategorySerializer</span><br><span class="line">    permission_classes = [IsAdminUserOrReadOnly]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_serializer_class</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.action == <span class="string">'list'</span>:</span><br><span class="line">            <span class="keyword">return</span> CategorySerializer</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> CategoryDetailSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleViewSet</span>(<span class="params">viewsets.ModelViewSet</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    文章视图集</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line">    permission_classes = [IsAdminUserOrReadOnly]</span><br><span class="line"></span><br><span class="line">    filter_backends = [filters.SearchFilter]</span><br><span class="line">    search_fields = [<span class="string">'title'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save(author=self.request.user)</span><br><span class="line">    </span><br></pre></td></tr></tbody></table></figure><h2 id="3-文章标签">3. 文章标签</h2><p>文章通常还有<strong>标签</strong>功能，作为分类的补充。分类对文章一般是<strong>一对多</strong>的关系，标签对文章时<strong>多对多</strong>的关系。</p><h3 id="3-1-增加模型">3.1 增加模型</h3><p>先创建标签的 model 并进行数据迁移</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># article/models.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> django.utils <span class="keyword">import</span> timezone</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tag</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    文章标签</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    text = models.CharField(max_length=<span class="number">30</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        ordering = [<span class="string">'-id'</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Category</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    文章分类</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">100</span>)</span><br><span class="line">    created = models.DateTimeField(default=timezone.now)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        ordering = [<span class="string">'-created'</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.title</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    博客文章</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">100</span>)              <span class="comment"># 标题</span></span><br><span class="line">    category = models.ForeignKey(</span><br><span class="line">        Category,</span><br><span class="line">        null=<span class="literal">True</span>,</span><br><span class="line">        blank=<span class="literal">True</span>,</span><br><span class="line">        on_delete=models.SET_NULL,</span><br><span class="line">        related_name=<span class="string">'articles'</span></span><br><span class="line">    )                                                     <span class="comment"># 分类</span></span><br><span class="line">    tags = models.ManyToManyField(</span><br><span class="line">        Tag,</span><br><span class="line">        blank=<span class="literal">True</span>,</span><br><span class="line">        related_name=<span class="string">'articles'</span></span><br><span class="line">    )                                                     <span class="comment"># 标签</span></span><br><span class="line">    author = models.ForeignKey(</span><br><span class="line">        User,</span><br><span class="line">        null=<span class="literal">True</span>,</span><br><span class="line">        on_delete=models.CASCADE,</span><br><span class="line">        related_name=<span class="string">"articles"</span></span><br><span class="line">    )                                                     <span class="comment"># 作者</span></span><br><span class="line">    body = models.TextField()                             <span class="comment"># 正文</span></span><br><span class="line">    created = models.DateTimeField(default=timezone.now)  <span class="comment"># 创建时间</span></span><br><span class="line">    updated = models.DateTimeField(auto_now=<span class="literal">True</span>)         <span class="comment"># 更新时间</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        ordering = [<span class="string">'-created'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.title</span><br><span class="line">        </span><br></pre></td></tr></tbody></table></figure><p>进行数据迁移：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line">(venv) &gt; python manage.py makemigrations</span><br><span class="line">(venv) &gt; python manage.py migrate</span><br></pre></td></tr></tbody></table></figure><h3 id="3-2-序列化器">3.2 序列化器</h3><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># article/serializers.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> article.models <span class="keyword">import</span> Article, Category, Tag</span><br><span class="line"><span class="keyword">from</span> user_info.serializers <span class="keyword">import</span> UserDescSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TagSerializer</span>(<span class="params">serializers.HyperlinkedIdentityField</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    标签序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Tag</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategorySerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    分类序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    url = serializers.HyperlinkedIdentityField(view_name=<span class="string">'category-detail'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Category</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line">        read_only_fields = [<span class="string">'created'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleSerializer</span>(<span class="params">serializers.HyperlinkedModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    文章序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    author = UserDescSerializer(read_only=<span class="literal">True</span>)</span><br><span class="line">    category = CategorySerializer(read_only=<span class="literal">True</span>)</span><br><span class="line">    category_id = serializers.IntegerField(write_only=<span class="literal">True</span>, allow_null=<span class="literal">True</span>, required=<span class="literal">False</span>)</span><br><span class="line">    tag = serializers.SlugRelatedField(query_set=Tag.objects.<span class="built_in">all</span>(), many=<span class="literal">True</span>, required=<span class="literal">False</span>, slug_field=<span class="string">'text'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_category_id</span>(<span class="params">self, value</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> Category.objects.<span class="built_in">filter</span>(<span class="built_in">id</span>=value).exists() <span class="keyword">and</span> value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> serializers.ValidationError(<span class="string">f"Category with id <span class="subst">{value}</span> not exits."</span>)</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Article</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleCategoryDetailSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    给分类详情的文章嵌套序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    url = serializers.HyperlinkedIdentityField(view_name=<span class="string">'article-detail'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Category</span><br><span class="line">        fields = [</span><br><span class="line">            <span class="string">'url'</span>,</span><br><span class="line">            <span class="string">'title'</span>,</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategoryDetailSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    分类详情</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    articles = ArticleCategoryDetailSerializer(many=<span class="literal">True</span>, read_only=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Category</span><br><span class="line">        fields = [</span><br><span class="line">            <span class="string">'id'</span>,</span><br><span class="line">            <span class="string">'title'</span>,</span><br><span class="line">            <span class="string">'created'</span>,</span><br><span class="line">            <span class="string">'articles'</span>,</span><br><span class="line">        ]</span><br><span class="line">        </span><br></pre></td></tr></tbody></table></figure><p><code>SlugRelatedField</code> 直接显示其 <code>text</code> 字段的内容。</p><p>多对多关系，DRF 默认你必须先得有这个外键对象，才能指定其关系。</p><p>现在希望在创建、更新文章时，程序会<strong>自动检查</strong>数据库里是否存在当前标签。如果存在则指向它，如果不存在则创建一个并指向它。可以覆写<code>to_internal_value()</code>方法。<code>to_internal_value()</code> 方法原本作用是将请求中的原始 Json 数据转化为 Python 表示形式（期间还会对字段有效性做初步检查）。它的执行时间比默认验证器的字段检查更早，因此有机会在此方法中将需要的数据创建好，然后等待检查的降临。<code>isinstance()</code> 确定标签数据是列表，才会循环并创建新数据。</p><p>除此之外，因为标签仅有 <code>text</code> 字段是有用的，两个 <code>id</code> 不同但是 <code>text</code> 相同的标签没有任何意义。更重要的是，<code>SlugRelatedField</code> 是不允许有重复的 <code>slug_field</code> 。因此还需要覆写 <code>TagSerializer</code> 的 <code>create()/update()</code> 方法。</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># article/serializers.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> article.models <span class="keyword">import</span> Article, Category, Tag</span><br><span class="line"><span class="keyword">from</span> user_info.serializers <span class="keyword">import</span> UserDescSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TagSerializer</span>(<span class="params">serializers.HyperlinkedModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    标签序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check_tag_obj_exists</span>(<span class="params">self, validated_data</span>):</span></span><br><span class="line">        text = validated_data.get(<span class="string">'text'</span>)</span><br><span class="line">        <span class="keyword">if</span> Tag.objects.<span class="built_in">filter</span>(text=text).exists():</span><br><span class="line">            <span class="keyword">raise</span> serializers.ValidationError(<span class="string">f'Tag with text <span class="subst">{text}</span> exists.'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, validated_data</span>):</span></span><br><span class="line">        self.check_tag_obj_exists(validated_data)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().create(validated_data)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">self, instance, validated_data</span>):</span></span><br><span class="line">        self.check_tag_obj_exists(validated_data)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().update(instance, validated_data)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Tag</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategorySerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    分类序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    url = serializers.HyperlinkedIdentityField(view_name=<span class="string">'category-detail'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Category</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line">        read_only_fields = [<span class="string">'created'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleSerializer</span>(<span class="params">serializers.HyperlinkedModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    文章序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    author = UserDescSerializer(read_only=<span class="literal">True</span>)</span><br><span class="line">    category = CategorySerializer(read_only=<span class="literal">True</span>)</span><br><span class="line">    category_id = serializers.IntegerField(write_only=<span class="literal">True</span>, allow_null=<span class="literal">True</span>, required=<span class="literal">False</span>)</span><br><span class="line">    tags = serializers.SlugRelatedField(queryset=Tag.objects.<span class="built_in">all</span>(), many=<span class="literal">True</span>, required=<span class="literal">False</span>, slug_field=<span class="string">'text'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_category_id</span>(<span class="params">self, value</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> Category.objects.<span class="built_in">filter</span>(<span class="built_in">id</span>=value).exists() <span class="keyword">and</span> value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> serializers.ValidationError(<span class="string">f"Category with id <span class="subst">{value}</span> not exits."</span>)</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">to_internal_value</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        tags_data = data.get(<span class="string">'tags'</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(tags_data, <span class="built_in">list</span>):</span><br><span class="line">            <span class="keyword">for</span> text <span class="keyword">in</span> tags_data:</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> Tag.objects.<span class="built_in">filter</span>(text=text).exists():</span><br><span class="line">                    Tag.objects.create(text=text)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().to_internal_value(data)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Article</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleCategoryDetailSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    给分类详情的文章嵌套序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    url = serializers.HyperlinkedIdentityField(view_name=<span class="string">'article-detail'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Category</span><br><span class="line">        fields = [</span><br><span class="line">            <span class="string">'url'</span>,</span><br><span class="line">            <span class="string">'title'</span>,</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategoryDetailSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    分类详情</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    articles = ArticleCategoryDetailSerializer(many=<span class="literal">True</span>, read_only=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Category</span><br><span class="line">        fields = [</span><br><span class="line">            <span class="string">'id'</span>,</span><br><span class="line">            <span class="string">'title'</span>,</span><br><span class="line">            <span class="string">'created'</span>,</span><br><span class="line">            <span class="string">'articles'</span>,</span><br><span class="line">        ]</span><br></pre></td></tr></tbody></table></figure><h3 id="3-3-视图与路由">3.3 视图与路由</h3><p>编写视图：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># article/views.py</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> viewsets, filters</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> article.permissions <span class="keyword">import</span> IsAdminUserOrReadOnly</span><br><span class="line"><span class="keyword">from</span> article.models <span class="keyword">import</span> Article, Category, Tag</span><br><span class="line"><span class="keyword">from</span> article.serializers <span class="keyword">import</span> ArticleSerializer, CategorySerializer, CategoryDetailSerializer, TagSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TagViewSet</span>(<span class="params">viewsets.ModelViewSet</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    标签视图集</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    queryset = Tag.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = TagSerializer</span><br><span class="line">    permission_classes = [IsAdminUserOrReadOnly]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategoryViewSet</span>(<span class="params">viewsets.ModelViewSet</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    分类视图集</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    queryset = Category.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = CategorySerializer</span><br><span class="line">    permission_classes = [IsAdminUserOrReadOnly]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_serializer_class</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.action == <span class="string">'list'</span>:</span><br><span class="line">            <span class="keyword">return</span> CategorySerializer</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> CategoryDetailSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleViewSet</span>(<span class="params">viewsets.ModelViewSet</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    文章视图集</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line">    permission_classes = [IsAdminUserOrReadOnly]</span><br><span class="line"></span><br><span class="line">    filter_backends = [filters.SearchFilter]</span><br><span class="line">    search_fields = [<span class="string">'title'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save(author=self.request.user)</span><br><span class="line">    </span><br></pre></td></tr></tbody></table></figure><p>编写路由：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># backend/urls.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line"><span class="keyword">from</span> rest_framework.routers <span class="keyword">import</span> DefaultRouter</span><br><span class="line"><span class="keyword">from</span> article <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router = DefaultRouter()</span><br><span class="line">router.register(<span class="string">r'article'</span>, views.ArticleViewSet)</span><br><span class="line">router.register(<span class="string">r'category'</span>, views.CategoryViewSet)</span><br><span class="line">router.register(<span class="string">r'tag'</span>, views.TagViewSet)</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">'api/'</span>, include(router.urls)),</span><br><span class="line">]</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>当然也可以简化代码，可以直接设置 tag 模型的 text 字段唯一, 即<code>unique=True</code>，然后执行数据迁移，再简化 Tag 的序列化器中唯一性的检查：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># article/models.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> django.utils <span class="keyword">import</span> timezone</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tag</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    文章标签</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    text = models.CharField(max_length=<span class="number">30</span>, unique=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        ordering = [<span class="string">'-id'</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Category</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    文章分类</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">100</span>)</span><br><span class="line">    created = models.DateTimeField(default=timezone.now)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        ordering = [<span class="string">'-created'</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.title</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    博客文章</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">100</span>)              <span class="comment"># 标题</span></span><br><span class="line">    category = models.ForeignKey(</span><br><span class="line">        Category,</span><br><span class="line">        null=<span class="literal">True</span>,</span><br><span class="line">        blank=<span class="literal">True</span>,</span><br><span class="line">        on_delete=models.SET_NULL,</span><br><span class="line">        related_name=<span class="string">'articles'</span></span><br><span class="line">    )                                                     <span class="comment"># 分类</span></span><br><span class="line">    tags = models.ManyToManyField(</span><br><span class="line">        Tag,</span><br><span class="line">        blank=<span class="literal">True</span>,</span><br><span class="line">        related_name=<span class="string">'articles'</span></span><br><span class="line">    )                                                     <span class="comment"># 标签</span></span><br><span class="line">    author = models.ForeignKey(</span><br><span class="line">        User,</span><br><span class="line">        null=<span class="literal">True</span>,</span><br><span class="line">        on_delete=models.CASCADE,</span><br><span class="line">        related_name=<span class="string">"articles"</span></span><br><span class="line">    )                                                     <span class="comment"># 作者</span></span><br><span class="line">    body = models.TextField()                             <span class="comment"># 正文</span></span><br><span class="line">    created = models.DateTimeField(default=timezone.now)  <span class="comment"># 创建时间</span></span><br><span class="line">    updated = models.DateTimeField(auto_now=<span class="literal">True</span>)         <span class="comment"># 更新时间</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        ordering = [<span class="string">'-created'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.title</span><br><span class="line">        </span><br><span class="line">    </span><br></pre></td></tr></tbody></table></figure><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># article/serializers.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> article.models <span class="keyword">import</span> Article, Category, Tag</span><br><span class="line"><span class="keyword">from</span> user_info.serializers <span class="keyword">import</span> UserDescSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TagSerializer</span>(<span class="params">serializers.HyperlinkedModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    标签序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Tag</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategorySerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    分类序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    url = serializers.HyperlinkedIdentityField(view_name=<span class="string">'category-detail'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Category</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line">        read_only_fields = [<span class="string">'created'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleSerializer</span>(<span class="params">serializers.HyperlinkedModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    文章序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    author = UserDescSerializer(read_only=<span class="literal">True</span>)</span><br><span class="line">    category = CategorySerializer(read_only=<span class="literal">True</span>)</span><br><span class="line">    category_id = serializers.IntegerField(write_only=<span class="literal">True</span>, allow_null=<span class="literal">True</span>, required=<span class="literal">False</span>)</span><br><span class="line">    tags = serializers.SlugRelatedField(queryset=Tag.objects.<span class="built_in">all</span>(), many=<span class="literal">True</span>, required=<span class="literal">False</span>, slug_field=<span class="string">'text'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_category_id</span>(<span class="params">self, value</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> Category.objects.<span class="built_in">filter</span>(<span class="built_in">id</span>=value).exists() <span class="keyword">and</span> value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> serializers.ValidationError(<span class="string">f"Category with id <span class="subst">{value}</span> not exits."</span>)</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">to_internal_value</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        tags_data = data.get(<span class="string">'tags'</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(tags_data, <span class="built_in">list</span>):</span><br><span class="line">            <span class="keyword">for</span> text <span class="keyword">in</span> tags_data:</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> Tag.objects.<span class="built_in">filter</span>(text=text).exists():</span><br><span class="line">                    Tag.objects.create(text=text)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().to_internal_value(data)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, validated_data</span>):</span></span><br><span class="line">        category_id = validated_data.pop(<span class="string">'category_id'</span>)</span><br><span class="line">        validated_data[<span class="string">'category'</span>] = Category.objects.get(<span class="built_in">id</span>=category_id)</span><br><span class="line">        tags = Tag.objects.<span class="built_in">filter</span>(text__in=validated_data[<span class="string">'tags'</span>])</span><br><span class="line">        validated_data.pop(<span class="string">'tags'</span>)</span><br><span class="line">        article = Article.objects.create(**validated_data)</span><br><span class="line">        article.tags.<span class="built_in">set</span>(tags)</span><br><span class="line">        <span class="keyword">return</span> article</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Article</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleCategoryDetailSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    给分类详情的文章嵌套序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    url = serializers.HyperlinkedIdentityField(view_name=<span class="string">'article-detail'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Category</span><br><span class="line">        fields = [</span><br><span class="line">            <span class="string">'url'</span>,</span><br><span class="line">            <span class="string">'title'</span>,</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategoryDetailSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    分类详情</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    articles = ArticleCategoryDetailSerializer(many=<span class="literal">True</span>, read_only=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Category</span><br><span class="line">        fields = [</span><br><span class="line">            <span class="string">'id'</span>,</span><br><span class="line">            <span class="string">'title'</span>,</span><br><span class="line">            <span class="string">'created'</span>,</span><br><span class="line">            <span class="string">'articles'</span>,</span><br><span class="line">        ]</span><br></pre></td></tr></tbody></table></figure><h2 id="4-Markdown正文">4. Markdown正文</h2><p>Markdown 是一种排版标注规则，”渲染“ Markdown 也就是把原始文本中的注释转化为前端中真正被用户看到的 HTML 排版文字。渲染过程可以在前端也可以在后端，本文将使用后端渲染，以便你理解 DRF 的相关知识。</p><h3 id="1-1-修改模型">1.1 修改模型</h3><p><code>markdown</code>库可Markdown渲染，要使用这个库，首先执行<code>pip install markdown==3.4.3</code>， 给文章模型添加一个 <code>get_md()</code> 方法：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># article/models.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> django.utils <span class="keyword">import</span> timezone</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> markdown <span class="keyword">import</span> Markdown</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tag</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    文章标签</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    text = models.CharField(max_length=<span class="number">30</span>, unique=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        ordering = [<span class="string">'-id'</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Category</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    文章分类</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">100</span>)</span><br><span class="line">    created = models.DateTimeField(default=timezone.now)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        ordering = [<span class="string">'-created'</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.title</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    博客文章</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">100</span>)              <span class="comment"># 标题</span></span><br><span class="line">    category = models.ForeignKey(</span><br><span class="line">        Category,</span><br><span class="line">        null=<span class="literal">True</span>,</span><br><span class="line">        blank=<span class="literal">True</span>,</span><br><span class="line">        on_delete=models.SET_NULL,</span><br><span class="line">        related_name=<span class="string">'articles'</span></span><br><span class="line">    )                                                     <span class="comment"># 分类</span></span><br><span class="line">    tags = models.ManyToManyField(</span><br><span class="line">        Tag,</span><br><span class="line">        blank=<span class="literal">True</span>,</span><br><span class="line">        related_name=<span class="string">'articles'</span></span><br><span class="line">    )                                                     <span class="comment"># 标签</span></span><br><span class="line">    author = models.ForeignKey(</span><br><span class="line">        User,</span><br><span class="line">        null=<span class="literal">True</span>,</span><br><span class="line">        on_delete=models.CASCADE,</span><br><span class="line">        related_name=<span class="string">"articles"</span></span><br><span class="line">    )                                                     <span class="comment"># 作者</span></span><br><span class="line">    body = models.TextField()                             <span class="comment"># 正文</span></span><br><span class="line">    created = models.DateTimeField(default=timezone.now)  <span class="comment"># 创建时间</span></span><br><span class="line">    updated = models.DateTimeField(auto_now=<span class="literal">True</span>)         <span class="comment"># 更新时间</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        ordering = [<span class="string">'-created'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.title</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_md</span>(<span class="params">self</span>):</span></span><br><span class="line">        md = Markdown(</span><br><span class="line">            extensions=[</span><br><span class="line">                <span class="string">'markdown.extensions.extra'</span>,</span><br><span class="line">                <span class="string">'markdown.extensions.codehilite'</span>,</span><br><span class="line">                <span class="string">'markdown.extensions.toc'</span>,</span><br><span class="line">            ]</span><br><span class="line">        )</span><br><span class="line">        md_body = md.convert(self.body)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> md_body, md.toc</span><br><span class="line">        </span><br></pre></td></tr></tbody></table></figure><p>方法返回了包含了两个元素的元组，分别为已渲染为 html 的<strong>正文</strong>和<strong>目录</strong>。</p><h3 id="1-2-序列化器">1.2 序列化器</h3><p>重构代码，添加文章序列化器父类，在列表接口传入 <code>extra_kwargs</code> 使其变成仅可写却不显示的字段，然后写新的 <code>ArticleDetailSerializer</code> ：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># article/serializers.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> article.models <span class="keyword">import</span> Article, Category, Tag</span><br><span class="line"><span class="keyword">from</span> user_info.serializers <span class="keyword">import</span> UserDescSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TagSerializer</span>(<span class="params">serializers.HyperlinkedModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    标签序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Tag</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategorySerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    分类序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    url = serializers.HyperlinkedIdentityField(view_name=<span class="string">'category-detail'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Category</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line">        read_only_fields = [<span class="string">'created'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleBaseSerializer</span>(<span class="params">serializers.HyperlinkedModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    文章序列化器父类</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    author = UserDescSerializer(read_only=<span class="literal">True</span>)</span><br><span class="line">    category = CategorySerializer(read_only=<span class="literal">True</span>)</span><br><span class="line">    category_id = serializers.IntegerField(write_only=<span class="literal">True</span>, allow_null=<span class="literal">True</span>, required=<span class="literal">False</span>)</span><br><span class="line">    tags = serializers.SlugRelatedField(queryset=Tag.objects.<span class="built_in">all</span>(), many=<span class="literal">True</span>, required=<span class="literal">False</span>, slug_field=<span class="string">'text'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_category_id</span>(<span class="params">self, value</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> Category.objects.<span class="built_in">filter</span>(<span class="built_in">id</span>=value).exists() <span class="keyword">and</span> value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> serializers.ValidationError(<span class="string">f"Category with id <span class="subst">{value}</span> not exits."</span>)</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">to_internal_value</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        tags_data = data.get(<span class="string">'tags'</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(tags_data, <span class="built_in">list</span>):</span><br><span class="line">            <span class="keyword">for</span> text <span class="keyword">in</span> tags_data:</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> Tag.objects.<span class="built_in">filter</span>(text=text).exists():</span><br><span class="line">                    Tag.objects.create(text=text)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().to_internal_value(data)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, validated_data</span>):</span></span><br><span class="line">        category_id = validated_data.pop(<span class="string">'category_id'</span>)</span><br><span class="line">        validated_data[<span class="string">'category'</span>] = Category.objects.get(<span class="built_in">id</span>=category_id)</span><br><span class="line">        tags = Tag.objects.<span class="built_in">filter</span>(text__in=validated_data[<span class="string">'tags'</span>])</span><br><span class="line">        validated_data.pop(<span class="string">'tags'</span>)</span><br><span class="line">        article = Article.objects.create(**validated_data)</span><br><span class="line">        article.tags.<span class="built_in">set</span>(tags)</span><br><span class="line">        <span class="keyword">return</span> article</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleSerializer</span>(<span class="params">ArticleBaseSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    文章列表序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Article</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line">        extra_kwargs = {<span class="string">'body'</span>: {<span class="string">'write_only'</span>: <span class="literal">True</span>}}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleDetailSerializer</span>(<span class="params">ArticleBaseSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    文章详情序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    body_html = serializers.SerializerMethodField()</span><br><span class="line">    toc_html = serializers.SerializerMethodField()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_body_html</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">        <span class="keyword">return</span> obj.get_md()[<span class="number">0</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_toc_html</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">        <span class="keyword">return</span> obj.get_md()[<span class="number">1</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Article</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleCategoryDetailSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    给分类详情的文章嵌套序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    url = serializers.HyperlinkedIdentityField(view_name=<span class="string">'article-detail'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Category</span><br><span class="line">        fields = [</span><br><span class="line">            <span class="string">'url'</span>,</span><br><span class="line">            <span class="string">'title'</span>,</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategoryDetailSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    分类详情</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    articles = ArticleCategoryDetailSerializer(many=<span class="literal">True</span>, read_only=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Category</span><br><span class="line">        fields = [</span><br><span class="line">            <span class="string">'id'</span>,</span><br><span class="line">            <span class="string">'title'</span>,</span><br><span class="line">            <span class="string">'created'</span>,</span><br><span class="line">            <span class="string">'articles'</span>,</span><br><span class="line">        ]</span><br><span class="line">        </span><br></pre></td></tr></tbody></table></figure><p><code>body_html</code> 、 <code>toc_html</code> 这两个渲染后的字段是经过加工后的数据，不存在于原始的数据中。为了将这类只读的附加字段添加到接口里，可以用<code>SerializerMethodField()</code> 字段。比如说上面代码中的 <code>body_html</code> 字段，它会自动去调用 <code>get_body_html()</code> 方法，并将其返回结果作为需要序列化的数据。方法中的 <code>obj</code> 参数是序列化器获取到的 model 实例，即文章对象。</p><h3 id="1-3-修复视图">1.3 修复视图</h3><p>渲染后的数据，在文章<strong>详情接口</strong>是需要的，但是在<strong>列表接口</strong>却没必要，因此视图集根据请求方式动态获取序列化器：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># article/views.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> viewsets, filters</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> article.permissions <span class="keyword">import</span> IsAdminUserOrReadOnly</span><br><span class="line"><span class="keyword">from</span> article.models <span class="keyword">import</span> Article, Category, Tag</span><br><span class="line"><span class="keyword">from</span> article.serializers <span class="keyword">import</span> ArticleSerializer, CategorySerializer, CategoryDetailSerializer, TagSerializer, ArticleDetailSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TagViewSet</span>(<span class="params">viewsets.ModelViewSet</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    标签视图集</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    queryset = Tag.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = TagSerializer</span><br><span class="line">    permission_classes = [IsAdminUserOrReadOnly]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategoryViewSet</span>(<span class="params">viewsets.ModelViewSet</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    分类视图集</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    queryset = Category.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = CategorySerializer</span><br><span class="line">    permission_classes = [IsAdminUserOrReadOnly]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_serializer_class</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.action == <span class="string">'list'</span>:</span><br><span class="line">            <span class="keyword">return</span> CategorySerializer</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> CategoryDetailSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleViewSet</span>(<span class="params">viewsets.ModelViewSet</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    文章视图集</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line">    permission_classes = [IsAdminUserOrReadOnly]</span><br><span class="line"></span><br><span class="line">    filter_backends = [filters.SearchFilter]</span><br><span class="line">    search_fields = [<span class="string">'title'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save(author=self.request.user)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_serializer_class</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.action == <span class="string">'list'</span>:</span><br><span class="line">            <span class="keyword">return</span> ArticleSerializer</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> ArticleDetailSerializer</span><br><span class="line">    </span><br></pre></td></tr></tbody></table></figure><h2 id="5-文章标题图">5. 文章标题图</h2><p>博客可能会有文件的上传与下载，但是 JSON 格式的载体是字符串，不能够直接处理文件流。</p><p>Django 用 <code>multipart/form-data</code> 表单发送夹杂着元数据的文件，DRF中也可以这样做，这种方法可行，但在主要接口中发送编码文不太好，还有其他方法：</p><ul><li>方法1：用 Base64 对文件进行编码（将文件变成字符串）。这种方法简单粗暴，并且只靠 Json 接口就可以实现。代价是数据传输大小增加了约 33％，并在服务器和客户端中增加了编码/解码的开销。</li><li>方法2：首先在 <code>multipart/form-data</code> 中单独发送文件，然后后端将保存好的文件 id 返回给客户端。客户端拿到文件 id 后，发送带有文件 id 的 Json 数据，在服务器端将它们关联起来。</li><li>方法3：首先单独发送 Json 数据，然后后端保存好这些元数据后将其 id 返回给客户端。接着客户端发送带有元数据 id 的文件，在服务器端将它们关联起来。</li></ul><p>三种方法各有优劣，具体用哪种方法应当视实际情况确定。</p><p>本文将使用第二种方法来实现博文标题图的功能。</p><h3 id="5-1-增加模型">5.1 增加模型</h3><p><code>Pillow</code>库可用于处理图片字段，要使用这个库，首先执行<code>pip install Pillow==9.4.0</code>，添加标题图模型：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># article/models.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> django.utils <span class="keyword">import</span> timezone</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> markdown <span class="keyword">import</span> Markdown</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Avatar</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    content = models.ImageField(upload_to=<span class="string">'avatar/%Y%m%d'</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tag</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    文章标签</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    text = models.CharField(max_length=<span class="number">30</span>, unique=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        ordering = [<span class="string">'-id'</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Category</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    文章分类</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">100</span>)</span><br><span class="line">    created = models.DateTimeField(default=timezone.now)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        ordering = [<span class="string">'-created'</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.title</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Article</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    博客文章</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">100</span>)              <span class="comment"># 标题</span></span><br><span class="line">    avatar = models.ForeignKey(</span><br><span class="line">        Avatar,</span><br><span class="line">        null=<span class="literal">True</span>,</span><br><span class="line">        blank=<span class="literal">True</span>,</span><br><span class="line">        on_delete=models.SET_NULL,</span><br><span class="line">        related_name=<span class="string">'article'</span></span><br><span class="line">    )</span><br><span class="line">    category = models.ForeignKey(</span><br><span class="line">        Category,</span><br><span class="line">        null=<span class="literal">True</span>,</span><br><span class="line">        blank=<span class="literal">True</span>,</span><br><span class="line">        on_delete=models.SET_NULL,</span><br><span class="line">        related_name=<span class="string">'articles'</span></span><br><span class="line">    )                                                     <span class="comment"># 分类</span></span><br><span class="line">    tags = models.ManyToManyField(</span><br><span class="line">        Tag,</span><br><span class="line">        blank=<span class="literal">True</span>,</span><br><span class="line">        related_name=<span class="string">'articles'</span></span><br><span class="line">    )                                                     <span class="comment"># 标签</span></span><br><span class="line">    author = models.ForeignKey(</span><br><span class="line">        User,</span><br><span class="line">        null=<span class="literal">True</span>,</span><br><span class="line">        on_delete=models.CASCADE,</span><br><span class="line">        related_name=<span class="string">"articles"</span></span><br><span class="line">    )                                                     <span class="comment"># 作者</span></span><br><span class="line">    body = models.TextField()                             <span class="comment"># 正文</span></span><br><span class="line">    created = models.DateTimeField(default=timezone.now)  <span class="comment"># 创建时间</span></span><br><span class="line">    updated = models.DateTimeField(auto_now=<span class="literal">True</span>)         <span class="comment"># 更新时间</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        ordering = [<span class="string">'-created'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.title</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_md</span>(<span class="params">self</span>):</span></span><br><span class="line">        md = Markdown(</span><br><span class="line">            extensions=[</span><br><span class="line">                <span class="string">'markdown.extensions.extra'</span>,</span><br><span class="line">                <span class="string">'markdown.extensions.codehilite'</span>,</span><br><span class="line">                <span class="string">'markdown.extensions.toc'</span>,</span><br><span class="line">            ]</span><br><span class="line">        )</span><br><span class="line">        md_body = md.convert(self.body)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> md_body, md.toc</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p><code>Avatar</code> 模型仅包含一个图片字段。接收的图片将保存在 <code>media/avatar/年月日/</code> 的路径中。</p><p>执行迁移：</p><figure class="highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line">(venv) &gt; python manage.py makemigrations</span><br><span class="line">(venv) &gt; python manage.py migrate</span><br></pre></td></tr></tbody></table></figure><h3 id="5-2-序列化器">5.2 序列化器</h3><p>用户的操作流程如下：</p><ul><li>发表新文章时，标题图需要先上传，添加一个单独的序列化器，DRF 对图片的处理进行了封装，通常不需要你关心实现的细节。</li><li>标题图上传完成会返回其数据（比如图片数据的 id）到前端并暂存，前端将图片的信息以嵌套结构表示到文章接口中，并在适当的时候将其链接到文章数据中，等待新文章完成后一起提交。</li><li>提交新文章时，序列化器对标题图进行检查，如果无效则返回错误信息。</li></ul><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># article/serializers.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> article.models <span class="keyword">import</span> Article, Category, Tag, Avatar</span><br><span class="line"><span class="keyword">from</span> user_info.serializers <span class="keyword">import</span> UserDescSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AvatarSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    url = serializers.HyperlinkedIdentityField(view_name=<span class="string">'avatar-detail'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Avatar</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TagSerializer</span>(<span class="params">serializers.HyperlinkedModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    标签序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Tag</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategorySerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    分类序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    url = serializers.HyperlinkedIdentityField(view_name=<span class="string">'category-detail'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Category</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line">        read_only_fields = [<span class="string">'created'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleBaseSerializer</span>(<span class="params">serializers.HyperlinkedModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    文章序列化器父类</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    author = UserDescSerializer(read_only=<span class="literal">True</span>)</span><br><span class="line">    category = CategorySerializer(read_only=<span class="literal">True</span>)</span><br><span class="line">    category_id = serializers.IntegerField(write_only=<span class="literal">True</span>, allow_null=<span class="literal">True</span>, required=<span class="literal">False</span>)</span><br><span class="line">    tags = serializers.SlugRelatedField(queryset=Tag.objects.<span class="built_in">all</span>(), many=<span class="literal">True</span>, required=<span class="literal">False</span>, slug_field=<span class="string">'text'</span>)</span><br><span class="line">    avatar = AvatarSerializer(read_only=<span class="literal">True</span>)</span><br><span class="line">    avatar_id = serializers.IntegerField(write_only=<span class="literal">True</span>, allow_null=<span class="literal">True</span>, required=<span class="literal">False</span>)</span><br><span class="line">    </span><br><span class="line">    default_error_messages = {</span><br><span class="line">        <span class="string">'incorrect_avatar_id'</span>: <span class="string">'Avatar with id {value} not exits.'</span>,</span><br><span class="line">        <span class="string">'incorrect_category_id'</span>: <span class="string">'Category with id {value} not exits.'</span>,</span><br><span class="line">        <span class="string">'default'</span>: <span class="string">'No more message here...'</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check_obj_exists_or_fail</span>(<span class="params">self, model, value, message=<span class="string">'default'</span></span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.default_error_messages.get(message, <span class="literal">None</span>):</span><br><span class="line">            message = <span class="string">'default'</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> model.objects.<span class="built_in">filter</span>(<span class="built_in">id</span>=value).exists() <span class="keyword">and</span> value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self.fail(message, value=value)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_category_id</span>(<span class="params">self, value</span>):</span></span><br><span class="line">        self.check_obj_exists_or_fail(model=Category, value=value, message=<span class="string">'incorrect_category_id'</span>)</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_avatar_id</span>(<span class="params">self, value</span>):</span></span><br><span class="line">        self.check_obj_exists_or_fail(model=Avatar, value=value, message=<span class="string">'incorrect_avatar_id'</span>)</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">to_internal_value</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        tags_data = data.get(<span class="string">'tags'</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(tags_data, <span class="built_in">list</span>):</span><br><span class="line">            <span class="keyword">for</span> text <span class="keyword">in</span> tags_data:</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> Tag.objects.<span class="built_in">filter</span>(text=text).exists():</span><br><span class="line">                    Tag.objects.create(text=text)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().to_internal_value(data)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, validated_data</span>):</span></span><br><span class="line">        category_id = validated_data.pop(<span class="string">'category_id'</span>)</span><br><span class="line">        validated_data[<span class="string">'category'</span>] = Category.objects.get(<span class="built_in">id</span>=category_id)</span><br><span class="line">        tags = Tag.objects.<span class="built_in">filter</span>(text__in=validated_data[<span class="string">'tags'</span>])</span><br><span class="line">        validated_data.pop(<span class="string">'tags'</span>)</span><br><span class="line">        article = Article.objects.create(**validated_data)</span><br><span class="line">        article.tags.<span class="built_in">set</span>(tags)</span><br><span class="line">        <span class="keyword">return</span> article</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleSerializer</span>(<span class="params">ArticleBaseSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    文章列表序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Article</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line">        extra_kwargs = {<span class="string">'body'</span>: {<span class="string">'write_only'</span>: <span class="literal">True</span>}}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleDetailSerializer</span>(<span class="params">ArticleBaseSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    文章详情序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    body_html = serializers.SerializerMethodField()</span><br><span class="line">    toc_html = serializers.SerializerMethodField()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_body_html</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">        <span class="keyword">return</span> obj.get_md()[<span class="number">0</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_toc_html</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">        <span class="keyword">return</span> obj.get_md()[<span class="number">1</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Article</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleCategoryDetailSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    给分类详情的文章嵌套序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    url = serializers.HyperlinkedIdentityField(view_name=<span class="string">'article-detail'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Category</span><br><span class="line">        fields = [</span><br><span class="line">            <span class="string">'url'</span>,</span><br><span class="line">            <span class="string">'title'</span>,</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategoryDetailSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    分类详情</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    articles = ArticleCategoryDetailSerializer(many=<span class="literal">True</span>, read_only=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Category</span><br><span class="line">        fields = [</span><br><span class="line">            <span class="string">'id'</span>,</span><br><span class="line">            <span class="string">'title'</span>,</span><br><span class="line">            <span class="string">'created'</span>,</span><br><span class="line">            <span class="string">'articles'</span>,</span><br><span class="line">        ]</span><br><span class="line">        </span><br></pre></td></tr></tbody></table></figure><h3 id="5-3-视图与路由">5.3 视图与路由</h3><p>编写视图：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># article/views.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> viewsets, filters</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> article.permissions <span class="keyword">import</span> IsAdminUserOrReadOnly</span><br><span class="line"><span class="keyword">from</span> article.models <span class="keyword">import</span> Article, Category, Tag, Avatar</span><br><span class="line"><span class="keyword">from</span> article.serializers <span class="keyword">import</span> (</span><br><span class="line">    ArticleSerializer,</span><br><span class="line">    CategorySerializer,</span><br><span class="line">    CategoryDetailSerializer,</span><br><span class="line">    TagSerializer,</span><br><span class="line">    ArticleDetailSerializer,</span><br><span class="line">    AvatarSerializer,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AvatarViewSet</span>(<span class="params">viewsets.ModelViewSet</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    文章标题图视图集</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    queryset = Avatar.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = AvatarSerializer</span><br><span class="line">    permission_classes = [IsAdminUserOrReadOnly]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TagViewSet</span>(<span class="params">viewsets.ModelViewSet</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    标签视图集</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    queryset = Tag.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = TagSerializer</span><br><span class="line">    permission_classes = [IsAdminUserOrReadOnly]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategoryViewSet</span>(<span class="params">viewsets.ModelViewSet</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    分类视图集</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    queryset = Category.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = CategorySerializer</span><br><span class="line">    permission_classes = [IsAdminUserOrReadOnly]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_serializer_class</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.action == <span class="string">'list'</span>:</span><br><span class="line">            <span class="keyword">return</span> CategorySerializer</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> CategoryDetailSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleViewSet</span>(<span class="params">viewsets.ModelViewSet</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    文章视图集</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    queryset = Article.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = ArticleSerializer</span><br><span class="line">    permission_classes = [IsAdminUserOrReadOnly]</span><br><span class="line"></span><br><span class="line">    filter_backends = [filters.SearchFilter]</span><br><span class="line">    search_fields = [<span class="string">'title'</span>]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save(author=self.request.user)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_serializer_class</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.action == <span class="string">'list'</span>:</span><br><span class="line">            <span class="keyword">return</span> ArticleSerializer</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> ArticleDetailSerializer</span><br><span class="line">    </span><br></pre></td></tr></tbody></table></figure><p>还需要修改配置文件，配置图片存放的路径</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># backend/settings.py</span></span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">MEDIA_URL =  <span class="string">'/media/'</span></span><br><span class="line">MEDIA_ROOT = BASE_DIR / <span class="string">'media'</span></span><br></pre></td></tr></tbody></table></figure><p>最后编写路由：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># backend/urls.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> django.conf.urls.static <span class="keyword">import</span> static</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line"><span class="keyword">from</span> rest_framework.routers <span class="keyword">import</span> DefaultRouter</span><br><span class="line"><span class="keyword">from</span> article <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router = DefaultRouter()</span><br><span class="line">router.register(<span class="string">r'article'</span>, views.ArticleViewSet)</span><br><span class="line">router.register(<span class="string">r'category'</span>, views.CategoryViewSet)</span><br><span class="line">router.register(<span class="string">r'tag'</span>, views.TagViewSet)</span><br><span class="line">router.register(<span class="string">r'avatar'</span>, views.AvatarViewSet)</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">'api/'</span>, include(router.urls)),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> settings.DEBUG:</span><br><span class="line">    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="5-4-测试">5.4 测试</h3><blockquote><p><em>Postman 操作文件接口需要将</em> <code>Content-Type</code> <em>改为</em> <code>multipart/form-data</code> <em>，并在</em> <code>Body</code> <em>中上传图片文件。</em></p></blockquote><p>可浏览器打开http://127.0.0.1:8000/api/avatar/"进行测试</p><h2 id="6-评论">6. 评论</h2><p>有很多方式可以将评论功能托管给第三方（推荐这么做），不过也可以自己实现简单的评论接口。</p><p>评论功能比较独立，因此新增一个 <code>comment</code> 的 App：</p><figure class="highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line">(venv) &gt; python manage.py startapp comment</span><br></pre></td></tr></tbody></table></figure><p>将App注册到配置文件</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># backend/settings.py</span></span><br><span class="line"></span><br><span class="line">INSTALLED_APPS = [</span><br><span class="line">    <span class="string">'django.contrib.admin'</span>,</span><br><span class="line">    <span class="string">'django.contrib.auth'</span>,</span><br><span class="line">    <span class="string">'django.contrib.contenttypes'</span>,</span><br><span class="line">    <span class="string">'django.contrib.sessions'</span>,</span><br><span class="line">    <span class="string">'django.contrib.messages'</span>,</span><br><span class="line">    <span class="string">'django.contrib.staticfiles'</span>,</span><br><span class="line">    <span class="string">'rest_framework'</span>,</span><br><span class="line">    <span class="string">'article'</span>,</span><br><span class="line">    <span class="string">'user_info'</span>,</span><br><span class="line">    <span class="string">'django_filters'</span>,</span><br><span class="line">    <span class="string">'comment'</span>,</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure><h3 id="6-1-添加模型">6.1 添加模型</h3><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># comment/models.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> django.utils <span class="keyword">import</span> timezone</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> article.models <span class="keyword">import</span> Article</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Comment</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    author = models.ForeignKey(</span><br><span class="line">        User,</span><br><span class="line">        on_delete=models.CASCADE,</span><br><span class="line">        related_name=<span class="string">'comments'</span></span><br><span class="line">    )</span><br><span class="line">    article = models.ForeignKey(</span><br><span class="line">        Article,</span><br><span class="line">        on_delete=models.CASCADE,</span><br><span class="line">        related_name=<span class="string">'comments'</span></span><br><span class="line">    )</span><br><span class="line">    content = models.TextField()</span><br><span class="line">    created = models.DateTimeField(default=timezone.now)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        ordering = [<span class="string">'-created'</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.content[:<span class="number">20</span>]</span><br><span class="line">    </span><br></pre></td></tr></tbody></table></figure><p>模型包含一对多的作者外键、一对多的文章外键、评论实际内容、评论时间这4个字段。</p><p>执行 <code>python manage.py makemigrations</code> 和 <code>python manage.py migrate</code> 。</p><h3 id="6-2-序列化器">6.2 序列化器</h3><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># comment/serializers.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> comment.models <span class="keyword">import</span> Comment</span><br><span class="line"><span class="keyword">from</span> user_info.serializers <span class="keyword">import</span> UserDescSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CommentSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    评论序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    url = serializers.HyperlinkedIdentityField(view_name=<span class="string">'comment-detail'</span>)</span><br><span class="line">    author = UserDescSerializer(read_only=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Comment</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line">        extra_kwargs = {<span class="string">'created'</span>: {<span class="string">'read_only'</span>: <span class="literal">True</span>}}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p><code>url</code> 超链接字段让接口的跳转更方便，<code>author</code> 嵌套序列化器让显示的内容更丰富，让评论通过文章接口显示出来：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># article/serializers.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> article.models <span class="keyword">import</span> Article, Category, Tag, Avatar</span><br><span class="line"><span class="keyword">from</span> user_info.serializers <span class="keyword">import</span> UserDescSerializer</span><br><span class="line"><span class="keyword">from</span> comment.serializers <span class="keyword">import</span> CommentSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AvatarSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    url = serializers.HyperlinkedIdentityField(view_name=<span class="string">'avatar-detail'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Avatar</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TagSerializer</span>(<span class="params">serializers.HyperlinkedModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    标签序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Tag</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategorySerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    分类序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    url = serializers.HyperlinkedIdentityField(view_name=<span class="string">'category-detail'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Category</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line">        read_only_fields = [<span class="string">'created'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleBaseSerializer</span>(<span class="params">serializers.HyperlinkedModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    文章序列化器父类</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    author = UserDescSerializer(read_only=<span class="literal">True</span>)</span><br><span class="line">    category = CategorySerializer(read_only=<span class="literal">True</span>)</span><br><span class="line">    category_id = serializers.IntegerField(write_only=<span class="literal">True</span>, allow_null=<span class="literal">True</span>, required=<span class="literal">False</span>)</span><br><span class="line">    tags = serializers.SlugRelatedField(queryset=Tag.objects.<span class="built_in">all</span>(), many=<span class="literal">True</span>, required=<span class="literal">False</span>, slug_field=<span class="string">'text'</span>)</span><br><span class="line">    avatar = AvatarSerializer(read_only=<span class="literal">True</span>)</span><br><span class="line">    avatar_id = serializers.IntegerField(write_only=<span class="literal">True</span>, allow_null=<span class="literal">True</span>, required=<span class="literal">False</span>)</span><br><span class="line">    </span><br><span class="line">    default_error_messages = {</span><br><span class="line">        <span class="string">'incorrect_avatar_id'</span>: <span class="string">'Avatar with id {value} not exits.'</span>,</span><br><span class="line">        <span class="string">'incorrect_category_id'</span>: <span class="string">'Category with id {value} not exits.'</span>,</span><br><span class="line">        <span class="string">'default'</span>: <span class="string">'No more message here...'</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check_obj_exists_or_fail</span>(<span class="params">self, model, value, message=<span class="string">'default'</span></span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.default_error_messages.get(message, <span class="literal">None</span>):</span><br><span class="line">            message = <span class="string">'default'</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> model.objects.<span class="built_in">filter</span>(<span class="built_in">id</span>=value).exists() <span class="keyword">and</span> value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            self.fail(message, value=value)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_category_id</span>(<span class="params">self, value</span>):</span></span><br><span class="line">        self.check_obj_exists_or_fail(model=Category, value=value, message=<span class="string">'incorrect_category_id'</span>)</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">validate_avatar_id</span>(<span class="params">self, value</span>):</span></span><br><span class="line">        self.check_obj_exists_or_fail(model=Avatar, value=value, message=<span class="string">'incorrect_avatar_id'</span>)</span><br><span class="line">        <span class="keyword">return</span> value</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">to_internal_value</span>(<span class="params">self, data</span>):</span></span><br><span class="line">        tags_data = data.get(<span class="string">'tags'</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(tags_data, <span class="built_in">list</span>):</span><br><span class="line">            <span class="keyword">for</span> text <span class="keyword">in</span> tags_data:</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> Tag.objects.<span class="built_in">filter</span>(text=text).exists():</span><br><span class="line">                    Tag.objects.create(text=text)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().to_internal_value(data)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, validated_data</span>):</span></span><br><span class="line">        category_id = validated_data.pop(<span class="string">'category_id'</span>)</span><br><span class="line">        validated_data[<span class="string">'category'</span>] = Category.objects.get(<span class="built_in">id</span>=category_id)</span><br><span class="line">        tags = Tag.objects.<span class="built_in">filter</span>(text__in=validated_data[<span class="string">'tags'</span>])</span><br><span class="line">        validated_data.pop(<span class="string">'tags'</span>)</span><br><span class="line">        article = Article.objects.create(**validated_data)</span><br><span class="line">        article.tags.<span class="built_in">set</span>(tags)</span><br><span class="line">        <span class="keyword">return</span> article</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleSerializer</span>(<span class="params">ArticleBaseSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    文章列表序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Article</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line">        extra_kwargs = {<span class="string">'body'</span>: {<span class="string">'write_only'</span>: <span class="literal">True</span>}}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleDetailSerializer</span>(<span class="params">ArticleBaseSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    文章详情序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="built_in">id</span> = serializers.IntegerField(read_only=<span class="literal">True</span>)</span><br><span class="line">    comments = CommentSerializer(many=<span class="literal">True</span>, read_only=<span class="literal">True</span>)</span><br><span class="line">    body_html = serializers.SerializerMethodField()</span><br><span class="line">    toc_html = serializers.SerializerMethodField()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_body_html</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">        <span class="keyword">return</span> obj.get_md()[<span class="number">0</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_toc_html</span>(<span class="params">self, obj</span>):</span></span><br><span class="line">        <span class="keyword">return</span> obj.get_md()[<span class="number">1</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Article</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArticleCategoryDetailSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    给分类详情的文章嵌套序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    url = serializers.HyperlinkedIdentityField(view_name=<span class="string">'article-detail'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Category</span><br><span class="line">        fields = [</span><br><span class="line">            <span class="string">'url'</span>,</span><br><span class="line">            <span class="string">'title'</span>,</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategoryDetailSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    分类详情</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    articles = ArticleCategoryDetailSerializer(many=<span class="literal">True</span>, read_only=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Category</span><br><span class="line">        fields = [</span><br><span class="line">            <span class="string">'id'</span>,</span><br><span class="line">            <span class="string">'title'</span>,</span><br><span class="line">            <span class="string">'created'</span>,</span><br><span class="line">            <span class="string">'articles'</span>,</span><br><span class="line">        ]</span><br><span class="line">        </span><br></pre></td></tr></tbody></table></figure><h3 id="6-3-权限、视图与路由">6.3 权限、视图与路由</h3><p>评论对用户身份的要求比文章宽松，<strong>非安全请求</strong>只需要是本人操作就可以了。</p><p>因此自定义一个所有人都可查看、仅本人可更改的权限：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># comment/permissions.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> BasePermission, SAFE_METHODS</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IsOwnerOrReadOnly</span>(<span class="params">BasePermission</span>):</span></span><br><span class="line">    message = <span class="string">'You must be the owner to update.'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">safe_methods_or_owner</span>(<span class="params">self, request, func</span>):</span></span><br><span class="line">        <span class="keyword">if</span> request.method <span class="keyword">in</span> SAFE_METHODS:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> func()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">has_permission</span>(<span class="params">self, request, view</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.safe_methods_or_owner(</span><br><span class="line">            request,</span><br><span class="line">            <span class="keyword">lambda</span>: request.user.is_authenticated</span><br><span class="line">        )</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">has_object_permission</span>(<span class="params">self, request, view, obj</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.safe_methods_or_owner(</span><br><span class="line">            request,</span><br><span class="line">            <span class="keyword">lambda</span>: obj.author == request.user</span><br><span class="line">        )</span><br><span class="line">    </span><br></pre></td></tr></tbody></table></figure><p>进行<strong>非安全请求</strong>时，需要验证当前评论的作者和当前登录的用户是否为同一个人，这里用到了 <code>def has_object_permission(...)</code> 这个钩子方法，方法参数中的 <code>obj</code> 即为评论模型的实例。</p><p>看起来只需要实现这个 <code>def has_object_permission(...)</code> 就可以了，但还有一点点小问题：此方法是晚于视图集中的 <code>def perform_create(author=self.request.user)</code> 执行的。如果用户未登录时新建评论，由于用户不存在，接口会抛出 500 错误。</p><p>本着即使出错也要做出正确错误提示的原则，增加了 <code>def has_permission(...)</code> 方法。此方法早于 <code>def perform_create(...)</code> 执行，因此能够对用户登录状态做一个预先检查。</p><p>编写视图：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># comment/views.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> viewsets</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> comment.models <span class="keyword">import</span> Comment</span><br><span class="line"><span class="keyword">from</span> comment.serializers <span class="keyword">import</span> CommentSerializer</span><br><span class="line"><span class="keyword">from</span> comment.permissions <span class="keyword">import</span> IsOwnerOrReadOnly</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CommentViewSet</span>(<span class="params">viewsets.ModelViewSet</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    评论视图集</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    queryset = Comment.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = CommentSerializer</span><br><span class="line">    permission_classes = [IsOwnerOrReadOnly]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">perform_create</span>(<span class="params">self, serializer</span>):</span></span><br><span class="line">        serializer.save(author=self.request.user)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>注册路由：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># backend/urls.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> django.conf.urls.static <span class="keyword">import</span> static</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line"><span class="keyword">from</span> rest_framework.routers <span class="keyword">import</span> DefaultRouter</span><br><span class="line"><span class="keyword">from</span> article <span class="keyword">import</span> views</span><br><span class="line"><span class="keyword">from</span> comment.views <span class="keyword">import</span> CommentViewSet</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router = DefaultRouter()</span><br><span class="line">router.register(<span class="string">r'article'</span>, views.ArticleViewSet)</span><br><span class="line">router.register(<span class="string">r'category'</span>, views.CategoryViewSet)</span><br><span class="line">router.register(<span class="string">r'tag'</span>, views.TagViewSet)</span><br><span class="line">router.register(<span class="string">r'avatar'</span>, views.AvatarViewSet)</span><br><span class="line">router.register(<span class="string">r'comment'</span>, CommentViewSet)</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">'api/'</span>, include(router.urls)),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> settings.DEBUG:</span><br><span class="line">    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>可浏览器打开http://127.0.0.1:8000/api/comment/"进行测试</p><h3 id="6-4-多级评论">6.4 多级评论</h3><p>多级评论，也就是让评论模型和自身相关联，使其可以有一个父级。</p><p>修改评论模型，新增 <code>parent</code> 字段：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># comment/models.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> django.utils <span class="keyword">import</span> timezone</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> article.models <span class="keyword">import</span> Article</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Comment</span>(<span class="params">models.Model</span>):</span></span><br><span class="line">    parent = models.ForeignKey(</span><br><span class="line">        <span class="string">'self'</span>,</span><br><span class="line">        null=<span class="literal">True</span>,</span><br><span class="line">        blank=<span class="literal">True</span>,</span><br><span class="line">        on_delete=models.SET_NULL,</span><br><span class="line">        related_name=<span class="string">'children'</span></span><br><span class="line">    )</span><br><span class="line">    author = models.ForeignKey(</span><br><span class="line">        User,</span><br><span class="line">        on_delete=models.CASCADE,</span><br><span class="line">        related_name=<span class="string">'comments'</span></span><br><span class="line">    )</span><br><span class="line">    article = models.ForeignKey(</span><br><span class="line">        Article,</span><br><span class="line">        on_delete=models.CASCADE,</span><br><span class="line">        related_name=<span class="string">'comments'</span></span><br><span class="line">    )</span><br><span class="line">    content = models.TextField()</span><br><span class="line">    created = models.DateTimeField(default=timezone.now)</span><br><span class="line">    </span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        ordering = [<span class="string">'-created'</span>]</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> self.content[:<span class="number">20</span>]</span><br><span class="line">    </span><br></pre></td></tr></tbody></table></figure><ul><li>一个父评论可以有多个子评论，而一个子评论只能有一个父评论，因此用了一对多外键。</li><li>之前的一对多外键，第一个参数直接引用了对应的模型，但是由于语法规则限制，这里显然不能够自己引用自己，因此用了传递字符串 <code>self</code> 的方式，作用都是一样的。</li></ul><p>执行 <code>python manage.py makemigrations</code> 和 <code>python manage.py migrate</code> 进行迁移。</p><p>修改序列化器：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># comment/serializers.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> comment.models <span class="keyword">import</span> Comment</span><br><span class="line"><span class="keyword">from</span> user_info.serializers <span class="keyword">import</span> UserDescSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CommentChildrenSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    子评论序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    url = serializers.HyperlinkedIdentityField(view_name=<span class="string">'comment-detail'</span>)</span><br><span class="line">    author = UserDescSerializer(read_only=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Comment</span><br><span class="line">        exclude = [<span class="string">'parent'</span>, <span class="string">'article'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CommentSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    评论序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    url = serializers.HyperlinkedIdentityField(view_name=<span class="string">'comment-detail'</span>)</span><br><span class="line">    author = UserDescSerializer(read_only=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    article = serializers.HyperlinkedRelatedField(view_name=<span class="string">'article-detail'</span>, read_only=<span class="literal">True</span>)</span><br><span class="line">    article_id = serializers.IntegerField(write_only=<span class="literal">True</span>, allow_null=<span class="literal">False</span>, required=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    parent = CommentChildrenSerializer(read_only=<span class="literal">True</span>)</span><br><span class="line">    parent_id = serializers.IntegerField(write_only=<span class="literal">True</span>, allow_null=<span class="literal">True</span>, required=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">self, instance, validated_data</span>):</span></span><br><span class="line">        validated_data.pop(<span class="string">'parent_id'</span>, <span class="literal">None</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().update(instance, validated_data)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = Comment</span><br><span class="line">        fields = <span class="string">'__all__'</span></span><br><span class="line">        extra_kwargs = {<span class="string">'created'</span>: {<span class="string">'read_only'</span>: <span class="literal">True</span>}}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>新增代码大致可以分为三块：</p><ul><li>将 <code>article</code> 改为超链接字段用了 <code>HyperlinkedRelatedField</code> ，它同 <code>HyperlinkedIdentityField</code> 差别很小，可以简化理解为 <code>HyperlinkedRelatedField</code> 用于对外键关系，而 <code>HyperlinkedIdentityField</code> 用于对当前模型自身。（完整的解释<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/31566675/for-django-rest-framework-what-is-the-difference-in-use-case-for-hyperlinkedrel">看这里</a>）</li><li><code>parent</code> 为父评论，用了嵌套序列化器 <code>CommentChildrenSerializer</code> 。注意这个序列化器的 <code>Meta</code> 用 <code>exclude</code> 来定义不需要的字段。</li><li>由于希望父评论只能在创建时被关联，后续不能更改，因此覆写 <code>def update(...)</code> ，使得在更新评论时忽略掉 <code>parent_id</code> 参数。</li></ul><p>可浏览器打开http://127.0.0.1:8000/api/comment/"，在界面上进行评论的增删改查测试</p><h2 id="7-JWT身份认证">7. JWT身份认证</h2><p>Web 程序是使用 HTTP 协议传输的，而 HTTP 协议是<strong>无状态</strong>的协议，对于事务没有记忆能力。如果没有其他形式的帮助，服务器是没办法知道前后两次请求是否是同一个用户发起的，也不具有对用户进行身份验证的能力。</p><p>传统 web 开发中，身份验证<strong>通常</strong>是基于 Session 会话机制的。Session 对象存储特定用户会话所需的属性及配置信息。这样，当用户在应用程序的 Web 页之间跳转时，存储在 Session 对象中的变量将不会丢失，而是在整个用户会话中一直存在下去。 Session 通常是存储在服务器当中的，如果 Session 过多，会对服务器产生压力。</p><p>另一种比较常用的身份验证方式是 <strong>JWT (JSON Web Token)</strong> 令牌。JWT 是一种开放标准，它定义了一种紧凑且自包含的方式，用于在各方之间作为 JSON 对象安全地传输信息。由于 Token 是经过数字签名的，因此可以被验证和信任。<strong>JWT 非常适合用于身份验证和服务器到服务器授权</strong>。与 Session 不同，JWT 的 <strong>Token</strong> 是保存在用户端的，即摆脱了对服务器的依赖。在进行某些需要验证身份的业务中，用户需要把令牌一并提交。</p><p>JWT令牌组成如图所示：</p><p><img src="Django-Vue%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2(3)%EF%BC%9A%E5%90%8E%E7%AB%AF%E5%8A%9F%E8%83%BD%E5%AE%8C%E5%96%84/image-20230328162558878.png" alt="JWT令牌"></p><blockquote><p><em>详细的</em> <a target="_blank" rel="noopener" href="https://jwt.io/introduction">JWT 工作方式讲解</a><em>。</em></p></blockquote><h3 id="7-1-JWT引入">7.1 JWT引入</h3><p><code>djangorestframework-simplejwt</code>库可用于 JWT ，要使用这个库，首先执行<code>pip install djangorestframework-simplejwt==5.2.2</code>，修改配置文件，使用 JWT 为默认验证机制，同时配置token的有效期：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># backend/settings.py</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> timedelta</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">REST_FRAMEWORK = {</span><br><span class="line">    <span class="string">'DEFAULT_PAGINATION_CLASS'</span>: <span class="string">'rest_framework.pagination.PageNumberPagination'</span>,</span><br><span class="line">    <span class="string">'PAGE_SIZE'</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="string">'DEFAULT_AUTHENTICATION_CLASSES'</span>: (</span><br><span class="line">        <span class="string">'rest_framework_simplejwt.authentication.JWTAuthentication'</span>,</span><br><span class="line">    )</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">SIMPLE_JWT = {</span><br><span class="line">    <span class="string">'ACCESS_TOKEN_LIFETIME'</span>: timedelta(hours=<span class="number">3</span>),</span><br><span class="line">    <span class="string">'REFRESH_TOKEN_LIFETIME'</span>: timedelta(days=<span class="number">1</span>),</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><blockquote><p>Token 一旦泄露，任何人都可以获得该令牌的所有权限。出于安全考虑，Token 的有效期通常不应该设置得太长。</p></blockquote><p>更多配置项请查看<a target="_blank" rel="noopener" href="https://django-rest-framework-simplejwt.readthedocs.io/en/latest/settings.html">官方文档</a>。</p><p>在路由中添加Token的获取和刷新地址</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># backend/urls.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> django.conf.urls.static <span class="keyword">import</span> static</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line"><span class="keyword">from</span> rest_framework.routers <span class="keyword">import</span> DefaultRouter</span><br><span class="line"><span class="keyword">from</span> article <span class="keyword">import</span> views</span><br><span class="line"><span class="keyword">from</span> comment.views <span class="keyword">import</span> CommentViewSet</span><br><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.views <span class="keyword">import</span> (</span><br><span class="line">    TokenObtainPairView,</span><br><span class="line">    TokenRefreshView,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router = DefaultRouter()</span><br><span class="line">router.register(<span class="string">r'article'</span>, views.ArticleViewSet)</span><br><span class="line">router.register(<span class="string">r'category'</span>, views.CategoryViewSet)</span><br><span class="line">router.register(<span class="string">r'tag'</span>, views.TagViewSet)</span><br><span class="line">router.register(<span class="string">r'avatar'</span>, views.AvatarViewSet)</span><br><span class="line">router.register(<span class="string">r'comment'</span>, CommentViewSet)</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">'api/'</span>, include(router.urls)),</span><br><span class="line">    path(<span class="string">'api/token/'</span>, TokenObtainPairView.as_view(), name=<span class="string">'token_obtain_pair'</span>),</span><br><span class="line">    path(<span class="string">'api/token/refresh'</span>, TokenRefreshView.as_view(), name=<span class="string">'token_refresh'</span>),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> settings.DEBUG:</span><br><span class="line">    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><h3 id="7-2-测试">7.2 测试</h3><p>浏览器打开页面 <a target="_blank" rel="noopener" href="http://127.0.0.1:8000/api/token/">http://127.0.0.1:8000/api/token/</a> ，填入你的用户名和密码，点击 <strong>POST</strong> 即可得到 Access Token 和 Refresh Token 。如：</p><figure class="highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line">HTTP <span class="number">200</span> OK</span><br><span class="line">Allow: POST, OPTIONS</span><br><span class="line">Content<span class="literal">-Type</span>: application/json</span><br><span class="line">Vary: Accept</span><br><span class="line"></span><br><span class="line">{</span><br><span class="line">    <span class="string">"refresh"</span>: <span class="string">"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoicmVmcmVzaCIsImV4cCI6MTY4MDA3OTMwMiwiaWF0IjoxNjc5OTkyOTAyLCJqdGkiOiI2ZWZmYzRhODJjZDY0ZjZiYjk3MDlmZTUzNDE2N2M1NSIsInVzZXJfaWQiOjF9.A2Z0oqu_TB-eLwCFgBkYMjjE71utzPa492VV9hX_zS0"</span>,</span><br><span class="line">    <span class="string">"access"</span>: <span class="string">"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNjgwMDAzNzAyLCJpYXQiOjE2Nzk5OTI5MDIsImp0aSI6ImYyMDNkNmMxMGY5ZDQ4MmJiNGI4ZjQwNGFhNzJlMjQ3IiwidXNlcl9pZCI6MX0.lN3ThGRBGg0Kz3u1vPrUJoYzlEFgoTNy_fyciPHxNRo"</span></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>拿到 Token 后，就可以用 Access Token 作为你的身份令牌，进行正常的资源请求了：</p><blockquote><p>Postman 有一个专门的标签页 (Authorization) 用于填写令牌。此标签页的 Type 栏选择 Bearer Token 即可。</p></blockquote><p>当 Access Token 过期后，可使用 Refresh Token 访问 <a target="_blank" rel="noopener" href="http://127.0.0.1:8000/api/token/refresh/">http://127.0.0.1:8000/api/token/refresh/</a> 再获取一个新的令牌 Access Token ，当 Refresh Token 也过期后，之后浏览器打开页面 <a target="_blank" rel="noopener" href="http://127.0.0.1:8000/api/token/">http://127.0.0.1:8000/api/token/</a> ，填入你的用户名和密码，获取新的Token了。</p><p>功能与用 Session 相同，并且成功切换到 JWT 方式了，非安全类的请求必须携带 Access Token。</p><blockquote><p>开启 JWT 后，Session 验证就自动失效了。也就是说，除了申请 Token 时会用到账户密码，其他时候的身份验证都不再需要它们了。</p></blockquote><p>Session V.S. JWT: JWT将会话移至客户端意味着摆脱了对服务器端会话的依赖，但这会带来如何安全存储、运输令牌等一系列挑战。不能够一概而论，而是要根据你的项目实际需求。关于这个话题更深入的讨论，请移步<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/43452896/authentication-jwt-usage-vs-session">Stackoverflow</a>。</p><h2 id="8-用户管理">8. 用户管理</h2><h3 id="8-1-序列化器">8.1 序列化器</h3><p>用户管理涉及到对密码的操作，因此新写一个序列化器，覆写 <code>def create(...)</code> 和 <code>def update(...)</code> 方法：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># user_info/serializers.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserDescSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    文章列表中引用的嵌套用户信息</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = User</span><br><span class="line">        fields = [</span><br><span class="line">            <span class="string">'id'</span>,</span><br><span class="line">            <span class="string">'username'</span>,</span><br><span class="line">            <span class="string">'last_login'</span>,</span><br><span class="line">            <span class="string">'date_joined'</span></span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserRegisterSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    用户管理序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    url = serializers.HyperlinkedIdentityField(view_name=<span class="string">'user-detail'</span>, lookup_field=<span class="string">'username'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = User</span><br><span class="line">        fields = [<span class="string">'url'</span>, <span class="string">'id'</span>, <span class="string">'username'</span>, <span class="string">'password'</span>]</span><br><span class="line">        extra_kwargs = {<span class="string">'password'</span>: {<span class="string">'write_only'</span>: <span class="literal">True</span>}}</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, validated_data</span>):</span></span><br><span class="line">        user = User.objects.create_user(**validated_data)</span><br><span class="line">        <span class="keyword">return</span> user</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">self, instance, validated_data</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'password'</span> <span class="keyword">in</span> validated_data:</span><br><span class="line">            password = validated_data.pop(<span class="string">'password'</span>)</span><br><span class="line">            instance.set_password(password)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().update(instance, validated_data)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><ul><li>注意 <code>def update(...)</code> 时，密码需要单独拿出来通过 <code>set_password()</code> 方法加密后存入数据库，而不能以明文的形式保存。</li><li>超链接字段的参数有一条 <code>lookup_field</code>，这是指定了解析超链接关系的字段。直观来说，将其配置为 <code>username</code> 后，用户详情接口的地址表示为用户名而不是主键。</li></ul><h3 id="8-2-权限、视图与路由">8.2 权限、视图与路由</h3><p>新增权限：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># user_info/permissions.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> BasePermission, SAFE_METHODS</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IsSelfOrReadOnly</span>(<span class="params">BasePermission</span>):</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">has_object_permission</span>(<span class="params">self, request, view, obj</span>):</span></span><br><span class="line">        <span class="keyword">if</span> request.method <span class="keyword">in</span> SAFE_METHODS:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> obj == request.user</span><br><span class="line">    </span><br></pre></td></tr></tbody></table></figure><p>新增视图：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># user_info/views.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> viewsets</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> AllowAny, IsAuthenticatedOrReadOnly</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> user_info.serializers <span class="keyword">import</span> UserRegisterSerializer</span><br><span class="line"><span class="keyword">from</span> user_info.permissions <span class="keyword">import</span> IsSelfOrReadOnly</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserViewSet</span>(<span class="params">viewsets.ModelViewSet</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    用户管理视图</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    queryset = User.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = UserRegisterSerializer</span><br><span class="line">    lookup_field = <span class="string">'username'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_permissions</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.request.method == <span class="string">'POST'</span>:</span><br><span class="line">            self.permission_classes = [AllowAny]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.permission_classes = [IsAuthenticatedOrReadOnly, IsSelfOrReadOnly]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().get_permissions()</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><ul><li>注册用户的 POST 请求是允许所有人都可以操作的，但其他类型的请求（比如修改、删除）就必须是本人才行了，因此可以覆写 <code>def get_permissions(...)</code> 定义不同情况下所允许的权限。 <code>permission_classes</code> 接受列表，因此可以同时定义多个权限，权限之间是 and 关系。</li><li>注意这里的 <code>lookup_field</code> 属性，和序列化器中对应起来。</li></ul><p>修改路由：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># backend/urls.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> django.conf.urls.static <span class="keyword">import</span> static</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path, include</span><br><span class="line"><span class="keyword">from</span> rest_framework.routers <span class="keyword">import</span> DefaultRouter</span><br><span class="line"><span class="keyword">from</span> article <span class="keyword">import</span> views</span><br><span class="line"><span class="keyword">from</span> comment.views <span class="keyword">import</span> CommentViewSet</span><br><span class="line"><span class="keyword">from</span> user_info.views <span class="keyword">import</span> UserViewSet</span><br><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.views <span class="keyword">import</span> (</span><br><span class="line">    TokenObtainPairView,</span><br><span class="line">    TokenRefreshView,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router = DefaultRouter()</span><br><span class="line">router.register(<span class="string">r'article'</span>, views.ArticleViewSet)</span><br><span class="line">router.register(<span class="string">r'category'</span>, views.CategoryViewSet)</span><br><span class="line">router.register(<span class="string">r'tag'</span>, views.TagViewSet)</span><br><span class="line">router.register(<span class="string">r'avatar'</span>, views.AvatarViewSet)</span><br><span class="line">router.register(<span class="string">r'comment'</span>, CommentViewSet)</span><br><span class="line">router.register(<span class="string">r'user'</span>, UserViewSet)</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">'api/'</span>, include(router.urls)),</span><br><span class="line">    path(<span class="string">'api/token/'</span>, TokenObtainPairView.as_view(), name=<span class="string">'token_obtain_pair'</span>),</span><br><span class="line">    path(<span class="string">'api/token/refresh'</span>, TokenRefreshView.as_view(), name=<span class="string">'token_refresh'</span>),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> settings.DEBUG:</span><br><span class="line">    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>可用浏览器打开 <a target="_blank" rel="noopener" href="http://127.0.0.1:8000/api/user/">http://127.0.0.1:8000/api/user/</a> 进行用户列表查看和创建用户测试。</p><p>可以看到详情地址不是主键值而是用户名了，这就是 <code>lookup_field</code> 发挥的作用。</p><h3 id="8-3-自定义动作">8.3 自定义动作</h3><p>视图集除了默认的增删改查外，还可以有其他的自定义动作。</p><p>为了测试，先写一个信息更加丰富的用户序列化器：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># user_info/serializers.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserDescSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    文章列表中引用的嵌套用户信息</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = User</span><br><span class="line">        fields = [</span><br><span class="line">            <span class="string">'id'</span>,</span><br><span class="line">            <span class="string">'username'</span>,</span><br><span class="line">            <span class="string">'last_login'</span>,</span><br><span class="line">            <span class="string">'date_joined'</span></span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserRegisterSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    用户管理序列化器</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    url = serializers.HyperlinkedIdentityField(view_name=<span class="string">'user-detail'</span>, lookup_field=<span class="string">'username'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = User</span><br><span class="line">        fields = [<span class="string">'url'</span>, <span class="string">'id'</span>, <span class="string">'username'</span>, <span class="string">'password'</span>]</span><br><span class="line">        extra_kwargs = {<span class="string">'password'</span>: {<span class="string">'write_only'</span>: <span class="literal">True</span>}}</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span>(<span class="params">self, validated_data</span>):</span></span><br><span class="line">        user = User.objects.create_user(**validated_data)</span><br><span class="line">        <span class="keyword">return</span> user</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">update</span>(<span class="params">self, instance, validated_data</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'password'</span> <span class="keyword">in</span> validated_data:</span><br><span class="line">            password = validated_data.pop(<span class="string">'password'</span>)</span><br><span class="line">            instance.set_password(password)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().update(instance, validated_data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserDetailSerializer</span>(<span class="params">serializers.ModelSerializer</span>):</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = User</span><br><span class="line">        fields = [</span><br><span class="line">            <span class="string">'id'</span>,</span><br><span class="line">            <span class="string">'username'</span>,</span><br><span class="line">            <span class="string">'first_name'</span>,</span><br><span class="line">            <span class="string">'last_name'</span>,</span><br><span class="line">            <span class="string">'email'</span>,</span><br><span class="line">            <span class="string">'last_login'</span>,</span><br><span class="line">            <span class="string">'date_joined'</span></span><br><span class="line">        ]</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>接着在视图集中新增自定义动作的代码：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># user_info/views.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> viewsets</span><br><span class="line"><span class="keyword">from</span> rest_framework.permissions <span class="keyword">import</span> AllowAny, IsAuthenticatedOrReadOnly</span><br><span class="line"><span class="keyword">from</span> rest_framework.decorators <span class="keyword">import</span> action</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> user_info.serializers <span class="keyword">import</span> UserRegisterSerializer, UserDetailSerializer</span><br><span class="line"><span class="keyword">from</span> user_info.permissions <span class="keyword">import</span> IsSelfOrReadOnly</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserViewSet</span>(<span class="params">viewsets.ModelViewSet</span>):</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    用户管理视图</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    queryset = User.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = UserRegisterSerializer</span><br><span class="line">    lookup_field = <span class="string">'username'</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_permissions</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">if</span> self.request.method == <span class="string">'POST'</span>:</span><br><span class="line">            self.permission_classes = [AllowAny]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            self.permission_classes = [IsAuthenticatedOrReadOnly, IsSelfOrReadOnly]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().get_permissions()</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @action(<span class="params">detail=<span class="literal">True</span>, methods=[<span class="string">'get'</span>]</span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">info</span>(<span class="params">self, request, username=<span class="literal">None</span></span>):</span></span><br><span class="line">        queryset = User.objects.get(username=username)</span><br><span class="line">        serializer = UserDetailSerializer(queryset, many=<span class="literal">False</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @action(<span class="params">detail=<span class="literal">False</span></span>)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sorted</span>(<span class="params">self, reqeust</span>):</span></span><br><span class="line">        users = User.objects.<span class="built_in">all</span>().order_by(<span class="string">'-username'</span>)</span><br><span class="line">        page = self.paginate_queryset(users)</span><br><span class="line">        <span class="keyword">if</span> page <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            serializer = self.get_serializer(page, many=<span class="literal">True</span>)</span><br><span class="line">            <span class="keyword">return</span> self.get_paginated_response(serializer.data)</span><br><span class="line">        </span><br><span class="line">        serializer = self.get_serializer(users, many=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(serializer.data)</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>魔法都在装饰器 <code>@action</code> 里，它的参数可以定义是否为详情的动作、请求类型、url 地址、url 解析名等常规需求。</p><figure class="highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line">(venv) &gt; http get http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8000</span>/api/user/admin/info/</span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Allow: GET, HEAD, OPTIONS</span><br><span class="line">Connection: close</span><br><span class="line">Content<span class="literal">-Length</span>: <span class="number">183</span></span><br><span class="line">Content<span class="literal">-Type</span>: application/json</span><br><span class="line">Cross<span class="literal">-Origin</span><span class="literal">-Opener</span><span class="literal">-Policy</span>: same<span class="literal">-origin</span></span><br><span class="line">Date: Tue, <span class="number">28</span> Mar <span class="number">2023</span> <span class="number">09</span>:<span class="number">50</span>:<span class="number">04</span> GMT</span><br><span class="line">Referrer<span class="literal">-Policy</span>: same<span class="literal">-origin</span></span><br><span class="line">Server: WSGIServer/<span class="number">0.2</span> CPython/<span class="number">3.10</span>.<span class="number">6</span></span><br><span class="line">Vary: Accept</span><br><span class="line">X<span class="literal">-Content</span><span class="literal">-Type</span><span class="literal">-Options</span>: nosniff</span><br><span class="line">X<span class="literal">-Frame</span><span class="literal">-Options</span>: DENY</span><br><span class="line"></span><br><span class="line">{</span><br><span class="line">    <span class="string">"date_joined"</span>: <span class="string">"2023-03-27T02:08:41.097951+08:00"</span>,</span><br><span class="line">    <span class="string">"email"</span>: <span class="string">"admin@example.com"</span>,</span><br><span class="line">    <span class="string">"first_name"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"id"</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">"last_login"</span>: <span class="string">"2023-03-27T23:24:54.504055+08:00"</span>,</span><br><span class="line">    <span class="string">"last_name"</span>: <span class="string">""</span>,</span><br><span class="line">    <span class="string">"username"</span>: <span class="string">"admin"</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">(venv) &gt; http get http://<span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">8000</span>/api/user/sorted/</span><br><span class="line">HTTP/<span class="number">1.1</span> <span class="number">200</span> OK</span><br><span class="line">Allow: GET, HEAD, OPTIONS</span><br><span class="line">Connection: close</span><br><span class="line">Content<span class="literal">-Length</span>: <span class="number">197</span></span><br><span class="line">Content<span class="literal">-Type</span>: application/json</span><br><span class="line">Cross<span class="literal">-Origin</span><span class="literal">-Opener</span><span class="literal">-Policy</span>: same<span class="literal">-origin</span></span><br><span class="line">Date: Tue, <span class="number">28</span> Mar <span class="number">2023</span> <span class="number">09</span>:<span class="number">51</span>:<span class="number">41</span> GMT</span><br><span class="line">Referrer<span class="literal">-Policy</span>: same<span class="literal">-origin</span></span><br><span class="line">Server: WSGIServer/<span class="number">0.2</span> CPython/<span class="number">3.10</span>.<span class="number">6</span></span><br><span class="line">Vary: Accept</span><br><span class="line">X<span class="literal">-Content</span><span class="literal">-Type</span><span class="literal">-Options</span>: nosniff</span><br><span class="line">X<span class="literal">-Frame</span><span class="literal">-Options</span>: DENY</span><br><span class="line"></span><br><span class="line">{</span><br><span class="line">    <span class="string">"count"</span>: <span class="number">2</span>,</span><br><span class="line">    <span class="string">"next"</span>: null,</span><br><span class="line">    <span class="string">"previous"</span>: null,</span><br><span class="line">    <span class="string">"results"</span>: [</span><br><span class="line">        {</span><br><span class="line">            <span class="string">"id"</span>: <span class="number">2</span>,</span><br><span class="line">            <span class="string">"url"</span>: <span class="string">"http://127.0.0.1:8000/api/user/test/"</span>,</span><br><span class="line">            <span class="string">"username"</span>: <span class="string">"test"</span></span><br><span class="line">        },</span><br><span class="line">        {</span><br><span class="line">            <span class="string">"id"</span>: <span class="number">1</span>,</span><br><span class="line">            <span class="string">"url"</span>: <span class="string">"http://127.0.0.1:8000/api/user/admin/"</span>,</span><br><span class="line">            <span class="string">"username"</span>: <span class="string">"admin"</span></span><br><span class="line">        }</span><br><span class="line">    ]</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>默认情况下，方法名就是此动作的路由路径。返回的 Json 也正确显示为方法中所封装的数据。</p><blockquote><p><em>关于自定义动作详见</em><a target="_blank" rel="noopener" href="https://www.django-rest-framework.org/api-guide/viewsets/#marking-extra-actions-for-routing">官方文档</a><em>。</em></p></blockquote><figure class="highlight markdown"><table><tbody><tr><td class="code"><pre><span class="line">本文标题： Django-Vue搭建个人博客(3)：后端功能完善</span><br><span class="line">原文链接： https://www.dusaiphoto.com/article/112/ ~ https://www.dusaiphoto.com/article/120/</span><br><span class="line">原文作者： 杜赛</span><br><span class="line">许可协议： 署名-非商业性使用 4.0 国际许可协议</span><br><span class="line">本文对原始作品作了修改，转载请保留原文链接及作者</span><br></pre></td></tr></tbody></table></figure></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者:</span> <span class="post-copyright-info"><a href="https://xiongbinzou.github.io">小邹同学</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接:</span> <span class="post-copyright-info"><a href="https://xiongbinzou.github.io/posts/16431.html">https://xiongbinzou.github.io/posts/16431.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明:</span> <span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://xiongbinzou.github.io" target="_blank">小邹同学</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Django/">Django</a><a class="post-meta__tags" href="/tags/Django-REST-framework/">Django REST framework</a><a class="post-meta__tags" href="/tags/Vue/">Vue</a><a class="post-meta__tags" href="/tags/%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB/">前后端分离</a></div><div class="post_share"><div class="social-share" data-image="/pics/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/pics/reward/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/pics/reward/wechat.jpg" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/pics/reward/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/pics/reward/alipay.jpg" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/12498.html"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Django-Vue搭建个人博客(4)：前端功能完善</div></div></a></div><div class="next-post pull-right"><a href="/posts/8442.html"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Django-Vue搭建个人博客(2)：DRF的使用</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/63190.html" title="Django-Vue搭建个人博客(0)：前言"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-02</div><div class="title">Django-Vue搭建个人博客(0)：前言</div></div></a></div><div><a href="/posts/39175.html" title="Django-Vue搭建个人博客(1)：搭建开发环境"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-03</div><div class="title">Django-Vue搭建个人博客(1)：搭建开发环境</div></div></a></div><div><a href="/posts/8442.html" title="Django-Vue搭建个人博客(2)：DRF的使用"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-04</div><div class="title">Django-Vue搭建个人博客(2)：DRF的使用</div></div></a></div><div><a href="/posts/12498.html" title="Django-Vue搭建个人博客(4)：前端功能完善"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-04-06</div><div class="title">Django-Vue搭建个人博客(4)：前端功能完善</div></div></a></div><div><a href="/posts/24277.html" title="SpringBoot+Vue全栈开发学习笔记"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-08-09</div><div class="title">SpringBoot+Vue全栈开发学习笔记</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i> <span>评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E8%BF%87%E6%BB%A4%E6%96%87%E7%AB%A0"><span class="toc-text">1. 过滤文章</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E5%8F%82%E6%95%B0%E8%BF%87%E6%BB%A4"><span class="toc-text">1.1 参数过滤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E9%80%9A%E7%94%A8%E8%BF%87%E6%BB%A4"><span class="toc-text">1.2 通用过滤</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%96%87%E7%AB%A0%E5%88%86%E7%B1%BB"><span class="toc-text">2. 文章分类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%A2%9E%E5%8A%A0%E6%A8%A1%E5%9E%8B"><span class="toc-text">2.1 增加模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8"><span class="toc-text">2.2 序列化器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E8%A7%86%E5%9B%BE%E4%B8%8E%E8%B7%AF%E7%94%B1"><span class="toc-text">2.3 视图与路由</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E6%B5%8B%E8%AF%95"><span class="toc-text">2.4 测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5-%E5%AE%8C%E5%96%84%E5%88%86%E7%B1%BB%E8%AF%A6%E6%83%85"><span class="toc-text">2.5 完善分类详情</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%96%87%E7%AB%A0%E6%A0%87%E7%AD%BE"><span class="toc-text">3. 文章标签</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-%E5%A2%9E%E5%8A%A0%E6%A8%A1%E5%9E%8B"><span class="toc-text">3.1 增加模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8"><span class="toc-text">3.2 序列化器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-%E8%A7%86%E5%9B%BE%E4%B8%8E%E8%B7%AF%E7%94%B1"><span class="toc-text">3.3 视图与路由</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Markdown%E6%AD%A3%E6%96%87"><span class="toc-text">4. Markdown正文</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1-%E4%BF%AE%E6%94%B9%E6%A8%A1%E5%9E%8B"><span class="toc-text">1.1 修改模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2-%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8"><span class="toc-text">1.2 序列化器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3-%E4%BF%AE%E5%A4%8D%E8%A7%86%E5%9B%BE"><span class="toc-text">1.3 修复视图</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E6%96%87%E7%AB%A0%E6%A0%87%E9%A2%98%E5%9B%BE"><span class="toc-text">5. 文章标题图</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E5%A2%9E%E5%8A%A0%E6%A8%A1%E5%9E%8B"><span class="toc-text">5.1 增加模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8"><span class="toc-text">5.2 序列化器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-%E8%A7%86%E5%9B%BE%E4%B8%8E%E8%B7%AF%E7%94%B1"><span class="toc-text">5.3 视图与路由</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-%E6%B5%8B%E8%AF%95"><span class="toc-text">5.4 测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E8%AF%84%E8%AE%BA"><span class="toc-text">6. 评论</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E6%B7%BB%E5%8A%A0%E6%A8%A1%E5%9E%8B"><span class="toc-text">6.1 添加模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8"><span class="toc-text">6.2 序列化器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-%E6%9D%83%E9%99%90%E3%80%81%E8%A7%86%E5%9B%BE%E4%B8%8E%E8%B7%AF%E7%94%B1"><span class="toc-text">6.3 权限、视图与路由</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-4-%E5%A4%9A%E7%BA%A7%E8%AF%84%E8%AE%BA"><span class="toc-text">6.4 多级评论</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-JWT%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81"><span class="toc-text">7. JWT身份认证</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-JWT%E5%BC%95%E5%85%A5"><span class="toc-text">7.1 JWT引入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-%E6%B5%8B%E8%AF%95"><span class="toc-text">7.2 测试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E7%94%A8%E6%88%B7%E7%AE%A1%E7%90%86"><span class="toc-text">8. 用户管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-%E5%BA%8F%E5%88%97%E5%8C%96%E5%99%A8"><span class="toc-text">8.1 序列化器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E6%9D%83%E9%99%90%E3%80%81%E8%A7%86%E5%9B%BE%E4%B8%8E%E8%B7%AF%E7%94%B1"><span class="toc-text">8.2 权限、视图与路由</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-3-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8A%A8%E4%BD%9C"><span class="toc-text">8.3 自定义动作</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-image:url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By 小邹同学</div><div class="framework-info"><span>框架</span> <a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题</span> <a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">你好，欢迎来到<a href="https://xiongbinzou.github.io">小邹同学的Secret Base</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i> <span>数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><script>var preloader={endLoading:()=>{document.body.style.overflow="auto",document.getElementById("loading-box").classList.add("loaded")},initLoading:()=>{document.body.style.overflow="",document.getElementById("loading-box").classList.remove("loaded")}};window.addEventListener("load",preloader.endLoading())</script><div class="js-pjax"><script>if(window.MathJax)MathJax.startup.document.state(0),MathJax.texReset(),MathJax.typeset();else{window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],tags:"ams"},chtml:{scale:1.2},options:{renderActions:{findScript:[10,t=>{for(const e of document.querySelectorAll('script[type^="math/tex"]')){const a=!!e.type.match(/; *mode=display/),n=new t.options.MathItem(e.textContent,t.inputJax[0],a),s=document.createTextNode("");e.parentNode.replaceChild(s,e),n.start={node:s,delim:"",n:0},n.end={node:s,delim:"",n:0},t.math.push(n)}},""],insertScript:[200,()=>{document.querySelectorAll("mjx-container:not([display])").forEach((t=>{const e=t.parentNode;"li"===e.nodeName.toLowerCase()?e.parentNode.classList.add("has-jax"):e.classList.add("has-jax")}))},"",!1]}}};const t=document.createElement("script");t.src="https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js",t.id="MathJax-script",t.async=!0,document.head.appendChild(t)}</script><script>(()=>{const e=document.querySelectorAll("#article-container .mermaid-wrap");if(e.length){window.runMermaid=()=>{window.loadMermaid=!0;const t="dark"===document.documentElement.getAttribute("data-theme")?"dark":"default";Array.from(e).forEach(((e,n)=>{const d=e.firstElementChild,r="mermaid-"+n,i="%%{init:{ 'theme':'"+t+"'}}%%\n"+d.textContent;mermaid.mermaidAPI.render(r,i,(e=>{d.insertAdjacentHTML("afterend",e)}))}))};const t=()=>{window.loadMermaid?runMermaid():getScript("https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js").then(runMermaid)};window.pjax?t():document.addEventListener("DOMContentLoaded",t)}})()</script><script>function loadValine(){function n(){new Valine(Object.assign({el:"#vcomment",appId:"WU7g4I4cNK7LYpz3RJVoz1YV-gzGzoHsz",appKey:"4MHXbgYuTwfEzqQofOeNVquO",avatar:"monsterid",serverURLs:"",emojiMaps:"",path:window.location.pathname,visitor:!1},null))}"function"==typeof Valine?n():getScript("https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js").then(n)}{function loadOtherComment(){loadValine()}setTimeout(loadValine,0)}</script></div><div class="aplayer no-destroy" data-id="5183531430" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listfolded="false" data-order="random" data-preload="none" data-autoplay="false" muted></div><script id="canvas_nest" defer color="0,0,255" opacity="0.7" zindex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!1,POWERMODE.mobile=!1,document.body.addEventListener("input",POWERMODE)</script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,log:!1,model:{jsonPath:"/live2dw/assets/hijiki.model.json"},display:{position:"left",width:150,height:190},mobile:{show:!1},react:{opacity:1}})</script></body></html>