<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>Docker进阶教程学习笔记 | 小邹同学</title><meta name="keywords" content="学习笔记,Docker技术,虚拟化,进阶教程"><meta name="author" content="小邹同学"><meta name="copyright" content="小邹同学"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Docker是一个开源的引擎，可以轻松的为任何应用创建一个轻量级、可移植的、自给自足的容器。笔者在工作中使用过Docker，此文为系统性学习Docker的进阶级笔记。"><meta property="og:type" content="article"><meta property="og:title" content="Docker进阶教程学习笔记"><meta property="og:url" content="https://xiongbinzou.github.io/posts/47611.html"><meta property="og:site_name" content="小邹同学"><meta property="og:description" content="Docker是一个开源的引擎，可以轻松的为任何应用创建一个轻量级、可移植的、自给自足的容器。笔者在工作中使用过Docker，此文为系统性学习Docker的进阶级笔记。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://xiongbinzou.github.io/pics/avatar.jpg"><meta property="article:published_time" content="2022-10-28T13:00:00.000Z"><meta property="article:modified_time" content="2022-11-21T04:58:56.914Z"><meta property="article:author" content="小邹同学"><meta property="article:tag" content="学习笔记"><meta property="article:tag" content="Docker技术"><meta property="article:tag" content="虚拟化"><meta property="article:tag" content="进阶教程"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://xiongbinzou.github.io/pics/avatar.jpg"><link rel="shortcut icon" href="/pics/favicon.png"><link rel="canonical" href="https://xiongbinzou.github.io/posts/47611"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.xml",preload:!1,languages:{hits_empty:"找不到您查询的内容：${query}"}},translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:!1},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"天",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{limitCount:300,languages:{author:"作者: 小邹同学",link:"链接: ",source:"来源: 小邹同学",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},lightbox:"fancybox",Snackbar:{chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#49b1f5",bgDark:"#121212",position:"top-right"},source:{justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js",css:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css"}},isPhotoFigcaption:!0,islazyload:!1,isAnchor:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"Docker进阶教程学习笔记",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2022-11-21 12:58:56"}</script><noscript><style>#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,o){if(0===o)return;const a=864e5*o,c={value:t,expiry:(new Date).getTime()+a};localStorage.setItem(e,JSON.stringify(c))},get:function(e){const t=localStorage.getItem(e);if(!t)return;const o=JSON.parse(t);if(!((new Date).getTime()>o.expiry))return o.value;localStorage.removeItem(e)}},e.getScript=e=>new Promise(((t,o)=>{const a=document.createElement("script");a.src=e,a.async=!0,a.onerror=o,a.onload=a.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)})),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};const t=saveToLocal.get("theme"),o=window.matchMedia("(prefers-color-scheme: dark)").matches,a=window.matchMedia("(prefers-color-scheme: light)").matches,c=window.matchMedia("(prefers-color-scheme: no-preference)").matches,n=!o&&!a&&!c;if(void 0===t){if(a)activateLightMode();else if(o)activateDarkMode();else if(c||n){const e=(new Date).getHours();e<=6||e>=18?activateDarkMode():activateLightMode()}window.matchMedia("(prefers-color-scheme: dark)").addListener((function(e){void 0===saveToLocal.get("theme")&&(e.matches?activateDarkMode():activateLightMode())}))}else"light"===t?activateLightMode():activateDarkMode();const i=saveToLocal.get("aside-status");void 0!==i&&("hide"===i?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside"));/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><meta name="generator" content="Hexo 5.4.2"><style>.github-emoji{position:relative;display:inline-block;width:1.2em;min-height:1.2em;overflow:hidden;vertical-align:top;color:transparent}.github-emoji>span{position:relative;z-index:10}.github-emoji .fancybox,.github-emoji img{margin:0!important;padding:0!important;border:none!important;outline:0!important;text-decoration:none!important;user-select:none!important;cursor:auto!important}.github-emoji img{height:1.2em!important;width:1.2em!important;position:absolute!important;left:50%!important;top:50%!important;transform:translate(-50%,-50%)!important;user-select:none!important;cursor:auto!important}.github-emoji-fallback{color:inherit}.github-emoji-fallback img{opacity:0!important}</style></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/pics/avatar.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">21</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">40</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-graduation-cap"></i> <span>博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-archive"></i> <span>归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-folder-open"></i> <span>分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i> <span>标签</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i> <span>生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/photos/"><i class="fa-fw fa fa-camera-retro"></i> <span>相册</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i> <span>音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i> <span>影视</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fa fa-gamepad"></i> <span>游戏</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i> <span>友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">小邹同学</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i> <span>搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-graduation-cap"></i> <span>博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-archive"></i> <span>归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-folder-open"></i> <span>分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i> <span>标签</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i> <span>生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/photos/"><i class="fa-fw fa fa-camera-retro"></i> <span>相册</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i> <span>音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i> <span>影视</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fa fa-gamepad"></i> <span>游戏</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i> <span>友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Docker进阶教程学习笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-10-28T13:00:00.000Z" title="发表于 2022-10-28 21:00:00">2022-10-28</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-11-21T04:58:56.914Z" title="更新于 2022-11-21 12:58:56">2022-11-21</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/Docker/">Docker</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">10.9k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>50分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="容器数据卷">容器数据卷</h2><h3 id="什么是容器数据卷">什么是容器数据卷</h3><p><strong>Docker的理念回顾</strong></p><p>将应用和环境打包成一个镜像，可以快速部署在不同的平台。</p><p>问题：如果数据都在容器中，那么如果我们删除容器，数据就会丢失！</p><p>需求：数据可持续化，数据可以存储在宿主机。</p><p>引入：容器之间可以有一个数据共享的技术，Docker容器中产生的数据，同步到宿主机，这就是容器数据卷技术。</p><p>总结：将容器内的目录挂载在宿主机上，实现容器数据的持久化和同步操作，容器间的数据共享。</p><p><img src="/posts/47611/image-20221030155110222.png" alt="容器数据卷"></p><h3 id="使用数据卷">使用数据卷</h3><blockquote><p>挂载数据卷方式1：运行容器时直接使用命令 -v来挂载</p></blockquote><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">docker run -it -v 主机目录:容器目录</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试</span></span><br><span class="line">[root@xizou /]# cd /home/</span><br><span class="line">[root@xizou home]# ls</span><br><span class="line">[root@xizou home]# docker run -it -v /home/ceshi:/home centos /bin/bash</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Ctrl +p +q退出容器</span></span><br><span class="line">[root@xizou /]# cd /home/</span><br><span class="line">[root@xizou home]# ls</span><br><span class="line">ceshi</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以通过 docker inspect 容器id 查看容器挂载信息</span></span><br></pre></td></tr></tbody></table></figure><p><img src="/posts/47611/image-20221030160156530.png" alt="双向绑定挂载数据卷"></p><p>测试文件的同步</p><p><img src="/posts/47611/image-20221030161728773.png" alt="数据卷挂载测试"></p><p>就算容器停止，宿主机上修改文件，修改后的文件也能同步到容器内。</p><h3 id="实战：安装MySQL">实战：安装MySQL</h3><p>思考：MySQL的数据持久化的问题</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 获取镜像</span></span><br><span class="line">[root@xizou /]# docker pull mysql:5.7</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 运行容器，需要做数据挂载，安装MySql上需要配置密码，参考Docker Hub的官方指令 docker run --name some-mysql -v /my/custom:/etc/mysql/conf.d -e MYSQL_ROOT_PASSWORD=my-secret-pw -d mysql:tag</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> docker run 命令</span></span><br><span class="line">-d 后台运行</span><br><span class="line">-p 端口映射</span><br><span class="line">-v 卷挂载</span><br><span class="line">-e 环境配置</span><br><span class="line">--name 容器名字</span><br><span class="line"></span><br><span class="line">[root@xizou /]# docker run -d -p 3310:3306 -v /home/mysql/conf:/etc/mysql/conf.d -v /home/mysql/data:/var/lib/mysql -e MYSQL_ROOT_PASSWORD=123456 --name mysql01 mysql:5.7</span><br><span class="line">4dc2e63a55e463168c39249dd4c4cdec2a1d43a1c4fa6f9045da2dd4099fa3a9</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动成功之后，就可以使用 Navicat Premium 或任意数据库连接软件远程连接到容器内的MySQL</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Navicat Premium - 连接到服务器的3310端口 -- 服务器的3310端口与容器内的3306端口映射，因此就能连接到服务器启动的容器内部的MySQL</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 在Navicat Premium创建一个数据库<span class="built_in">test</span>，可以发现服务器/home/mysql/data目录下会多一个<span class="built_in">test</span>目录，并且容器内/var/lib/mysql目录下也会多一个<span class="built_in">test</span>目录</span></span><br></pre></td></tr></tbody></table></figure><p>将容器删除，发现挂载到服务器的数据卷依旧没有丢失，这体现了容器数据持久化功能。</p><h3 id="具名挂载和匿名挂载">具名挂载和匿名挂载</h3><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 匿名挂载</span></span><br><span class="line">-v 容器内路径</span><br><span class="line">[root@xizou /]# docker run -d -P --name nginx01 -v /etc/nginx nginx</span><br><span class="line">e5b3b9b6b45b916a91ab149604bea917995cdea321ba3158be51503010624c90</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看容器卷的情况</span></span><br><span class="line">[root@xizou /]# docker volume ls</span><br><span class="line">DRIVER    VOLUME NAME</span><br><span class="line">local     18ae53d1715fed2dd0250ae1dc8ab0a5a06bd6efcf801f7c46e9ed9bd7ffdd3d</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 这种就是匿名挂载，在 -v 只写了容器内的路径，没有写容器外的路径</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 具名挂载</span></span><br><span class="line">[root@xizou /]# docker run -d -P --name nginx02 -v juming-nginx:/etc/nginx nginx</span><br><span class="line">dbcd1852923d857b825f9afff4429e79c29617e45402ae54e12b8861638c1c7e</span><br><span class="line">[root@xizou /]# docker volume ls</span><br><span class="line">DRIVER    VOLUME NAME</span><br><span class="line">local     18ae53d1715fed2dd0250ae1dc8ab0a5a06bd6efcf801f7c46e9ed9bd7ffdd3d</span><br><span class="line">local     juming-nginx</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过 -v 卷名:容器内路径</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看该卷</span></span><br><span class="line">[root@xizou /]# docker volume inspect juming-nginx</span><br><span class="line">[</span><br><span class="line">    {</span><br><span class="line">        "CreatedAt": "2022-10-30T16:53:03+08:00",</span><br><span class="line">        "Driver": "local",</span><br><span class="line">        "Labels": null,</span><br><span class="line">        "Mountpoint": "/var/lib/docker/volumes/juming-nginx/_data",</span><br><span class="line">        "Name": "juming-nginx",</span><br><span class="line">        "Options": null,</span><br><span class="line">        "Scope": "local"</span><br><span class="line">    }</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">[root@xizou /]# cd /var/lib/docker/volumes/juming-nginx/_data/</span><br><span class="line">[root@xizou _data]# ls</span><br><span class="line">conf.d          mime.types  nginx.conf   uwsgi_params</span><br><span class="line">fastcgi_params  modules     scgi_params</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>所有的Docker容器内的卷，没有指定宿主机目录的情况下都是放在宿主机的 <code>/var/lib/docker/volumes/xxx/_data</code>下。</p><p>通过具名挂载可以方便的找到我们的一个卷，大多数情况下使用<strong>具名挂载</strong>。</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 如何区分具名挂载和匿名挂载</span></span><br><span class="line">-v 容器内路径    # 匿名挂载</span><br><span class="line">-v 卷名:容器内路径  # 具名挂载</span><br><span class="line">-v /宿主机路径:容器内路径  # 指定路径挂载</span><br></pre></td></tr></tbody></table></figure><p><strong>拓展</strong></p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 通过 -v 容器内路径，ro、rw改变读写权限</span></span><br><span class="line">ro    readonly  # 只读</span><br><span class="line">rw    readwrite # 可读可写</span><br><span class="line">docker run -d -P --name nginx02 -v juming-nginx:/etc/nginx:ro nginx</span><br><span class="line">docker run -d -P --name nginx02 -v juming-nginx:/etc/nginx:rw nginx</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ro说明该路径的文件只能通过宿主机来改变，容器内部无法操作</span></span><br></pre></td></tr></tbody></table></figure><h3 id="初始Dockerfile">初始Dockerfile</h3><p>Dockerfile是用来构建Docker镜像的构建文件。</p><blockquote><p>挂载数据卷方式2：Dockerfile文件内定义</p></blockquote><p>如，创建一个dockerfile1文件，内容为：</p><figure class="highlight dockerfile"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># 创建一个dockerfile文件，名字可以随意，建议为Dockerfile</span></span><br><span class="line"><span class="comment"># 文件中的内容 指令(大写) 参数</span></span><br><span class="line"><span class="keyword">FROM</span> centos</span><br><span class="line"></span><br><span class="line"><span class="keyword">VOLUME</span><span class="bash"> [<span class="string">"volume01"</span>, <span class="string">"volume02"</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> <span class="built_in">echo</span> <span class="string">"----end----"</span></span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> /bin/bash</span></span><br></pre></td></tr></tbody></table></figure><p>生成镜像</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">[root@xizou docker-test-volume]# docker build -f dockerfile1 -t xizou/centos:1.0 .</span><br><span class="line">Sending build context to Docker daemon  2.048kB</span><br><span class="line">Step 1/4 : FROM centos</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> 5d0da3dc9764</span></span><br><span class="line">Step 2/4 : VOLUME ["volume01", "volume02"]</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> Running <span class="keyword">in</span> 6cc1bc751006</span></span><br><span class="line">Removing intermediate container 6cc1bc751006</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> f3475e56ea65</span></span><br><span class="line">Step 3/4 : CMD echo "----end----"</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> Running <span class="keyword">in</span> 3eeb578f3d3d</span></span><br><span class="line">Removing intermediate container 3eeb578f3d3d</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> 3db916284cfc</span></span><br><span class="line">Step 4/4 : CMD /bin/bash</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> Running <span class="keyword">in</span> d0b660ad310f</span></span><br><span class="line">Removing intermediate container d0b660ad310f</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> ee034a44e231</span></span><br><span class="line">Successfully built ee034a44e231</span><br><span class="line">Successfully tagged xizou/centos:1.0</span><br><span class="line"></span><br><span class="line">[root@xizou docker-test-volume]# docker images</span><br><span class="line">REPOSITORY            TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">xizou/centos          1.0       ee034a44e231   27 seconds ago   231MB</span><br><span class="line">tomcat02              1.0       600af0d3c7c9   20 hours ago     684MB</span><br><span class="line">elasticsearch         8.4.3     ce2b9dc7fe85   3 weeks ago      1.26GB</span><br><span class="line">nginx                 latest    605c77e624dd   10 months ago    141MB</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 运行容器</span></span><br><span class="line">[root@xizou docker-test-volume]# docker run -it ee034a44e231 /bin/bash</span><br><span class="line">[root@6d21590582da /]# ls -l</span><br><span class="line">total 56</span><br><span class="line">lrwxrwxrwx   1 root root    7 Nov  3  2020 bin -&gt; usr/bin</span><br><span class="line">drwxr-xr-x   5 root root  360 Oct 30 09:23 dev</span><br><span class="line">drwxr-xr-x   1 root root 4096 Oct 30 09:23 etc</span><br><span class="line">drwxr-xr-x   2 root root 4096 Nov  3  2020 home</span><br><span class="line">lrwxrwxrwx   1 root root    7 Nov  3  2020 lib -&gt; usr/lib</span><br><span class="line">lrwxrwxrwx   1 root root    9 Nov  3  2020 lib64 -&gt; usr/lib64</span><br><span class="line">drwx------   2 root root 4096 Sep 15  2021 lost+found</span><br><span class="line">drwxr-xr-x   2 root root 4096 Nov  3  2020 media</span><br><span class="line">drwxr-xr-x   2 root root 4096 Nov  3  2020 mnt</span><br><span class="line">drwxr-xr-x   2 root root 4096 Nov  3  2020 opt</span><br><span class="line">dr-xr-xr-x 130 root root    0 Oct 30 09:23 proc</span><br><span class="line">dr-xr-x---   2 root root 4096 Sep 15  2021 root</span><br><span class="line">drwxr-xr-x  11 root root 4096 Sep 15  2021 run</span><br><span class="line">lrwxrwxrwx   1 root root    8 Nov  3  2020 sbin -&gt; usr/sbin</span><br><span class="line">drwxr-xr-x   2 root root 4096 Nov  3  2020 srv</span><br><span class="line">dr-xr-xr-x  13 root root    0 Oct 30 09:23 sys</span><br><span class="line">drwxrwxrwt   7 root root 4096 Sep 15  2021 tmp</span><br><span class="line">drwxr-xr-x  12 root root 4096 Sep 15  2021 usr</span><br><span class="line">drwxr-xr-x  20 root root 4096 Sep 15  2021 var</span><br><span class="line">drwxr-xr-x   2 root root 4096 Oct 30 09:23 volume01</span><br><span class="line">drwxr-xr-x   2 root root 4096 Oct 30 09:23 volume02</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以看见生成挂载的两个数据卷目录 volume01和volume02</span></span><br></pre></td></tr></tbody></table></figure><p>验证：这个卷和外部一定有一个同步的目录</p><p>在容器的volume01内创建一个container.txt文件</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">[root@09423fb0f1d5 /]# cd volume01/</span><br><span class="line">[root@09423fb0f1d5 volume01]# ls    </span><br><span class="line">[root@09423fb0f1d5 volume01]# touch container.txt</span><br><span class="line">[root@09423fb0f1d5 volume01]# ls</span><br><span class="line">container.txt</span><br></pre></td></tr></tbody></table></figure><p>查看下卷挂载的路径 docker inspect 容器id，如可以看到信息：</p><p><img src="/posts/47611/image-20221030172818939.png" alt="卷挂载路径"></p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">[root@xizou /]# cd /var/lib/docker/volumes/6fc2791f3e981e53c16a71d17d36c8279fda6210956603e69c9f75ccc9c0669c/_data</span><br><span class="line">[root@xizou _data]# ls</span><br><span class="line">container.txt</span><br></pre></td></tr></tbody></table></figure><p>容器间数据共享实现多个MySQL数据同步。</p><p><img src="/posts/47611/image-20221030173514724.png" alt="数据卷容器"></p><p>启动第1个容器docker01</p><p><img src="/posts/47611/image-20221030174028615.png" alt="父容器"></p><p>启动第2个容器docker02，数据卷继承自docker01，docker01成为数据卷容器。</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">docker run -it --name docker02 --volumes-from docker01 xizou/centos:1.0</span><br></pre></td></tr></tbody></table></figure><p>删掉容器docker01，docker02依旧可以访问数据卷。数据卷之间是拷贝的概念。</p><p>多个MySQL实现数据共享</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">[root@xizou /]# docker run -d -p 3310:3306 -v /etc/mysql/conf.d -v /var/lib/mysql -e MYSQL_ROOT_PASSWORD=123456 --name mysql01 mysql:5.7</span><br><span class="line"></span><br><span class="line">[root@xizou /]# docker run -d -p 3311:3306 -e MYSQL_ROOT_PASSWORD=123456 --name mysql02 --volumes-from mysql01 mysql:5.7</span><br></pre></td></tr></tbody></table></figure><p><strong>结论</strong>：</p><p>容器之间配置信息的传递，数据卷容器的生命周期一直持续到没有容器使用为止。</p><p>但是一旦持久化到了本地，本地的数据是不会自动删除的。</p><h2 id="Dockerfile">Dockerfile</h2><h3 id="Dockerfile介绍">Dockerfile介绍</h3><p>Dockerfile是用来构建Docker镜像的文件，是一个命令参数脚本文件。</p><p><strong>构建步骤</strong>：</p><p>1、编写Dockerfile文件</p><p>2、docker build构建为一个镜像</p><p>3、docker run 运行镜像</p><p>4、docker push 发布镜像（Docker Hub、阿里云镜像仓库）</p><p>示例：CentOS7的Dockerfile文件，点击tag可跳转到Github，看到其Dockerfile文件。</p><p><img src="/posts/47611/image-20221030184828837.png" alt="Docker Hub CentOS7界面"></p><p><img src="/posts/47611/image-20221030185422824.png" alt="CentOS7的Dockerfile文件"></p><p>很多官方镜像都是基础包，很多功能没有，通常需要自己搭建自己的镜像。</p><h3 id="Dockerfile构建过程">Dockerfile构建过程</h3><p><strong>基础知识：</strong></p><p>1、每个保留关键字（指令）都必须是大写字母</p><p>2、执行从上到下顺序执行</p><p>3、#表示注释</p><p>4、每一个指令都会创建和提交一个镜像层</p><p><img src="/posts/47611/image-20221030185924855.png" alt="Docker镜像制作"></p><p>Dockerfile是面向开发的，发布项目制作镜像就需要写Dockerfile文件，Docker镜像逐渐成为企业交付的标准，必须掌握。</p><p>Dockerfile：构建文件，定义了一切的步骤，源代码，用来构建镜像。</p><p>Docker镜像：发布和运行的产品，可以通过commit指令或Dockerfile来制作。</p><p>Docker容器：镜像运行起来提供服务的服务器。</p><h3 id="Dockerfile命令">Dockerfile命令</h3><figure class="highlight dockerfile"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span>		 <span class="comment"># 基础镜像，一切从这里开始构建</span></span><br><span class="line"><span class="keyword">MAINTAINER</span>	 <span class="comment"># 镜像是谁写的，姓名+邮箱</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash">			 <span class="comment"># 镜像构建时需要运行的指令</span></span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash">			 <span class="comment"># 步骤，添加内容</span></span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash">		 <span class="comment"># 镜像的工作目录</span></span></span><br><span class="line"><span class="keyword">VOLUME</span><span class="bash">		 <span class="comment"># 挂载的目录</span></span></span><br><span class="line"><span class="keyword">EXPOSE</span>		 <span class="comment"># 暴露端口配置</span></span><br><span class="line"><span class="keyword">CMD</span><span class="bash">			 <span class="comment"># 指定这个容器启动的时候要运行的命令，只有最后一个CMD命令会生效，可被替换</span></span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash">	 <span class="comment"># 指定这个容器启动的时候要运行的命令，可以追加命令</span></span></span><br><span class="line"><span class="keyword">ONBUILD</span>		 <span class="comment"># 当构建一个被继承的Dockerfile时就会运行ONBUILD的指令，触发指令</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash">		 <span class="comment"># 类似ADD，将文件拷贝到镜像中</span></span></span><br><span class="line"><span class="keyword">ENV</span>			 <span class="comment"># 构建的时候设置环境变量</span></span><br></pre></td></tr></tbody></table></figure><p><img src="/posts/47611/image-20221030190914783.png" alt="Dockerfile命令比喻"></p><h3 id="Dockerfile实战">Dockerfile实战</h3><p>Docker Hub 中大部分镜像是从基础镜像 <code>scratch</code> 开始的，然后配置需要的软件来进行构建的。</p><blockquote><p>创建自己的CentOS镜像</p></blockquote><p>CentOS镜像默认的根目录为/，且没有ifconfig</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1. 编写Dockerfile镜像</span></span><br><span class="line">[root@xizou dockerfile]# cat mydockerfile-centos </span><br><span class="line">FROM centos:7</span><br><span class="line">MAINTAINER xizou&lt;xiongbinzou@163.com&gt;</span><br><span class="line"></span><br><span class="line">ENV MYPATH /usr/local</span><br><span class="line">WORKDIR $MYPATH</span><br><span class="line"></span><br><span class="line">RUN yum -y install vim</span><br><span class="line">RUN yum -y install net-tools</span><br><span class="line"></span><br><span class="line">EXPOSE 80</span><br><span class="line"></span><br><span class="line">CMD echo $MYPATH</span><br><span class="line">CMD echo "---end---"</span><br><span class="line">CMD /bin/bash</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2. 通过这个文件构建镜像</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 命令是 docker build -f dockerfile文件路径 -t 镜像名[:tag] .</span></span><br><span class="line">[root@xizou dockerfile]# docker build -f mydockerfile-centos -t centos:0.1 .</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 构建成功</span></span><br><span class="line">.....</span><br><span class="line">Successfully built 0fc60a3f44de</span><br><span class="line">Successfully tagged mycentos:0.1</span><br><span class="line"></span><br><span class="line">[root@xizou dockerfile]# docker images</span><br><span class="line">REPOSITORY            TAG       IMAGE ID       CREATED          SIZE</span><br><span class="line">mycentos              0.1       0fc60a3f44de   2 minutes ago    626MB</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3. 测试运行，发现默认目录变更且ifconfig和vim指令都能够支持</span></span><br><span class="line">[root@xizou ~]# docker run -it mycentos:0.1</span><br><span class="line">[root@c7cad6e52fd3 local]# pwd</span><br><span class="line">/usr/local</span><br><span class="line">[root@c7cad6e52fd3 local]# ifconfig</span><br><span class="line">eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.17.0.3  netmask 255.255.0.0  broadcast 172.17.255.255</span><br><span class="line">        ether 02:42:ac:11:00:03  txqueuelen 0  (Ethernet)</span><br><span class="line">        RX packets 8  bytes 656 (656.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br><span class="line">        inet 127.0.0.1  netmask 255.0.0.0</span><br><span class="line">        loop  txqueuelen 1000  (Local Loopback)</span><br><span class="line">        RX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">        TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">[root@c7cad6e52fd3 local]# vim --help</span><br><span class="line">VIM - Vi IMproved 7.4 (2013 Aug 10, compiled Dec 15 2020 16:44:08)</span><br><span class="line"></span><br><span class="line">usage: vim [arguments] [file ..]       edit specified file(s)</span><br><span class="line">   or: vim [arguments] -               read text from stdin</span><br><span class="line">   or: vim [arguments] -t tag          edit file where tag is defined</span><br><span class="line">   or: vim [arguments] -q [errorfile]  edit file with first error</span><br><span class="line">   </span><br><span class="line"><span class="meta">#</span><span class="bash"> 4. 查看指定image构建历史（先回到宿主机）</span></span><br><span class="line">[root@xizou dockerfile]# docker images</span><br><span class="line">REPOSITORY            TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">mycentos              0.1       0fc60a3f44de   2 hours ago     626MB</span><br><span class="line">xizou/centos          1.0       ee034a44e231   5 hours ago     231MB</span><br><span class="line">tomcat02              1.0       600af0d3c7c9   24 hours ago    684MB</span><br><span class="line"></span><br><span class="line">[root@xizou dockerfile]# docker history 0fc60a3f44de</span><br><span class="line">IMAGE          CREATED         CREATED BY                                      SIZE      COMMENT</span><br><span class="line">0fc60a3f44de   2 hours ago     /bin/sh -c #(nop)  CMD ["/bin/sh" "-c" "/bin…   0B        </span><br><span class="line">87d94a5cd7db   2 hours ago     /bin/sh -c #(nop)  CMD ["/bin/sh" "-c" "echo…   0B        </span><br><span class="line">701f4da62eda   2 hours ago     /bin/sh -c #(nop)  CMD ["/bin/sh" "-c" "echo…   0B        </span><br><span class="line">a28bd4c7b6d4   2 hours ago     /bin/sh -c #(nop)  EXPOSE 80                    0B        </span><br><span class="line">15d49edff70d   2 hours ago     /bin/sh -c yum -y install net-tools             183MB     </span><br><span class="line">565a95d30b44   2 hours ago     /bin/sh -c yum -y install vim                   238MB     </span><br><span class="line">1dda317404d4   2 hours ago     /bin/sh -c #(nop) WORKDIR /usr/local            0B        </span><br><span class="line">ca7984844f10   2 hours ago     /bin/sh -c #(nop)  ENV MYPATH=/usr/local        0B        </span><br><span class="line">6e566e3aace3   2 hours ago     /bin/sh -c #(nop)  MAINTAINER xizou&lt;xiongbin…   0B        </span><br><span class="line">eeb6ee3f44bd   13 months ago   /bin/sh -c #(nop)  CMD ["/bin/bash"]            0B        </span><br><span class="line">&lt;missing&gt;      13 months ago   /bin/sh -c #(nop)  LABEL org.label-schema.sc…   0B        </span><br><span class="line">&lt;missing&gt;      13 months ago   /bin/sh -c #(nop) ADD file:b3ebbe8bd304723d4…   204MB  </span><br></pre></td></tr></tbody></table></figure><p>拿到一个镜像后，可以通过docker history 镜像id查看镜像的构建历史，分析该镜像Dockerfile文件的组成。</p><blockquote><p>CMD和ENREYPOINT的区别</p></blockquote><figure class="highlight dockerfile"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">CMD</span><span class="bash">			 <span class="comment"># 指定这个容器启动的时候要运行的命令，只有最后一个CMD命令会生效，可被替换</span></span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash">	 <span class="comment"># 指定这个容器启动的时候要运行的命令，可以追加命令</span></span></span><br></pre></td></tr></tbody></table></figure><p>测试 CMD 命令</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1.进入文件</span></span><br><span class="line">[root@xizou /]# cd /home/dockerfile/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 2.创建dockerfile</span></span><br><span class="line">[root@xizou dockerfile]# cat dockerfile-cmd-test</span><br><span class="line">FROM centos:7</span><br><span class="line">CMD ["ls","-a"]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 3.构建镜像</span></span><br><span class="line">[root@xizou dockerfile]# docker build -f dockerfile-cmd-test -t cmdtest .</span><br><span class="line">Sending build context to Docker daemon  3.072kB</span><br><span class="line">Step 1/2 : FROM centos:7</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> eeb6ee3f44bd</span></span><br><span class="line">Step 2/2 : CMD ["ls","-a"]</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> Running <span class="keyword">in</span> 850c034e822a</span></span><br><span class="line">Removing intermediate container 850c034e822a</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> 0b3e53a3ddc6</span></span><br><span class="line">Successfully built 0b3e53a3ddc6</span><br><span class="line">Successfully tagged cmdtest:latest</span><br><span class="line"><span class="meta">#</span><span class="bash"> 4.运行，发现 ls -a 命令生效</span></span><br><span class="line">[root@xizou dockerfile]# docker run 0b3e53a3ddc6</span><br><span class="line">.</span><br><span class="line">..</span><br><span class="line">.dockerenv</span><br><span class="line">anaconda-post.log</span><br><span class="line">bin</span><br><span class="line">dev</span><br><span class="line">etc</span><br><span class="line">home</span><br><span class="line">lib</span><br><span class="line">lib64</span><br><span class="line">media</span><br><span class="line">mnt</span><br><span class="line">opt</span><br><span class="line">proc</span><br><span class="line">root</span><br><span class="line">run</span><br><span class="line">sbin</span><br><span class="line">srv</span><br><span class="line">sys</span><br><span class="line">tmp</span><br><span class="line">usr</span><br><span class="line">var</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 想追加一个命令-l，ls -al</span></span><br><span class="line">[root@xizou dockerfile]# docker run 0b3e53a3ddc6 -l</span><br><span class="line">docker: Error response from daemon: failed to create shim task: OCI runtime create failed: runc create failed: unable to start container process: exec: "-l": executable file not found in $PATH: unknown.</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> cmd的清理下 -l 替换了CMD [<span class="string">"ls"</span>,<span class="string">"-a"</span>]命令，-l 不是命令，所以报错</span></span><br></pre></td></tr></tbody></table></figure><p>测试 ENTRYPOINT 命令</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1.进入文件</span></span><br><span class="line">[root@xizou /]# cd /home/dockerfile/</span><br><span class="line"><span class="meta">#</span><span class="bash"> 2.创建dockerfile</span></span><br><span class="line">[root@xizou dockerfile]# cat dockerfile-entrypoint-test</span><br><span class="line">FROM centos:7</span><br><span class="line">ENTRYPOINT ["ls","-a"]</span><br><span class="line"><span class="meta">#</span><span class="bash"> 3.构建镜像</span></span><br><span class="line">[root@xizou dockerfile]# docker build -f dockerfile-entrypoint-test -t entrypointtest .</span><br><span class="line">Sending build context to Docker daemon  4.096kB</span><br><span class="line">Step 1/2 : FROM centos:7</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> eeb6ee3f44bd</span></span><br><span class="line">Step 2/2 : ENTRYPOINT ["ls","-a"]</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> Running <span class="keyword">in</span> 6ebfea05232f</span></span><br><span class="line">Removing intermediate container 6ebfea05232f</span><br><span class="line"><span class="meta"> ---&gt;</span><span class="bash"> 16b996a429de</span></span><br><span class="line">Successfully built 16b996a429de</span><br><span class="line">Successfully tagged entrypointtest:latest</span><br><span class="line"><span class="meta">#</span><span class="bash"> 4.运行，发现 ls -a 命令生效</span></span><br><span class="line">[root@xizou dockerfile]# docker run 16b996a429de</span><br><span class="line">.</span><br><span class="line">..</span><br><span class="line">.dockerenv</span><br><span class="line">anaconda-post.log</span><br><span class="line">bin</span><br><span class="line">dev</span><br><span class="line">etc</span><br><span class="line">home</span><br><span class="line">lib</span><br><span class="line">lib64</span><br><span class="line">media</span><br><span class="line">mnt</span><br><span class="line">opt</span><br><span class="line">proc</span><br><span class="line">root</span><br><span class="line">run</span><br><span class="line">sbin</span><br><span class="line">srv</span><br><span class="line">sys</span><br><span class="line">tmp</span><br><span class="line">usr</span><br><span class="line">var</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 想追加一个命令-l，ls -al，entrypoint没有替换命令，命令是拼接在后面</span></span><br><span class="line">[root@xizou dockerfile]# docker run 16b996a429de -l</span><br><span class="line">total 64</span><br><span class="line">drwxr-xr-x  1 root root  4096 Oct 30 14:21 .</span><br><span class="line">drwxr-xr-x  1 root root  4096 Oct 30 14:21 ..</span><br><span class="line">-rwxr-xr-x  1 root root     0 Oct 30 14:21 .dockerenv</span><br><span class="line">-rw-r--r--  1 root root 12114 Nov 13  2020 anaconda-post.log</span><br><span class="line">lrwxrwxrwx  1 root root     7 Nov 13  2020 bin -&gt; usr/bin</span><br><span class="line">drwxr-xr-x  5 root root   340 Oct 30 14:21 dev</span><br><span class="line">drwxr-xr-x  1 root root  4096 Oct 30 14:21 etc</span><br><span class="line">drwxr-xr-x  2 root root  4096 Apr 11  2018 home</span><br><span class="line">lrwxrwxrwx  1 root root     7 Nov 13  2020 lib -&gt; usr/lib</span><br><span class="line">lrwxrwxrwx  1 root root     9 Nov 13  2020 lib64 -&gt; usr/lib64</span><br><span class="line">drwxr-xr-x  2 root root  4096 Apr 11  2018 media</span><br><span class="line">drwxr-xr-x  2 root root  4096 Apr 11  2018 mnt</span><br><span class="line">drwxr-xr-x  2 root root  4096 Apr 11  2018 opt</span><br><span class="line">dr-xr-xr-x 99 root root     0 Oct 30 14:21 proc</span><br><span class="line">dr-xr-x---  2 root root  4096 Nov 13  2020 root</span><br><span class="line">drwxr-xr-x 11 root root  4096 Nov 13  2020 run</span><br><span class="line">lrwxrwxrwx  1 root root     8 Nov 13  2020 sbin -&gt; usr/sbin</span><br><span class="line">drwxr-xr-x  2 root root  4096 Apr 11  2018 srv</span><br><span class="line">dr-xr-xr-x 13 root root     0 Oct 30 09:23 sys</span><br><span class="line">drwxrwxrwt  7 root root  4096 Nov 13  2020 tmp</span><br><span class="line">drwxr-xr-x 13 root root  4096 Nov 13  2020 usr</span><br><span class="line">drwxr-xr-x 18 root root  4096 Nov 13  2020 var</span><br></pre></td></tr></tbody></table></figure><blockquote><p>创建自己的Tomcat镜像</p></blockquote><p>1、准备镜像文件 tomcat压缩包和jdk压缩包</p><p>本教程使用的是 <code>apache-tomcat-9.0.68.tar.gz</code> 和 <code>jdk-8u161-linux-x64.tar.gz</code>。需要自己本地下载，然后上传到服务器。</p><p>2、编写Dockerfile文件</p><figure class="highlight dockerfile"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> centos:<span class="number">7</span></span><br><span class="line"><span class="keyword">MAINTAINER</span> xizou&lt;xiongbinzou@<span class="number">163</span>.com&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> readme.txt /usr/<span class="built_in">local</span>/readme.txt</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> jdk-8u161-linux-x64.tar.gz /usr/<span class="built_in">local</span>/</span></span><br><span class="line"><span class="keyword">ADD</span><span class="bash"> apache-tomcat-9.0.68.tar.gz /usr/<span class="built_in">local</span>/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> yum -y install vim</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> MYPATH /usr/local</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> <span class="variable">$MYPATH</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> JAVA_HOME /usr/local/jdk1.<span class="number">8.0</span>_161</span><br><span class="line"><span class="keyword">ENV</span> CLASSPATH $JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line"><span class="keyword">ENV</span> CATALINA_HOME /usr/local/apache-tomcat-<span class="number">9.0</span>.<span class="number">68</span></span><br><span class="line"><span class="keyword">ENV</span> CATALINA_BASH /usr/local/apache-tomcat-<span class="number">9.0</span>.<span class="number">68</span></span><br><span class="line"><span class="keyword">ENV</span> PATH $PATH:$JAVA_HOME/bin:$CATALINA_HOME/lib:$CATALINA_HOME/bin</span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> /usr/<span class="built_in">local</span>/apache-tomcat-9.0.68/bin/startup.sh &amp;&amp; tail -F /usr/<span class="built_in">local</span>/apache-tomcat-9.0.68/bin/logs/catalina.out</span></span><br></pre></td></tr></tbody></table></figure><p>3、构建镜像</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">[root@xizou tomcat]# docker build -t diytomcat .</span><br><span class="line">......</span><br><span class="line">Successfully built 1a0b96225372</span><br><span class="line">Successfully tagged diytomcat:latest</span><br><span class="line">[root@xizou tomcat]# docker images</span><br><span class="line">REPOSITORY            TAG       IMAGE ID       CREATED              SIZE</span><br><span class="line">diytomcat             latest    1a0b96225372   About a minute ago   843MB</span><br></pre></td></tr></tbody></table></figure><p>4、运行容器</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 使用自定义的tomcat镜像构建容器</span></span><br><span class="line">[root@xizou tomcat]# docker run -d -p 9090:8080 --name xizoutomcat -v /home/xizou/build/tomcat/test:/usr/local/apache-tomcat-9.0.68/webapps/test -v /home/xizou/build/tomcat/logs/:/usr/local/apache-tomcat-9.0.68/logs diytomcat</span><br><span class="line">3a3378620c68d7619622f4914c801bec41686d4f8caabdcdfe97ca867657b40a</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看当前目录</span></span><br><span class="line">[root@xizou tomcat]# ls</span><br><span class="line">apache-tomcat-9.0.68.tar.gz  logs</span><br><span class="line">Dockerfile                   readme.txt</span><br><span class="line">jdk-8u161-linux-x64.tar.gz   test</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 进入容器</span></span><br><span class="line">[root@xizou tomcat]# docker exec -it 3a3378620c68 /bin/bash</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看目录</span></span><br><span class="line">[root@3a3378620c68 local]# ls</span><br><span class="line">aegis                 etc      jdk1.8.0_161  libexec     share</span><br><span class="line">apache-tomcat-9.0.68  games    lib           readme.txt  src</span><br><span class="line">bin                   include  lib64         sbin</span><br><span class="line">[root@3a3378620c68 local]# cd apache-tomcat-9.0.68/</span><br><span class="line">[root@3a3378620c68 apache-tomcat-9.0.68]# ls</span><br><span class="line">BUILDING.txt     NOTICE         RUNNING.txt  lib   webapps</span><br><span class="line">CONTRIBUTING.md  README.md      bin          logs  work</span><br><span class="line">LICENSE          RELEASE-NOTES  conf         temp</span><br></pre></td></tr></tbody></table></figure><p>5、访问测试</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">[root@xizou /]# curl localhost:9090</span><br><span class="line"><span class="meta">#</span><span class="bash"> 可以正常访问</span></span><br></pre></td></tr></tbody></table></figure><p>6、发布项目（由于做了卷挂载，直接在本地可以发布）</p><p>进入test目录，创建WEB-INF目录和index.jsp，进入WEB-INF目录创建web.xml</p><p>index.jsp:</p><figure class="highlight jsp"><table><tbody><tr><td class="code"><pre><span class="line">&lt;%@ page language=<span class="string">"java"</span> contentType=<span class="string">"text/html; charset=UTF-8"</span></span><br><span class="line">    pageEncoding=<span class="string">"UTF-8"</span>%&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;meta charset=<span class="string">"utf-8"</span>&gt;</span><br><span class="line">&lt;title&gt;小邹同学(xiongbinzou.github.io)&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">Hello World!&lt;br/&gt;</span><br><span class="line">&lt;%</span><br><span class="line">System.out.println(<span class="string">"---Welcome to my blog---"</span>);</span><br><span class="line">%&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></tbody></table></figure><p>web.xml</p><figure class="highlight xml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">"http://xmlns.jcp.org/xml/ns/javaee"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://xmlns.jcp.org/xml/ns/javaee</span></span></span><br><span class="line"><span class="string"><span class="tag">                      http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd"</span> <span class="attr">version</span>=<span class="string">"4.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">display-name</span>&gt;</span>Archetype Created Web Application<span class="tag">&lt;/<span class="name">display-name</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></tbody></table></figure><p>打开浏览器，输入 你的服务器ip地址+端口/test/ ，就能看到Hello World!</p><p><img src="/posts/47611/image-20221031003643740.png" alt="访问成功"></p><h3 id="发布自己的镜像">发布自己的镜像</h3><blockquote><p>发布到DockerHub网站</p></blockquote><p>1、在<a target="_blank" rel="noopener" href="https://hub.docker.com/">DockerHub网站</a>注册自己的账号</p><p>2、确定账号可以登陆</p><p>3、在我们的服务器上提交自己的镜像到DockerHub</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">[root@xizou tomcat]# docker login --help</span><br><span class="line"></span><br><span class="line">Usage:  docker login [OPTIONS] [SERVER]</span><br><span class="line"></span><br><span class="line">Log in to a Docker registry.</span><br><span class="line">If no server is specified, the default is defined by the daemon.</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -p, --password string   Password</span><br><span class="line">      --password-stdin    Take the password from stdin</span><br><span class="line">  -u, --username string   Username</span><br><span class="line">  </span><br><span class="line">[root@xizou tomcat]# docker login -u xizou1995</span><br><span class="line">Password: </span><br><span class="line">WARNING! Your password will be stored unencrypted in /root/.docker/config.json.</span><br><span class="line">Configure a credential helper to remove this warning. See</span><br><span class="line">https://docs.docker.com/engine/reference/commandline/login/#credentials-store</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>4、登陆完毕后</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">Login Succeeded</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> push自己的镜像到服务器上！</span></span><br><span class="line">[root@xizou tomcat]# docker push diytomcat</span><br><span class="line">Using default tag: latest</span><br><span class="line">The push refers to repository [docker.io/library/diytomcat]</span><br><span class="line">5132fa4d71f7: Preparing </span><br><span class="line">61502ae68a5a: Preparing </span><br><span class="line">09ef56b9dc63: Preparing </span><br><span class="line">6d92c54bcf47: Preparing </span><br><span class="line">174f56854903: Preparing </span><br><span class="line">denied: requested access to the resource is denied # 被拒绝</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改镜像名为 Dockerhub上你的用户名/镜像名:tag</span></span><br><span class="line">[root@xizou tomcat]# docker tag hello-world xizou1995/hello-world:1.0</span><br><span class="line">[root@xizou tomcat]# docker push xizou1995/hello-world:1.0</span><br><span class="line">The push refers to repository [docker.io/xizou1995/hello-world]</span><br><span class="line">e07ee1baac5f: Mounted from library/hello-world </span><br><span class="line">1.0: digest: sha256:f54a58bc1aac5ea1a25d796ae155dc228b3f0e11d046ae276b39c4bf2f13d8c4 size: 525</span><br></pre></td></tr></tbody></table></figure><p>5、在DockerHub网站你的页面上可以看到</p><p><img src="/posts/47611/image-20221031010328248.png" alt="Docker镜像库"></p><blockquote><p>发布到阿里云镜像服务上</p></blockquote><p>1、登陆阿里云</p><p>2、找到容器镜像服务</p><p>3、找到镜像仓库，如果没有需要自己创建个人实例，在个人实例里能找到镜像仓库</p><p>4、在个人实例里创建命名空间</p><p><img src="/posts/47611/image-20221031011109470.png" alt="创建命名空间"></p><p>5、创建镜像仓库，选择本地仓库</p><p><img src="/posts/47611/image-20221031011642998.png" alt="创建镜像仓库"></p><p>6、点击仓库名称浏览信息</p><p><img src="/posts/47611/image-20221031011754689.png" alt="阿里云镜像操作指南"></p><h3 id="小结-2">小结</h3><p><img src="/posts/47611/image-20221031013807233.png" alt="Dockerfile操作流程"></p><h2 id="Docker网络原理">Docker网络原理</h2><h3 id="理解Docker0">理解Docker0</h3><p>先清空所有的容器和镜像</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">docker rm -f $(docker ps -aq)</span><br><span class="line">docker rmi -f $(docker images -aq)</span><br></pre></td></tr></tbody></table></figure><blockquote><p>测试</p></blockquote><p><img src="/posts/47611/image-20221031100729238.png" alt="ip addr"></p><p>三个网络</p><p>问题：Docker是如何处理容器网络访问的？比如容器内的tomcat访问容器内的mysql。</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">[root@xizou /]# docker run -d -P --name tomcat01 tomcat</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看容器的内部网络地址 ip addr</span></span><br><span class="line">[root@xizou /]# docker exec -it tomcat ip addr</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果执行失败，进入容器内部安装工具 apt update &amp;&amp; apt -y install iproute2，然后再退出容器</span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">4: eth0@if5: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default </span><br><span class="line">    link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet 172.17.0.2/16 brd 172.17.255.255 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">       </span><br><span class="line"><span class="meta">#</span><span class="bash"> 容器启动时会得到一个 eth0@if5 ip地址，docker分配的</span></span><br><span class="line"></span><br><span class="line">[root@xizou /]# ping 172.17.0.2</span><br><span class="line">PING 172.17.0.2 (172.17.0.2) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.17.0.2: icmp_seq=1 ttl=64 time=0.058 ms</span><br><span class="line">64 bytes from 172.17.0.2: icmp_seq=2 ttl=64 time=0.044 ms</span><br><span class="line">64 bytes from 172.17.0.2: icmp_seq=3 ttl=64 time=0.046 ms</span><br><span class="line">64 bytes from 172.17.0.2: icmp_seq=4 ttl=64 time=0.055 ms</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> linux可以ping通docker容器内部</span></span><br></pre></td></tr></tbody></table></figure><blockquote><p>原理</p></blockquote><p>1、每启动一个docker容器，docker就会给docker容器分配一个ip，只要安装了docker，就会有一个网卡docker0桥接技术，使用的是evth-pair技术</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">[root@xizou /]# ip addr</span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:16:3e:06:ad:10 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.20.179.171/20 brd 172.20.191.255 scope global dynamic eth0</span><br><span class="line">       valid_lft 315327838sec preferred_lft 315327838sec</span><br><span class="line">    inet6 fe80::216:3eff:fe06:ad10/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">3: docker0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default </span><br><span class="line">    link/ether 02:42:46:b8:0a:f8 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::42:46ff:feb8:af8/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">5: veth33d487b@if4: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default </span><br><span class="line">    link/ether 36:f0:95:72:d4:2b brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet6 fe80::34f0:95ff:fe72:d42b/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></tbody></table></figure><p>ip地址多了一个<code>5: veth33d487b@if4</code>，是为容器内网卡对应的网卡。</p><p>发现容器带来的网卡都是成对出现的，一个在容器内部，一个在宿主机，evth-pair技术充当一个桥梁，让宿主机可以与容器内部通信。</p><p>按照相同的方式创建tomcat02容器，然后让tomcat01容器ping tomcat02容器，可以发现能够ping通。</p><p>tomcat01与tomcat02容器网络通过宿主机内的docker0连接。</p><p><img src="/posts/47611/image-20221031104809950.png" alt="tomcat01与tomcat02网络通信示意"></p><p>所有的容器在不指定网络的情况下，都是docker0路由的，docker会给容器分配一个默认的可用IP。</p><blockquote><p>结论</p></blockquote><p>Docker通过宿主机的Docker0进行桥接，Docker中所有的网络接口都是虚拟的，转发效率高。只要容器删除，虚拟网卡也会消失。</p><p><img src="/posts/47611/image-20221031105208672.png" alt="Docker桥接示意"></p><h3 id="–link">–link</h3><blockquote><p>编写一个微服务，database url=ip，项目不启动，数据库ip换掉了，可以通过名字来访问容器，实现高可用。</p></blockquote><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">[root@xizou /]# docker exec -it tomcat02 ping tomcat01</span><br><span class="line">ping: tomcat01: Name or service not known</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 如何解决？</span></span><br><span class="line">[root@xizou /]# docker run -d -P --name tomcat03 --link tomcat02 tomcat</span><br><span class="line">6a603a98a0de2fbe2504b01bfb2b40cab602feffcc9d379c5887f2364e6ff5df</span><br><span class="line"><span class="meta">#</span><span class="bash"> 此时tomcat3可以ping通tomcat02</span></span><br><span class="line">[root@xizou /]# docker exec -it tomcat03 ping tomcat02</span><br><span class="line"><span class="meta">#</span><span class="bash"> 如果提示ping命令不存在，请执行</span></span><br><span class="line">docker exec -it tomcat03 apt-get update</span><br><span class="line">docker exec -it tomcat03 apt install iputils-ping</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> tomcat02能够ping同tomcat03吗？ 不能</span></span><br><span class="line">[root@xizou /]# docker exec -it tomcat02 ping tomcat03</span><br><span class="line">ping: tomcat03: Name or service not known</span><br><span class="line"></span><br><span class="line">[root@xizou /]# docker network ls</span><br><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line">8e9b37aaa9ce   bridge    bridge    local</span><br><span class="line">0673ec2aaa1c   host      host      local</span><br><span class="line">9ba9f05fc241   none      null      local</span><br><span class="line"></span><br><span class="line">[root@xizou /]# docker network inspect 8e9b37aaa9ce</span><br><span class="line">[</span><br><span class="line">    {</span><br><span class="line">        "Name": "bridge",</span><br><span class="line">        "Id": "8e9b37aaa9ce5bb9d88f68daa4f3eea16d1c8cbfe62a127a7e019ef931687391",</span><br><span class="line">        "Created": "2022-10-31T01:31:03.542724354+08:00",</span><br><span class="line">        "Scope": "local",</span><br><span class="line">        "Driver": "bridge",</span><br><span class="line">        "EnableIPv6": false,</span><br><span class="line">        "IPAM": {</span><br><span class="line">            "Driver": "default",</span><br><span class="line">            "Options": null,</span><br><span class="line">            "Config": [</span><br><span class="line">                {</span><br><span class="line">                    "Subnet": "172.17.0.0/16",</span><br><span class="line">                    "Gateway": "172.17.0.1"</span><br><span class="line">                }</span><br><span class="line">            ]</span><br><span class="line">        },</span><br><span class="line">        "Internal": false,</span><br><span class="line">        "Attachable": false,</span><br><span class="line">        "Ingress": false,</span><br><span class="line">        "ConfigFrom": {</span><br><span class="line">            "Network": ""</span><br><span class="line">        },</span><br><span class="line">        "ConfigOnly": false,</span><br><span class="line">        "Containers": {</span><br><span class="line">            "3b8af7fbc37fd2905b411a9e0a3b4bbc57c2685a555aea6482ac7948858a01aa": {</span><br><span class="line">                "Name": "tomcat01",</span><br><span class="line">                "EndpointID": "db565d8188ff9fd69be16c86d193199eed1934b9ae416cdf903a12755b20fbe4",</span><br><span class="line">                "MacAddress": "02:42:ac:11:00:02",</span><br><span class="line">                "IPv4Address": "172.17.0.2/16",</span><br><span class="line">                "IPv6Address": ""</span><br><span class="line">            },</span><br><span class="line">            "6a603a98a0de2fbe2504b01bfb2b40cab602feffcc9d379c5887f2364e6ff5df": {</span><br><span class="line">                "Name": "tomcat03",</span><br><span class="line">                "EndpointID": "40fb946ba46cba96573646ed6374272b1c27c490c1a1c7f14b084ddb9296f1c3",</span><br><span class="line">                "MacAddress": "02:42:ac:11:00:04",</span><br><span class="line">                "IPv4Address": "172.17.0.4/16",</span><br><span class="line">                "IPv6Address": ""</span><br><span class="line">            },</span><br><span class="line">            "92a91f9faa29e067d006ace0b4a1c32245b4521ab71098db1503c78f023e45c6": {</span><br><span class="line">                "Name": "tomcat02",</span><br><span class="line">                "EndpointID": "a0a96ea13aaef24383be2abd638422cfb59cfda4e670ec2a392418d7f96d4c5e",</span><br><span class="line">                "MacAddress": "02:42:ac:11:00:03",</span><br><span class="line">                "IPv4Address": "172.17.0.3/16",</span><br><span class="line">                "IPv6Address": ""</span><br><span class="line">            }</span><br><span class="line">        },</span><br><span class="line">        "Options": {</span><br><span class="line">            "com.docker.network.bridge.default_bridge": "true",</span><br><span class="line">            "com.docker.network.bridge.enable_icc": "true",</span><br><span class="line">            "com.docker.network.bridge.enable_ip_masquerade": "true",</span><br><span class="line">            "com.docker.network.bridge.host_binding_ipv4": "0.0.0.0",</span><br><span class="line">            "com.docker.network.bridge.name": "docker0",</span><br><span class="line">            "com.docker.network.driver.mtu": "1500"</span><br><span class="line">        },</span><br><span class="line">        "Labels": {}</span><br><span class="line">    }</span><br><span class="line">]</span><br></pre></td></tr></tbody></table></figure><p><img src="/posts/47611/image-20221031111104405-16671858903321.png" alt="docker network inspect 8e9b37aaa9ce"></p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">[root@xizou /]# docker ps -a</span><br><span class="line">CONTAINER ID   IMAGE     COMMAND             CREATED             STATUS             PORTS                                         NAMES</span><br><span class="line">6a603a98a0de   tomcat    "catalina.sh run"   6 minutes ago       Up 6 minutes       0.0.0.0:49155-&gt;8080/tcp, :::49155-&gt;8080/tcp   tomcat03</span><br><span class="line">92a91f9faa29   tomcat    "catalina.sh run"   41 minutes ago      Up 41 minutes      0.0.0.0:49154-&gt;8080/tcp, :::49154-&gt;8080/tcp   tomcat02</span><br><span class="line">3b8af7fbc37f   tomcat    "catalina.sh run"   About an hour ago   Up About an hour   0.0.0.0:49153-&gt;8080/tcp, :::49153-&gt;8080/tcp   tomcat01</span><br><span class="line">[root@xizou /]# docker inspect tomcat03</span><br><span class="line"><span class="meta">#</span><span class="bash"> 在HostConfig的Links字段里能看到link到tomcat02，如：</span></span><br><span class="line">"Links": ["/tomcat02:/tomcat03/tomcat02"],</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 也可以查看/etc/hosts文件</span></span><br><span class="line">[root@xizou /]# docker exec -it tomcat03 cat /etc/hosts</span><br><span class="line">127.0.0.1       localhost</span><br><span class="line">::1     localhost ip6-localhost ip6-loopback</span><br><span class="line">fe00::0 ip6-localnet</span><br><span class="line">ff00::0 ip6-mcastprefix</span><br><span class="line">ff02::1 ip6-allnodes</span><br><span class="line">ff02::2 ip6-allrouters</span><br><span class="line">172.17.0.3      tomcat02 92a91f9faa29</span><br><span class="line">172.17.0.4      6a603a98a0de</span><br></pre></td></tr></tbody></table></figure><p>本质：–link 就是在容器tomcat03的hosts配置在中增加了一个tomcat02的映射</p><p>不建议使用–link实现网络映射</p><h3 id="自定义网络">自定义网络</h3><blockquote><p>查看所有的docker网络</p></blockquote><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">[root@xizou /]# docker network ls</span><br><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line">8e9b37aaa9ce   bridge    bridge    local</span><br><span class="line">0673ec2aaa1c   host      host      local</span><br><span class="line">9ba9f05fc241   none      null      local</span><br><span class="line"></span><br><span class="line">[root@xizou /]# docker network --help</span><br><span class="line"></span><br><span class="line">Usage:  docker network COMMAND</span><br><span class="line"></span><br><span class="line">Manage networks</span><br><span class="line"></span><br><span class="line">Commands:</span><br><span class="line">  connect     Connect a container to a network</span><br><span class="line">  create      Create a network</span><br><span class="line">  disconnect  Disconnect a container from a network</span><br><span class="line">  inspect     Display detailed information on one or more networks</span><br><span class="line">  ls          List networks</span><br><span class="line">  prune       Remove all unused networks</span><br><span class="line">  rm          Remove one or more networks</span><br><span class="line"></span><br><span class="line">Run 'docker network COMMAND --help' for more information on a command.</span><br></pre></td></tr></tbody></table></figure><p><strong>网络模式</strong></p><p>bridge：桥接 docker（默认）</p><p>none：不配置网络</p><p>host：和宿主机共享网络</p><p>container：容器网络连通（不常用）</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 直接启动命令 --net bridge，这个就是docker0</span></span><br><span class="line">docker run -d -P --name tomcat01 tomcat</span><br><span class="line">等价于</span><br><span class="line">docker run -d -P --name tomcat01 --net bridge tomcat</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> docker0的特点：默认，域名不能访问。--link可以打通</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建一个自定义网络</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --driver bridge</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --subnet 192.168.0.0/16</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> --gateway 192.168.0.1</span> </span><br><span class="line">[root@xizou /]# docker network create --driver bridge --subnet 192.168.0.0/16 --gateway 192.168.0.1 mynet</span><br><span class="line">8870e01ec415be0a02e181760b6bec5040edb660762903ec3c6dac14ffd368dd</span><br><span class="line"></span><br><span class="line">[root@xizou /]# docker network ls</span><br><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line">8e9b37aaa9ce   bridge    bridge    local</span><br><span class="line">0673ec2aaa1c   host      host      local</span><br><span class="line">8870e01ec415   mynet     bridge    local</span><br><span class="line">9ba9f05fc241   none      null      local</span><br><span class="line"></span><br><span class="line">[root@xizou /]# docker network inspect mynet</span><br><span class="line">[</span><br><span class="line">    {</span><br><span class="line">        "Name": "mynet",</span><br><span class="line">        "Id": "8870e01ec415be0a02e181760b6bec5040edb660762903ec3c6dac14ffd368dd",</span><br><span class="line">        "Created": "2022-10-31T11:31:39.986065834+08:00",</span><br><span class="line">        "Scope": "local",</span><br><span class="line">        "Driver": "bridge",</span><br><span class="line">        "EnableIPv6": false,</span><br><span class="line">        "IPAM": {</span><br><span class="line">            "Driver": "default",</span><br><span class="line">            "Options": {},</span><br><span class="line">            "Config": [</span><br><span class="line">                {</span><br><span class="line">                    "Subnet": "192.168.0.0/16",</span><br><span class="line">                    "Gateway": "192.168.0.1"</span><br><span class="line">                }</span><br><span class="line">            ]</span><br><span class="line">        },</span><br><span class="line">        "Internal": false,</span><br><span class="line">        "Attachable": false,</span><br><span class="line">        "Ingress": false,</span><br><span class="line">        "ConfigFrom": {</span><br><span class="line">            "Network": ""</span><br><span class="line">        },</span><br><span class="line">        "ConfigOnly": false,</span><br><span class="line">        "Containers": {},</span><br><span class="line">        "Options": {},</span><br><span class="line">        "Labels": {}</span><br><span class="line">    }</span><br><span class="line">]</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用自定义网络</span></span><br><span class="line">[root@xizou /]# docker run -d -P --name tomcat01 --net mynet tomcat</span><br><span class="line">5a311d6ef0e2fdd71afc8595de172cd54f7b51cb500f7040aebf562efea4896f</span><br><span class="line">[root@xizou /]# docker run -d -P --name tomcat02 --net mynet tomcat</span><br><span class="line">5459203e0fb8dcf80a79d24ad6dbf07765b0d8103f879c03aef3e20ec806a4a6</span><br><span class="line">[root@xizou /]# docker network inspect mynet</span><br><span class="line">[</span><br><span class="line">    {</span><br><span class="line">        "Name": "mynet",</span><br><span class="line">        "Id": "8870e01ec415be0a02e181760b6bec5040edb660762903ec3c6dac14ffd368dd",</span><br><span class="line">        "Created": "2022-10-31T11:31:39.986065834+08:00",</span><br><span class="line">        "Scope": "local",</span><br><span class="line">        "Driver": "bridge",</span><br><span class="line">        "EnableIPv6": false,</span><br><span class="line">        "IPAM": {</span><br><span class="line">            "Driver": "default",</span><br><span class="line">            "Options": {},</span><br><span class="line">            "Config": [</span><br><span class="line">                {</span><br><span class="line">                    "Subnet": "192.168.0.0/16",</span><br><span class="line">                    "Gateway": "192.168.0.1"</span><br><span class="line">                }</span><br><span class="line">            ]</span><br><span class="line">        },</span><br><span class="line">        "Internal": false,</span><br><span class="line">        "Attachable": false,</span><br><span class="line">        "Ingress": false,</span><br><span class="line">        "ConfigFrom": {</span><br><span class="line">            "Network": ""</span><br><span class="line">        },</span><br><span class="line">        "ConfigOnly": false,</span><br><span class="line">        "Containers": {</span><br><span class="line">            "5459203e0fb8dcf80a79d24ad6dbf07765b0d8103f879c03aef3e20ec806a4a6": {</span><br><span class="line">                "Name": "tomcat02",</span><br><span class="line">                "EndpointID": "ee8fe045e89d3c7c20ee1ea48f1f6fbb6877967fa67e8ccaa69bab2b9ed29694",</span><br><span class="line">                "MacAddress": "02:42:c0:a8:00:03",</span><br><span class="line">                "IPv4Address": "192.168.0.3/16",</span><br><span class="line">                "IPv6Address": ""</span><br><span class="line">            },</span><br><span class="line">            "5a311d6ef0e2fdd71afc8595de172cd54f7b51cb500f7040aebf562efea4896f": {</span><br><span class="line">                "Name": "tomcat01",</span><br><span class="line">                "EndpointID": "30d69fc865bc8020da370fd3a0e810e2f7a4e51f7ecc80a88c8bc1bfe66ce541",</span><br><span class="line">                "MacAddress": "02:42:c0:a8:00:02",</span><br><span class="line">                "IPv4Address": "192.168.0.2/16",</span><br><span class="line">                "IPv6Address": ""</span><br><span class="line">            }</span><br><span class="line">        },</span><br><span class="line">        "Options": {},</span><br><span class="line">        "Labels": {}</span><br><span class="line">    }</span><br><span class="line">]</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 再次测试ping连接，使用ip和使用容器名都可以ping成功</span></span><br><span class="line">[root@xizou ~]# docker exec -it tomcat01 ping tomcat02</span><br><span class="line">PING tomcat02 (192.168.0.3) 56(84) bytes of data.</span><br><span class="line">64 bytes from tomcat02.mynet (192.168.0.3): icmp_seq=1 ttl=64 time=0.047 ms</span><br><span class="line">64 bytes from tomcat02.mynet (192.168.0.3): icmp_seq=2 ttl=64 time=0.062 ms</span><br><span class="line">64 bytes from tomcat02.mynet (192.168.0.3): icmp_seq=3 ttl=64 time=0.042 ms</span><br></pre></td></tr></tbody></table></figure><p>自定义网络的docker都已经维护好了对应的关系，推荐平时使用这样的网络</p><p>好处：不同的集群使用不同的网络，保证集群是安全和健康的。</p><h3 id="网络连通">网络连通</h3><p><img src="/posts/47611/image-20221031125301011.png" alt="网络连通"></p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">[root@xizou ~]# docker network connect --help</span><br><span class="line"></span><br><span class="line">Usage:  docker network connect [OPTIONS] NETWORK CONTAINER</span><br><span class="line"></span><br><span class="line">Connect a container to a network</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">      --alias strings           Add network-scoped alias</span><br><span class="line">                                for the container</span><br><span class="line">      --driver-opt strings      driver options for the network</span><br><span class="line">      --ip string               IPv4 address (e.g.,</span><br><span class="line">                                172.30.100.104)</span><br><span class="line">      --ip6 string              IPv6 address (e.g.,</span><br><span class="line">                                2001:db8::33)</span><br><span class="line">      --link list               Add link to another container</span><br><span class="line">      --link-local-ip strings   Add a link-local address</span><br><span class="line">                                for the container</span><br></pre></td></tr></tbody></table></figure><p>让使用Docker0作为桥接的容器和使用自定义网络mynet作为桥接的容器连通。</p><p>假设：</p><p>使用Docker0作为桥接的容器有：tomcat01、tomcat02</p><p>使用自定义网络mynet作为桥接的容器有：tomcat-net-01、tomcat-net-02</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">[root@xizou /]# docker network connect mynet tomcat01</span><br><span class="line">[root@xizou /]# docker network inspect mynet</span><br><span class="line">可以发现Containes字段里多了tomcat01</span><br><span class="line">[root@xizou /]# docker exec -it tomcat01 ping tomcat-net-01</span><br></pre></td></tr></tbody></table></figure><h3 id="实战：Redis集群">实战：Redis集群</h3><p><img src="/posts/47611/image-20221031130410644.png" alt="Redis集群"></p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建网卡</span></span><br><span class="line">docker network create redis --subnet 172.38.0.0/16</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 通过脚本创建6个redis配置</span></span><br><span class="line">for port in $(seq 1 6); \</span><br><span class="line">do \</span><br><span class="line">mkdir -p /mydata/redis/node-${port}/conf</span><br><span class="line">touch /mydata/redis/node-${port}/conf/redis.conf</span><br><span class="line">cat &lt;&lt; EOF &gt;/mydata/redis/node-${port}/conf/redis.conf</span><br><span class="line">port 6379</span><br><span class="line">bind 0.0.0.0</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line">cluster-announce-ip 172.38.0.1${port}</span><br><span class="line">cluster-announce-port 6379</span><br><span class="line">cluster-announce-bus-port 16379</span><br><span class="line">appendonly yes</span><br><span class="line">EOF</span><br><span class="line">done</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 启动docker</span></span><br><span class="line">docker run -p 6371:6379 -p 16371:16739 --name redis-1 -v /mydate/redis/node-1/data:/data -v /mydate/redis/node-1/conf/redis.conf:/etc/redis/redis.conf -d --net redis --ip 172.38.0.11 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf</span><br><span class="line"></span><br><span class="line">docker run -p 6372:6379 -p 16372:16739 --name redis-2 -v /mydate/redis/node-2/data:/data -v /mydate/redis/node-2/conf/redis.conf:/etc/redis/redis.conf -d --net redis --ip 172.38.0.12 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf</span><br><span class="line"></span><br><span class="line">docker run -p 6373:6379 -p 16373:16739 --name redis-3 -v /mydate/redis/node-3/data:/data -v /mydate/redis/node-3/conf/redis.conf:/etc/redis/redis.conf -d --net redis --ip 172.38.0.13 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf</span><br><span class="line"></span><br><span class="line">docker run -p 6374:6379 -p 16374:16739 --name redis-4 -v /mydate/redis/node-4/data:/data -v /mydate/redis/node-4/conf/redis.conf:/etc/redis/redis.conf -d --net redis --ip 172.38.0.14 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf</span><br><span class="line"></span><br><span class="line">docker run -p 6375:6379 -p 16375:16739 --name redis-5 -v /mydate/redis/node-5/data:/data -v /mydate/redis/node-5/conf/redis.conf:/etc/redis/redis.conf -d --net redis --ip 172.38.0.15 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf</span><br><span class="line"></span><br><span class="line">docker run -p 6376:6379 -p 16376:16739 --name redis-6 -v /mydate/redis/node-6data:/data -v /mydate/redis/node-6/conf/redis.conf:/etc/redis/redis.conf -d --net redis --ip 172.38.0.16 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 进入任一个容器内</span></span><br><span class="line">docker exec -it redis-1 /bin/sh</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建集群</span></span><br><span class="line">/data # redis-cli --cluster create 172.38.0.11:6379 172.38.0.12:6379 172.38.0.13:6379 172.38.0.14:6379 172.38.0.15:6379 172.38.0.16:6379 --cluster-replicas 1</span><br><span class="line">/data # redis-cli -c</span><br><span class="line">127.0.0.1:6379&gt; cluster info</span><br><span class="line">观察发现已经创建了6个redis服务，其中3个主机，3个从机，主机的数据会同步到对应的从机，主机挂掉后，从机会替代挂掉的主机工作</span><br></pre></td></tr></tbody></table></figure><h3 id="实战：SpringBoot微服务打包成Docker镜像">实战：SpringBoot微服务打包成Docker镜像</h3><p><strong>步骤：</strong></p><p>1、构建SpringBoot项目</p><p>2、打包应用</p><p>3、编写Dockerfile</p><figure class="highlight dockerfile"><table><tbody><tr><td class="code"><pre><span class="line"><span class="keyword">FROM</span> java:<span class="number">8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">MAINTAINER</span> xizou&lt;xiongbinzou@<span class="number">163</span>.com&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> *.jar /app.jar</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"--server.port=8080"</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"java"</span>, <span class="string">"-jar"</span>, <span class="string">"/app.jar"</span>]</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>4、构建镜像</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">docker build -t helloworld .</span><br><span class="line">docker images</span><br><span class="line">docker run -d -P --name helloworld-web helloword</span><br><span class="line">curl localhost:32779</span><br></pre></td></tr></tbody></table></figure><p>5、发布运行</p><h2 id="扩展">扩展</h2><h3 id="什么是容器编排">什么是容器编排</h3><p><strong>问题</strong>：将应用程序打包到了Docker容器中后，如何在生产环境中运行它，如果应用程序有依赖于其他容器，如数据库、消息服务或其他后端服务容器，该怎么办？如果用户数量增加并且你需要扩展你的应用程序怎么办？如果要缩小规模减少负载该怎么做？</p><p><strong>思考</strong>：需要有一个具有一组资源和功能的底层平台，这个平台能够统筹容器之间的连接，并且根据负载可自动扩展或缩减容器。</p><p><strong>方案</strong>：这种自动部署和管理容器的整个过程称为<strong>容器编排</strong>，Docker有自己的容器编排工具，叫做Docker Swarm，但是缺少复杂应用程序所需的一些高级功能，MESOS也是一种容器编排技术，虽然支持许多高级功能，但是很难设置和上手。Kubernets是一种容器编排技术，设置和入门有点困难，提供了许多自定义部署的选项和支持复杂架构的部署，目前所有的公有云服务供应商都支持了Kubernetes。</p><p><strong>容器编排</strong>的优势：</p><ul><li><strong>应用程序高可用</strong>。硬件故障不会导致应用程序停机，因为容器编排技术使我们在不同节点上运行了应用程序的多个实例。</li><li><strong>用户流量在容器间负载均衡</strong>。</li><li><strong>需求增加时，可轻松、快速部署更多应用程序实例</strong>。</li></ul><p><img src="/posts/47611/image-20221101233701289.png" alt="容器编排"></p><p>Kubernetes是一种容器编排技术，用于编排数百个应用程序的部署和管理。</p><h3 id="Kubernetes架构">Kubernetes架构</h3><p>在设置Kubernetes集群前，先介绍一些Kubernetes的术语。</p><p><strong>节点Nodes</strong>：节点是安装了Kubernetes的物理或虚拟机器，节点是工作机器，是Kubernetes将容器启动的地方。过去也叫Minions。</p><img src="/posts/47611/image-20221102002124876.png" alt="节点Node" style="zoom:33%"><p><strong>集群Cluster</strong>：集群是一组组合在一起的节点，即使一个节点发生故障，依然可以从其他节点访问你的应用程序，此外节点也有助于分担负载，</p><img src="/posts/47611/image-20221102002510040.png" alt="集群Cluster" style="zoom:33%"><p><strong>Master</strong>：Master是另一个安装了Kubernetes的节点，被配置为Master，负责监视集群中的节点并负责工作节点上容器的编排，存储着集群成员的信息。当一个节点发生故障时，Master负责将节点的工作负载转移到另一个工作节点。</p><img src="/posts/47611/image-20221102004639106.png" alt="Master" style="zoom:33%"><p><strong>Kubernetes</strong>：在系统上安装Kubernetes时，实际上是在安装以下组件</p><ul><li><strong>API Server</strong>：充当Kubernetes的前端，包括用户、管理设备、命令行界面、从API服务器到Kubernets集群。</li><li><strong>etcd</strong>：是Kubernetes使用可靠键值来存储用于管理集群的所有数据，当集群中有多个节点和多个Master时，etcd会以分布式的方式在集群的所有节点上存储着所有这些信息。etcd负责在集群内实现锁，以确保Master之间不存在冲突。</li><li><strong>Scheduler</strong>：负责跨多个节点分发工作或容器，它查找新创建的容器并将它们分配给节点。</li><li><strong>Controller</strong>：是编排背后的大脑，它负责在节点、容器或端点出现故障时进行统通知和响应，负责决定在这种情况下启动新容器。</li><li><strong>Container Runtime</strong>：是运行容器的底层软件，如Docker。</li><li><strong>Kubelet</strong>：是在集群中每个节点上运行的代理，负责保证容器按预期在节点上运行。</li></ul><p><strong>Pod</strong>：Kubernetes不直接在工作节点上部署容器，容器封装进而成为Pod的Kubernetes对象，Pod是应用程序的单个实例，Pod是你可以在Kubernetes创建的最小对象。</p><p><img src="/posts/47611/image-20221102020138628.png" alt="POD"></p><p><img src="/posts/47611/image-20221102020313836.png" alt="Kubernetes容器编排"></p><p><strong>Pod</strong> 是可以在 Kubernetes 中创建和管理的、最小的可部署的计算单元。</p><p><strong>Pod</strong>（就像在鲸鱼荚或者豌豆荚中）是一组（一个或多个）容器； 这些容器共享存储、网络、以及怎样运行这些容器的声明。 Pod 中的内容总是并置（colocated）的并且一同调度，在共享的上下文中运行。</p><p>POD定义文件：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">appVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">        <span class="attr">type:</span> <span class="string">front-end</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nigix-container</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl create -f pod-definition.yml</span></span><br><span class="line"><span class="comment"># kubectl get pods</span></span><br></pre></td></tr></tbody></table></figure><p><strong>Replica Set</strong>：ReplicaSet 的目的是维护一组在任何时候都处于运行状态的 Pod 副本的稳定集合。 因此，它通常用来保证给定数量的、完全相同的 Pod 的可用性。ReplicaSet 是通过一组字段来定义的，包括一个用来识别可获得的 Pod 的集合的选择算符、一个用来标明应该维护的副本个数的数值、一个用来指定应该创建新 Pod 以满足副本个数条件时要使用的 Pod 模板等等。 每个 ReplicaSet 都通过根据需要创建和删除 Pod 以使得副本个数达到期望值， 进而实现其存在价值。当 ReplicaSet 需要创建新的 Pod 时，会使用所提供的 Pod 模板。</p><p>ReplicaSet 定义文件：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ReplicaSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-replicaset</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">front-end</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">      <span class="attr">metadata:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">myapp-pod</span></span><br><span class="line">        <span class="attr">labels:</span></span><br><span class="line">            <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">front-end</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">containers:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-container</span></span><br><span class="line">            <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">      <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">front-end</span></span><br><span class="line">          </span><br><span class="line"><span class="comment"># kubectl create -f replicaset-definition.yml</span></span><br><span class="line"><span class="comment"># kubectl get replicaset</span></span><br><span class="line"><span class="comment"># kubectl get pods</span></span><br></pre></td></tr></tbody></table></figure><p><strong>Deployment</strong>：Deployment 是一个更高级的概念，它管理 ReplicaSet，并向 Pod 提供声明式的更新以及许多其他有用的功能。 因此，我们建议使用 Deployment 而不是直接使用 ReplicaSet， 除非你需要自定义更新业务流程或根本不需要更新。</p><p>你负责描述 Deployment 中的目标状态，而 Deployment控制器（Controller）以受控速率更改实际状态， 使其变为期望状态。你可以定义 Deployment 以创建新的 ReplicaSet，或删除现有 Deployment， 并通过新的 Deployment 更新其资源。</p><p>应用：</p><p>1.当你有一个需要部署在生产环境中的Web服务器，你需要运行的不是一个而是多个Web服务器实例</p><p>2.每当应用程序需要更新版本时，你需要无缝升级Docker实例，但是当你升级实例时，不希望一次升级所有实例，因为会影响正在访问你应用程序的用户，因此你希望一个接一个升级他们，这种升级称为滚动更新。</p><p>3.当你执行的升级之一导致了意外错误，并且你被要求撤销最近的更改，你希望能够回滚最近执行的更改。</p><p>4.当对环境进行多项更改，例如升级底层Web服务器版本以及扩展你的环境并修改资源等，你不想在命令运行后立即应用每个更改，而是希望暂停应用进行更改，然后恢复，以便一起推出所有更改。</p><p>Deployment定义文件：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">front-end</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">myapp-pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx-container</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">      <span class="attr">matchLabels:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">front-end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl create -f deployment-definition.yml</span></span><br><span class="line"><span class="comment"># kubectl get deployments</span></span><br><span class="line"><span class="comment"># kubectl get replicaset</span></span><br><span class="line"><span class="comment"># kubectl get pods</span></span><br><span class="line"><span class="comment"># kubectl get all</span></span><br></pre></td></tr></tbody></table></figure><p><strong>POD、Replica Set、Deployment关系</strong></p><p><img src="/posts/47611/image-20221102143342986.png" alt="POD、Replica Set、Deployment关系"></p><p>工作节点拥有Container Runtime、Kubelet</p><p>Master节点拥有API Server、etcd、Controller、Scheduler</p><p><img src="/posts/47611/image-20221102010926832.png" alt="Master VS Worker Nodes"></p><p><strong>Kubernetes网络设置</strong></p><p>IP地址指定给POD：</p><img src="/posts/47611/image-20221102164749931.png" alt="IP地址指定给POD" style="zoom:50%"><p>Kubernetes网络需求：</p><ul><li>Pod 能够与所有其他节点上的 Pod 通信， 且不需要网络地址转译（NAT）</li><li>节点上的代理（比如：系统守护进程、kubelet）可以和节点上的所有 Pod 通信</li></ul><img src="/posts/47611/image-20221102170611783.png" alt="Kubernetes网络模型解决方案之一" style="zoom:80%"><p><strong>Kubernetes服务类型</strong></p><ul><li><strong>NodePort Server</strong></li></ul><img src="/posts/47611/image-20221102171636882.png" alt="NodePort Server" style="zoom:50%"> <img src="/posts/47611/image-20221102172918003.png" alt="NodePort Server-多个Pods" style="zoom:50%"> <img src="/posts/47611/image-20221102173055489.png" alt="NodePort Server-多个Nodes" style="zoom:80%"><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30008</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">front-end</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># kubectl create -f service-definition.yml</span></span><br><span class="line"><span class="comment"># kubectl get services</span></span><br></pre></td></tr></tbody></table></figure><p>外部执行指令http://192.168.1.2:30008即可以访问节点里POD应用</p><ul><li><strong>ClusterIP Server</strong></li></ul><img src="/posts/47611/image-20221102173713245.png" alt="ClusterIP Server" style="zoom:50%"><p>为每种应用服务创建一个单独的Service，这个Service可定义提供相同应当服务节点的网络地址、端口配置。</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">back-end</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myapp</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">back-end</span></span><br><span class="line">   </span><br><span class="line"><span class="comment"># kubectl create -f service-definition.yml</span></span><br><span class="line"><span class="comment"># kubectl get services</span></span><br></pre></td></tr></tbody></table></figure><ul><li><strong>LoadBalancer Server</strong></li></ul><p><img src="/posts/47611/image-20221102175051051.png" alt="LoadBalancer Server"></p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myapp-service</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">LoadBalancer</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30008</span></span><br><span class="line">      </span><br><span class="line"><span class="comment"># kubectl create -f service-definition.yml</span></span><br><span class="line"><span class="comment"># kubectl search sevices</span></span><br></pre></td></tr></tbody></table></figure><h3 id="kubectl工具">kubectl工具</h3><p>kubectl工具在Kubernetes集群上部署和管理应用程序，获取集群信息，获取集群中其他节点的状态并管理许多其他事情。</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">kubectl run hello-minikube  # 在集群上部署应用程序</span><br><span class="line">kubectl cluster-info  # 查看集群信息</span><br><span class="line">kubectl get nodes  # 用于列出集群的所有节点部分</span><br></pre></td></tr></tbody></table></figure><p><strong>可以通过<a target="_blank" rel="noopener" href="https://minikube.sigs.k8s.io/docs/start/">Minicube</a>项目体验kubernetes的部署与应用。</strong></p><h3 id="实战：Kubernetes部署投票应用">实战：Kubernetes部署投票应用</h3><p><img src="/posts/47611/image-20221102180743427.png" alt="投票应用"></p><p>解释：</p><ul><li><p>voting-app: 前端页面，用户通过该页面进行投票，python</p></li><li><p>redis：数据库，用户的投票数据暂存在内存的redis里，redis</p></li><li><p>worker：从redis里读取用户投票数据，统计计算后存入持久性数据库，.Net</p></li><li><p>postgress：数据库，持久化存储用户的投票数据跟统计结果，postgress</p></li><li><p>result-app: 前端页面，显示投票统计数据，Javascript</p></li></ul><p>部署的目标</p><p>1、运行容器</p><p>2、容器间的连通</p><p>3、外部访问</p><p><strong>解决方案1</strong>（不使用Deployment，不建议）：</p><p><img src="/posts/47611/image-20221102181935376.png" alt="投票应用解决方案1"></p><p>voting-app-pod.yaml</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">voting-app-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">voting-app-pod</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">voting-app</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">kodekcloud/examplevotingapp_vote:v1</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></tbody></table></figure><p>result-app-pod.yaml</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">result-app-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">result-app-pod</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">result-app</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">kodekcloud/examplevotingapp_result:v1</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></tbody></table></figure><p>redis-pod.yaml</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">redis-pod</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">6379</span></span><br></pre></td></tr></tbody></table></figure><p>postgres-pod.yaml</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgres-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">postgres-pod</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">postgres</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">postgres</span></span><br><span class="line">      <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">5432</span></span><br><span class="line">      <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_USER</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"postgres"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_PASSWORD</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">"postgres"</span></span><br></pre></td></tr></tbody></table></figure><p>worker-app-pod.yaml</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">worker-app-pod</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">worker-app-pod</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">worker-app</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">kodekcloud/examplevotingapp_worker:v1</span></span><br></pre></td></tr></tbody></table></figure><p>redis-service.yaml</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">redis-service</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">6379</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">redis-pod</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br></pre></td></tr></tbody></table></figure><p>postgres-service.yaml</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">db</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">postgres-service</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">5432</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">5432</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">postgres-pod</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br></pre></td></tr></tbody></table></figure><p>voting-app-service.yaml</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">voting-service</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">voting-service</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30004</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">voting-app-pod</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br></pre></td></tr></tbody></table></figure><p>result-app-service.yaml</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">result-service</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">result-service</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30005</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">result-app-pod</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br></pre></td></tr></tbody></table></figure><p>将上面所有文件放入voting-app文件夹下</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">cd voting-app</span><br><span class="line">kubectl get pods,svc</span><br><span class="line">kuberctl create -f voting-app-pod.yaml</span><br><span class="line">kuberctl create -f voting-app-service.yaml</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看投票服务的url</span></span><br><span class="line">minikube service voting-service --url</span><br><span class="line">kuberctl create -f redis-pod.yaml</span><br><span class="line">kuberctl create -f redis-service.yaml</span><br><span class="line">kubectl get pods,svc</span><br><span class="line">kuberctl create -f postgres-pod.yaml</span><br><span class="line">kuberctl create -f postgres-service.yaml</span><br><span class="line">kubectl get pods,svc</span><br><span class="line">kuberctl create -f worker-app-pod.yaml</span><br><span class="line">kubectl get pods,svc</span><br><span class="line">kuberctl create -f result-app-pod.yaml</span><br><span class="line">kuberctl create -f result-app-service.yaml</span><br><span class="line">kubectl get pods,svc</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看投票结果服务的url</span></span><br><span class="line">minikube service voting-service --url</span><br></pre></td></tr></tbody></table></figure><p><strong>解决方案2</strong>（使用Deployment）</p><p><img src="/posts/47611/image-20221102184937776.png" alt="投票应用解决方案2"></p><p>voting-app-deployment.yaml</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">voting-app-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">voting-app-deployment</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">voting-app-pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">voting-app-pod</span></span><br><span class="line">          <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">voting-app</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">kodekcloud/examplevotingapp_vote:v1</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">voting-app-pod</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br></pre></td></tr></tbody></table></figure><p>redis-deployment.yaml</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">redis-deployment</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">postgres-pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">postgres-pod</span></span><br><span class="line">          <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">postgres</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">postgres</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">5432</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_USER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"postgres"</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">POSTGRES_PASSWORD</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">"postgres"</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">redis-pod</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br></pre></td></tr></tbody></table></figure><p>postgress-deployment.yaml</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">postgres-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">postgres-deployment</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">redis-pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">redis-pod</span></span><br><span class="line">          <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">redis</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">6379</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">postgres-pod</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br></pre></td></tr></tbody></table></figure><p>worker-deployment.yaml</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">worker-app-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">worker-app-deployment</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">worker-app-pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">worker-app-pod</span></span><br><span class="line">          <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">worker-app</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">kodekcloud/examplevotingapp_worker:v1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">worker-app-pod</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br></pre></td></tr></tbody></table></figure><p>result-app-deployment.yaml</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">result-app-deployment</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">result-app-deployment</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">voting-app-pod</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">voting-app-pod</span></span><br><span class="line">          <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">voting-app</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">kodekcloud/examplevotingapp_result:v1</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">result-app-pod</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">demo-voting-app</span></span><br></pre></td></tr></tbody></table></figure><p>确保所有文件放入voting-app文件夹下，包括方案1的文件</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">cd voting-app</span><br><span class="line">kubectl get pods,svc</span><br><span class="line">kuberctl create -f voting-app-deployment.yaml</span><br><span class="line">kuberctl create -f voting-app-service.yaml</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看投票服务的url</span></span><br><span class="line">minikube service voting-service --url</span><br><span class="line">kuberctl create -f redis-deployment.yaml</span><br><span class="line">kuberctl create -f redis-service.yaml</span><br><span class="line">kubectl get deployments</span><br><span class="line">kuberctl create -f postgres-deployment.yaml</span><br><span class="line">kuberctl create -f postgres-service.yaml</span><br><span class="line">kubectl get deployments</span><br><span class="line">kuberctl create -f worker-app-deployment.yaml</span><br><span class="line">kubectl get deployments</span><br><span class="line">kuberctl create -f result-app-deployment.yaml</span><br><span class="line">kuberctl create -f result-app-service.yaml</span><br><span class="line">kubectl get deployments,svc</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看投票结果服务的url</span></span><br><span class="line">minikube service voting-service --url</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改投票和结果服务的集群为3</span></span><br><span class="line">kubectl scale deployment voting-app-deployment --replicas=3</span><br><span class="line">kubectl scale deployment result-app-deployment --replicas=3</span><br></pre></td></tr></tbody></table></figure><h3 id="为什么Podman比Docker更安全">为什么Podman比Docker更安全</h3><p>Docker必须由root用户启动一个守护进程才能使用<code>systemctl start docker</code>，其次，普通用户需要加入容器组，才能够运行和启动Docker，如此会存在一些安全问题，如普通用户可以通过容器进行提权。</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看docker版本</span></span><br><span class="line">[root@xizou /]# docker --version</span><br><span class="line">Docker version 20.10.21, build baeda1f</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> root用户启动docker服务进程</span></span><br><span class="line">[root@xizou /]# systemctl start docker</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看docker服务状态</span></span><br><span class="line">[root@xizou /]# systemctl status docker</span><br><span class="line">● docker.service - Docker Application Container Engine</span><br><span class="line">   Loaded: loaded (/usr/lib/systemd/system/docker.service; disabled; vendor preset: disabled)</span><br><span class="line">   Active: active (running) since Wed 2022-11-02 12:24:26 CST; 47s ago</span><br><span class="line">     Docs: https://docs.docker.com</span><br><span class="line"> Main PID: 31905 (dockerd)</span><br><span class="line">    Tasks: 7</span><br><span class="line">   Memory: 27.9M</span><br><span class="line">   CGroup: /system.slice/docker.service</span><br><span class="line">           └─31905 /usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</span><br><span class="line"></span><br><span class="line">Nov 02 12:24:26 xizou dockerd[31905]: time="2022-11-02T12:24:26.199751948+08:00" level=info m...ing"</span><br><span class="line">Nov 02 12:24:26 xizou dockerd[31905]: time="2022-11-02T12:24:26.431287299+08:00" level=info m...ing"</span><br><span class="line">Nov 02 12:24:26 xizou dockerd[31905]: time="2022-11-02T12:24:26.475634500+08:00" level=info m...ing"</span><br><span class="line">Nov 02 12:24:26 xizou dockerd[31905]: time="2022-11-02T12:24:26.676136067+08:00" level=info m...ess"</span><br><span class="line">Nov 02 12:24:26 xizou dockerd[31905]: time="2022-11-02T12:24:26.778914793+08:00" level=info m...ing"</span><br><span class="line">Nov 02 12:24:26 xizou dockerd[31905]: time="2022-11-02T12:24:26.891111549+08:00" level=info m...ne."</span><br><span class="line">Nov 02 12:24:26 xizou dockerd[31905]: time="2022-11-02T12:24:26.907790255+08:00" level=info m...0.21</span><br><span class="line">Nov 02 12:24:26 xizou dockerd[31905]: time="2022-11-02T12:24:26.907847502+08:00" level=info m...ion"</span><br><span class="line">Nov 02 12:24:26 xizou systemd[1]: Started Docker Application Container Engine.</span><br><span class="line">Nov 02 12:24:26 xizou dockerd[31905]: time="2022-11-02T12:24:26.924507836+08:00" level=info m...ock"</span><br><span class="line">Hint: Some lines were ellipsized, use -l to show in full.</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看当前所有镜像</span></span><br><span class="line">[root@xizou /]# docker images -a</span><br><span class="line">REPOSITORY   TAG       IMAGE ID   CREATED   SIZE</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载镜像</span></span><br><span class="line">[root@xizou /]# docker pull centos</span><br><span class="line">Using default tag: latest</span><br><span class="line">latest: Pulling from library/centos</span><br><span class="line">a1d0c7532777: Pull complete </span><br><span class="line">Digest: sha256:a27fd8080b517143cbbbab9dfb7c8571c40d67d534bbdee55bd6c473f432b177</span><br><span class="line">Status: Downloaded newer image for centos:latest</span><br><span class="line">docker.io/library/centos:latest</span><br><span class="line">[root@xizou /]# docker images -a</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">centos       latest    5d0da3dc9764   13 months ago   231MB</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建并切换用户</span></span><br><span class="line">[root@xizou /]# adduser test -G docker</span><br><span class="line">[root@xizou /]# su - test</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 普通用户能看到root用户下载的镜像，如果使用podman则不会显示</span></span><br><span class="line">[test@xizou ~]$ docker images -a</span><br><span class="line">REPOSITORY   TAG       IMAGE ID       CREATED         SIZE</span><br><span class="line">centos       latest    5d0da3dc9764   13 months ago   231MB</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 普通用户运行centos应用的容器，挂载根目录到容器内的/host目录，并把容器内的/host目录作为容器的根目录</span></span><br><span class="line">[test@xizou ~]$ docker run -it --privileged -v /:/host centos chroot /host</span><br><span class="line">sh-4.2# </span><br><span class="line"><span class="meta">#</span><span class="bash"> 容器内能够执行命令获取原本普通用户没有权限的内容</span></span><br><span class="line">sh-4.2# head -1 /etc/shadow</span><br><span class="line">root:$6$8Ufh0Fb6$tpjmUtcq0r36xLc.q9tDb.5/ECL5cS6iOmglyETI23.C0BbGO0uHLtS7c97O6YvKV.CBQvufaP7mHJ25P.J6X/:19293:0:99999:7:::</span><br><span class="line">sh-4.2# exit</span><br><span class="line">exit</span><br><span class="line">[test@xizou ~]$ head -1 /etc/shadow</span><br><span class="line">head: cannot open ‘/etc/shadow’ for reading: Permission denied</span><br><span class="line">[test@xizou ~]$ exit</span><br><span class="line">logout</span><br><span class="line">[root@xizou /]# head -1 /etc/shadow</span><br><span class="line">root:$6$8Ufh0Fb6$tpjmUtcq0r36xLc.q9tDb.5/ECL5cS6iOmglyETI23.C0BbGO0uHLtS7c97O6YvKV.CBQvufaP7mHJ25P.J6X/:19293:0:99999:7:::</span><br></pre></td></tr></tbody></table></figure><p>上面例子举证了Docker造成的安全隐患，通过挂载数据卷的方式，普通用户能够在容器内获得root权限，能够随意更改文件。另外，容器内创建的用户，退出容器后居然存在于宿主机中。容器的隔离性被破坏。</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 解决方案：</span></span><br><span class="line">方案1. 使用podman替代docker</span><br><span class="line">alias docker=podman</span><br><span class="line">方案2. 限制只有root用户才能使用docker</span><br><span class="line">将docker.sock文件的属组改成root组</span><br><span class="line">[root@xizou /]# cd /var/run/</span><br><span class="line">[root@xizou run]# chown root:root docker.sock </span><br></pre></td></tr></tbody></table></figure><h2 id="后续学习方向">后续学习方向</h2><ul><li>IDEA整合Docker</li><li>Docker Compose、yaml</li><li>Docker Swarm、Kubernetes</li><li>CI/CD Jenkins</li></ul><h2 id="参考文章-3">参考文章</h2><p>本文是笔者通过下列视频教程和文档进行Docker进阶学习的记录，有部分修改和补充，转载请注明出处，并附带下面链接。</p><p>1.<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1og4y1q7M4/">【B站up主-遇见狂神说】</a></p><p>2.<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/">【kubernetes官网】</a></p><p>3.<a target="_blank" rel="noopener" href="https://www.udemy.com/course/learn-kubernetes/">【Udemy学院-Kubernetes初学者教程视频】</a></p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者:</span> <span class="post-copyright-info"><a href="https://xiongbinzou.github.io">小邹同学</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接:</span> <span class="post-copyright-info"><a href="https://xiongbinzou.github.io/posts/47611.html">https://xiongbinzou.github.io/posts/47611.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明:</span> <span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://xiongbinzou.github.io" target="_blank">小邹同学</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/">学习笔记</a><a class="post-meta__tags" href="/tags/Docker%E6%8A%80%E6%9C%AF/">Docker技术</a><a class="post-meta__tags" href="/tags/%E8%99%9A%E6%8B%9F%E5%8C%96/">虚拟化</a><a class="post-meta__tags" href="/tags/%E8%BF%9B%E9%98%B6%E6%95%99%E7%A8%8B/">进阶教程</a></div><div class="post_share"><div class="social-share" data-image="/pics/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/pics/reward/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/pics/reward/wechat.jpg" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/pics/reward/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/pics/reward/alipay.jpg" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/63190.html"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Django-Vue搭建个人博客(0)：前言</div></div></a></div><div class="next-post pull-right"><a href="/posts/38460.html"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Docker入门教程学习笔记</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/38460.html" title="Docker入门教程学习笔记"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-10-27</div><div class="title">Docker入门教程学习笔记</div></div></a></div><div><a href="/posts/16133.html" title="C#语言进阶学习笔记"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-16</div><div class="title">C#语言进阶学习笔记</div></div></a></div><div><a href="/posts/5067.html" title="Lua语言学习笔记"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-04</div><div class="title">Lua语言学习笔记</div></div></a></div><div><a href="/posts/6569.html" title="C#语言基础学习笔记"><img class="cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-08-10</div><div class="title">C#语言基础学习笔记</div></div></a></div></div></div><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i> <span>评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E5%8D%B7"><span class="toc-text">容器数据卷</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%AE%B9%E5%99%A8%E6%95%B0%E6%8D%AE%E5%8D%B7"><span class="toc-text">什么是容器数据卷</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%95%B0%E6%8D%AE%E5%8D%B7"><span class="toc-text">使用数据卷</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%EF%BC%9A%E5%AE%89%E8%A3%85MySQL"><span class="toc-text">实战：安装MySQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B7%E5%90%8D%E6%8C%82%E8%BD%BD%E5%92%8C%E5%8C%BF%E5%90%8D%E6%8C%82%E8%BD%BD"><span class="toc-text">具名挂载和匿名挂载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8BDockerfile"><span class="toc-text">初始Dockerfile</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Dockerfile"><span class="toc-text">Dockerfile</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Dockerfile%E4%BB%8B%E7%BB%8D"><span class="toc-text">Dockerfile介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dockerfile%E6%9E%84%E5%BB%BA%E8%BF%87%E7%A8%8B"><span class="toc-text">Dockerfile构建过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dockerfile%E5%91%BD%E4%BB%A4"><span class="toc-text">Dockerfile命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Dockerfile%E5%AE%9E%E6%88%98"><span class="toc-text">Dockerfile实战</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E8%87%AA%E5%B7%B1%E7%9A%84%E9%95%9C%E5%83%8F"><span class="toc-text">发布自己的镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%8F%E7%BB%93-2"><span class="toc-text">小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Docker%E7%BD%91%E7%BB%9C%E5%8E%9F%E7%90%86"><span class="toc-text">Docker网络原理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%90%86%E8%A7%A3Docker0"><span class="toc-text">理解Docker0</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E2%80%93link"><span class="toc-text">–link</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BD%91%E7%BB%9C"><span class="toc-text">自定义网络</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E7%BB%9C%E8%BF%9E%E9%80%9A"><span class="toc-text">网络连通</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%EF%BC%9ARedis%E9%9B%86%E7%BE%A4"><span class="toc-text">实战：Redis集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%EF%BC%9ASpringBoot%E5%BE%AE%E6%9C%8D%E5%8A%A1%E6%89%93%E5%8C%85%E6%88%90Docker%E9%95%9C%E5%83%8F"><span class="toc-text">实战：SpringBoot微服务打包成Docker镜像</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%A9%E5%B1%95"><span class="toc-text">扩展</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92"><span class="toc-text">什么是容器编排</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Kubernetes%E6%9E%B6%E6%9E%84"><span class="toc-text">Kubernetes架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kubectl%E5%B7%A5%E5%85%B7"><span class="toc-text">kubectl工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%EF%BC%9AKubernetes%E9%83%A8%E7%BD%B2%E6%8A%95%E7%A5%A8%E5%BA%94%E7%94%A8"><span class="toc-text">实战：Kubernetes部署投票应用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88Podman%E6%AF%94Docker%E6%9B%B4%E5%AE%89%E5%85%A8"><span class="toc-text">为什么Podman比Docker更安全</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E7%BB%AD%E5%AD%A6%E4%B9%A0%E6%96%B9%E5%90%91"><span class="toc-text">后续学习方向</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0-3"><span class="toc-text">参考文章</span></a></li></ol></div></div></div></div></main><footer id="footer" style="background-image:url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By 小邹同学</div><div class="framework-info"><span>框架</span> <a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题</span> <a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">你好，欢迎来到<a href="https://xiongbinzou.github.io">小邹同学的Secret Base</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i> <span>数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><script>var preloader={endLoading:()=>{document.body.style.overflow="auto",document.getElementById("loading-box").classList.add("loaded")},initLoading:()=>{document.body.style.overflow="",document.getElementById("loading-box").classList.remove("loaded")}};window.addEventListener("load",preloader.endLoading())</script><div class="js-pjax"><script>if(window.MathJax)MathJax.startup.document.state(0),MathJax.texReset(),MathJax.typeset();else{window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],tags:"ams"},chtml:{scale:1.2},options:{renderActions:{findScript:[10,t=>{for(const e of document.querySelectorAll('script[type^="math/tex"]')){const a=!!e.type.match(/; *mode=display/),n=new t.options.MathItem(e.textContent,t.inputJax[0],a),s=document.createTextNode("");e.parentNode.replaceChild(s,e),n.start={node:s,delim:"",n:0},n.end={node:s,delim:"",n:0},t.math.push(n)}},""],insertScript:[200,()=>{document.querySelectorAll("mjx-container:not([display])").forEach((t=>{const e=t.parentNode;"li"===e.nodeName.toLowerCase()?e.parentNode.classList.add("has-jax"):e.classList.add("has-jax")}))},"",!1]}}};const t=document.createElement("script");t.src="https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js",t.id="MathJax-script",t.async=!0,document.head.appendChild(t)}</script><script>(()=>{const e=document.querySelectorAll("#article-container .mermaid-wrap");if(e.length){window.runMermaid=()=>{window.loadMermaid=!0;const t="dark"===document.documentElement.getAttribute("data-theme")?"dark":"default";Array.from(e).forEach(((e,n)=>{const d=e.firstElementChild,r="mermaid-"+n,i="%%{init:{ 'theme':'"+t+"'}}%%\n"+d.textContent;mermaid.mermaidAPI.render(r,i,(e=>{d.insertAdjacentHTML("afterend",e)}))}))};const t=()=>{window.loadMermaid?runMermaid():getScript("https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js").then(runMermaid)};window.pjax?t():document.addEventListener("DOMContentLoaded",t)}})()</script><script>function loadValine(){function n(){new Valine(Object.assign({el:"#vcomment",appId:"WU7g4I4cNK7LYpz3RJVoz1YV-gzGzoHsz",appKey:"4MHXbgYuTwfEzqQofOeNVquO",avatar:"monsterid",serverURLs:"",emojiMaps:"",path:window.location.pathname,visitor:!1},null))}"function"==typeof Valine?n():getScript("https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js").then(n)}{function loadOtherComment(){loadValine()}setTimeout(loadValine,0)}</script></div><div class="aplayer no-destroy" data-id="5183531430" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listfolded="false" data-order="random" data-preload="none" data-autoplay="false" muted></div><script id="canvas_nest" defer color="0,0,255" opacity="0.7" zindex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!1,POWERMODE.mobile=!1,document.body.addEventListener("input",POWERMODE)</script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,log:!1,model:{jsonPath:"/live2dw/assets/hijiki.model.json"},display:{position:"left",width:150,height:190},mobile:{show:!1},react:{opacity:1}})</script></body></html>