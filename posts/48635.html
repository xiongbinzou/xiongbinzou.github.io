<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><title>Ansible学习笔记 | 小邹同学</title><meta name="keywords" content="Ansible,自动化运维"><meta name="author" content="小邹同学"><meta name="copyright" content="小邹同学"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Ansible是一款自动化运维工具，可以实现批量系统配置、批量程序部署、批量运行命令等功能，我在以往的工作中没有用到过这个工具，但是它的大名如雷贯耳，我正好趁着失业之于好好学习这个工具，为将来更好更快地“搬砖”做准备。"><meta property="og:type" content="article"><meta property="og:title" content="Ansible学习笔记"><meta property="og:url" content="https://xiongbinzou.github.io/posts/48635.html"><meta property="og:site_name" content="小邹同学"><meta property="og:description" content="Ansible是一款自动化运维工具，可以实现批量系统配置、批量程序部署、批量运行命令等功能，我在以往的工作中没有用到过这个工具，但是它的大名如雷贯耳，我正好趁着失业之于好好学习这个工具，为将来更好更快地“搬砖”做准备。"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://xiongbinzou.github.io/pics/avatar.jpg"><meta property="article:published_time" content="2023-07-10T13:00:00.000Z"><meta property="article:modified_time" content="2023-08-08T17:48:10.079Z"><meta property="article:author" content="小邹同学"><meta property="article:tag" content="Ansible"><meta property="article:tag" content="自动化运维"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://xiongbinzou.github.io/pics/avatar.jpg"><link rel="shortcut icon" href="/pics/favicon.png"><link rel="canonical" href="https://xiongbinzou.github.io/posts/48635"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css" media="print" onload='this.media="all"'><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload='this.media="all"'><script>const GLOBAL_CONFIG={root:"/",algolia:void 0,localSearch:{path:"/search.xml",preload:!1,languages:{hits_empty:"找不到您查询的内容：${query}"}},translate:void 0,noticeOutdate:void 0,highlight:{plugin:"highlighjs",highlightCopy:!0,highlightLang:!0,highlightHeightLimit:!1},copy:{success:"复制成功",error:"复制错误",noSupport:"浏览器不支持"},relativeDate:{homepage:!1,post:!1},runtime:"天",date_suffix:{just:"刚刚",min:"分钟前",hour:"小时前",day:"天前",month:"个月前"},copyright:{limitCount:300,languages:{author:"作者: 小邹同学",link:"链接: ",source:"来源: 小邹同学",info:"著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。"}},lightbox:"fancybox",Snackbar:{chs_to_cht:"你已切换为繁体",cht_to_chs:"你已切换为简体",day_to_night:"你已切换为深色模式",night_to_day:"你已切换为浅色模式",bgLight:"#49b1f5",bgDark:"#121212",position:"top-right"},source:{justifiedGallery:{js:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js",css:"https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css"}},isPhotoFigcaption:!0,islazyload:!1,isAnchor:!1}</script><script id="config-diff">var GLOBAL_CONFIG_SITE={title:"Ansible学习笔记",isPost:!0,isHome:!1,isHighlightShrink:!1,isToc:!0,postUpdate:"2023-08-09 01:48:10"}</script><noscript><style>#nav{opacity:1}.justified-gallery img{opacity:1}#post-meta time,#recent-posts time{display:inline!important}</style></noscript><script>(e=>{e.saveToLocal={set:function(e,t,o){if(0===o)return;const a=864e5*o,c={value:t,expiry:(new Date).getTime()+a};localStorage.setItem(e,JSON.stringify(c))},get:function(e){const t=localStorage.getItem(e);if(!t)return;const o=JSON.parse(t);if(!((new Date).getTime()>o.expiry))return o.value;localStorage.removeItem(e)}},e.getScript=e=>new Promise(((t,o)=>{const a=document.createElement("script");a.src=e,a.async=!0,a.onerror=o,a.onload=a.onreadystatechange=function(){const e=this.readyState;e&&"loaded"!==e&&"complete"!==e||(a.onload=a.onreadystatechange=null,t())},document.head.appendChild(a)})),e.activateDarkMode=function(){document.documentElement.setAttribute("data-theme","dark"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#0d0d0d")},e.activateLightMode=function(){document.documentElement.setAttribute("data-theme","light"),null!==document.querySelector('meta[name="theme-color"]')&&document.querySelector('meta[name="theme-color"]').setAttribute("content","#ffffff")};const t=saveToLocal.get("theme"),o=window.matchMedia("(prefers-color-scheme: dark)").matches,a=window.matchMedia("(prefers-color-scheme: light)").matches,c=window.matchMedia("(prefers-color-scheme: no-preference)").matches,n=!o&&!a&&!c;if(void 0===t){if(a)activateLightMode();else if(o)activateDarkMode();else if(c||n){const e=(new Date).getHours();e<=6||e>=18?activateDarkMode():activateLightMode()}window.matchMedia("(prefers-color-scheme: dark)").addListener((function(e){void 0===saveToLocal.get("theme")&&(e.matches?activateDarkMode():activateLightMode())}))}else"light"===t?activateLightMode():activateDarkMode();const i=saveToLocal.get("aside-status");void 0!==i&&("hide"===i?document.documentElement.classList.add("hide-aside"):document.documentElement.classList.remove("hide-aside")),/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)&&document.documentElement.classList.add("apple")})(window)</script><meta name="generator" content="Hexo 5.4.2"><style>.github-emoji{position:relative;display:inline-block;width:1.2em;min-height:1.2em;overflow:hidden;vertical-align:top;color:transparent}.github-emoji>span{position:relative;z-index:10}.github-emoji .fancybox,.github-emoji img{margin:0!important;padding:0!important;border:none!important;outline:0!important;text-decoration:none!important;user-select:none!important;cursor:auto!important}.github-emoji img{height:1.2em!important;width:1.2em!important;position:absolute!important;left:50%!important;top:50%!important;transform:translate(-50%,-50%)!important;user-select:none!important;cursor:auto!important}.github-emoji-fallback{color:inherit}.github-emoji-fallback img{opacity:0!important}</style></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="/pics/avatar.jpg" onerror='onerror=null,src="/img/friend_404.gif"' alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">21</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">40</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">11</div></a></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-graduation-cap"></i> <span>博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-archive"></i> <span>归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-folder-open"></i> <span>分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i> <span>标签</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i> <span>生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/photos/"><i class="fa-fw fa fa-camera-retro"></i> <span>相册</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i> <span>音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i> <span>影视</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fa fa-gamepad"></i> <span>游戏</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i> <span>友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image:url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">小邹同学</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i> <span>搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i> <span>主页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-graduation-cap"></i> <span>博文</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fa fa-archive"></i> <span>归档</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fa fa-folder-open"></i> <span>分类</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fa fa-tags"></i> <span>标签</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i> <span>生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/photos/"><i class="fa-fw fa fa-camera-retro"></i> <span>相册</span></a></li><li><a class="site-page child" href="/music/"><i class="fa-fw fa fa-music"></i> <span>音乐</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i> <span>影视</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fa fa-gamepad"></i> <span>游戏</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i> <span>友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i> <span>关于</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Ansible学习笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2023-07-10T13:00:00.000Z" title="发表于 2023-07-10 21:00:00">2023-07-10</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2023-08-08T17:48:10.079Z" title="更新于 2023-08-09 01:48:10">2023-08-09</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/C/">C#</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">22.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>113分钟</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="1-Ansible简介">1. Ansible简介</h2><blockquote><p>认识Ansible</p></blockquote><p>Ansible是一个为软件提供<strong>系统配置管理</strong>和<strong>批量部署</strong>的<strong>开源工具集</strong>，最初由Michael DeHaan于2012年编写，并于2015年被Red Hat公司收购，此后，Red Hat公司和开源社区进一步开发和改进了Ansible。</p><p><strong>Ansible的核心组件</strong>：</p><ul><li><p><strong>Module</strong> （模块）</p><p>文档地址：<a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/collections/index_module.html">https://docs.ansible.com/ansible/latest/collections/index_module.html</a></p><p>模块涵盖领域：</p><ul><li>云计算</li><li>网络</li><li>服务配置和管理</li><li>虚拟化</li><li>容器化</li><li>…</li></ul><p>得益于Ansible可扩展的原生架构，支持自定义模块</p></li><li><p><strong>ad-hoc</strong>（Ansible命令行工具）</p><p>Ansible安装成功后即可执行Ansible指令，可使用<code>/usr/bin/ansible</code>命令行工具在一个或多个管理节点上执行单个任务的命令：</p><ul><li>有益于创建项目和测试Ansible配置</li><li>Ansible Modules的使用和测试更加方便</li></ul></li><li><p><strong>Playbook</strong>（剧本）</p><p>Ansible安装成功后可编写剧本：</p><ul><li>使用人类易读的配置部署和编排语言编写</li><li>可完成一组任务</li></ul></li><li><p><strong>Inventory</strong>（清单）</p><p>清单是目标的集合：</p><ul><li>最常见的由主机组成，但也可以是与之相关的组件，如网络交换机、容器、存储阵列、其他物理或虚拟组件</li><li>有用信息，如包含目标选择的文本文件</li><li>动态清单，可通过执行程序动态获取数据</li></ul></li></ul><p><strong>Ansible的特点</strong>：</p><ul><li>基于Python开发，容易扩展</li><li>功能强大，内置模块丰富，满足多样需求</li><li>管理模式简单，上手容易</li><li>无代理模式，通过SSH通信，跨平台支持</li></ul><h2 id="2-准备环境">2. 准备环境</h2><blockquote><p>安装Docker，配置Ansible实验环境，配置主机间SSH免密码连接，配置Ansible课程的代码库</p></blockquote><h3 id="2-1-安装Docker">2.1 安装Docker</h3><p>Docker是一个容器产品，利用操作系统级虚拟化，允许软件作为容器交付，容器是相互隔离的，每个容器内部都可以捆绑软件库和配置文件，Docker在Mac、Windows、Linux上都可用。</p><p>为了方便学习，我选择在Windows系统上安装Docker桌面级产品。</p><p>下载地址：<a target="_blank" rel="noopener" href="https://www.docker.com/">https://www.docker.com/</a></p><p>安装过程非常简单，安装后如果出现提示，按照提示去做就ok。</p><p>测试：</p><figure class="highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># cmd控制台</span></span><br><span class="line">C:\Users\zouxiongbin&gt;docker run <span class="literal">-it</span> -<span class="literal">-rm</span> ubuntu bash</span><br><span class="line">Unable to find image <span class="string">'ubuntu:latest'</span> locally</span><br><span class="line">latest: Pulling from library/ubuntu</span><br><span class="line"><span class="number">6</span>b851dcae6ca: Pull complete</span><br><span class="line">Digest: sha256:<span class="number">2</span>a357c4bd54822267339e601ae86ee3966723bdbcae640a70ace622cc9470c83</span><br><span class="line">Status: Downloaded newer image <span class="keyword">for</span> ubuntu:latest</span><br><span class="line">root@<span class="number">1</span>eb3165473b6:/<span class="comment"># uname -a</span></span><br><span class="line">Linux <span class="number">1</span>eb3165473b6 <span class="number">5.15</span>.<span class="number">90.1</span><span class="literal">-microsoft</span><span class="literal">-standard</span><span class="literal">-WSL2</span> <span class="comment">#1 SMP Fri Jan 27 02:56:13 UTC 2023 x86_64 x86_64 x86_64 GNU/Linux</span></span><br><span class="line">root@<span class="number">1</span>eb3165473b6:/<span class="comment"># cat /etc/os-release</span></span><br><span class="line">PRETTY_NAME=<span class="string">"Ubuntu 22.04.2 LTS"</span></span><br><span class="line">NAME=<span class="string">"Ubuntu"</span></span><br><span class="line">VERSION_ID=<span class="string">"22.04"</span></span><br><span class="line">VERSION=<span class="string">"22.04.2 LTS (Jammy Jellyfish)"</span></span><br><span class="line">VERSION_CODENAME=jammy</span><br><span class="line">ID=ubuntu</span><br><span class="line">ID_LIKE=debian</span><br><span class="line">HOME_URL=<span class="string">"https://www.ubuntu.com/"</span></span><br><span class="line">SUPPORT_URL=<span class="string">"https://help.ubuntu.com/"</span></span><br><span class="line">BUG_REPORT_URL=<span class="string">"https://bugs.launchpad.net/ubuntu/"</span></span><br><span class="line">PRIVACY_POLICY_URL=<span class="string">"https://www.ubuntu.com/legal/terms-and-policies/privacy-policy"</span></span><br><span class="line">UBUNTU_CODENAME=jammy</span><br><span class="line">root@<span class="number">1</span>eb3165473b6:/<span class="comment">#</span></span><br></pre></td></tr></tbody></table></figure><h3 id="2-2-安装Ansible实验环境">2.2 安装Ansible实验环境</h3><p>Ansible实验环境代码地址： <a target="_blank" rel="noopener" href="https://github.com/spurin/diveintoansible-lab%EF%BC%8C%E5%AE%89%E8%A3%85%E6%96%B9%E6%B3%95%E5%8F%82%E8%80%83%E8%AF%A5%E5%9C%B0%E5%9D%80%E6%96%87%E6%A1%A3%EF%BC%8C%E8%BF%99%E9%87%8C%E8%AE%B0%E5%BD%95%E4%B8%8BWindows%E7%9A%84%E5%AE%89%E8%A3%85%E6%96%B9%E6%B3%95%EF%BC%88%E5%89%8D%E6%8F%90%EF%BC%9A%E6%9C%AC%E5%9C%B0Windows%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%AE%89%E8%A3%85%E4%BA%86git%EF%BC%89%EF%BC%9A">https://github.com/spurin/diveintoansible-lab，安装方法参考该地址文档，这里记录下Windows的安装方法（前提：本地Windows操作系统安装了git）：</a></p><figure class="highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># cmd控制台</span></span><br><span class="line">C:\Users\zouxiongbin&gt;git version</span><br><span class="line">git version <span class="number">2.37</span>.<span class="number">1</span>.windows.<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 拉取ansible实验环境代码</span></span><br><span class="line">C:\Users\zouxiongbin&gt;git clone https://github.com/spurin/diveintoansible<span class="literal">-lab</span>.git</span><br><span class="line"></span><br><span class="line"><span class="comment"># 对比查看文件是否缺失</span></span><br><span class="line">C:\Users\zouxiongbin\diveintoansible<span class="literal">-lab</span>\.env</span><br><span class="line">C:\Users\zouxiongbin\diveintoansible<span class="literal">-lab</span>\DiveIntoAnsible_Cover.png</span><br><span class="line">C:\Users\zouxiongbin\diveintoansible<span class="literal">-lab</span>\README.md</span><br><span class="line">C:\Users\zouxiongbin\diveintoansible<span class="literal">-lab</span>\docker<span class="literal">-compose</span>.yaml</span><br><span class="line">C:\Users\zouxiongbin\diveintoansible<span class="literal">-lab</span>\config\guest_name</span><br><span class="line">C:\Users\zouxiongbin\diveintoansible<span class="literal">-lab</span>\config\guest_passwd</span><br><span class="line">C:\Users\zouxiongbin\diveintoansible<span class="literal">-lab</span>\config\guest_shell</span><br><span class="line">C:\Users\zouxiongbin\diveintoansible<span class="literal">-lab</span>\config\root_passwd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行实验环境</span></span><br><span class="line">C:\Users\zouxiongbin\diveintoansible<span class="literal">-lab</span>&gt;docker<span class="literal">-compose</span> up</span><br><span class="line">......</span><br><span class="line">Attaching to centos1, centos2, centos3, docker, portal, ubuntu<span class="literal">-c</span>, ubuntu1, ubuntu2, ubuntu3</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新实验环境</span></span><br><span class="line">docker<span class="literal">-compose</span> pull</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除实验环境</span></span><br><span class="line">docker<span class="literal">-compose</span> down</span><br></pre></td></tr></tbody></table></figure><p>访问http://localhost:1000/即可进入Ansible实验环境，如下：</p><p><img src="Ansible%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230616192742571.png" alt=""></p><p>实验环境由7台主机组成，分别是ubuntu-c（ansible管理主机，其他为ubuntu系统或centos系统的被管理主机）、ubuntu1、ubuntu2、ubuntu3、centos1、centos2、centos3</p><p>登录ubuntu-c主机，账号是<code>ansible</code>，密码是<code>password</code></p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 登录Ubuntu-C主机</span></span><br><span class="line">ubuntu-c login: ansible</span><br><span class="line">Password: </span><br><span class="line">Welcome to Ubuntu 22.04.1 LTS (GNU/Linux 5.15.90.1-microsoft-standard-WSL2 x86_64)</span><br><span class="line"></span><br><span class="line"> * Documentation:  https://help.ubuntu.com</span><br><span class="line"> * Management:     https://landscape.canonical.com</span><br><span class="line"> * Support:        https://ubuntu.com/advantage</span><br><span class="line"></span><br><span class="line">The programs included with the Ubuntu system are free software;</span><br><span class="line">the exact distribution terms for each program are described in the</span><br><span class="line">individual files in /usr/share/doc/*/copyright.</span><br><span class="line"></span><br><span class="line">Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by</span><br><span class="line">applicable law.</span><br><span class="line"></span><br><span class="line">To run a command as administrator (user "root"), use "sudo &lt;command&gt;".</span><br><span class="line">See "man sudo_root" for details.</span><br><span class="line"></span><br><span class="line">ansible@ubuntu-c:~$ </span><br></pre></td></tr></tbody></table></figure><p>除了使用本地的系统搭建Ansible实验环境外，还可以使用Google Cloud使用云服务器搭建Ansible实验环境，地址为：<a target="_blank" rel="noopener" href="https://diveinto.com/p/playground">https://diveinto.com/p/playground</a></p><h3 id="2-3-配置主机间SSH免密码连接">2.3 配置主机间SSH免密码连接</h3><p>Ansible是一个无代理架构，意味着被管理主机无需安装Agent，只需要配置主机间的SSH免密码连接。</p><p>SSH连接建立过程如图：</p><p><img src="Ansible%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230616201117155.png" alt=""></p><p>配置Ansible SSH免密码连接</p><p><img src="Ansible%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20230616201943353.png" alt=""></p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ubuntu-c ansible管理主机</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 生成ssh密钥</span></span><br><span class="line">ansible@ubuntu-c:~$ ssh-keygen</span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/home/ansible/.ssh/id_rsa): </span><br><span class="line">Created directory '/home/ansible/.ssh'.</span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in /home/ansible/.ssh/id_rsa</span><br><span class="line">Your public key has been saved in /home/ansible/.ssh/id_rsa.pub</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:p498cMfcCkbqBCie6F26a9f3vGVKJIP7nBgFP53/pmA ansible@ubuntu-c</span><br><span class="line">The key's randomart image is:</span><br><span class="line">+---[RSA 3072]----+</span><br><span class="line">|                 |</span><br><span class="line">|                 |</span><br><span class="line">|     . .         |</span><br><span class="line">|  . . . + o .    |</span><br><span class="line">| o o   oSO.* .   |</span><br><span class="line">|. o  .  *oO = .  |</span><br><span class="line">|. . o .=.+ E =   |</span><br><span class="line">| . + . o*+* * .. |</span><br><span class="line">|  .o+  .+=o=..o. |</span><br><span class="line">+----[SHA256]-----+</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看公钥</span></span><br><span class="line">ansible@ubuntu-c:~$ cat .ssh/id_rsa.pub </span><br><span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC3qePtp0SWcYxUAg+05EW/s7silEEMWU1gYgdyJlbqO3miImGQKt+jit4eLcKjwcduF1CpiIJ2bR2CWFx2eCOT1esg9xwNy7J9Mu52kzkwoSgvIumlczkHMla4k03KERp7kIeX3oDae98XpRULu+b7rknKh02HGWmsPwMuhq0pX0928BWRiEa4SJmFzvNGoKoJbyXCVF8ZcAiZAJI0TaMe1aEEUuIm41dRhYZf/6AftChWFcJ7x1YgXG6EbG0xlacImgYE9/n+X1Hhjklm+MmBnXE6VMde4E8CdVP5OOkMNqg3H2s23UFj+4tPha5juLfSEKxm2mXOfE5rqtPJZQImgGwHINgiZv4qbTg6t78CsCl2YXzBHk8oAPnpE/YFZ8tc5vozdhdhphbN2a5Q9xZ9abByGV7bHB5MS+GQuuGSHSnSp9Ai87gb43QoU1V76jlbngYzwQFwhxLnfoNCwzr3FQj9OJ8KrwQS8zuKKujGzG5UIytGQDlpgJOE97OTS2s= ansible@ubuntu-c</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用ssh-copy-id将公钥的内容复制到被管理主机的authorized_keys文件</span></span><br><span class="line">ansible@ubuntu-c:~$ ssh-copy-id ansible@ubuntu1</span><br><span class="line">/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: "/home/ansible/.ssh/id_rsa.pub"</span><br><span class="line">The authenticity of host 'ubuntu1 (172.18.0.3)' can't be established.</span><br><span class="line">ED25519 key fingerprint is SHA256:Bq0T7Bg1OWZDjSsLlhWtp7QjqtZitWuPQCgcXX+pXas.</span><br><span class="line">This host key is known by the following other names/addresses:</span><br><span class="line">    ~/.ssh/known_hosts:1: [hashed name]</span><br><span class="line">Are you sure you want to continue connecting (yes/no/[fingerprint])? yes</span><br><span class="line">/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed</span><br><span class="line">/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys</span><br><span class="line">ansible@ubuntu1's password: </span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   "ssh 'ansible@ubuntu1'"</span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试连接</span></span><br><span class="line">ansible@ubuntu-c:~$ ssh ubuntu1</span><br><span class="line">Last login: Fri Jun 16 12:28:32 2023 from 172.18.0.9</span><br><span class="line">To run a command as administrator (user "root"), use "sudo &lt;command&gt;".</span><br><span class="line">See "man sudo_root" for details.</span><br><span class="line"></span><br><span class="line">ansible@ubuntu1:~$</span><br></pre></td></tr></tbody></table></figure><p>不难发现，上面的做法存在弊端，每次将公钥的内容复制到新的被管理主机时，都需要键入<strong>yes</strong>和被管理主机的<strong>密码</strong>，被管理主机很多时设置起来比较费时，因此，可以使用sshpass脚本将这一过程自动化。</p><p>安装sshpass</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 更新apt</span></span><br><span class="line">ansible@ubuntu-c:~$ sudo apt update</span><br><span class="line">[sudo] password for ansible: </span><br><span class="line">Get:1 http://security.ubuntu.com/ubuntu jammy-security InRelease [110 kB]</span><br><span class="line">......</span><br><span class="line">Get:18 http://archive.ubuntu.com/ubuntu jammy-backports/universe amd64 Packages [27.0 kB]                                                                                                                                                                       Fetched 25.2 MB in 28s (904 kB/s)                                                                                               </span><br><span class="line"></span><br><span class="line">Reading package lists... Done</span><br><span class="line">Building dependency tree... Done</span><br><span class="line">Reading state information... Done</span><br><span class="line">90 packages can be upgraded. Run 'apt list --upgradable' to see them.</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 下载sshpass</span></span><br><span class="line">ansible@ubuntu-c:~$ sudo apt install sshpass</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>编写公钥分发脚本</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 编写公钥分发脚本</span></span><br><span class="line">ansible@ubuntu-c:~$ cat ssh_key_send.sh</span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">rm -rf ~/.ssh/id_rsa*</span><br><span class="line">ssh-keygen -f ~/.ssh/id_rsa -P "" &gt; /dev/null 2&gt;&amp;1</span><br><span class="line">Pass_Text=password.txt</span><br><span class="line">Key_Path=~/.ssh/id_rsa.pub</span><br><span class="line">for user in ansible root</span><br><span class="line">do</span><br><span class="line">	for os in ubuntu centos</span><br><span class="line">	do</span><br><span class="line">		for instance in 1 2 3</span><br><span class="line">		do</span><br><span class="line">        	sshpass -f $Pass_Text ssh-copy-id -i $Key_Path -o StrictHostKeyChecking=no ${user}@${os}${instance}</span><br><span class="line">        done</span><br><span class="line">    done</span><br><span class="line">done</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 非交互式分发公钥命令，使用sshpass指定ssh密码，通过 -o StrictHostKeyChecking=no 跳过ssh连接确认信息</span></span><br></pre></td></tr></tbody></table></figure><p>执行脚本</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 执行脚本</span></span><br><span class="line">ansible@ubuntu-c:~$ sh ssh_key_send.sh</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 安全起见，删除password.txt</span></span><br><span class="line">ansible@ubuntu-c:~$ rm password.txt</span><br></pre></td></tr></tbody></table></figure><p>此时ubuntu-c连接任何被管理主机都不需要输入账号密码</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 测试连接</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ansible</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -i 指定清单文件，也可以接 ,和主机列表</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -m 指定模板</span></span><br><span class="line">ansible@ubuntu-c:~$ ansible -i,ubuntu1,ubuntu2,ubuntu3,centos1,centos2,centos3 all -m ping</span><br><span class="line">ubuntu1 | SUCCESS =&gt; {</span><br><span class="line">    "ansible_facts": {</span><br><span class="line">        "discovered_interpreter_python": "/usr/bin/python3"</span><br><span class="line">    },</span><br><span class="line">    "changed": false,</span><br><span class="line">    "ping": "pong"</span><br><span class="line">}</span><br><span class="line">ubuntu3 | SUCCESS =&gt; {</span><br><span class="line">    "ansible_facts": {</span><br><span class="line">        "discovered_interpreter_python": "/usr/bin/python3"</span><br><span class="line">    },</span><br><span class="line">    "changed": false,</span><br><span class="line">    "ping": "pong"</span><br><span class="line">}</span><br><span class="line">ubuntu2 | SUCCESS =&gt; {</span><br><span class="line">    "ansible_facts": {</span><br><span class="line">        "discovered_interpreter_python": "/usr/bin/python3"</span><br><span class="line">    },</span><br><span class="line">    "changed": false,</span><br><span class="line">    "ping": "pong"</span><br><span class="line">}</span><br><span class="line">centos1 | SUCCESS =&gt; {</span><br><span class="line">    "ansible_facts": {</span><br><span class="line">        "discovered_interpreter_python": "/usr/libexec/platform-python"</span><br><span class="line">    },</span><br><span class="line">    "changed": false,</span><br><span class="line">    "ping": "pong"</span><br><span class="line">}</span><br><span class="line">centos2 | SUCCESS =&gt; {</span><br><span class="line">    "ansible_facts": {</span><br><span class="line">        "discovered_interpreter_python": "/usr/libexec/platform-python"</span><br><span class="line">    },</span><br><span class="line">    "changed": false,</span><br><span class="line">    "ping": "pong"</span><br><span class="line">}</span><br><span class="line">centos3 | SUCCESS =&gt; {</span><br><span class="line">    "ansible_facts": {</span><br><span class="line">        "discovered_interpreter_python": "/usr/libexec/platform-python"</span><br><span class="line">    },</span><br><span class="line">    "changed": false,</span><br><span class="line">    "ping": "pong"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="2-4-配置Ansible课程的代码库">2.4 配置Ansible课程的代码库</h3><p>Ansible课程代码库地址：<a target="_blank" rel="noopener" href="https://github.com/spurin/diveintoansible%EF%BC%8C%E5%BB%BA%E8%AE%AEgithub%E4%B8%8Astar">https://github.com/spurin/diveintoansible，建议github上star</a></p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~$ git clone https://github.com/spurin/diveintoansible.git</span><br></pre></td></tr></tbody></table></figure><h2 id="3-Ansible架构和设计">3. Ansible架构和设计</h2><blockquote><p>Ansible配置文件，Ansible Inventory清单和Module模块</p></blockquote><h3 id="3-1-Ansible配置文件">3.1 Ansible配置文件</h3><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 查看ansible版本信息</span></span><br><span class="line">ansible@ubuntu-c:~$ ansible --version</span><br><span class="line">ansible [core 2.14.2]</span><br><span class="line">  config file = None</span><br><span class="line">  configured module search path = ['/home/ansible/.ansible/plugins/modules', '/usr/share/ansible/plugins/modules']</span><br><span class="line">  ansible python module location = /usr/local/lib/python3.10/dist-packages/ansible</span><br><span class="line">  ansible collection location = /home/ansible/.ansible/collections:/usr/share/ansible/collections</span><br><span class="line">  executable location = /usr/local/bin/ansible</span><br><span class="line">  python version = 3.10.6 (main, Nov 14 2022, 16:10:14) [GCC 11.3.0] (/usr/bin/python3)</span><br><span class="line">  jinja version = 3.1.2</span><br><span class="line">  libyaml = True</span><br></pre></td></tr></tbody></table></figure><p><strong>配置文件优先级</strong></p><p>可以发现Ansible config file还未配置，Ansible配置文件位置和环境变量可以用于影响config file，优先级从高到低依次是：</p><ol><li><strong>ANSIBLE_CONFIG</strong> 环境变量，带ansible配置文件路径</li><li><strong>./ansible.cfg</strong> 当前目录，当前目录可以有自己单独的配置文件，<strong>推荐</strong></li><li><strong>~/.ansible.cfg</strong> 隐藏文件，在用户的主目录中</li><li><strong>/etc/ansible/ansible.cfg</strong> 通常由Ansible通过包或系统安装提供，如<code>apt install ansible</code></li></ol><h3 id="3-2-Ansible清单">3.2 Ansible清单</h3><p>停止Ansible实验环境</p><figure class="highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># cmd控制台</span></span><br><span class="line">C:\Users\zouxiongbin\diveintoansible<span class="literal">-lab</span>&gt;docker<span class="literal">-compose</span> down</span><br></pre></td></tr></tbody></table></figure><p>修改docker-compose.yml文件为：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3.8'</span> <span class="comment"># if no version is specificed then v1 is assumed. Recommend v2 minimum</span></span><br><span class="line"></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">ubuntu-c:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">ubuntu-c</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">ubuntu-c</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">spurin/diveintoansible:ansible</span></span><br><span class="line">    <span class="attr">ports:</span> </span><br><span class="line">     <span class="bullet">-</span> <span class="string">${UBUNTUC_PORT_SSHD}:22</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${UBUNTUC_PORT_TTYD}:7681</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${CONFIG}:/config</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${ANSIBLE_HOME}/shared:/shared</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${ANSIBLE_HOME}/ubuntu-c/ansible:/home/ansible</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${ANSIBLE_HOME}/ubuntu-c/root:/root</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">diveinto.io</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">ubuntu1:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">ubuntu1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">ubuntu1</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">spurin/diveintoansible:ubuntu</span></span><br><span class="line">    <span class="attr">ports:</span> </span><br><span class="line">     <span class="bullet">-</span> <span class="string">${UBUNTU1_PORT_SSHD}:22</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${UBUNTU1_PORT_TTYD}:7681</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${CONFIG}:/config</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${ANSIBLE_HOME}/shared:/shared</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${ANSIBLE_HOME}/ubuntu1/ansible:/home/ansible</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${ANSIBLE_HOME}/ubuntu1/root:/root</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">diveinto.io</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">ubuntu2:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">ubuntu2</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">ubuntu2</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">spurin/diveintoansible:ubuntu</span></span><br><span class="line">    <span class="attr">ports:</span> </span><br><span class="line">     <span class="bullet">-</span> <span class="string">${UBUNTU2_PORT_SSHD}:22</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${UBUNTU2_PORT_TTYD}:7681</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${CONFIG}:/config</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${ANSIBLE_HOME}/shared:/shared</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${ANSIBLE_HOME}/ubuntu2/ansible:/home/ansible</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${ANSIBLE_HOME}/ubuntu2/root:/root</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">diveinto.io</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">ubuntu3:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">ubuntu3</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">ubuntu3</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">spurin/diveintoansible:ubuntu</span></span><br><span class="line">    <span class="attr">ports:</span> </span><br><span class="line">     <span class="bullet">-</span> <span class="string">${UBUNTU3_PORT_SSHD}:22</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${UBUNTU3_PORT_TTYD}:7681</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${CONFIG}:/config</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${ANSIBLE_HOME}/shared:/shared</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${ANSIBLE_HOME}/ubuntu3/ansible:/home/ansible</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${ANSIBLE_HOME}/ubuntu3/root:/root</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">diveinto.io</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">centos1:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">centos1</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">centos1</span></span><br><span class="line">    <span class="comment">#image: spurin/diveintoansible:centos</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">spurin/diveintoansible:centos-sshd-2222</span></span><br><span class="line">    <span class="attr">ports:</span> </span><br><span class="line">     <span class="comment">#- ${CENTOS1_PORT_SSHD}:22</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${CENTOS1_PORT_SSHD}:2222</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${CENTOS1_PORT_TTYD}:7681</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${CONFIG}:/config</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${ANSIBLE_HOME}/shared:/shared</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${ANSIBLE_HOME}/centos1/ansible:/home/ansible</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${ANSIBLE_HOME}/centos1/root:/root</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">diveinto.io</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">centos2:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">centos2</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">centos2</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">spurin/diveintoansible:centos</span></span><br><span class="line">    <span class="attr">ports:</span> </span><br><span class="line">     <span class="bullet">-</span> <span class="string">${CENTOS2_PORT_SSHD}:22</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${CENTOS2_PORT_TTYD}:7681</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${CONFIG}:/config</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${ANSIBLE_HOME}/shared:/shared</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${ANSIBLE_HOME}/centos2/ansible:/home/ansible</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${ANSIBLE_HOME}/centos2/root:/root</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">diveinto.io</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">centos3:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">centos3</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">centos3</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">spurin/diveintoansible:centos</span></span><br><span class="line">    <span class="attr">ports:</span> </span><br><span class="line">     <span class="bullet">-</span> <span class="string">${CENTOS3_PORT_SSHD}:22</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${CENTOS3_PORT_TTYD}:7681</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${CONFIG}:/config</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${ANSIBLE_HOME}/shared:/shared</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${ANSIBLE_HOME}/centos3/ansible:/home/ansible</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${ANSIBLE_HOME}/centos3/root:/root</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">diveinto.io</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># Docker in Docker</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># Usage: on host that wishes to use docker</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="comment"># sudo apt-get update</span></span><br><span class="line">  <span class="comment"># sudo apt -y install docker.io</span></span><br><span class="line">  <span class="comment"># export DOCKER_HOST=tcp://docker:2375</span></span><br><span class="line">  <span class="comment"># docker ps -a</span></span><br><span class="line">  <span class="comment">#</span></span><br><span class="line">  <span class="attr">docker:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">docker</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">docker</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">spurin/diveintoansible:dind</span></span><br><span class="line">    <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">${ANSIBLE_HOME}/shared:/shared</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">diveinto.io</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">portal:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">portal</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">portal</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">spurin/diveintoansible:portal</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">NGINX_ENTRYPOINT_QUIET_LOGS=1</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">centos1</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">centos2</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">centos3</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">ubuntu1</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">ubuntu2</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">ubuntu3</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">"1000:80"</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">diveinto.io</span></span><br><span class="line"></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">diveinto.io:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">diveinto.io</span></span><br><span class="line">    <span class="comment"># Canonical bridge interface name</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># The setting below provides a friendly name for the bridge interface</span></span><br><span class="line">    <span class="comment"># as seen in the likes of the ip command.  Use at your own discretion</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#driver_opts:</span></span><br><span class="line">    <span class="comment">#  com.docker.network.bridge.name: "diveinto.io"</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>重新启动Ansible实验环境</p><figure class="highlight powershell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># cmd控制台</span></span><br><span class="line">C:\Users\zouxiongbin\diveintoansible<span class="literal">-lab</span>&gt;docker<span class="literal">-compose</span> up</span><br><span class="line">......</span><br><span class="line">Attaching to centos1, centos2, centos3, docker, portal, ubuntu<span class="literal">-c</span>, ubuntu1, ubuntu2, ubuntu3</span><br></pre></td></tr></tbody></table></figure><p>访问http://localhost:1000/进入ubuntu-c环境</p><p><strong>ini清单文件</strong></p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~$ ls</span><br><span class="line">diveintoansible  ssh_key_send.sh  this_is_example_ansible.cfg</span><br><span class="line"><span class="meta">#</span><span class="bash"> 新建文件夹并进入</span></span><br><span class="line">ansible@ubuntu-c:~$ mkdir demo01 &amp;&amp; cd demo01</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建配置文件和清单文件</span></span><br><span class="line">ansible@ubuntu-c:~/demo01$ touch ansible.cfg hosts</span><br></pre></td></tr></tbody></table></figure><p>配置文件 <strong>ansible.cfg</strong> :</p><figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">[defaults]</span></span><br><span class="line"><span class="attr">inventory</span> = hosts</span><br><span class="line"><span class="attr">host_key_checking</span> = <span class="literal">False</span></span><br></pre></td></tr></tbody></table></figure><p>清单文件 <strong>hosts</strong> :</p><figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">[control]</span></span><br><span class="line">ubuntu-c <span class="attr">ansible_connection</span>=local</span><br><span class="line"></span><br><span class="line"><span class="section">[centos]</span></span><br><span class="line">centos1 <span class="attr">ansible_port</span>=<span class="number">2222</span></span><br><span class="line">centos<span class="section">[2:3]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[centos:vars]</span></span><br><span class="line"><span class="attr">ansible_user</span>=root</span><br><span class="line"></span><br><span class="line"><span class="section">[ubuntu]</span></span><br><span class="line">ubuntu<span class="section">[1:3]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[ubuntu:vars]</span></span><br><span class="line"><span class="attr">ansible_become</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">ansible_become_pass</span>=password</span><br><span class="line"></span><br><span class="line"><span class="section">[linux:children]</span></span><br><span class="line">centos</span><br><span class="line">ubuntu</span><br><span class="line"></span><br><span class="line"><span class="section">[linux:vars]</span></span><br><span class="line"><span class="attr">ansible_port</span>=<span class="number">1234</span></span><br></pre></td></tr></tbody></table></figure><p>上面的清单文件包括了：</p><ul><li><p>清单主机变量，如ansible_port</p></li><li><p>简单的范围清单，如ubuntu[1:3]</p></li><li><p>清单组变量，如[ubuntu:vars]、[linux:vars]</p></li><li><p>清单子组，如[linux:children]</p></li><li><p>ansible通过root连接centos机器</p></li><li><p>ansible通过2222端口连接centos1</p></li><li><p>ansible通过sudo连接ubuntu机器</p></li></ul><p>测试：</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~/demo01$ ansible all -m ping -o</span><br><span class="line">centos2 | UNREACHABLE!: Failed to connect to the host via ssh: ssh: connect to host centos2 port 1234: Connection refused</span><br><span class="line">centos3 | UNREACHABLE!: Failed to connect to the host via ssh: ssh: connect to host centos3 port 1234: Connection refused</span><br><span class="line">ubuntu1 | UNREACHABLE!: Failed to connect to the host via ssh: ssh: connect to host ubuntu1 port 1234: Connection refused</span><br><span class="line">ubuntu2 | UNREACHABLE!: Failed to connect to the host via ssh: ssh: connect to host ubuntu2 port 1234: Connection refused</span><br><span class="line">ubuntu3 | UNREACHABLE!: Failed to connect to the host via ssh: ssh: connect to host ubuntu3 port 1234: Connection refused</span><br><span class="line">ubuntu-c | SUCCESS =&gt; {"ansible_facts": {"discovered_interpreter_python": "/usr/bin/python3"},"changed": false,"ping": "pong"}</span><br><span class="line">centos1 | SUCCESS =&gt; {"ansible_facts": {"discovered_interpreter_python": "/usr/libexec/platform-python"},"changed": false,"ping": "pong"}</span><br></pre></td></tr></tbody></table></figure><p>注释掉hosts文件里最后两行，再进行测试：</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~/demo01$ ansible all -m ping -o</span><br><span class="line">ubuntu-c | SUCCESS =&gt; {"ansible_facts": {"discovered_interpreter_python": "/usr/bin/python3"},"changed": false,"ping": "pong"}</span><br><span class="line">centos2 | SUCCESS =&gt; {"ansible_facts": {"discovered_interpreter_python": "/usr/libexec/platform-python"},"changed": false,"ping": "pong"}</span><br><span class="line">centos1 | SUCCESS =&gt; {"ansible_facts": {"discovered_interpreter_python": "/usr/libexec/platform-python"},"changed": false,"ping": "pong"}</span><br><span class="line">centos3 | SUCCESS =&gt; {"ansible_facts": {"discovered_interpreter_python": "/usr/libexec/platform-python"},"changed": false,"ping": "pong"}</span><br><span class="line">ubuntu1 | SUCCESS =&gt; {"ansible_facts": {"discovered_interpreter_python": "/usr/bin/python3"},"changed": false,"ping": "pong"}</span><br><span class="line">ubuntu2 | SUCCESS =&gt; {"ansible_facts": {"discovered_interpreter_python": "/usr/bin/python3"},"changed": false,"ping": "pong"}</span><br><span class="line">ubuntu3 | SUCCESS =&gt; {"ansible_facts": {"discovered_interpreter_python": "/usr/bin/python3"},"changed": false,"ping": "pong"}</span><br></pre></td></tr></tbody></table></figure><p><strong>yaml清单文件</strong></p><p>新增清单文件 <strong>hosts.yaml</strong> :</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">control:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="attr">ubuntu-c:</span></span><br><span class="line">      <span class="attr">ansible_connection:</span> <span class="string">local</span></span><br><span class="line"><span class="attr">centos:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="attr">centos1:</span></span><br><span class="line">      <span class="attr">ansible_port:</span> <span class="number">2222</span></span><br><span class="line">    <span class="attr">centos2:</span></span><br><span class="line">    <span class="attr">centos3:</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">ansible_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">ubuntu:</span></span><br><span class="line">  <span class="attr">hosts:</span></span><br><span class="line">    <span class="attr">ubuntu1:</span></span><br><span class="line">    <span class="attr">ubuntu2:</span></span><br><span class="line">    <span class="attr">ubuntu3:</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">ansible_become:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">ansible_become_pass:</span> <span class="string">password</span></span><br><span class="line"><span class="attr">linux:</span></span><br><span class="line">  <span class="attr">children:</span></span><br><span class="line">    <span class="attr">centos:</span></span><br><span class="line">    <span class="attr">ubuntu:</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>将清单改为yaml类型，只需修改配置文件 <strong>ansible.cfg</strong> :</p><figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">[defaults]</span></span><br><span class="line"><span class="attr">inventory</span> = hosts.yaml</span><br><span class="line"><span class="attr">host_key_checking</span> = <span class="literal">False</span></span><br></pre></td></tr></tbody></table></figure><p>再次进行测试：</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~/demo01$ ansible linux -m ping -o</span><br><span class="line">centos1 | SUCCESS =&gt; {"ansible_facts": {"discovered_interpreter_python": "/usr/libexec/platform-python"},"changed": false,"ping": "pong"}</span><br><span class="line">centos2 | SUCCESS =&gt; {"ansible_facts": {"discovered_interpreter_python": "/usr/libexec/platform-python"},"changed": false,"ping": "pong"}</span><br><span class="line">centos3 | SUCCESS =&gt; {"ansible_facts": {"discovered_interpreter_python": "/usr/libexec/platform-python"},"changed": false,"ping": "pong"}</span><br><span class="line">ubuntu1 | SUCCESS =&gt; {"ansible_facts": {"discovered_interpreter_python": "/usr/bin/python3"},"changed": false,"ping": "pong"}</span><br><span class="line">ubuntu2 | SUCCESS =&gt; {"ansible_facts": {"discovered_interpreter_python": "/usr/bin/python3"},"changed": false,"ping": "pong"}</span><br><span class="line">ubuntu3 | SUCCESS =&gt; {"ansible_facts": {"discovered_interpreter_python": "/usr/bin/python3"},"changed": false,"ping": "pong"}</span><br></pre></td></tr></tbody></table></figure><p><strong>json清单文件</strong></p><p>使用python根据<strong>hosts.yaml</strong>生成清单文件 <strong>hosts.json</strong> （前提是已安装python3）:</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~/demo01$ python3 --version</span><br><span class="line">Python 3.10.6</span><br><span class="line">ansible@ubuntu-c:~/demo01$ python3 -c 'import sys, yaml, json; json.dump(yaml.load(sys.stdin, Loader=yaml.FullLoader), sys.stdout, indent=4)' &lt; hosts.yaml &gt; hosts.json</span><br><span class="line">ansible@ubuntu-c:~/demo01$ cat hosts.json </span><br><span class="line">{</span><br><span class="line">    "control": {</span><br><span class="line">        "hosts": {</span><br><span class="line">            "ubuntu-c": {</span><br><span class="line">                "ansible_connection": "local"</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    },</span><br><span class="line">    "centos": {</span><br><span class="line">        "hosts": {</span><br><span class="line">            "centos1": {</span><br><span class="line">                "ansible_port": 2222</span><br><span class="line">            },</span><br><span class="line">            "centos2": null,</span><br><span class="line">            "centos3": null</span><br><span class="line">        },</span><br><span class="line">        "vars": {</span><br><span class="line">            "ansible_user": "root"</span><br><span class="line">        }</span><br><span class="line">    },</span><br><span class="line">    "ubuntu": {</span><br><span class="line">        "hosts": {</span><br><span class="line">            "ubuntu1": null,</span><br><span class="line">            "ubuntu2": null,</span><br><span class="line">            "ubuntu3": null</span><br><span class="line">        },</span><br><span class="line">        "vars": {</span><br><span class="line">            "ansible_become": true,</span><br><span class="line">            "ansible_become_pass": "password"</span><br><span class="line">        }</span><br><span class="line">    },</span><br><span class="line">    "linux": {</span><br><span class="line">        "children": {</span><br><span class="line">            "centos": null,</span><br><span class="line">            "ubuntu": null</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>将清单改为json类型，只需修改配置文件 <strong>ansible.cfg</strong> :</p><figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">[defaults]</span></span><br><span class="line"><span class="attr">inventory</span> = hosts.json</span><br><span class="line"><span class="attr">host_key_checking</span> = <span class="literal">False</span></span><br></pre></td></tr></tbody></table></figure><p>再次进行测试：</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~/demo01$ ansible centos -m ping -o</span><br><span class="line">centos1 | SUCCESS =&gt; {"ansible_facts": {"discovered_interpreter_python": "/usr/libexec/platform-python"},"changed": false,"ping": "pong"}</span><br><span class="line">centos3 | SUCCESS =&gt; {"ansible_facts": {"discovered_interpreter_python": "/usr/libexec/platform-python"},"changed": false,"ping": "pong"}</span><br><span class="line">centos2 | SUCCESS =&gt; {"ansible_facts": {"discovered_interpreter_python": "/usr/libexec/platform-python"},"changed": false,"ping": "pong"}</span><br></pre></td></tr></tbody></table></figure><p><strong>命令行工具参数</strong></p><p>也可以使用ansible命令行工具参数，指定清单文件运行，如：</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> ansible</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -i 指定清单文件，会覆盖配置文件的inventory参数</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -e 指定清单命令，会覆盖清单文件对应的变量</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -m 指定模块，默认使用<span class="built_in">command</span>模块</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> -a 指定在被管理主机上执行的命令，命令需要使用引号</span></span><br><span class="line">ansible@ubuntu-c:~/demo01$ ansible all -i hosts.yaml --list-hosts</span><br><span class="line">  hosts (7):</span><br><span class="line">    ubuntu-c</span><br><span class="line">    centos1</span><br><span class="line">    centos2</span><br><span class="line">    centos3</span><br><span class="line">    ubuntu1</span><br><span class="line">    ubuntu2</span><br><span class="line">    ubuntu3</span><br><span class="line">    </span><br><span class="line">ansible@ubuntu-c:~/demo01$ ansible linux -m ping -e 'ansible_port=22' -o</span><br><span class="line">centos1 | UNREACHABLE!: Failed to connect to the host via ssh: ssh: connect to host centos1 port 22: Connection refused</span><br><span class="line">centos2 | SUCCESS =&gt; {"ansible_facts": {"discovered_interpreter_python": "/usr/libexec/platform-python"},"changed": false,"ping": "pong"}</span><br><span class="line">centos3 | SUCCESS =&gt; {"ansible_facts": {"discovered_interpreter_python": "/usr/libexec/platform-python"},"changed": false,"ping": "pong"}</span><br><span class="line">ubuntu1 | SUCCESS =&gt; {"ansible_facts": {"discovered_interpreter_python": "/usr/bin/python3"},"changed": false,"ping": "pong"}</span><br><span class="line">ubuntu2 | SUCCESS =&gt; {"ansible_facts": {"discovered_interpreter_python": "/usr/bin/python3"},"changed": false,"ping": "pong"}</span><br><span class="line">ubuntu3 | SUCCESS =&gt; {"ansible_facts": {"discovered_interpreter_python": "/usr/bin/python3"},"changed": false,"ping": "pong"}</span><br><span class="line"></span><br><span class="line">ansible@ubuntu-c:~/demo01$ ansible ubuntu -a 'id' -o</span><br><span class="line">ubuntu1 | CHANGED | rc=0 | (stdout) uid=0(root) gid=0(root) groups=0(root)</span><br><span class="line">ubuntu3 | CHANGED | rc=0 | (stdout) uid=0(root) gid=0(root) groups=0(root)</span><br><span class="line">ubuntu2 | CHANGED | rc=0 | (stdout) uid=0(root) gid=0(root) groups=0(root)</span><br></pre></td></tr></tbody></table></figure><h3 id="3-3-Ansible模块">3.3 Ansible模块</h3><p><strong>执行期间颜色含义</strong></p><ul><li><font color="Red">红色</font> —— 代表失败</li><li><font color="yellow">黄色</font> —— 代表成功，有改变</li><li><font color="Green">绿色</font> —— 代表成功，无改变</li></ul><p><strong>幂等性</strong></p><p>幂等性指多次执行产生的结果不会发生改变，ansible的大部分模块都能够保持操作的幂等性，即相关操作的多次执行能够达到相同结果，但也有不满足幂等性原则的模块，比如shell模块和raw模块。</p><p><strong><a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/setup_module.html">setup模块</a></strong></p><p>setup模块自动被剧本调用，收集远程主机的基本信息，随后可以在剧本中使用，可以使用ansible命令直接调用该模块查看目标的信息</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~/demo01$ ansible centos1 -m setup | more</span><br></pre></td></tr></tbody></table></figure><p><strong><a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/file_module.html">file模块</a></strong></p><p>file模块用于文件管理操作，包括文件/文件夹/链接文件的增删改查，其他模块如copy、template、assemble也可进行文件管理操作，对于windows目标系统，则需要使用win_file模块。</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建文件</span></span><br><span class="line">ansible@ubuntu-c:~/demo01$ ansible all -m file -a 'path=/tmp/test state=touch'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 修改文件权限</span></span><br><span class="line">ansible@ubuntu-c:~/demo01$ ansible all -m file -a 'path=/tmp/test state=file mode=600'</span><br></pre></td></tr></tbody></table></figure><p><strong><a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/copy_module.html">copy模块</a></strong></p><p>copy模块作用是复制文件，通常用于将ansible管理主机上的文件拷贝到远程主机中，也可以将远程主机的文件拷贝到远程主机</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 拷贝管理主机上的文件到远程主机中</span></span><br><span class="line">ansible@ubuntu-c:~/demo01$ ansible all -m copy -a 'src=/tmp/x dest=/tmp/x'</span><br><span class="line"><span class="meta">#</span><span class="bash"> 拷贝远程主机上的文件到远程主机中</span></span><br><span class="line">ansible@ubuntu-c:~/demo01$ ansible all -m copy -a 'remote_src=yes src=/tmp/x dest=/tmp/y'</span><br></pre></td></tr></tbody></table></figure><p><strong><a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/fetch_module.html">fetch模块</a></strong></p><p>fetch模块作用也是复制文件，通常用于将到远程主机上的文件拷贝到ansible管理主机上</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建文件</span></span><br><span class="line">ansible@ubuntu-c:~/demo01$ ansible all -m file -a 'path=/tmp/test_modules.txt state=touch mode=600' -o</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 远程文件拷贝到本地</span></span><br><span class="line">ansible@ubuntu-c:~/demo01$ ansible all -m fetch -a 'src=/tmp/test_modules.txt dest=/tmp/' -o</span><br></pre></td></tr></tbody></table></figure><p><strong><a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/command_module.html">command模块</a></strong></p><p>command模块是ansible的默认基本模块，也可以省略不写，但是使用command模块，不得出现shell变量，如<code>$name</code>，也不得出现特殊符号<code>&gt; &lt; | ; &amp;</code>，如果需要使用，请使用<code>shell</code>模块</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 所有主机执行 hostname 命令</span></span><br><span class="line">ansible@ubuntu-c:~/demo01$ ansible all -a 'hostname' -o</span><br><span class="line">ubuntu-c | CHANGED | rc=0 | (stdout) ubuntu-c</span><br><span class="line">centos1 | CHANGED | rc=0 | (stdout) centos1</span><br><span class="line">centos2 | CHANGED | rc=0 | (stdout) centos2</span><br><span class="line">ubuntu1 | CHANGED | rc=0 | (stdout) ubuntu1</span><br><span class="line">centos3 | CHANGED | rc=0 | (stdout) centos3</span><br><span class="line">ubuntu2 | CHANGED | rc=0 | (stdout) ubuntu2</span><br><span class="line">ubuntu3 | CHANGED | rc=0 | (stdout) ubuntu3</span><br></pre></td></tr></tbody></table></figure><p><strong><a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/shell_module.html">shell模块</a></strong></p><p>shell模块作用是在远程主机上执行命令</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 远程主机执行 ps -ef | grep vim 命令</span></span><br><span class="line">ansible@ubuntu-c:~/demo01$ ansible linux -m shell -a 'ps -ef | grep vim' -o</span><br><span class="line">centos1 | CHANGED | rc=0 | (stdout) root         864     863  0 07:33 pts/0    00:00:00 /bin/sh -c ps -ef | grep vim\nroot         866     864  0 07:33 pts/0    00:00:00 grep vim</span><br><span class="line">centos2 | CHANGED | rc=0 | (stdout) root         769     768  0 07:33 pts/0    00:00:00 /bin/sh -c ps -ef | grep vim\nroot         771     769  0 07:33 pts/0    00:00:00 grep vim</span><br><span class="line">centos3 | CHANGED | rc=0 | (stdout) root         682     681  0 07:33 pts/0    00:00:00 /bin/sh -c ps -ef | grep vim\nroot         684     682  0 07:33 pts/0    00:00:00 grep vim</span><br><span class="line">ubuntu2 | CHANGED | rc=0 | (stdout) root        1338    1337  0 07:33 pts/1    00:00:00 /bin/sh -c ps -ef | grep vim\nroot        1340    1338  0 07:33 pts/1    00:00:00 grep vim</span><br><span class="line">ubuntu1 | CHANGED | rc=0 | (stdout) root        1345    1344  0 07:33 pts/1    00:00:00 /bin/sh -c ps -ef | grep vim\nroot        1347    1345  0 07:33 pts/1    00:00:00 grep vim</span><br><span class="line">ubuntu3 | CHANGED | rc=0 | (stdout) root        1335    1334  0 07:33 pts/1    00:00:00 /bin/sh -c ps -ef | grep vim\nroot        1337    1335  0 07:33 pts/1    00:00:00 grep vim</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p><strong><a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/script_module.html">script模块</a></strong></p><p>script模块的作用是在远程主机上执行ansible管理主机上的脚本，脚本存在ansible管理主机上，不需要手动拷贝到远程主机后再执行</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 创建脚本</span></span><br><span class="line">ansible@ubuntu-c:~/demo01$ cat show_pwd.sh </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">pwd</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 去/tmp目录下 批量执行脚本</span></span><br><span class="line">ansible@ubuntu-c:~/demo01$ ansible all -m script -a 'chdir=/tmp /home/ansible/demo01/show_pwd.sh' -o</span><br><span class="line">ubuntu-c | CHANGED =&gt; {"changed": true,"rc": 0,"stderr": "","stderr_lines": [],"stdout": "/tmp\n","stdout_lines": ["/tmp"]}</span><br><span class="line">centos1 | CHANGED =&gt; {"changed": true,"rc": 0,"stderr": "Shared connection to centos1 closed.\r\n","stderr_lines": ["Shared connection to centos1 closed."],"stdout": "/tmp\r\n","stdout_lines": ["/tmp"]}</span><br><span class="line">centos2 | CHANGED =&gt; {"changed": true,"rc": 0,"stderr": "Shared connection to centos2 closed.\r\n","stderr_lines": ["Shared connection to centos2 closed."],"stdout": "/tmp\r\n","stdout_lines": ["/tmp"]}</span><br><span class="line">centos3 | CHANGED =&gt; {"changed": true,"rc": 0,"stderr": "Shared connection to centos3 closed.\r\n","stderr_lines": ["Shared connection to centos3 closed."],"stdout": "/tmp\r\n","stdout_lines": ["/tmp"]}</span><br><span class="line">ubuntu1 | CHANGED =&gt; {"changed": true,"rc": 0,"stderr": "Shared connection to ubuntu1 closed.\r\n","stderr_lines": ["Shared connection to ubuntu1 closed."],"stdout": "\r\n/tmp\r\n","stdout_lines": ["","/tmp"]}</span><br><span class="line">ubuntu2 | CHANGED =&gt; {"changed": true,"rc": 0,"stderr": "Shared connection to ubuntu2 closed.\r\n","stderr_lines": ["Shared connection to ubuntu2 closed."],"stdout": "\r\n/tmp\r\n","stdout_lines": ["","/tmp"]}</span><br><span class="line">ubuntu3 | CHANGED =&gt; {"changed": true,"rc": 0,"stderr": "Shared connection to ubuntu3 closed.\r\n","stderr_lines": ["Shared connection to ubuntu3 closed."],"stdout": "\r\n/tmp\r\n","stdout_lines": ["","/tmp"]}</span><br></pre></td></tr></tbody></table></figure><p><strong>Ansible-doc</strong></p><p>适合用于查看指定模块的变量和语法</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~/demo01$ ansible-doc shell</span><br></pre></td></tr></tbody></table></figure><h2 id="4-Ansible-Playbook介绍">4. Ansible Playbook介绍</h2><blockquote><p>YAML，Playbook剧本，变量，Facts 变量， Jinja2模板，Playbook的编写和执行</p></blockquote><h3 id="4-1-YAML">4.1 YAML</h3><p>YAML是一种面向数据的语言，ansible剧本可以使用YAML和json编写，使用YAML编写的剧本具有易读易写的特性，便于分享合作。</p><p>编写yaml文件<strong>test.yaml</strong></p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># YAML文件开始于3个 - (短横线)</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="comment"># 字符串</span></span><br><span class="line"><span class="attr">example_key_1:</span> <span class="string">this</span> <span class="string">is</span> <span class="string">a</span> <span class="string">string</span></span><br><span class="line"><span class="attr">example_key_2:</span> <span class="string">this</span> <span class="string">is</span> <span class="string">another</span> <span class="string">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 单引号和双引号</span></span><br><span class="line"><span class="attr">no_quotes:</span> <span class="string">this</span> <span class="string">is</span> <span class="string">a</span> <span class="string">string</span> <span class="string">example</span></span><br><span class="line"><span class="attr">double_quotes:</span> <span class="string">"this is a string example"</span></span><br><span class="line"><span class="attr">single_quotes:</span> <span class="string">'this is a string example'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 转义字符</span></span><br><span class="line"><span class="attr">escape_no_quotes:</span> <span class="string">this</span> <span class="string">is</span> <span class="string">a</span> <span class="string">string</span> <span class="string">example\n</span></span><br><span class="line"><span class="attr">escape_double_quotes:</span> <span class="string">"this is a string example\n"</span></span><br><span class="line"><span class="attr">escape_single_quotes:</span> <span class="string">'this is a string example\n'</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 多行</span></span><br><span class="line"><span class="attr">multilines_example_key_1:</span> <span class="string">|</span></span><br><span class="line"><span class="string">  this is a string</span></span><br><span class="line"><span class="string">  that goes over</span></span><br><span class="line"><span class="string">  multiple lines</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="attr">multilines_example_key_2:</span> <span class="string">&gt;</span></span><br><span class="line"><span class="string">  this is a string</span></span><br><span class="line"><span class="string">  that goes over</span></span><br><span class="line"><span class="string">  multiple lines</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="attr">multilines_example_key_3:</span> <span class="string">&gt;-</span></span><br><span class="line"><span class="string">  this is a string</span></span><br><span class="line"><span class="string">  that goes over</span></span><br><span class="line"><span class="string">  multiple lines</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="comment"># 数字</span></span><br><span class="line"><span class="attr">example_integer_1:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="attr">example_integer_2:</span> <span class="string">"1"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 真与假</span></span><br><span class="line"><span class="comment"># false, False, FALSE, no, No, NO, off, Off, OFF</span></span><br><span class="line"><span class="comment"># true, True, TRUE, yes, Yes, YES, on, On, ON</span></span><br><span class="line"><span class="comment"># n不等于假，y不等于真</span></span><br><span class="line"></span><br><span class="line"><span class="attr">is_false_01:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">is_false_02:</span> <span class="literal">False</span></span><br><span class="line"><span class="attr">is_false_03:</span> <span class="literal">FALSE</span></span><br><span class="line"><span class="attr">is_false_04:</span> <span class="literal">no</span></span><br><span class="line"><span class="attr">is_false_05:</span> <span class="literal">No</span></span><br><span class="line"><span class="attr">is_false_06:</span> <span class="literal">NO</span></span><br><span class="line"><span class="attr">is_false_07:</span> <span class="string">off</span></span><br><span class="line"><span class="attr">is_false_08:</span> <span class="string">Off</span></span><br><span class="line"><span class="attr">is_false_09:</span> <span class="string">OFF</span></span><br><span class="line"><span class="attr">is_false_10:</span> <span class="string">n</span></span><br><span class="line"><span class="attr">is_true_01:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">is_true_02:</span> <span class="literal">True</span></span><br><span class="line"><span class="attr">is_true_03:</span> <span class="literal">TRUE</span></span><br><span class="line"><span class="attr">is_true_04:</span> <span class="literal">yes</span></span><br><span class="line"><span class="attr">is_true_05:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="attr">is_true_06:</span> <span class="literal">YES</span></span><br><span class="line"><span class="attr">is_true_07:</span> <span class="string">on</span></span><br><span class="line"><span class="attr">is_true_08:</span> <span class="string">On</span></span><br><span class="line"><span class="attr">is_true_09:</span> <span class="string">ON</span></span><br><span class="line"><span class="attr">is_true_10:</span> <span class="string">y</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 列表，内联列表和内联字典不能同时存在，所以此处注释掉</span></span><br><span class="line"><span class="comment"># - item 1</span></span><br><span class="line"><span class="comment"># - item 2</span></span><br><span class="line"><span class="comment"># - item 3</span></span><br><span class="line"><span class="comment"># - item 4</span></span><br><span class="line"><span class="comment"># - item 5</span></span><br><span class="line"></span><br><span class="line"><span class="attr">example_key_4:</span> [<span class="string">item</span> <span class="number">1</span>, <span class="string">item</span> <span class="number">2</span>, <span class="string">item</span> <span class="number">3</span>, <span class="string">item</span> <span class="number">4</span>, <span class="string">item</span> <span class="number">5</span>]  </span><br><span class="line"></span><br><span class="line"><span class="comment"># 字典</span></span><br><span class="line"><span class="attr">example_key_5:</span> <span class="string">example_key_5</span></span><br><span class="line"><span class="attr">example_key_6:</span> <span class="string">example_key_6</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 下面这种字典表示方法不常用</span></span><br><span class="line"><span class="comment"># {example_key_7: example_key_7, example_key_8: example_key_8}</span></span><br><span class="line"><span class="comment"># 嵌套字典</span></span><br><span class="line"><span class="attr">example_key_9:</span></span><br><span class="line">  <span class="attr">example_key_10:</span> <span class="string">sub_example_value1</span></span><br><span class="line"><span class="attr">example_key_11:</span></span><br><span class="line">  <span class="attr">example_key_12:</span> <span class="string">sub_example_value2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 嵌套列表</span></span><br><span class="line"><span class="attr">example_key_13:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">item_1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">item_2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">item_3</span></span><br><span class="line"><span class="attr">exmaple_key_14:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">item_4</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">item_5</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">item_6</span></span><br><span class="line">  </span><br><span class="line"><span class="comment"># 多级嵌套</span></span><br><span class="line"><span class="attr">example_dictionary_1:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">example_dictioanry_2:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">3</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">example_dictionary_3:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">4</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">5</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">6</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">example_dictioanry_4:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">7</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">8</span></span><br><span class="line">    <span class="bullet">-</span> <span class="number">9</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># YAML文件结束语3个 . (点)</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>编写展示脚本<strong>show_yaml_python.sh</strong></p><figure class="highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">python3 -c <span class="string">'import yaml,pprint;pprint.pprint(yaml.load(open("test.yaml").read(), Loader=yaml.FullLoader))'</span></span><br></pre></td></tr></tbody></table></figure><p>测试：</p><figure class="highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~/demo02$ chmod +x show_yaml_python.sh </span><br><span class="line">ansible@ubuntu-c:~/demo02$ ./show_yaml_python.sh </span><br><span class="line">{<span class="string">'double_quotes'</span>: <span class="string">'this is a string example'</span>,</span><br><span class="line"> <span class="string">'escape_double_quotes'</span>: <span class="string">'this is a string example\n'</span>,</span><br><span class="line"> <span class="string">'escape_no_quotes'</span>: <span class="string">'this is a string example\\n'</span>,</span><br><span class="line"> <span class="string">'escape_single_quotes'</span>: <span class="string">'this is a string example\\n'</span>,</span><br><span class="line"> <span class="string">'example_dictionary_1'</span>: [{<span class="string">'example_dictioanry_2'</span>: [1, 2, 3]},</span><br><span class="line">                          {<span class="string">'example_dictionary_3'</span>: [4, 5, 6]},</span><br><span class="line">                          {<span class="string">'example_dictioanry_4'</span>: [7, 8, 9]}],</span><br><span class="line"> <span class="string">'example_integer_1'</span>: 1,</span><br><span class="line"> <span class="string">'example_integer_2'</span>: <span class="string">'1'</span>,</span><br><span class="line"> <span class="string">'example_key_1'</span>: <span class="string">'this is a string'</span>,</span><br><span class="line"> <span class="string">'example_key_11'</span>: {<span class="string">'example_key_12'</span>: <span class="string">'sub_example_value2'</span>},</span><br><span class="line"> <span class="string">'example_key_13'</span>: [<span class="string">'item_1'</span>, <span class="string">'item_2'</span>, <span class="string">'item_3'</span>],</span><br><span class="line"> <span class="string">'example_key_2'</span>: <span class="string">'this is another string'</span>,</span><br><span class="line"> <span class="string">'example_key_4'</span>: [<span class="string">'item 1'</span>, <span class="string">'item 2'</span>, <span class="string">'item 3'</span>, <span class="string">'item 4'</span>, <span class="string">'item 5'</span>],</span><br><span class="line"> <span class="string">'example_key_5'</span>: <span class="string">'example_key_5'</span>,</span><br><span class="line"> <span class="string">'example_key_6'</span>: <span class="string">'example_key_6'</span>,</span><br><span class="line"> <span class="string">'example_key_9'</span>: {<span class="string">'example_key_10'</span>: <span class="string">'sub_example_value1'</span>},</span><br><span class="line"> <span class="string">'exmaple_key_14'</span>: [<span class="string">'item_4'</span>, <span class="string">'item_5'</span>, <span class="string">'item_6'</span>],</span><br><span class="line"> <span class="string">'is_false_01'</span>: False,</span><br><span class="line"> <span class="string">'is_false_02'</span>: False,</span><br><span class="line"> <span class="string">'is_false_03'</span>: False,</span><br><span class="line"> <span class="string">'is_false_04'</span>: False,</span><br><span class="line"> <span class="string">'is_false_05'</span>: False,</span><br><span class="line"> <span class="string">'is_false_06'</span>: False,</span><br><span class="line"> <span class="string">'is_false_07'</span>: False,</span><br><span class="line"> <span class="string">'is_false_08'</span>: False,</span><br><span class="line"> <span class="string">'is_false_09'</span>: False,</span><br><span class="line"> <span class="string">'is_false_10'</span>: <span class="string">'n'</span>,</span><br><span class="line"> <span class="string">'is_true_01'</span>: True,</span><br><span class="line"> <span class="string">'is_true_02'</span>: True,</span><br><span class="line"> <span class="string">'is_true_03'</span>: True,</span><br><span class="line"> <span class="string">'is_true_04'</span>: True,</span><br><span class="line"> <span class="string">'is_true_05'</span>: True,</span><br><span class="line"> <span class="string">'is_true_06'</span>: True,</span><br><span class="line"> <span class="string">'is_true_07'</span>: True,</span><br><span class="line"> <span class="string">'is_true_08'</span>: True,</span><br><span class="line"> <span class="string">'is_true_09'</span>: True,</span><br><span class="line"> <span class="string">'is_true_10'</span>: <span class="string">'y'</span>,</span><br><span class="line"> <span class="string">'multilines_example_key_1'</span>: <span class="string">'this is a string\n'</span></span><br><span class="line">                             <span class="string">'that goes over\n'</span></span><br><span class="line">                             <span class="string">'multiple lines\n'</span>,</span><br><span class="line"> <span class="string">'multilines_example_key_2'</span>: <span class="string">'this is a string that goes over multiple lines\n'</span>,</span><br><span class="line"> <span class="string">'multilines_example_key_3'</span>: <span class="string">'this is a string that goes over multiple lines'</span>,</span><br><span class="line"> <span class="string">'no_quotes'</span>: <span class="string">'this is a string example'</span>,</span><br><span class="line"> <span class="string">'single_quotes'</span>: <span class="string">'this is a string example'</span>}</span><br></pre></td></tr></tbody></table></figure><p><strong>YAML学习资源</strong></p><ul><li>YAML 标准 - <a target="_blank" rel="noopener" href="https://yaml.org/spec/1.2.2/">https://yaml.org/spec/1.2.2/</a></li><li>维基百科 YAML词条 - <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/YAML">https://zh.wikipedia.org/wiki/YAML</a></li><li>stackoverflow 关于YAML多行的问题讨论 - <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/3790454/how-do-i-break-a-string-in-yaml-over-multiple-lines">https://stackoverflow.com/questions/3790454/how-do-i-break-a-string-in-yaml-over-multiple-lines</a></li></ul><h3 id="4-2-初识剧本">4.2 初识剧本</h3><p>先通过例子来熟悉下Ansible Playbook剧本。</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 新建文件夹并进入</span></span><br><span class="line">ansible@ubuntu-c:~$ mkdir demo03 &amp;&amp; cd demo03</span><br><span class="line"><span class="meta">#</span><span class="bash"> 创建配置文件和清单文件</span></span><br><span class="line">ansible@ubuntu-c:~/demo03$ touch ansible.cfg hosts motd_playbook.yaml</span><br></pre></td></tr></tbody></table></figure><p>配置文件 <strong>ansible.cfg</strong>:</p><figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">[defaults]</span></span><br><span class="line"><span class="attr">inventory</span> = hosts</span><br><span class="line"><span class="attr">host_key_checking</span> = <span class="literal">False</span></span><br></pre></td></tr></tbody></table></figure><p>清单文件 <strong>hosts</strong>:</p><figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">[control]</span></span><br><span class="line">ubuntu-c <span class="attr">ansible_connection</span>=local</span><br><span class="line"></span><br><span class="line"><span class="section">[centos]</span></span><br><span class="line">centos1 <span class="attr">ansible_port</span>=<span class="number">2222</span></span><br><span class="line">centos<span class="section">[2:3]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[centos:vars]</span></span><br><span class="line"><span class="attr">ansible_user</span>=root</span><br><span class="line"></span><br><span class="line"><span class="section">[ubuntu]</span></span><br><span class="line">ubuntu<span class="section">[1:3]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[ubuntu:vars]</span></span><br><span class="line"><span class="attr">ansible_become</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">ansible_become_pass</span>=password</span><br><span class="line"></span><br><span class="line"><span class="section">[linux:children]</span></span><br><span class="line">centos</span><br><span class="line">ubuntu</span><br></pre></td></tr></tbody></table></figure><p>剧本文件<strong>motd_playbook.yaml</strong>:</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># YAML文件开始于3个 - (短横线)</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="comment"># YAML中的减号表示列表项，剧本(playbook)包含戏剧(play)列表，每个戏剧都是字典数据类型</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="comment"># Hosts: 戏剧将在哪运行以及其他运行选项配置</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">centos</span></span><br><span class="line">  <span class="attr">user:</span> <span class="string">root</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Vars: 将在所有目标系统上应用的戏剧变量</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">motd:</span> <span class="string">"Welcome to CentOS Linux - Ansible Rocks\n"</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Tasks: 将在戏剧中执行的任务列表，此部分也可用于前置和后置任务</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">a</span> <span class="string">MOTD</span> <span class="string">(message</span> <span class="string">of</span> <span class="string">day)</span></span><br><span class="line">      <span class="comment"># 将motd变量的内容复制到远程cento主机的/etc/motd文件</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">content:</span> <span class="string">"<span class="template-variable">{{ motd }}</span>"</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/motd</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Handlers: 作为任务的通知键处理程序列表</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Roles: 导入戏剧中的角色列表</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># YAML文件结束语3个 . (点)</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>测试：</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~/demo03$ ansible-playbook  motd_playbook.yaml </span><br><span class="line"></span><br><span class="line">PLAY [centos] *******************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] **********************************************************************************************************</span><br><span class="line">ok: [centos2]</span><br><span class="line">ok: [centos3]</span><br><span class="line">ok: [centos1]</span><br><span class="line"></span><br><span class="line">TASK [Configure a MOTD (message of the day)] ************************************************************************************</span><br><span class="line">changed: [centos1]</span><br><span class="line">changed: [centos2]</span><br><span class="line">changed: [centos3]</span><br><span class="line"></span><br><span class="line">PLAY RECAP **********************************************************************************************************************</span><br><span class="line">centos1                    : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">centos2                    : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">centos3                    : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 </span><br></pre></td></tr></tbody></table></figure><p>其中，TASK [Gathering Facts] 是默认执行的任务，通过setup模块收集目标系统的Facts变量。所以，虽然只定义了1个任务，但是每个目标主机都执行了2个任务。</p><p>上面定义了变量<strong>motd</strong>，在执行时也可以通过<code>-e 'motd="Testing the motd playbook\n"'</code>重写</p><p>登录任意centos系统，可以看到：</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">centos1 login: ansible</span><br><span class="line">Password: </span><br><span class="line">Last login: Tue Jun 20 03:15:36 from 172.19.0.3</span><br><span class="line">Welcome to CentOS Linux - Ansible Rocks</span><br><span class="line">ansible@centos1:~$</span><br></pre></td></tr></tbody></table></figure><p>修改剧本文件，添加任务的通知键及处理程序：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># YAML文件开始于3个 - (短横线)</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="comment"># YAML中的减号表示列表项，剧本(playbook)包含戏剧(play)列表，每个戏剧都是字典数据类型</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="comment"># Hosts: 戏剧将在哪运行以及其他执行选项配置</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">centos</span></span><br><span class="line">  <span class="attr">user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Vars: 将在所有目标系统上应用的戏剧变量</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">motd:</span> <span class="string">"Welcome to CentOS Linux - Ansible Rocks\n"</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Tasks: 将在戏剧中执行的任务列表，此部分也可用于前置和后置任务</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">a</span> <span class="string">MOTD</span> <span class="string">(message</span> <span class="string">of</span> <span class="string">day)</span></span><br><span class="line">      <span class="comment"># 将motd变量的内容复制到远程cento主机的/etc/motd路径</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">content:</span> <span class="string">"<span class="template-variable">{{ motd }}</span>"</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/motd</span></span><br><span class="line">      <span class="comment"># 设置任务的通知键</span></span><br><span class="line">      <span class="attr">notify:</span> <span class="string">MOTD</span> <span class="string">changed</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Handlers: 作为任务的通知键处理程序列表</span></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MOTD</span> <span class="string">changed</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">The</span> <span class="string">MOTD</span> <span class="string">was</span> <span class="string">changed</span></span><br><span class="line">  <span class="comment"># Roles: 导入剧本中的角色列表</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># YAML文件结束语3个 . (点)</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>gather_facts —— 默认为True，设置为False时不执行默认的TASK [Gathering Facts] 任务</p><p>测试：</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~/demo03$ ansible-playbook motd_playbook.yaml</span><br><span class="line"></span><br><span class="line">PLAY [centos] *******************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Configure a MOTD (message of day)] ****************************************************************************************</span><br><span class="line">changed: [centos2]</span><br><span class="line">changed: [centos1]</span><br><span class="line">changed: [centos3]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [MOTD changed] **************************************************************************************************</span><br><span class="line">ok: [centos1] =&gt; {</span><br><span class="line">    "msg": "The MOTD was changed"</span><br><span class="line">}</span><br><span class="line">ok: [centos2] =&gt; {</span><br><span class="line">    "msg": "The MOTD was changed"</span><br><span class="line">}</span><br><span class="line">ok: [centos3] =&gt; {</span><br><span class="line">    "msg": "The MOTD was changed"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PLAY RECAP **********************************************************************************************************************</span><br><span class="line">centos1                    : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">centos2                    : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">centos3                    : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></tbody></table></figure><p>因为MOTD任务更改了，通知键的处理程序 RUNNING HANDLER [MOTD changed] 任务也执行了，调试输出<strong>msg: The MOTD was changed</strong>，并且 <strong>ok=2</strong></p><p>利用系统信息的facts变量<strong>ansible_distribution</strong>，配合<strong>when</strong>指令来区分不同系统发行版，从而在不同系统上执行不同内容，修改剧本文件：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># YAML文件开始于3个 - (短横线)</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="comment"># YAML中的减号表示列表项，剧本(playbook)包含戏剧(play)列表，每个戏剧都是字典数据类型</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="comment"># Hosts: 戏剧将在哪运行以及其他执行选项配置</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">linux</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Vars: 将在所有目标系统上应用的戏剧变量</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">    <span class="attr">motd_centos:</span> <span class="string">"Welcome to CentOS Linux - Ansible Rocks\n"</span></span><br><span class="line">    <span class="attr">motd_ubuntu:</span> <span class="string">"Welcome to Ubuntu Linux - Ansible Rocks\n"</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Tasks: 将在戏剧中执行的任务列表，此部分也可用于前置和后置任务</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">a</span> <span class="string">MOTD</span> <span class="string">(message</span> <span class="string">of</span> <span class="string">day)</span></span><br><span class="line">      <span class="comment"># 将motd变量的内容复制到远程cento主机的/etc/motd路径</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">content:</span> <span class="string">"<span class="template-variable">{{ motd_centos }}</span>"</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/motd</span></span><br><span class="line">      <span class="comment"># 设置任务的通知键</span></span><br><span class="line">      <span class="attr">notify:</span> <span class="string">MOTD</span> <span class="string">changed</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_distribution</span> <span class="string">==</span> <span class="string">"CentOS"</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">a</span> <span class="string">MOTD</span> <span class="string">(message</span> <span class="string">of</span> <span class="string">day)</span></span><br><span class="line">      <span class="comment"># 将motd变量的内容复制到远程cento主机的/etc/motd路径</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">content:</span> <span class="string">"<span class="template-variable">{{ motd_ubuntu }}</span>"</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/motd</span></span><br><span class="line">      <span class="comment"># 设置任务的通知键</span></span><br><span class="line">      <span class="attr">notify:</span> <span class="string">MOTD</span> <span class="string">changed</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_distribution</span> <span class="string">==</span> <span class="string">"Ubuntu"</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment"># Handlers: 作为任务的通知键处理程序列表</span></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MOTD</span> <span class="string">changed</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">The</span> <span class="string">MOTD</span> <span class="string">was</span> <span class="string">changed</span></span><br><span class="line">  <span class="comment"># Roles: 导入剧本中的角色列表</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># YAML文件结束语3个 . (点)</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>测试：</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~/demo03$ ansible-playbook motd_playbook.yaml </span><br><span class="line"></span><br><span class="line">PLAY [linux] ********************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] **********************************************************************************************************</span><br><span class="line">ok: [centos3]</span><br><span class="line">ok: [centos1]</span><br><span class="line">ok: [centos2]</span><br><span class="line">ok: [ubuntu1]</span><br><span class="line">ok: [ubuntu2]</span><br><span class="line">ok: [ubuntu3]</span><br><span class="line"></span><br><span class="line">TASK [Configure a MOTD (message of day)] ****************************************************************************************</span><br><span class="line">skipping: [ubuntu1]</span><br><span class="line">skipping: [ubuntu2]</span><br><span class="line">skipping: [ubuntu3]</span><br><span class="line">ok: [centos3]</span><br><span class="line">ok: [centos1]</span><br><span class="line">ok: [centos2]</span><br><span class="line"></span><br><span class="line">TASK [Configure a MOTD (message of day)] ****************************************************************************************</span><br><span class="line">skipping: [centos1]</span><br><span class="line">skipping: [centos2]</span><br><span class="line">skipping: [centos3]</span><br><span class="line">changed: [ubuntu1]</span><br><span class="line">changed: [ubuntu3]</span><br><span class="line">changed: [ubuntu2]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [MOTD changed] **************************************************************************************************</span><br><span class="line">ok: [ubuntu1] =&gt; {</span><br><span class="line">    "msg": "The MOTD was changed"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu2] =&gt; {</span><br><span class="line">    "msg": "The MOTD was changed"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu3] =&gt; {</span><br><span class="line">    "msg": "The MOTD was changed"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PLAY RECAP **********************************************************************************************************************</span><br><span class="line">centos1                    : ok=2    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span><br><span class="line">centos2                    : ok=2    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span><br><span class="line">centos3                    : ok=2    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span><br><span class="line">ubuntu1                    : ok=3    changed=1    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span><br><span class="line">ubuntu2                    : ok=3    changed=1    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span><br><span class="line">ubuntu3                    : ok=3    changed=1    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0</span><br></pre></td></tr></tbody></table></figure><p>点击查看更多的剧本关键字：<a target="_blank" rel="noopener" href="http://docs.ansible.com/ansible/devel/playbooks_keywords.html">http://docs.ansible.com/ansible/devel/playbooks_keywords.html</a></p><h3 id="4-3-剧本变量">4.3 剧本变量</h3><p>新建变量文件<strong>external_vars.yaml</strong></p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">external_example_key:</span> <span class="string">example</span> <span class="string">value</span></span><br><span class="line"></span><br><span class="line"><span class="attr">external_dict:</span></span><br><span class="line">   <span class="attr">dict_key:</span> <span class="string">This</span> <span class="string">is</span> <span class="string">a</span> <span class="string">dictionary</span> <span class="string">value</span></span><br><span class="line"></span><br><span class="line"><span class="attr">external_inline_dict:</span> </span><br><span class="line">   {<span class="attr">inline_dict_key:</span> <span class="string">This</span> <span class="string">is</span> <span class="string">an</span> <span class="string">inline</span> <span class="string">dictionary</span> <span class="string">value</span>}</span><br><span class="line"></span><br><span class="line"><span class="attr">external_named_list:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">item1</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">item2</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">item3</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">item4</span></span><br><span class="line"></span><br><span class="line"><span class="attr">external_inline_named_list:</span></span><br><span class="line">   [ <span class="string">item1</span>, <span class="string">item2</span>, <span class="string">item3</span>, <span class="string">item4</span> ]</span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>新建剧本variables_playbook.yaml</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line"> </span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">centos1</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line"> </span><br><span class="line">  <span class="comment"># 通过文件引入变量</span></span><br><span class="line">  <span class="attr">vars_files:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">external_vars.yaml</span></span><br><span class="line"> </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Test</span> <span class="string">external</span> <span class="string">dictionary</span> <span class="string">key</span> <span class="string">value</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">"<span class="template-variable">{{ external_example_key }}</span>"</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Test</span> <span class="string">external</span> <span class="string">named</span> <span class="string">dictionary</span> <span class="string">dictionary</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">"<span class="template-variable">{{ external_dict }}</span>"</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Test</span> <span class="string">external</span> <span class="string">named</span> <span class="string">dictionary</span> <span class="string">dictionary</span> <span class="string">key</span> <span class="string">value</span> <span class="string">with</span> <span class="string">dictionary</span> <span class="string">dot</span> <span class="string">notation</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">"<span class="template-variable">{{ external_dict.dict_key }}</span>"</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Test</span> <span class="string">external</span> <span class="string">named</span> <span class="string">dictionary</span> <span class="string">dictionary</span> <span class="string">key</span> <span class="string">value</span> <span class="string">with</span> <span class="string">brackets</span> <span class="string">notation</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">"<span class="template-variable">{{ external_dict['dict_key'] }}</span>"</span></span><br><span class="line"> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Test</span> <span class="string">external</span> <span class="string">named</span> <span class="string">inline</span> <span class="string">dictionary</span> <span class="string">dictionary</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">"<span class="template-variable">{{ external_inline_dict }}</span>"</span></span><br><span class="line"> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Test</span> <span class="string">external</span> <span class="string">named</span> <span class="string">inline</span> <span class="string">dictionary</span> <span class="string">dictionary</span> <span class="string">key</span> <span class="string">value</span> <span class="string">with</span> <span class="string">dictionary</span> <span class="string">dot</span> <span class="string">notation</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">"<span class="template-variable">{{ external_inline_dict.inline_dict_key }}</span>"</span></span><br><span class="line"> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Test</span> <span class="string">external</span> <span class="string">named</span> <span class="string">inline</span> <span class="string">dictionary</span> <span class="string">dictionary</span> <span class="string">key</span> <span class="string">value</span> <span class="string">with</span> <span class="string">brackets</span> <span class="string">notation</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">"<span class="template-variable">{{ external_inline_dict['inline_dict_key'] }}</span>"</span></span><br><span class="line"> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Test</span> <span class="string">external</span> <span class="string">named</span> <span class="string">list</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">"<span class="template-variable">{{ external_named_list }}</span>"</span></span><br><span class="line"> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Test</span> <span class="string">external</span> <span class="string">named</span> <span class="string">list</span> <span class="string">first</span> <span class="string">item</span> <span class="string">dot</span> <span class="string">notation</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">"<span class="template-variable">{{ external_named_list.0 }}</span>"</span></span><br><span class="line"> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Test</span> <span class="string">external</span> <span class="string">named</span> <span class="string">list</span> <span class="string">first</span> <span class="string">item</span> <span class="string">brackets</span> <span class="string">notation</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">"<span class="template-variable">{{ external_named_list[0] }}</span>"</span></span><br><span class="line"> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Test</span> <span class="string">external</span> <span class="string">inline</span> <span class="string">named</span> <span class="string">list</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">"<span class="template-variable">{{ external_inline_named_list }}</span>"</span></span><br><span class="line"> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Test</span> <span class="string">external</span> <span class="string">inline</span> <span class="string">named</span> <span class="string">list</span> <span class="string">first</span> <span class="string">item</span> <span class="string">dot</span> <span class="string">notation</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">"<span class="template-variable">{{ external_inline_named_list.0 }}</span>"</span></span><br><span class="line"> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Test</span> <span class="string">external</span> <span class="string">inline</span> <span class="string">named</span> <span class="string">list</span> <span class="string">first</span> <span class="string">item</span> <span class="string">brackets</span> <span class="string">notation</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">"<span class="template-variable">{{ external_inline_named_list[0] }}</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p><code>vars_files</code> —— 通过文件引入变量，如：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">vars_files:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="string">external_vars.yaml</span></span><br></pre></td></tr></tbody></table></figure><p><code>vars_prompt</code> —— 提示用户输入变量值，如：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">vars_promt:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">username</span></span><br><span class="line">    <span class="attr">private:</span> <span class="literal">False</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">password</span></span><br><span class="line">    <span class="attr">private:</span> <span class="literal">True</span></span><br></pre></td></tr></tbody></table></figure><p><code>hostvars[ansible_hostname]['ansible_port'] | default('22')</code> —— 获取主机的变量，如：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Test</span> <span class="string">hostvars</span> <span class="string">with</span> <span class="string">an</span> <span class="string">ansible</span> <span class="string">fact</span> <span class="string">and</span> <span class="string">collect</span> <span class="string">ansible_port,</span> <span class="string">dict</span> <span class="string">notation</span></span><br><span class="line">    <span class="attr">debug:</span></span><br><span class="line">      <span class="attr">msg:</span> <span class="string">"<span class="template-variable">{{ hostvars[ansible_hostname]['ansible_port'] | default('22') }}</span>"</span></span><br></pre></td></tr></tbody></table></figure><p>ansible-playbook通过<code>-e</code>传入变量值时有5种方式：</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1.通过ini格式传入</span></span><br><span class="line">ansible-playbook variable_playbook.yaml -e extra_vars_key="extra vars value"</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 2.通过json格式传入</span></span><br><span class="line">ansible-playbook variable_playbook.yaml -e {"extra_vars_key": "extra vars value"}</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 3.通过yaml格式传入</span></span><br><span class="line">ansible-playbook variable_playbook.yaml -e {extra_vars_key: extra vars value}</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 4.通过yaml文件传入</span></span><br><span class="line">ansible-playbook variable_playbook.yaml -e @extra_vars_file.yaml</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 5.通过json文件传入</span></span><br><span class="line">ansible-playbook variable_playbook.yaml -e @extra_vars_file.json</span><br></pre></td></tr></tbody></table></figure><p>另外，主机变量和组变量可以分布使用单独的yaml文件host_vars/centos1、host_vars/ubuntu-c和group_vars/centos、group_vars/ubuntu来保存和区分，而不是写在一个host文件里</p><p>hosts文件内容变为：</p><figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">[control]</span></span><br><span class="line">ubuntu-c</span><br><span class="line"></span><br><span class="line"><span class="section">[centos]</span></span><br><span class="line">centos<span class="section">[1:3]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[ubuntu]</span></span><br><span class="line">ubuntu<span class="section">[1:3]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[linux:children]</span></span><br><span class="line">centos</span><br><span class="line">ubuntu</span><br></pre></td></tr></tbody></table></figure><p>新建的host_vars/centos1内容为：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">ansible_port:</span> <span class="number">2222</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>新建的host_vars/ubuntu-c内容为：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">ansible_connection:</span> <span class="string">local</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>新建的group_vars/centos内容为：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">ansible_user:</span> <span class="string">root</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>新建的group_vars/ubuntu内容为：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">ansible_become:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">ansible_become_pass:</span> <span class="string">password</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><h3 id="4-4-使用和自定义Facts变量">4.4 使用和自定义Facts变量</h3><p>**Ansible Facts 是 Ansible 在被托管主机上自动收集的变量。**它是通过在执行 ad-hoc 以及 Playbook 时使用 setup 模块进行收集的，并且这个操作是默认的。</p><p>setup模块官方文档地址：<a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/setup_module.html">https://docs.ansible.com/ansible/latest/collections/ansible/builtin/setup_module.html</a></p><p>ad-hoc使用setup模块示例：</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 显示来自centos1主机所有关于network子集的facts变量</span></span><br><span class="line">ansible@ubuntu-c:~/demo03$ ansible centos1 -m setup -a 'gather_subset=network'</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 显示来自centos1主机特定network子集的facts变量</span></span><br><span class="line">ansible@ubuntu-c:~/demo03$ ansible centos1 -m setup -a 'gather_subset=!all,!min,network'</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用过滤器选项显示来自centos1主机facts变量 - ansible_memfree_mb</span> </span><br><span class="line">ansible@ubuntu-c:~/demo03$ ansible centos1 -m setup -a 'filter=ansible_memfree_mb'</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 使用过滤器选项+通配符显示来自centos1主机facts变量 - 包含ansible_mem 字段的变量</span> </span><br><span class="line">ansible@ubuntu-c:~/demo03$ ansible centos1 -m setup -a 'filter=ansible_mem*'</span><br></pre></td></tr></tbody></table></figure><p>ad-hoc命令模式中，setup模块收集的返回数据是字典结构，其中键为ansible_facts包含着收集到的facts变量，如：</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~/demo03$ ansible centos1 -m setup -a 'filter=ansible_mem*'</span><br><span class="line">centos1 | SUCCESS =&gt; {</span><br><span class="line">    "ansible_facts": {</span><br><span class="line">        "ansible_memfree_mb": 10619,</span><br><span class="line">        "ansible_memory_mb": {</span><br><span class="line">            "nocache": {</span><br><span class="line">                "free": 13976,</span><br><span class="line">                "used": 1882</span><br><span class="line">            },</span><br><span class="line">            "real": {</span><br><span class="line">                "free": 10619,</span><br><span class="line">                "total": 15858,</span><br><span class="line">                "used": 5239</span><br><span class="line">            },</span><br><span class="line">            "swap": {</span><br><span class="line">                "cached": 0,</span><br><span class="line">                "free": 4096,</span><br><span class="line">                "total": 4096,</span><br><span class="line">                "used": 0</span><br><span class="line">            }</span><br><span class="line">        },</span><br><span class="line">        "ansible_memtotal_mb": 15858,</span><br><span class="line">        "discovered_interpreter_python": "/usr/libexec/platform-python"</span><br><span class="line">    },</span><br><span class="line">    "changed": false</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>playbook剧本模式中，setup模块收集的返回数据是字典结构，没有ansible_facts键，可以直接用facts变量，如：</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~$ mkdir demo04 &amp;&amp; cd demo04</span><br><span class="line">ansible@ubuntu-c:~/demo04$ cp ../demo03/hosts .</span><br><span class="line">ansible@ubuntu-c:~/demo04$ cp ../demo03/ansible.cfg .</span><br><span class="line">ansible@ubuntu-c:~/demo04$ cat facts_playbook.yaml </span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">-</span><br><span class="line"></span><br><span class="line">  hosts: all</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: Show Ip Address</span><br><span class="line">      debug:</span><br><span class="line">        msg: "{{ ansible_default_ipv4.address }}"</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">ansible@ubuntu-c:~/demo04$ ansible-playbook facts_playbook.yaml </span><br><span class="line"></span><br><span class="line">PLAY [all] **********************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] **********************************************************************************************************</span><br><span class="line">ok: [ubuntu-c]</span><br><span class="line">ok: [centos2]</span><br><span class="line">ok: [centos1]</span><br><span class="line">ok: [centos3]</span><br><span class="line">ok: [ubuntu1]</span><br><span class="line">ok: [ubuntu2]</span><br><span class="line">ok: [ubuntu3]</span><br><span class="line"></span><br><span class="line">TASK [Show Ip Address] **********************************************************************************************************</span><br><span class="line">ok: [ubuntu-c] =&gt; {</span><br><span class="line">    "msg": "172.19.0.2"</span><br><span class="line">}</span><br><span class="line">ok: [centos1] =&gt; {</span><br><span class="line">    "msg": "172.19.0.7"</span><br><span class="line">}</span><br><span class="line">ok: [centos2] =&gt; {</span><br><span class="line">    "msg": "172.19.0.5"</span><br><span class="line">}</span><br><span class="line">ok: [centos3] =&gt; {</span><br><span class="line">    "msg": "172.19.0.8"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu1] =&gt; {</span><br><span class="line">    "msg": "172.19.0.9"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu2] =&gt; {</span><br><span class="line">    "msg": "172.19.0.4"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu3] =&gt; {</span><br><span class="line">    "msg": "172.19.0.3"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PLAY RECAP **********************************************************************************************************************</span><br><span class="line">centos1                    : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">centos2                    : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">centos3                    : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">ubuntu-c                   : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">ubuntu1                    : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">ubuntu2                    : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">ubuntu3                    : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br></pre></td></tr></tbody></table></figure><p><strong>创造自定义facts变量</strong></p><ul><li>能够使用任何语言编写</li><li>返回JSON结构或ini结构</li><li>默认放置在/etc/ansible/facts.d</li></ul><p>创建一个自定义facts变量用于收集系统日期信息：</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 自定义facts变量（返回JSON结构）</span></span><br><span class="line">ansible@ubuntu-c:~/demo04$ cat getdate1.fact </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">echo {\""date\"": \""`date`""}</span><br><span class="line">ansible@ubuntu-c:~/demo04$ chmod +x getdate1.fact </span><br><span class="line">ansible@ubuntu-c:~/demo04$ ./getdate1.fact</span><br><span class="line">{"date" : "Mon Jun 26 09:45:11 UTC 2023"}</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 自定义facts变量（返回ini结构）</span></span><br><span class="line">ansible@ubuntu-c:~/demo04$ cat getdate2.fact </span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">echo [date]</span><br><span class="line">echo date=`date`</span><br><span class="line">ansible@ubuntu-c:~/demo04$ chmod +x getdate2.fact </span><br><span class="line">ansible@ubuntu-c:~/demo04$ ./getdate2.fact</span><br><span class="line">[date]</span><br><span class="line">date=Mon Jun 26 09:47:31 UTC 2023</span><br><span class="line"></span><br><span class="line">ansible@ubuntu-c:~/demo04$ sudo mkdir -p /etc/ansible/facts.d</span><br><span class="line">ansible@ubuntu-c:~/demo04$ sudo cp getdate* /etc/ansible/facts.d/</span><br><span class="line">ansible@ubuntu-c:~/demo04$ ansible ubuntu-c -m setup -a 'filter=ansible_local'</span><br><span class="line">ubuntu-c | SUCCESS =&gt; {</span><br><span class="line">    "ansible_facts": {</span><br><span class="line">        "ansible_local": {</span><br><span class="line">            "getdate1": {</span><br><span class="line">                "date": "Mon Jun 26 09:53:15 UTC 2023"</span><br><span class="line">            },</span><br><span class="line">            "getdate2": {</span><br><span class="line">                "date": {</span><br><span class="line">                    "date": "Mon Jun 26 09:53:15 UTC 2023"</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        },</span><br><span class="line">        "discovered_interpreter_python": "/usr/bin/python3"</span><br><span class="line">    },</span><br><span class="line">    "changed": false</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><p>修改剧本facts_playbook.yaml，使用自定义的facts变量</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~/demo04$ cat facts_playbook.yaml </span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">-</span><br><span class="line"></span><br><span class="line">  hosts: all</span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: Show Ip Address</span><br><span class="line">      debug:</span><br><span class="line">        msg: "{{ ansible_default_ipv4.address }}"</span><br><span class="line"></span><br><span class="line">    - name: Show Custom Fact 1</span><br><span class="line">      debug:</span><br><span class="line">        msg: "{{ ansible_local.getdate1.date }}"</span><br><span class="line"></span><br><span class="line">    - name: Show Custom Fact 2</span><br><span class="line">      debug:</span><br><span class="line">        msg: "{{ ansible_local.getdate2.date.date  }}"</span><br><span class="line"></span><br><span class="line">...</span><br><span class="line">ansible@ubuntu-c:~/demo04$ ansible-playbook facts_playbook.yaml -l ubuntu-c</span><br><span class="line"></span><br><span class="line">PLAY [all] **********************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] **********************************************************************************************************</span><br><span class="line">ok: [ubuntu-c]</span><br><span class="line"></span><br><span class="line">TASK [Show Ip Address] **********************************************************************************************************</span><br><span class="line">ok: [ubuntu-c] =&gt; {</span><br><span class="line">    "msg": "172.19.0.2"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">TASK [Show Custom Fact 1] *******************************************************************************************************</span><br><span class="line">ok: [ubuntu-c] =&gt; {</span><br><span class="line">    "msg": "Mon Jun 26 09:58:49 UTC 2023"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">TASK [Show Custom Fact 2] *******************************************************************************************************</span><br><span class="line">ok: [ubuntu-c] =&gt; {</span><br><span class="line">    "msg": "Mon Jun 26 09:58:49 UTC 2023"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PLAY RECAP **********************************************************************************************************************</span><br><span class="line">ubuntu-c                   : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 </span><br></pre></td></tr></tbody></table></figure><p>目前自定义的facts变量只在ubuntu-c管理主机上生效，要想其他被管理主机也能使用自定义的facts变量，则可将自定义facts变量的文件拷贝到各自主机的/etc/ansible/facts.d目录下。</p><p>修改剧本facts_playbook.yaml：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">linux</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Make</span> <span class="string">Facts</span> <span class="string">Dir</span></span><br><span class="line">      <span class="attr">file:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/etc/ansible/facts.d</span></span><br><span class="line">        <span class="attr">recurse:</span> <span class="literal">yes</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Copy</span> <span class="string">Fact</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">/etc/ansible/facts.d/getdate1.fact</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/ansible/facts.d/getdate1.fact</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0755</span></span><br><span class="line">    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Copy</span> <span class="string">Fact</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">/etc/ansible/facts.d/getdate2.fact</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/etc/ansible/facts.d/getdate2.fact</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0755</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Refresh</span> <span class="string">Facts</span></span><br><span class="line">      <span class="attr">setup:</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Show</span> <span class="string">Ip</span> <span class="string">Address</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">"<span class="template-variable">{{ ansible_default_ipv4.address }}</span>"</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Show</span> <span class="string">Custom</span> <span class="string">Fact</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">"<span class="template-variable">{{ ansible_local.getdate1.date }}</span>"</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Show</span> <span class="string">Custom</span> <span class="string">Fact</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">"<span class="template-variable">{{ ansible_local.getdate2.date.date  }}</span>"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Show</span> <span class="string">Custom</span> <span class="string">Fact</span> <span class="number">1</span> <span class="string">in</span> <span class="string">hostvars</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">"<span class="template-variable">{{ hostvars[ansible_hostname].ansible_local.getdate1.date }}</span>"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Show</span> <span class="string">Custom</span> <span class="string">Fact</span> <span class="number">2</span> <span class="string">in</span> <span class="string">hostvars</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">"<span class="template-variable">{{ hostvars[ansible_hostname].ansible_local.getdate2.date.date }}</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>默认情况下，Ansible期望自定义facts变量文件位于需要root访问权限的位置/etc/ansible/facts.d，如何在没有root访问权限的环境中使用自定义facts变量。</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 首先删除被管理主机上的自定义facts变量文件</span></span><br><span class="line">ansible@ubuntu-c:~/demo04$ ansible linux -m file -a 'path=/etc/ansible/facts.d/getdate1.fact state=absent'</span><br><span class="line">ansible@ubuntu-c:~/demo04$ ansible linux -m file -a 'path=/etc/ansible/facts.d/getdate2.fact state=absent'</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 然后将控制主机上的自定义facts变量文件移动</span></span><br><span class="line">ansible@ubuntu-c:~/demo04$ ls</span><br><span class="line">ansible.cfg  facts_playbook.yaml  getdate1.fact  getdate2.fact  hosts</span><br><span class="line">ansible@ubuntu-c:~/demo04$ mkdir facts.d</span><br><span class="line">ansible@ubuntu-c:~/demo04$ mv getdate* facts.d</span><br><span class="line">ansible@ubuntu-c:~/demo04$ ls</span><br><span class="line">ansible.cfg  facts.d  facts_playbook.yaml  hosts</span><br></pre></td></tr></tbody></table></figure><p>修改剧本facts_playbook.yaml，使用fact_path制定自定义facts变量文件位置：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">linux</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Make</span> <span class="string">Facts</span> <span class="string">Dir</span></span><br><span class="line">      <span class="attr">file:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/home/ansible/facts.d</span></span><br><span class="line">        <span class="attr">recurse:</span> <span class="literal">yes</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">ansible</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Copy</span> <span class="string">Fact</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">facts.d/getdate1.fact</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/home/ansible/facts.d/getdate1.fact</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">ansible</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0755</span></span><br><span class="line">    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Copy</span> <span class="string">Fact</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">/facts.d/getdate2.fact</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/home/ansible/facts.d/getdate2.fact</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">ansible</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0755</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Refresh</span> <span class="string">Facts</span></span><br><span class="line">      <span class="attr">setup:</span></span><br><span class="line">        <span class="attr">fact_path:</span> <span class="string">/home/ansible/facts.d</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Show</span> <span class="string">Ip</span> <span class="string">Address</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">"<span class="template-variable">{{ ansible_default_ipv4.address }}</span>"</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Show</span> <span class="string">Custom</span> <span class="string">Fact</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">"<span class="template-variable">{{ ansible_local.getdate1.date }}</span>"</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Show</span> <span class="string">Custom</span> <span class="string">Fact</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">"<span class="template-variable">{{ ansible_local.getdate2.date.date  }}</span>"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Show</span> <span class="string">Custom</span> <span class="string">Fact</span> <span class="number">1</span> <span class="string">in</span> <span class="string">hostvars</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">"<span class="template-variable">{{ hostvars[ansible_hostname].ansible_local.getdate1.date }}</span>"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Show</span> <span class="string">Custom</span> <span class="string">Fact</span> <span class="number">2</span> <span class="string">in</span> <span class="string">hostvars</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">"<span class="template-variable">{{ hostvars[ansible_hostname].ansible_local.getdate2.date.date }}</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>测试：</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~/demo04$ ansible-playbook facts_playbook.yaml </span><br><span class="line"></span><br><span class="line">PLAY [linux] ********************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] **********************************************************************************************************</span><br><span class="line">ok: [centos3]</span><br><span class="line">ok: [centos1]</span><br><span class="line">ok: [centos2]</span><br><span class="line">ok: [ubuntu2]</span><br><span class="line">ok: [ubuntu1]</span><br><span class="line">ok: [ubuntu3]</span><br><span class="line"></span><br><span class="line">TASK [Make Facts Dir] ***********************************************************************************************************</span><br><span class="line">changed: [centos1]</span><br><span class="line">changed: [centos3]</span><br><span class="line">changed: [centos2]</span><br><span class="line">changed: [ubuntu1]</span><br><span class="line">changed: [ubuntu2]</span><br><span class="line">changed: [ubuntu3]</span><br><span class="line"></span><br><span class="line">TASK [Copy Fact 1] **************************************************************************************************************</span><br><span class="line">changed: [ubuntu1]</span><br><span class="line">changed: [centos3]</span><br><span class="line">changed: [ubuntu2]</span><br><span class="line">changed: [centos1]</span><br><span class="line">changed: [centos2]</span><br><span class="line">changed: [ubuntu3]</span><br><span class="line"></span><br><span class="line">TASK [Copy Fact 2] **************************************************************************************************************</span><br><span class="line">changed: [centos1]</span><br><span class="line">changed: [centos2]</span><br><span class="line">changed: [ubuntu1]</span><br><span class="line">changed: [ubuntu2]</span><br><span class="line">changed: [centos3]</span><br><span class="line">changed: [ubuntu3]</span><br><span class="line"></span><br><span class="line">TASK [Refresh Facts] ************************************************************************************************************</span><br><span class="line">ok: [centos1]</span><br><span class="line">ok: [centos3]</span><br><span class="line">ok: [centos2]</span><br><span class="line">ok: [ubuntu1]</span><br><span class="line">ok: [ubuntu2]</span><br><span class="line">ok: [ubuntu3]</span><br><span class="line"></span><br><span class="line">TASK [Show Ip Address] **********************************************************************************************************</span><br><span class="line">ok: [centos1] =&gt; {</span><br><span class="line">    "msg": "172.19.0.7"</span><br><span class="line">}</span><br><span class="line">ok: [centos2] =&gt; {</span><br><span class="line">    "msg": "172.19.0.5"</span><br><span class="line">}</span><br><span class="line">ok: [centos3] =&gt; {</span><br><span class="line">    "msg": "172.19.0.8"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu1] =&gt; {</span><br><span class="line">    "msg": "172.19.0.9"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu2] =&gt; {</span><br><span class="line">    "msg": "172.19.0.4"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu3] =&gt; {</span><br><span class="line">    "msg": "172.19.0.3"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">TASK [Show Custom Fact 1] *******************************************************************************************************</span><br><span class="line">ok: [centos1] =&gt; {</span><br><span class="line">    "msg": "Mon Jun 26 10:23:47 UTC 2023"</span><br><span class="line">}</span><br><span class="line">ok: [centos2] =&gt; {</span><br><span class="line">    "msg": "Mon Jun 26 10:23:47 UTC 2023"</span><br><span class="line">}</span><br><span class="line">ok: [centos3] =&gt; {</span><br><span class="line">    "msg": "Mon Jun 26 10:23:47 UTC 2023"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu1] =&gt; {</span><br><span class="line">    "msg": "Mon Jun 26 10:23:47 UTC 2023"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu2] =&gt; {</span><br><span class="line">    "msg": "Mon Jun 26 10:23:47 UTC 2023"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu3] =&gt; {</span><br><span class="line">    "msg": "Mon Jun 26 10:23:48 UTC 2023"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">TASK [Show Custom Fact 2] *******************************************************************************************************</span><br><span class="line">ok: [centos1] =&gt; {</span><br><span class="line">    "msg": "Mon Jun 26 10:23:47 UTC 2023"</span><br><span class="line">}</span><br><span class="line">ok: [centos2] =&gt; {</span><br><span class="line">    "msg": "Mon Jun 26 10:23:47 UTC 2023"</span><br><span class="line">}</span><br><span class="line">ok: [centos3] =&gt; {</span><br><span class="line">    "msg": "Mon Jun 26 10:23:47 UTC 2023"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu1] =&gt; {</span><br><span class="line">    "msg": "Mon Jun 26 10:23:47 UTC 2023"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu2] =&gt; {</span><br><span class="line">    "msg": "Mon Jun 26 10:23:47 UTC 2023"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu3] =&gt; {</span><br><span class="line">    "msg": "Mon Jun 26 10:23:48 UTC 2023"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">TASK [Show Custom Fact 1 in hostvars] *******************************************************************************************</span><br><span class="line">ok: [centos1] =&gt; {</span><br><span class="line">    "msg": "Mon Jun 26 10:23:47 UTC 2023"</span><br><span class="line">}</span><br><span class="line">ok: [centos2] =&gt; {</span><br><span class="line">    "msg": "Mon Jun 26 10:23:47 UTC 2023"</span><br><span class="line">}</span><br><span class="line">ok: [centos3] =&gt; {</span><br><span class="line">    "msg": "Mon Jun 26 10:23:47 UTC 2023"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu1] =&gt; {</span><br><span class="line">    "msg": "Mon Jun 26 10:23:47 UTC 2023"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu2] =&gt; {</span><br><span class="line">    "msg": "Mon Jun 26 10:23:47 UTC 2023"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu3] =&gt; {</span><br><span class="line">    "msg": "Mon Jun 26 10:23:48 UTC 2023"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">TASK [Show Custom Fact2 in hostvars] ********************************************************************************************</span><br><span class="line">ok: [centos1] =&gt; {</span><br><span class="line">    "msg": "Mon Jun 26 10:23:47 UTC 2023"</span><br><span class="line">}</span><br><span class="line">ok: [centos2] =&gt; {</span><br><span class="line">    "msg": "Mon Jun 26 10:23:47 UTC 2023"</span><br><span class="line">}</span><br><span class="line">ok: [centos3] =&gt; {</span><br><span class="line">    "msg": "Mon Jun 26 10:23:47 UTC 2023"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu1] =&gt; {</span><br><span class="line">    "msg": "Mon Jun 26 10:23:47 UTC 2023"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu2] =&gt; {</span><br><span class="line">    "msg": "Mon Jun 26 10:23:47 UTC 2023"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu3] =&gt; {</span><br><span class="line">    "msg": "Mon Jun 26 10:23:48 UTC 2023"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PLAY RECAP **********************************************************************************************************************</span><br><span class="line">centos1                    : ok=10   changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">centos2                    : ok=10   changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">centos3                    : ok=10   changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">ubuntu1                    : ok=10   changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">ubuntu2                    : ok=10   changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">ubuntu3                    : ok=10   changed=3    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 测试完毕后删除自定义的facts变量</span></span><br><span class="line">ansible@ubuntu-c:~/demo04$ ansible linux -m file -a 'path=/home/ansible/facts.d state=absent'</span><br><span class="line">centos1 | CHANGED =&gt; {</span><br><span class="line">    "ansible_facts": {</span><br><span class="line">        "discovered_interpreter_python": "/usr/libexec/platform-python"</span><br><span class="line">    },</span><br><span class="line">    "changed": true,</span><br><span class="line">    "path": "/home/ansible/facts.d",</span><br><span class="line">    "state": "absent"</span><br><span class="line">}</span><br><span class="line">centos3 | CHANGED =&gt; {</span><br><span class="line">    "ansible_facts": {</span><br><span class="line">        "discovered_interpreter_python": "/usr/libexec/platform-python"</span><br><span class="line">    },</span><br><span class="line">    "changed": true,</span><br><span class="line">    "path": "/home/ansible/facts.d",</span><br><span class="line">    "state": "absent"</span><br><span class="line">}</span><br><span class="line">centos2 | CHANGED =&gt; {</span><br><span class="line">    "ansible_facts": {</span><br><span class="line">        "discovered_interpreter_python": "/usr/libexec/platform-python"</span><br><span class="line">    },</span><br><span class="line">    "changed": true,</span><br><span class="line">    "path": "/home/ansible/facts.d",</span><br><span class="line">    "state": "absent"</span><br><span class="line">}</span><br><span class="line">ubuntu1 | CHANGED =&gt; {</span><br><span class="line">    "ansible_facts": {</span><br><span class="line">        "discovered_interpreter_python": "/usr/bin/python3"</span><br><span class="line">    },</span><br><span class="line">    "changed": true,</span><br><span class="line">    "path": "/home/ansible/facts.d",</span><br><span class="line">    "state": "absent"</span><br><span class="line">}</span><br><span class="line">ubuntu2 | CHANGED =&gt; {</span><br><span class="line">    "ansible_facts": {</span><br><span class="line">        "discovered_interpreter_python": "/usr/bin/python3"</span><br><span class="line">    },</span><br><span class="line">    "changed": true,</span><br><span class="line">    "path": "/home/ansible/facts.d",</span><br><span class="line">    "state": "absent"</span><br><span class="line">}</span><br><span class="line">ubuntu3 | CHANGED =&gt; {</span><br><span class="line">    "ansible_facts": {</span><br><span class="line">        "discovered_interpreter_python": "/usr/bin/python3"</span><br><span class="line">    },</span><br><span class="line">    "changed": true,</span><br><span class="line">    "path": "/home/ansible/facts.d",</span><br><span class="line">    "state": "absent"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure><h3 id="4-5-剧本使用Jinja2模板语言">4.5 剧本使用Jinja2模板语言</h3><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~$ mkdir demo05 &amp;&amp; cd demo05</span><br><span class="line">ansible@ubuntu-c:~/demo05$ cp ../demo04/ansible.cfg .</span><br><span class="line">ansible@ubuntu-c:~/demo05$ cp ../demo04/hosts .</span><br><span class="line">ansible@ubuntu-c:~/demo05$ touch jinja2_playbook.yaml</span><br><span class="line">ansible@ubuntu-c:~/demo05$ echo jinja2_extensions = jinja2.ext.loopcontrols &gt;&gt; ansible.cfg</span><br></pre></td></tr></tbody></table></figure><p>jinja2_playbook.yaml文件内容如下：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Ansible</span> <span class="string">Jinja2</span> <span class="string">if</span> <span class="string">elif</span> <span class="string">else</span> <span class="string">statement</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&gt;</span></span><br><span class="line"><span class="string">             --== Ansible Jinja2 if elif else statement ==--</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">             {<span class="comment"># If the hostname is ubuntu-c, include a message -#}</span></span><br><span class="line">             {<span class="string">%</span> <span class="string">if</span> <span class="string">ansible_hostname</span> <span class="string">==</span> <span class="string">"ubuntu-c"</span> <span class="string">-%</span>}</span><br><span class="line">                <span class="string">This</span> <span class="string">is</span> <span class="string">ubuntu-c</span></span><br><span class="line">             {<span class="string">%</span> <span class="string">elif</span> <span class="string">ansible_hostname</span> <span class="string">==</span> <span class="string">"centos1"</span> <span class="string">-%</span>}</span><br><span class="line">                 <span class="string">This</span> <span class="string">is</span> <span class="string">centos1</span> <span class="string">with</span> <span class="string">it's</span> <span class="string">modified</span> <span class="string">SSH</span> <span class="string">Port</span></span><br><span class="line">             {<span class="string">%</span> <span class="string">else</span> <span class="string">-%</span>}</span><br><span class="line">                 <span class="string">This</span> <span class="string">is</span> <span class="string">good</span> <span class="string">old</span> {{ <span class="string">ansible_hostname</span> }}</span><br><span class="line">             {<span class="string">%</span> <span class="string">endif</span> <span class="string">%</span>}</span><br><span class="line">    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Ansible</span> <span class="string">Jinja2</span> <span class="string">if</span> <span class="string">variable</span> <span class="string">is</span> <span class="string">defined</span> <span class="string">(</span> <span class="string">where</span> <span class="string">variable</span> <span class="string">is</span> <span class="string">defined</span> <span class="string">)</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&gt;</span></span><br><span class="line"><span class="string">             --== Ansible Jinja2 if variable is defined ( where variable is defined ) ==--</span></span><br><span class="line"><span class="string"></span>             </span><br><span class="line">             {<span class="string">%</span> <span class="string">set</span> <span class="string">example_variable</span> <span class="string">=</span> <span class="string">'defined'</span> <span class="string">-%</span>}</span><br><span class="line">             {<span class="string">%</span> <span class="string">if</span> <span class="string">example_variable</span> <span class="string">is</span> <span class="string">defined</span> <span class="string">-%</span>}</span><br><span class="line">                 <span class="string">example_variable</span> <span class="string">is</span> <span class="string">defined</span></span><br><span class="line">             {<span class="string">%</span> <span class="string">else</span> <span class="string">-%</span>}</span><br><span class="line">                 <span class="string">example_variable</span> <span class="string">is</span> <span class="string">not</span> <span class="string">defiend</span></span><br><span class="line">             {<span class="string">%</span> <span class="string">endif</span> <span class="string">%</span>}</span><br><span class="line">     </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Ansible</span> <span class="string">Jinja2</span> <span class="string">for</span> <span class="string">statement</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&gt;</span></span><br><span class="line"><span class="string">             --== Ansible Jinja2 for statement ==--</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">             {<span class="string">%</span> <span class="string">for</span> <span class="string">entry</span> <span class="string">in</span> <span class="string">ansible_interfaces</span> <span class="string">-%</span>}</span><br><span class="line">                 <span class="string">Interface</span> <span class="string">entry</span> {{ <span class="string">loop.index</span> }} <span class="string">=</span> {{ <span class="string">entry</span> }}</span><br><span class="line">             {<span class="string">%</span> <span class="string">endfor</span> <span class="string">%</span>}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Ansible</span> <span class="string">Jinja2</span> <span class="string">for</span> <span class="string">range</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&gt;</span></span><br><span class="line"><span class="string">          --== Ansible Jinja2 for range ==--</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">          {<span class="string">%</span> <span class="string">for</span> <span class="string">entry</span> <span class="string">in</span> <span class="string">range(1</span>, <span class="number">11</span><span class="string">)</span> <span class="string">-%</span>}</span><br><span class="line">              {{ <span class="string">entry</span> }}</span><br><span class="line">          {<span class="string">%</span> <span class="string">endfor</span> <span class="string">%</span>}</span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Ansible</span> <span class="string">Jinja2</span> <span class="string">for</span> <span class="string">range</span>, <span class="string">reversed</span> <span class="string">(simulate</span> <span class="string">while</span> <span class="string">greater</span> <span class="number">5</span><span class="string">)</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&gt;</span></span><br><span class="line"><span class="string">             --== Ansible Jinja2 for range, reversed (simulate while greater 5) ==--</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">             {<span class="string">%</span> <span class="string">for</span> <span class="string">entry</span> <span class="string">in</span> <span class="string">range(10</span>, <span class="number">0</span>, <span class="number">-1</span><span class="string">)</span> <span class="string">-%</span>}</span><br><span class="line">                 {<span class="string">%</span> <span class="string">if</span> <span class="string">entry</span> <span class="string">==</span> <span class="number">5</span> <span class="string">-%</span>}</span><br><span class="line">                     {<span class="string">%</span> <span class="string">break</span> <span class="string">%</span>}</span><br><span class="line">                 {<span class="string">%</span> <span class="string">endif</span> <span class="string">-%</span>}</span><br><span class="line">             {{ <span class="string">entry</span> }}</span><br><span class="line">             {<span class="string">%</span> <span class="string">endfor</span> <span class="string">%</span>}</span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Ansible</span> <span class="string">Jinja2</span> <span class="string">for</span> <span class="string">range</span>, <span class="string">reversed(continue</span> <span class="string">if</span> <span class="string">odd)</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&gt;</span></span><br><span class="line"><span class="string">             --== Ansible Jinja2 for range, reversed (continue if odd)</span></span><br><span class="line"><span class="string">             {% for entry in range(10, 0, -1) -%}</span></span><br><span class="line"><span class="string">                 {% if entry is odd -%}</span></span><br><span class="line"><span class="string">                     {% continue %}</span></span><br><span class="line"><span class="string">                 {% endif -%}</span></span><br><span class="line"><span class="string">                 {{ entry }}</span></span><br><span class="line"><span class="string">             {% endfor %}</span></span><br><span class="line"><span class="string"></span>  </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Ansible</span> <span class="string">Jinja2</span> <span class="string">filters</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">&gt;</span></span><br><span class="line"><span class="string">             --=== Ansible Jinja2 filters ===--</span></span><br><span class="line"><span class="string"></span>             </span><br><span class="line">             <span class="string">--==</span> <span class="string">min</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>] <span class="string">==--</span></span><br><span class="line">             {{ [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>] <span class="string">|</span> <span class="string">min</span> }}</span><br><span class="line"></span><br><span class="line">             <span class="string">--==</span> <span class="string">max</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>] <span class="string">==--</span></span><br><span class="line">             {{ [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>] <span class="string">|</span> <span class="string">max</span> }}</span><br><span class="line"></span><br><span class="line">             <span class="string">--==</span> <span class="string">unique</span> [<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">5</span>] <span class="string">==--</span></span><br><span class="line">             {{ [<span class="number">1</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">5</span>] <span class="string">|</span> <span class="string">unique</span> }}</span><br><span class="line"></span><br><span class="line">             <span class="string">--==</span> <span class="string">difference</span> [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>] <span class="string">vs</span> [<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>] <span class="string">==--</span></span><br><span class="line">             {{ [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>] <span class="string">|</span> <span class="string">difference(</span>[<span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>]<span class="string">)</span> }}</span><br><span class="line"></span><br><span class="line">             <span class="string">--==</span> <span class="string">random</span> [<span class="string">'rod'</span>, <span class="string">'jane'</span>, <span class="string">'freddy'</span>] <span class="string">==--</span></span><br><span class="line">             {{ [<span class="string">'rod'</span>, <span class="string">'jane'</span>, <span class="string">'freddy'</span>] <span class="string">|</span> <span class="string">random</span> }}</span><br><span class="line"></span><br><span class="line">             <span class="string">--==</span> <span class="string">urlsplit</span> <span class="string">hostname</span> <span class="string">==--</span></span><br><span class="line">             {{ <span class="string">"http://docs.ansible.com/ansible/latest/playbook_filters.html"</span> <span class="string">|</span> <span class="string">urlsplit('hostname')</span> }}</span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>剧本过滤器官方文档地址：<a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_filters.html">https://docs.ansible.com/ansible/latest/user_guide/playbooks_filters.html</a></p><p>jinjia2相关内容可以写成单独的文件，然后在Ansible通过template模块引入。如：</p><p>新建template.j2文件，内容如下：</p><figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">--== Ansible Jinja2 if statement ==--</span><br><span class="line"></span><br><span class="line">{# If the hostname is ubuntu-c, include a message -#}</span><br><span class="line">{% if ansible_hostname == "ubuntu-c" -%}</span><br><span class="line">      This is ubuntu-c</span><br><span class="line">{% endif %}</span><br><span class="line"></span><br><span class="line">--== Ansible Jinja2 if elif statement ==--</span><br><span class="line"></span><br><span class="line">{% if ansible_hostname == "ubuntu-c" -%}</span><br><span class="line">   This is ubuntu-c</span><br><span class="line">{% elif ansible_hostname == "centos1" -%}</span><br><span class="line">   This is centos1 with it's modified SSH Port</span><br><span class="line">{% endif %}</span><br><span class="line"></span><br><span class="line">--== Ansible Jinja2 if elif else statement ==--</span><br><span class="line"></span><br><span class="line">{% if ansible_hostname == "ubuntu-c" -%}</span><br><span class="line">   This is ubuntu-c</span><br><span class="line">{% elif ansible_hostname == "centos1" -%}</span><br><span class="line">   This is centos1 with it's modified SSH Port</span><br><span class="line">{% else -%}</span><br><span class="line">   This is good old {{ ansible_hostname }}</span><br><span class="line">{% endif %}</span><br><span class="line"></span><br><span class="line">--== Ansible Jinja2 if variable is defined ( where variable is not defined ) ==--</span><br><span class="line"></span><br><span class="line">{% if example_variable is defined -%}</span><br><span class="line">   example_variable is defined</span><br><span class="line">{% else -%}</span><br><span class="line">   example_variable is not defined</span><br><span class="line">{% endif %}</span><br><span class="line"></span><br><span class="line">--== Ansible Jinja2 if varible is defined ( where variable is defined ) ==--</span><br><span class="line"></span><br><span class="line">{% set example_variable = 'defined' -%}</span><br><span class="line">{% if example_variable is defined -%}</span><br><span class="line">   example_variable is defined</span><br><span class="line">{% else -%}</span><br><span class="line">   example_variable is not defined</span><br><span class="line">{% endif %}</span><br><span class="line"></span><br><span class="line">--== Ansible Jinja2 for statement ==--</span><br><span class="line"></span><br><span class="line">{% for entry in ansible_all_ipv4_addresses -%}</span><br><span class="line">   IP Address entry {{ loop.index }} = {{ entry }}</span><br><span class="line">{% endfor %}</span><br><span class="line"></span><br><span class="line">--== Ansible Jinja2 for range</span><br><span class="line"></span><br><span class="line">{% for entry in range(1, 11) -%}</span><br><span class="line">   {{ entry }}</span><br><span class="line">{% endfor %}</span><br><span class="line"></span><br><span class="line">--== Ansible Jinja2 for range, reversed (simulate while greater 5) ==--</span><br><span class="line"></span><br><span class="line">{% for entry in range(10, 0, -1) -%}</span><br><span class="line">   {% if entry == 5 -%}</span><br><span class="line">      {% break %}</span><br><span class="line">   {% endif -%}</span><br><span class="line">   {{ entry }}</span><br><span class="line">{% endfor %}</span><br><span class="line"></span><br><span class="line">--== Ansible Jinja2 for range, reversed (continue if odd) ==--</span><br><span class="line"></span><br><span class="line">{% for entry in range(10, 0, -1) -%}</span><br><span class="line">   {% if entry is odd -%}</span><br><span class="line">      {% continue %}</span><br><span class="line">   {% endif -%}</span><br><span class="line">   {{ entry }}</span><br><span class="line">{% endfor %}</span><br><span class="line"></span><br><span class="line">---=== Ansible Jinja2 filters ===---</span><br><span class="line"></span><br><span class="line">--== min [1, 2, 3, 4, 5] ==--</span><br><span class="line"></span><br><span class="line">{{ [1, 2, 3, 4, 5] | min }}</span><br><span class="line"></span><br><span class="line">--== max [1, 2, 3, 4, 5] ==--</span><br><span class="line"></span><br><span class="line">{{ [1, 2, 3, 4, 5] | max }}</span><br><span class="line"></span><br><span class="line">--== unique [1, 1, 2, 2, 3, 3, 4, 4, 5, 5] ==--</span><br><span class="line"></span><br><span class="line">{{ [1, 1, 2, 2, 3, 3, 4, 4, 5, 5] | unique }}</span><br><span class="line"></span><br><span class="line">--== difference [1, 2, 3, 4, 5] vs [2, 3, 4] ==--</span><br><span class="line"></span><br><span class="line">{{ [1, 2, 3, 4, 5] | difference([2, 3, 4]) }}</span><br><span class="line"></span><br><span class="line">--== random ['rod', 'jane', 'freddy'] ==--</span><br><span class="line"></span><br><span class="line">{{ ['rod', 'jane', 'freddy'] | random }}</span><br><span class="line"></span><br><span class="line">--== urlsplit hostname ==--</span><br><span class="line"></span><br><span class="line">{{ "http://docs.ansible.com/ansible/latest/playbooks_filters.html" | urlsplit('hostname') }}</span><br></pre></td></tr></tbody></table></figure><p>修改jinja2_playbook.yaml：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Jinja2</span> <span class="string">template</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">template.j2</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">"/tmp/<span class="template-variable">{{ ansible_hostname }}</span>_template.out"</span></span><br><span class="line">        <span class="attr">trim_blocks:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0644</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><h3 id="4-6-剧本实际应用">4.6 剧本实际应用</h3><p>在不同的linux系统上安装nginx，并配置index.html，引用变量</p><ul><li>配置hosts指向目标linux组</li><li>创建任务 Install EPEL：CentOS使用yum安装epel-release</li><li>分别创建任务 Install Nginx CentOS、Install Nginx Ubuntu：CentOS使用yum安装nginx，Ubuntu使用apt安装包安装nginx</li><li>删除任务 Install Nginx CentOS、Install Nginx Ubuntu，新增任务 Install Nginx：改为使用package模块安装nginx，不需要区分CentOS和Ubuntu</li><li>创建任务 Restart Nginx：使用service模块重启目标linux系统的nginx服务器</li><li>创建处理程序 Check HTTP Service：使用uri模块测试HTTP服务</li><li>修改任务 Restart Nginx：添加notify指向Check HTTP Service处理程序</li><li>创建组变量 nginx_root_location：CentOS组的nginx_root_location=/usr/share/nginx/html、Ubuntu组的nginx_root_location=/var/www/html</li><li>创建任务 Template index.html-base.j2 to index.html on target: 使用template模块，将自定义的index.html-base.j2 Jinja2模板指向nginx的/index.html</li><li>修改ansible.cfg：echo ‘ansible_managed = Managed by Ansible - file: {file} - host: {host} - uid:{uid}’ &gt;&gt; ansible.cfg</li><li>更新任务 Template index.html-base.j2 to index.html on target: 改为Template index.html-ansible_managed.j2 to index.html on target，更新自定义的模板文件为index.html-ansible_managed.j2</li><li>更新剧本，引入变量文件vars/logos.yaml</li><li>更新任务 Template index.html-ansible_managed.j2 to index.html on target：改为 Template index.html-logos.j2 to index.html on target，更新自定义的模板文件为index.html-logos.j2</li><li>使用package模块安装unzip包，创建任务 Unarchive playbook stacker game，使用unarchive模块解压缩</li><li>更新任务 Template index.html-ansible_managed.j2 to index.html on target：改为 Template index.html-logos.j2 to index.html on target，更新自定义的模板文件为index.html-logos.j2</li><li>更新任务 Template index.html-logos.j2 to index.html on target，改为 Template index.html-easter_egg.j2 to index.html on target，更新自定义的模板文件为index.html-easter_egg.j2</li></ul><p>最终，nginx_playbook.yaml内容为：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">linux</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">vars_files:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">vars/logos.yaml</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">EPEL</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">epel-release</span></span><br><span class="line">        <span class="attr">update_cache:</span> <span class="literal">yes</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_distribution</span> <span class="string">==</span> <span class="string">'CentOS'</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Nginx</span></span><br><span class="line">      <span class="attr">package:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line">      <span class="attr">notify:</span> <span class="string">Check</span> <span class="string">HTTP</span> <span class="string">Service</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Template</span> <span class="string">index.html-easter_egg.j2</span> <span class="string">to</span> <span class="string">index.html</span> <span class="string">on</span> <span class="string">target</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">index.html-easter_egg.j2</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">"<span class="template-variable">{{ nginx_root_location }}</span>/index.html"</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0644</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">unzip</span></span><br><span class="line">      <span class="attr">package:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">unzip</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Unarchive</span> <span class="string">playbook</span> <span class="string">stacker</span> <span class="string">game</span></span><br><span class="line">      <span class="attr">unarchive:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">playbook_stacker.zip</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">"<span class="template-variable">{{ nginx_root_location }}</span>"</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0755</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">HTTP</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">http://{{</span> <span class="string">ansible_default_ipv4.address</span> <span class="string">}}</span></span><br><span class="line">        <span class="attr">status_code:</span> <span class="number">200</span> </span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>详细资源可以参见Ansible课程代码</p><h2 id="5-深入Ansible-Playbooks">5. 深入Ansible Playbooks</h2><blockquote><p>剧本 Module模块，动态Inventory清单，Register，When和Loops循环的使用，异步、串行、并行的性能，任务委派，Ansible魔法变量，Ansible Blocks块，Ansible Vault信息保护</p></blockquote><h3 id="5-1-剧本常用模块">5.1 剧本常用模块</h3><p>Ansible内置了数以千计的模块，涵盖了众多领域和技术方向，接下来将介绍一些剧本常用模块</p><p><strong>set_fact</strong>模块</p><p>作用：允许执行期间动态添加或改变facts变量</p><p>官方文档地址：<a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/set_fact_module.html">https://docs.ansible.com/ansible/latest/collections/ansible/builtin/set_fact_module.html</a></p><p>示例：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">ubuntu3,centos3</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">a</span> <span class="string">fact</span></span><br><span class="line">      <span class="attr">set_fact:</span></span><br><span class="line">        <span class="attr">our_fact:</span> <span class="string">Ansible</span> <span class="string">Rocks!</span></span><br><span class="line">        <span class="attr">ansible_distribution:</span> <span class="string">"<span class="template-variable">{{ ansible_distribution | upper }}</span>"</span></span><br><span class="line">        </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">our</span> <span class="string">installation</span> <span class="string">variables</span> <span class="string">for</span> <span class="string">CentOS</span></span><br><span class="line">      <span class="attr">set_fact:</span></span><br><span class="line">        <span class="attr">webserver_application_port:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">webserver_application_path:</span> <span class="string">/usr/share/nginx/html</span></span><br><span class="line">        <span class="attr">webserver_application_user:</span> <span class="string">root</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_distribution</span> <span class="string">==</span> <span class="string">'CENTOS'</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Set</span> <span class="string">our</span> <span class="string">installation</span> <span class="string">variables</span> <span class="string">for</span> <span class="string">Ubuntu</span></span><br><span class="line">      <span class="attr">set_fact:</span></span><br><span class="line">        <span class="attr">webserver_application_port:</span> <span class="number">8080</span></span><br><span class="line">        <span class="attr">webserver_application_path:</span> <span class="string">/var/www/html</span></span><br><span class="line">        <span class="attr">webserver_application_user:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_distribution</span> <span class="string">==</span> <span class="string">'UBUNTU'</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Show</span> <span class="string">our_fact</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">"<span class="template-variable">{{ our_fact }}</span>"</span></span><br><span class="line">        </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Show</span> <span class="string">ansible_distribution</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">"<span class="template-variable">{{ ansible_distribution }}</span>"</span></span><br><span class="line">    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Show</span> <span class="string">pre-set</span> <span class="string">distribution</span> <span class="string">based</span> <span class="string">facts</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">"webserver_application_port: <span class="template-variable">{{ webserver_application_port }}</span> webserver_application_path: <span class="template-variable">{{ webserver_application_path }}</span> webserver_application_user: <span class="template-variable">{{ webserver_application_user }}</span>"</span></span><br><span class="line">      </span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p><strong>pause</strong>模块</p><p>作用：允许暂停给定时间的剧本执行，或者暂停直到确认特定提示</p><p>官方文档地址：<a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/pause_module.html">https://docs.ansible.com/ansible/latest/collections/ansible/builtin/pause_module.html</a></p><p>示例：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">ubuntu3,centos3</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Pause</span> <span class="string">our</span> <span class="string">playbook</span> <span class="string">for</span> <span class="number">10</span> <span class="string">seconds</span></span><br><span class="line">      <span class="attr">pause:</span></span><br><span class="line">        <span class="attr">seconds:</span> <span class="number">10</span></span><br><span class="line">    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Prompt</span> <span class="string">user</span> <span class="string">to</span> <span class="string">verify</span> <span class="string">before</span> <span class="string">continue</span></span><br><span class="line">      <span class="attr">pause:</span></span><br><span class="line">        <span class="attr">prompt:</span> <span class="string">Please</span> <span class="string">check</span> <span class="string">that</span> <span class="string">the</span> <span class="string">webserver</span> <span class="string">is</span> <span class="string">running,</span> <span class="string">press</span> <span class="string">enter</span> <span class="string">to</span> <span class="string">continue</span></span><br><span class="line">        </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Wait</span> <span class="string">for</span> <span class="string">the</span> <span class="string">webserver</span> <span class="string">to</span> <span class="string">be</span> <span class="string">running</span> <span class="string">on</span> <span class="string">port</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">wait_for:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p><strong>wait_for</strong>模块</p><p>作用：允许等待指定的时间后、等待指定的端口可用时、等待指定模块启动并准备好时、等待正则匹配文件中字符串存在时，继续执行剧本</p><p>官方文档地址：<a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/wait_for_module.html">https://docs.ansible.com/ansible/latest/collections/ansible/builtin/wait_for_module.html</a></p><p>示例：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">ubuntu3,centos3</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Wait</span> <span class="string">for</span> <span class="string">the</span> <span class="string">webserver</span> <span class="string">to</span> <span class="string">be</span> <span class="string">running</span> <span class="string">on</span> <span class="string">port</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">wait_for:</span></span><br><span class="line">        <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p><strong>assemble</strong>模块</p><p>作用：允许将文件的集合组装成一个文件，可将获取本地或被管理主机的文件目录，并将他们连接在一起生成目标文件</p><p>官方文档地址：<a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/assemble_module.html">https://docs.ansible.com/ansible/latest/collections/ansible/builtin/assemble_module.html</a></p><p>示例：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">ubuntu-c</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Assemble</span> <span class="string">conf.d</span> <span class="string">to</span> <span class="string">sshd_config</span></span><br><span class="line">      <span class="attr">assemble:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">conf.d</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">sshd_config</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p><strong>add_host</strong>模块</p><p>作用：允许动态添加目标主机到正在执行的剧本中，已备后续使用</p><p>官方文档地址：<a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/add_host_module.html">https://docs.ansible.com/ansible/latest/collections/ansible/builtin/add_host_module.html</a></p><p>示例：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">ubuntu-c</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Add</span> <span class="string">centos1</span> <span class="string">to</span> <span class="string">adhoc_group</span></span><br><span class="line">      <span class="attr">add_host:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">centos1</span></span><br><span class="line">        <span class="attr">groups:</span> <span class="string">adhoc_group1,</span> <span class="string">adhoc_group2</span></span><br><span class="line">      </span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">adhoc_group1</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Ping</span> <span class="string">all</span> <span class="string">in</span> <span class="string">adhoc_group</span></span><br><span class="line">      <span class="attr">ping:</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p><strong>group_by</strong>模块</p><p>作用：允许使用facts变量创建临时组，以便稍后在剧本中使用</p><p>官方文档地址：<a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/group_by_module.html">https://docs.ansible.com/ansible/latest/collections/ansible/builtin/group_by_module.html</a></p><p>示例：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">all</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">group</span> <span class="string">based</span> <span class="string">on</span> <span class="string">ansible_distribution</span></span><br><span class="line">      <span class="attr">group_by:</span></span><br><span class="line">        <span class="attr">key:</span> <span class="string">"custom_<span class="template-variable">{{ ansible_distribution | lower }}</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">custom_centos</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Ping</span> <span class="string">all</span> <span class="string">in</span> <span class="string">custom_centos</span></span><br><span class="line">      <span class="attr">ping:</span></span><br><span class="line">      </span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p><strong>fetch</strong>模块</p><p>作用：允许从远程计算机获取文件并将它们存储在本地文件树中，按主机名组织</p><p>官方文档地址：<a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/fetch_module.html">https://docs.ansible.com/ansible/latest/collections/ansible/builtin/fetch_module.html</a></p><p>示例：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">centos</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Fetch</span> <span class="string">/etc/redhat-release</span></span><br><span class="line">      <span class="attr">fetch:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">/etc/redhat-release</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/tmp/redhat-release</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><h3 id="5-2-动态清单">5.2 动态清单</h3><p>目前，我们都是在ansible.cfg文件中配置清单hosts文件，然后在hosts文件内或host_vars、group_vars文件夹内指定清单变量，在命令行工具中也可以使用<code>-i</code>选项指定或覆盖之前配置的清单文件，如果指定的清单文件为可执行文件，则Ansible将执行此文件并将结果作为清单。</p><p>Ansible可以使用可执行文件作为动态清单，并使用文件执行结果作为清单</p><p>动态清单需要满足的条件：</p><ul><li>必须是可执行文件，能够从 命令行执行，语言不限</li><li>接受 <code>--list</code>、<code>--host</code>命令行选项</li><li>使用<code>--list</code>选项，返回JSON编码字典，包含清单内容</li><li>使用<code>--host</code>选项，返回基本的JSON编码字典，包含主机内容</li></ul><p>示例：</p><p>ansible.cfg</p><figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">[defaults]</span></span><br><span class="line"><span class="attr">host_key_checking</span> = <span class="literal">False</span></span><br></pre></td></tr></tbody></table></figure><p><a target="_blank" rel="noopener" href="http://inventory.py">inventory.py</a></p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">Dynamic inventory for Ansible in Python</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Use print functionality from Python 3 for compatibility</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> print_function</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="comment"># Attempt to import json, if it fails, import simplejson</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    <span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">except</span> ImportError:</span><br><span class="line">    <span class="keyword">import</span> simplejson <span class="keyword">as</span> json</span><br><span class="line"></span><br><span class="line"><span class="comment"># Inherit from object for Python 2/3 compatibility</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Inventory</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Constructor</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, include_hostvars_in_list</span>):</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Configure logger</span></span><br><span class="line">        <span class="comment">#self.configure_logger()</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># Capture and store include_hostvars_in_list</span></span><br><span class="line">        self.include_hostvars_in_list = include_hostvars_in_list</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Capture the script command line arguments</span></span><br><span class="line">        parser = argparse.ArgumentParser()</span><br><span class="line">        parser.add_argument(<span class="string">'--list'</span>, action=<span class="string">'store_true'</span>,</span><br><span class="line">                            <span class="built_in">help</span>=<span class="string">'list inventory'</span>)</span><br><span class="line">        parser.add_argument(<span class="string">'--host'</span>, action=<span class="string">'store'</span>,</span><br><span class="line">                            <span class="built_in">help</span>=<span class="string">'show HOST variables'</span>)</span><br><span class="line">        self.args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># If not called with --host or --list, show usage and exit</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> (self.args.<span class="built_in">list</span> <span class="keyword">or</span> self.args.host):</span><br><span class="line">            parser.print_usage()</span><br><span class="line">            <span class="keyword">raise</span> SystemExit</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Capture and store the inventory</span></span><br><span class="line">        self.define_inventory()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># When called with --list, print the inventory</span></span><br><span class="line">        <span class="keyword">if</span> self.args.<span class="built_in">list</span>:</span><br><span class="line">            self.print_json(self.<span class="built_in">list</span>())</span><br><span class="line"></span><br><span class="line">        <span class="comment"># If called with --host, print host information</span></span><br><span class="line">        <span class="keyword">elif</span> self.args.host:</span><br><span class="line">            self.print_json(self.host())</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">define_inventory</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.groups = {</span><br><span class="line">            <span class="string">"centos"</span>: {</span><br><span class="line">                <span class="string">"hosts"</span>: [<span class="string">"centos1"</span>, <span class="string">"centos2"</span>, <span class="string">"centos3"</span>],</span><br><span class="line">                <span class="string">"vars"</span>: {</span><br><span class="line">                    <span class="string">"ansible_user"</span>: <span class="string">'root'</span></span><br><span class="line">                }</span><br><span class="line">            },</span><br><span class="line">            <span class="string">"control"</span>: {</span><br><span class="line">                <span class="string">"hosts"</span>: [<span class="string">"ubuntu-c"</span>],</span><br><span class="line">            },</span><br><span class="line">            <span class="string">"ubuntu"</span>: {</span><br><span class="line">                <span class="string">"hosts"</span>: [<span class="string">"ubuntu1"</span>, <span class="string">"ubuntu2"</span>, <span class="string">"ubuntu3"</span>],</span><br><span class="line">                <span class="string">"vars"</span>: {</span><br><span class="line">                    <span class="string">"ansible_become"</span>: <span class="literal">True</span>,</span><br><span class="line">                    <span class="string">"ansible_become_pass"</span>: <span class="string">'password'</span></span><br><span class="line">                }</span><br><span class="line">            },</span><br><span class="line">            <span class="string">"linux"</span>: {</span><br><span class="line">                <span class="string">"children"</span>: [<span class="string">"centos"</span>, <span class="string">"ubuntu"</span>],</span><br><span class="line">            }}</span><br><span class="line"></span><br><span class="line">        self.hostvars = {</span><br><span class="line">            <span class="string">'centos1'</span>: {</span><br><span class="line">                <span class="string">'ansible_port'</span>: <span class="number">2222</span></span><br><span class="line">            },</span><br><span class="line">            <span class="string">'ubuntu-c'</span>: {</span><br><span class="line">                <span class="string">'ansible_connection'</span>: <span class="string">'local'</span></span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Pretty print JSON</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">print_json</span>(<span class="params">self, content</span>):</span></span><br><span class="line">        <span class="built_in">print</span>(json.dumps(content, indent=<span class="number">4</span>, sort_keys=<span class="literal">True</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Return inventory dictionary</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">list</span>(<span class="params">self</span>):</span></span><br><span class="line"></span><br><span class="line">        self.logger.info(<span class="string">'list executed'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># If include_hostvars_in_list is True, merge the hostvars</span></span><br><span class="line">        <span class="comment"># as _meta data</span></span><br><span class="line">        <span class="keyword">if</span> self.include_hostvars_in_list:</span><br><span class="line">            merged = self.groups</span><br><span class="line">            merged[<span class="string">'_meta'</span>] = {}</span><br><span class="line">            merged[<span class="string">'_meta'</span>][<span class="string">'hostvars'</span>] = self.hostvars</span><br><span class="line">            <span class="keyword">return</span> merged</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Otherwise, return the groups without hostvars</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> self.groups</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Return host dictionary</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">host</span>(<span class="params">self</span>):</span></span><br><span class="line"></span><br><span class="line">        self.logger.info(<span class="string">'host executed for {}'</span>.<span class="built_in">format</span>(self.args.host))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># If the requested hosts exists in hostvars, return it</span></span><br><span class="line">        <span class="keyword">if</span> self.args.host <span class="keyword">in</span> self.hostvars:</span><br><span class="line">            <span class="keyword">return</span> self.hostvars[self.args.host]</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Otherwise, return an empty list</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> {}</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Logger, for debugging as stdout is used by the script</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">configure_logger</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.logger = logging.getLogger(<span class="string">'ansible_dynamic_inventory'</span>)</span><br><span class="line">        self.hdlr = logging.FileHandler(<span class="string">'/var/tmp/ansible_dynamic_inventory.log'</span>)</span><br><span class="line">        self.formatter = logging.Formatter(<span class="string">'%(asctime)s %(levelname)s %(message)s'</span>)</span><br><span class="line">        self.hdlr.setFormatter(self.formatter)</span><br><span class="line">        self.logger.addHandler(self.hdlr) </span><br><span class="line">        self.logger.setLevel(logging.DEBUG)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Call the Inventory class constructor (__init__)</span></span><br><span class="line"><span class="comment"># Pass include_hostsvars_in_list as True to include hostvars</span></span><br><span class="line"><span class="comment"># as _meta data in list output</span></span><br><span class="line">Inventory(include_hostvars_in_list=<span class="literal">False</span>)</span><br></pre></td></tr></tbody></table></figure><p>测试：</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~/diveintoansible/Ansible Playbooks, Deep Dive/Dynamic Inventories/01$ ansible all -i inventory.py --list-hosts</span><br><span class="line">  hosts (7):</span><br><span class="line">    ubuntu-c</span><br><span class="line">    centos1</span><br><span class="line">    centos2</span><br><span class="line">    centos3</span><br><span class="line">    ubuntu1</span><br><span class="line">    ubuntu2</span><br><span class="line">    ubuntu3</span><br><span class="line">    </span><br><span class="line">ansible@ubuntu-c:~/diveintoansible/Ansible Playbooks, Deep Dive/Dynamic Inventories/01$ ansible all -i inventory.py -m ping -o</span><br><span class="line">ubuntu-c | SUCCESS =&gt; {"ansible_facts": {"discovered_interpreter_python": "/usr/bin/python3"},"changed": false,"ping": "pong"}</span><br><span class="line">centos1 | SUCCESS =&gt; {"ansible_facts": {"discovered_interpreter_python": "/usr/libexec/platform-python"},"changed": false,"ping": "pong"}</span><br><span class="line">centos2 | SUCCESS =&gt; {"ansible_facts": {"discovered_interpreter_python": "/usr/libexec/platform-python"},"changed": false,"ping": "pong"}</span><br><span class="line">centos3 | SUCCESS =&gt; {"ansible_facts": {"discovered_interpreter_python": "/usr/libexec/platform-python"},"changed": false,"ping": "pong"}</span><br><span class="line">ubuntu1 | SUCCESS =&gt; {"ansible_facts": {"discovered_interpreter_python": "/usr/bin/python3"},"changed": false,"ping": "pong"}</span><br><span class="line">ubuntu2 | SUCCESS =&gt; {"ansible_facts": {"discovered_interpreter_python": "/usr/bin/python3"},"changed": false,"ping": "pong"}</span><br><span class="line">ubuntu3 | SUCCESS =&gt; {"ansible_facts": {"discovered_interpreter_python": "/usr/bin/python3"},"changed": false,"ping": "pong"}</span><br></pre></td></tr></tbody></table></figure><p>将脚本inventory.py中的最后一行改为Inventory(include_hostvars_in_list=True)，对比发现，使用_meta可提高性能表现</p><h3 id="5-3-Register和When">5.3 Register和When</h3><p><strong>Register</strong></p><p>使用Register指令可以存储输出为一个变量，后续可以直接使用：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">linux</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Exploring</span> <span class="string">register</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">hostname</span> <span class="string">-c</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">hostname_output</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Show</span> <span class="string">hostname_output</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">var:</span> <span class="string">hostname_output.stdout</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>register与when结合使用可以针对命令的执行结果进行而额外的处理，从而覆盖多种情况，如：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">linux</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Exploring</span> <span class="string">register</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">hostname</span> <span class="string">-s</span></span><br><span class="line">      <span class="attr">when:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">ansible_distribution</span> <span class="string">==</span> <span class="string">"CentOS"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">ansible_distribution_major_version</span> <span class="string">|</span> <span class="string">int</span> <span class="string">&gt;=</span> <span class="number">8</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">command_register</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">patch</span> <span class="string">when</span> <span class="string">changed</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">patch</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">command_register</span> <span class="string">is</span> <span class="string">changed</span></span><br><span class="line">    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">patch</span> <span class="string">when</span> <span class="string">skipped</span></span><br><span class="line">      <span class="attr">apt:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">patch</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">command_register</span> <span class="string">is</span> <span class="string">skipped</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><h3 id="5-4-循环的使用">5.4 循环的使用</h3><p>用好循环能够使剧本的编写更加简洁美观，提高编写效率。Ansible的剧本可以使用多种方式的循环，下面简单了解下：</p><p><strong>with_items循环</strong></p><p>遍历列表</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">linux</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Configure</span> <span class="string">a</span> <span class="string">MOTD</span> <span class="string">(message</span> <span class="string">of</span> <span class="string">the</span> <span class="string">day)</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">content:</span> <span class="string">"Welcome to <span class="template-variable">{{ item }}</span> Linux - Ansible Rocks!\n"</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/ect/motd</span></span><br><span class="line">      <span class="attr">notify:</span> <span class="string">MOTD</span> <span class="string">changed</span></span><br><span class="line">      <span class="attr">with_items:</span> [ <span class="string">'CentOS'</span>, <span class="string">'Ubuntu'</span> ]</span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_distribution</span> <span class="string">==</span> <span class="string">item</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Creating</span> <span class="string">user</span></span><br><span class="line">      <span class="attr">user:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">"<span class="template-variable">{{ item }}</span>"</span></span><br><span class="line">      <span class="attr">with_items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">jane</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">michael</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">tom</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">danel</span></span><br><span class="line">        </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Removing</span> <span class="string">user</span></span><br><span class="line">      <span class="attr">user:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">"<span class="template-variable">{{ item }}</span>"</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">absent</span></span><br><span class="line">      <span class="attr">with_items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">jane</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">michael</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">tom</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">danel</span></span><br><span class="line">        </span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">MOTD</span> <span class="string">changed</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">The</span> <span class="string">MOTD</span> <span class="string">was</span> <span class="string">changed</span></span><br><span class="line">        </span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p><strong>with_dict循环</strong></p><p>遍历字典</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">linux</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Creating</span> <span class="string">user</span></span><br><span class="line">      <span class="attr">user:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">"<span class="template-variable">{{ item.key }}</span>"</span></span><br><span class="line">        <span class="attr">comment:</span> <span class="string">"<span class="template-variable">{{ item.value.full_name }}</span>"</span></span><br><span class="line">      <span class="attr">with_dict:</span></span><br><span class="line">        <span class="attr">jane:</span></span><br><span class="line">          <span class="attr">full_name:</span> <span class="string">Jane</span> <span class="string">Smith</span></span><br><span class="line">        <span class="attr">michael:</span></span><br><span class="line">          <span class="attr">full_name:</span> <span class="string">Michael</span> <span class="string">Smith</span></span><br><span class="line">        <span class="attr">tom:</span></span><br><span class="line">          <span class="attr">full_name:</span> <span class="string">Tom</span> <span class="string">Smith</span></span><br><span class="line">        <span class="attr">danel:</span></span><br><span class="line">          <span class="attr">full_name:</span> <span class="string">Danel</span> <span class="string">Smith</span></span><br><span class="line">        </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Removing</span> <span class="string">user</span></span><br><span class="line">      <span class="attr">user:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">"<span class="template-variable">{{ item.key }}</span>"</span></span><br><span class="line">        <span class="attr">comment:</span> <span class="string">"<span class="template-variable">{{ item.value.full_name }}</span>"</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">absent</span></span><br><span class="line">      <span class="attr">with_dict:</span></span><br><span class="line">        <span class="attr">jane:</span></span><br><span class="line">          <span class="attr">full_name:</span> <span class="string">Jane</span> <span class="string">Smith</span></span><br><span class="line">        <span class="attr">michael:</span></span><br><span class="line">          <span class="attr">full_name:</span> <span class="string">Michael</span> <span class="string">Smith</span></span><br><span class="line">        <span class="attr">tom:</span></span><br><span class="line">          <span class="attr">full_name:</span> <span class="string">Tom</span> <span class="string">Smith</span></span><br><span class="line">        <span class="attr">danel:</span></span><br><span class="line">          <span class="attr">full_name:</span> <span class="string">Danel</span> <span class="string">Smith</span></span><br><span class="line">      </span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p><strong>with_subelements循环</strong></p><p>组合子元素后，然后遍历</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">linux</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Creating</span> <span class="string">user</span></span><br><span class="line">      <span class="attr">user:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">"<span class="template-variable">{{ item.1 }}</span>"</span></span><br><span class="line">        <span class="attr">comment:</span> <span class="string">"<span class="template-variable">{{ item.1 | title }}</span> <span class="template-variable">{{ item.0.surname }}</span>"</span></span><br><span class="line">        <span class="comment"># https://docs.ansible.com/ansible/latest/plugins/lookup/password.html</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">"<span class="template-variable">{{ lookup('password', 'dev/null length=15 chars=ascii_letters,digits,hexdigits,punctuation') | password_hash('sha512') }}</span>"</span></span><br><span class="line">      <span class="attr">with_subelements:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">family:</span></span><br><span class="line">            <span class="attr">surname:</span> <span class="string">Smith</span></span><br><span class="line">            <span class="attr">members:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">jane</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">michael</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">tom</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">danel</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">members</span></span><br><span class="line">        </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Creating</span> <span class="string">user</span></span><br><span class="line">      <span class="attr">user:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">"<span class="template-variable">{{ item.1 }}</span>"</span></span><br><span class="line">        <span class="attr">comment:</span> <span class="string">"<span class="template-variable">{{ item.1 | title }}</span> <span class="template-variable">{{ item.0.surname }}</span>"</span></span><br><span class="line">        <span class="attr">password:</span> <span class="string">"<span class="template-variable">{{ lookup('password', 'dev/null length=15 chars=ascii_letters,digits,hexdigits,punctuation') | password_hash('sha512') }}</span>"</span></span><br><span class="line">      <span class="attr">with_subelements:</span></span><br><span class="line">        <span class="bullet">-</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">surname:</span> <span class="string">Smith</span></span><br><span class="line">            <span class="attr">members:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">jane</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">michael</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">tom</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">danel</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">surname:</span> <span class="string">James</span></span><br><span class="line">            <span class="attr">members:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">Kangkang</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">Lihua</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">surname:</span> <span class="string">Angne</span></span><br><span class="line">            <span class="attr">members:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="string">Richu</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">members</span></span><br><span class="line">      </span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p><strong>with_nested循环</strong></p><p>排列组合后，遍历</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">linux</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Creating</span> <span class="string">user</span> <span class="string">directories</span></span><br><span class="line">      <span class="attr">file:</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">"/home/<span class="template-variable">{{ item.0 }}</span>/<span class="template-variable">{{ item.1 }}</span>"</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">"<span class="template-variable">{{ item.0 }}</span>"</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">"<span class="template-variable">{{ item.0 }}</span>"</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line">      <span class="attr">with_nested:</span></span><br><span class="line">        <span class="bullet">-</span> [ <span class="string">jane</span>, <span class="string">michael</span>, <span class="string">tom</span>, <span class="string">danel</span> ]</span><br><span class="line">        <span class="bullet">-</span> [ <span class="string">photos</span>, <span class="string">movies</span>, <span class="string">documents</span> ]</span><br><span class="line">        </span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p><strong>with_together循环</strong></p><p>一一对应后，遍历</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">linux</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Creating</span> <span class="string">user</span> <span class="string">directories</span></span><br><span class="line">      <span class="attr">file:</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">"/home/<span class="template-variable">{{ item.0 }}</span>/<span class="template-variable">{{ item.1 }}</span>"</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">"<span class="template-variable">{{ item.0 }}</span>"</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">"<span class="template-variable">{{ item.0 }}</span>"</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line">      <span class="attr">with_together:</span></span><br><span class="line">        <span class="bullet">-</span> [ <span class="string">jane</span>, <span class="string">michael</span>, <span class="string">tom</span>, <span class="string">danel</span> ]</span><br><span class="line">        <span class="bullet">-</span> [ <span class="string">photos</span>, <span class="string">movies</span>, <span class="string">documents</span>, <span class="string">music</span> ]</span><br><span class="line">        </span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p><strong>with_file</strong>循环</p><p>遍历读取文件内容</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">linux</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">authorized</span> <span class="string">key</span></span><br><span class="line">      <span class="attr">authorized_key:</span></span><br><span class="line">        <span class="attr">user:</span> <span class="string">jane</span></span><br><span class="line">        <span class="attr">key:</span> <span class="string">"<span class="template-variable">{{ item }}</span>"</span></span><br><span class="line">      <span class="attr">with_file:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/home/ansible/.ssh/id_rsa.pub</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">custom_key.pub</span></span><br><span class="line">        </span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p><strong>with_sequence循环</strong></p><p>遍历序列</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">linux</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">sequence</span> <span class="string">directories</span></span><br><span class="line">      <span class="attr">file:</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">"/home/jane/sequence_<span class="template-variable">{{ item }}</span>"</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line">      <span class="attr">with_sequence:</span> <span class="string">start=0</span> <span class="string">end=100</span> <span class="string">stride=10</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">sequence</span> <span class="string">directories</span></span><br><span class="line">      <span class="attr">file:</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">"<span class="template-variable">{{ item }}</span>"</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line">      <span class="attr">with_sequence:</span> <span class="string">start=110</span> <span class="string">end=120</span> <span class="string">stride=2</span> <span class="string">format=/home/jane/hex_sequence_%d</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">hex</span> <span class="string">sequence</span> <span class="string">directories</span></span><br><span class="line">      <span class="attr">file:</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">"<span class="template-variable">{{ item }}</span>"</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line">      <span class="attr">with_sequence:</span> <span class="string">start=0</span> <span class="string">end=16</span> <span class="string">stride=1</span> <span class="string">format=/home/jane/hex_sequence_%x</span></span><br><span class="line">   </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">hex</span> <span class="string">sequence</span> <span class="string">directories</span></span><br><span class="line">      <span class="attr">file:</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">"<span class="template-variable">{{ item }}</span>"</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line">      <span class="attr">with_sequence:</span> <span class="string">count=5</span> <span class="string">format=/home/jane/count_sequence_%x</span></span><br><span class="line">      </span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p><strong>with_random_choice循环</strong></p><p>遍历选项，随机选择其一</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">linux</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">random</span> <span class="string">directory</span></span><br><span class="line">      <span class="attr">file:</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">"/home/jane/<span class="template-variable">{{ item }}</span>"</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">directory</span></span><br><span class="line">      <span class="attr">with_random_choice:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">"google"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">"apple"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">"microsoft"</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">"tencent"</span></span><br><span class="line">        </span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p><strong>util循环</strong></p><p>直到达到条件，循环停止</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">linux</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Run</span> <span class="string">a</span> <span class="string">script</span> <span class="string">until</span> <span class="string">we</span> <span class="string">hit</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">script:</span> <span class="string">random.sh</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">result</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">100</span></span><br><span class="line">      <span class="attr">util:</span> <span class="string">result.stdout.find("10")</span> <span class="type">!=</span> <span class="number">-1</span></span><br><span class="line">      <span class="attr">delay:</span> <span class="number">1</span></span><br><span class="line">        </span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> random.sh</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> !/bin/bash</span></span><br><span class="line">echo $((1 + RANDOM % 10))</span><br></pre></td></tr></tbody></table></figure><h3 id="5-5-异步、串行和并行">5.5 异步、串行和并行</h3><p>剧本执行也需要关注其执行的性能和速度</p><p>先看一个执行效率低下的剧本：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">linux</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Task</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">/bin/sleep</span> <span class="number">5</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Task</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">/bin/sleep</span> <span class="number">5</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Task</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">/bin/sleep</span> <span class="number">5</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Task</span> <span class="number">4</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">/bin/sleep</span> <span class="number">5</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Task</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">/bin/sleep</span> <span class="number">5</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Task</span> <span class="number">6</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">/bin/sleep</span> <span class="number">5</span></span><br><span class="line">      </span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>ansible的剧本执行默认使用线性策略：执行该任务的所有主机都执行完毕后，才开始进入下一个任务的执行。如果执行该任务的某一个主机因为性能或别的原因，需要很长时间才能执行完该任务，其他所有主机都需要等待。</p><p>ansible的剧本支持异步执行策略，有益于需要长执行时间的任务。</p><blockquote><p>异步指的是程序或任务可以并发执行，当前任务不必等待前一个任务的完成。在异步方式下，任务可以提交给其他线程、进程或服务进行处理，而当前任务可以继续执行其他操作。</p><p>应用场景：异步通常用于需要提高系统的并发性和响应性能的情况，比如处理大量的并发请求或执行耗时操作。</p></blockquote><p>修改上面剧本为异步剧本：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">linux</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Task</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">/bin/sleep</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">async:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">poll:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">result1</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Task</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">/bin/sleep</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">async:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">poll:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">result2</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Task</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">/bin/sleep</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">async:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">poll:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">result3</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Task</span> <span class="number">4</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">/bin/sleep</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">async:</span> <span class="number">60</span></span><br><span class="line">      <span class="attr">poll:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">result4</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Task</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">/bin/sleep</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">async:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">poll:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">result5</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Task</span> <span class="number">6</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">/bin/sleep</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">async:</span> <span class="number">10</span></span><br><span class="line">      <span class="attr">poll:</span> <span class="number">0</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">result6</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Capture</span> <span class="string">Job</span> <span class="string">IDs</span></span><br><span class="line">      <span class="attr">set_fact:</span></span><br><span class="line">        <span class="attr">jobids:</span> <span class="string">&gt;</span></span><br><span class="line"><span class="string">                {% if item.ansible_job_id is defined -%}</span></span><br><span class="line"><span class="string">                  {{ jobids + [item.ansible_job_id] }}</span></span><br><span class="line"><span class="string">                {% else -%}</span></span><br><span class="line"><span class="string">                  {{ jobids }}</span></span><br><span class="line"><span class="string">                {% endif %}</span></span><br><span class="line"><span class="string"></span>        <span class="attr">with_items:</span> <span class="string">"<span class="template-variable">{{ [ result1, result2, result3, result4, result5, result6 ] }}</span>"</span> </span><br><span class="line">    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Show</span> <span class="string">Job</span> <span class="string">IDs</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">var:</span> <span class="string">jobids</span></span><br><span class="line">        </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">'Wait for Job IDs'</span></span><br><span class="line">      <span class="attr">aysnc_status:</span></span><br><span class="line">        <span class="attr">jid:</span> <span class="string">"<span class="template-variable">{{ item }}</span>"</span></span><br><span class="line">      <span class="attr">with_items:</span> <span class="string">"<span class="template-variable">{{ jobids }}</span>"</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">jobs_result</span></span><br><span class="line">      <span class="attr">util:</span> <span class="string">jobs_result.finished</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">30</span></span><br><span class="line">        </span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>设置async参数为10，代表等待至少10秒，设置poll参数为0，代表每秒轮询状态，不等待上个任务所有主机都执行完毕就开始下一个任务，但是最终会等待所有任务执行完成。</p><p>上面的方法需要用到很多剧本的知识，还有其他简单的方法设置异步剧本，如执行<code>echo forks=6 &gt;&gt; ansible.cfg</code>，不修改原剧本的情况下就能实现执行的异步。</p><p>ansible的剧本支持串行批量执行策略。</p><blockquote><p>串行是一种任务执行方式，指的是任务按照顺序依次执行，每个任务在前一个任务完成后才能开始执行。在串行执行中，任务之间没有并发或并行的特性。</p><p>应用场景：串行通常用于必须按照严格的顺序执行任务的情况，比如单线程的程序或依赖关系严格的任务流。</p></blockquote><p>修改原剧本为串行批量执行剧本：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">linux</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">serial:</span> <span class="number">2</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Task</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">/bin/sleep</span> <span class="number">5</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Task</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">/bin/sleep</span> <span class="number">5</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Task</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">/bin/sleep</span> <span class="number">5</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Task</span> <span class="number">4</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">/bin/sleep</span> <span class="number">5</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Task</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">/bin/sleep</span> <span class="number">5</span></span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Task</span> <span class="number">6</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">/bin/sleep</span> <span class="number">5</span></span><br><span class="line">      </span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>serial设置分批次执行，2个执行主机为1批，比如说，centos1和centos2为第1批次，执行任务1，然后执行任务2，。。。，直到执行完成任务6。然后centos3和ubuntu1为第2个批次，执行任务1，然后执行任务2，。。。，直到执行完成任务6。最后ubuntu2和ubuntu3为第3个批次，执行任务1，然后执行任务2，。。。，直到执行完成任务6。</p><p>serial也可以指定为数字列表或百分比列表，即每个批次的执行主机数可以不一样。</p><p>ansible的剧本支持自由随机执行策略，适合没有执行顺序和主机要求的任务。</p><p>修改原剧本为自由随机执行剧本：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">linux</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  <span class="attr">strategy:</span> <span class="string">free</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Task</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">/bin/sleep</span> {{ <span class="number">10</span> <span class="string">|</span> <span class="string">random</span> }}</span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Task</span> <span class="number">2</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">/bin/sleep</span> {{ <span class="number">10</span> <span class="string">|</span> <span class="string">random</span> }}</span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Task</span> <span class="number">3</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">/bin/sleep</span> {{ <span class="number">10</span> <span class="string">|</span> <span class="string">random</span> }}</span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Task</span> <span class="number">4</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">/bin/sleep</span> {{ <span class="number">10</span> <span class="string">|</span> <span class="string">random</span> }}</span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Task</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">/bin/sleep</span> {{ <span class="number">10</span> <span class="string">|</span> <span class="string">random</span> }}</span><br><span class="line">      </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Task</span> <span class="number">6</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">/bin/sleep</span> {{ <span class="number">10</span> <span class="string">|</span> <span class="string">random</span> }}</span><br><span class="line">      </span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>任务执行的顺序和每次任务执行的主机数目都是随机的。</p><h3 id="5-6-任务委派">5.6 任务委派</h3><p>委派特定的任务在特定的目标上执行，因为存在在管理主机或其他被管理主机运行特定的命令或任务的需求。</p><p>如在主机ubuntu-c上设置ubuntu3的tcpwrappers规则，约束SSH连接只有来自ubuntu-c、centos1、ubuntu1主机才能成功。</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">ubuntu-c</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Generate</span> <span class="string">an</span> <span class="string">OpenSSH</span> <span class="string">keypair</span> <span class="string">for</span> <span class="string">ubuntu3</span></span><br><span class="line">      <span class="attr">openssh_keypair:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">~/.ssh/ubuntu3_id_rsa</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">linux</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Copy</span> <span class="string">ubuntu3</span> <span class="string">OpenSSH</span> <span class="string">keypair</span> <span class="string">with</span> <span class="string">permissions</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">owner:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">"<span class="template-variable">{{ item.0 }}</span>"</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">"<span class="template-variable">{{ item.0 }}</span>"</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="string">"<span class="template-variable">{{ item.1 }}</span>"</span></span><br><span class="line">      <span class="attr">with_together:</span></span><br><span class="line">        <span class="bullet">-</span> [ <span class="string">~/.ssh/ubuntu3_id_rsa</span>, <span class="string">~/.ssh/ubuntu3_id_rsa.pub</span> ]</span><br><span class="line">        <span class="bullet">-</span> [ <span class="string">"0600"</span>, <span class="string">"0644"</span> ]</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">ubuntu3</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Add</span> <span class="string">public</span> <span class="string">key</span> <span class="string">to</span> <span class="string">the</span> <span class="string">ubuntu3</span> <span class="string">authorized_keys</span> <span class="string">file</span></span><br><span class="line">      <span class="attr">authorized_key:</span></span><br><span class="line">        <span class="attr">user:</span> <span class="string">root</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">        <span class="attr">key:</span> <span class="string">"<span class="template-variable">{{ lookup('file', '~/.ssh/ubuntu3_id_rsa.pub') }}</span>"</span></span><br><span class="line">        </span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">that</span> <span class="string">ssh</span> <span class="string">can</span> <span class="string">connect</span> <span class="string">to</span> <span class="string">ubuntu3</span> <span class="string">using</span> <span class="string">the</span> <span class="string">ssh</span> <span class="string">tool</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">ssh</span> <span class="string">-i</span> <span class="string">~/.ssh/ubuntu3_id_rsa</span> <span class="string">-o</span> <span class="string">BatchMode=yes</span> <span class="string">-o</span> <span class="string">StrictHostKeyChecking=no</span> <span class="string">-o</span> <span class="string">UserKnownHostsFile=/dev/null</span> <span class="string">root@ubuntu3</span> <span class="string">date</span></span><br><span class="line">      <span class="attr">changed_when:</span> <span class="literal">False</span></span><br><span class="line">      <span class="attr">ignore_errors:</span> <span class="literal">True</span></span><br><span class="line">      </span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">ubuntu-c,</span> <span class="string">centos1,</span> <span class="string">ubuntu1</span></span><br><span class="line">  <span class="attr">serial:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Add</span> <span class="string">host</span> <span class="string">to</span> <span class="string">/etc/hosts.allow</span> <span class="string">for</span> <span class="string">sshd</span></span><br><span class="line">      <span class="attr">lineinfile:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/etc/hosts.allow</span></span><br><span class="line">        <span class="attr">line:</span> <span class="string">"sshd: <span class="template-variable">{{ ansible_hostname }}</span>.diveinto.io"</span></span><br><span class="line">        <span class="attr">create:</span> <span class="literal">True</span></span><br><span class="line">      <span class="attr">delegate_to:</span> <span class="string">ubuntu3</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> </span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">that</span> <span class="string">ssh</span> <span class="string">can</span> <span class="string">connect</span> <span class="string">to</span> <span class="string">ubuntu3</span> <span class="string">using</span> <span class="string">the</span> <span class="string">ssh</span> <span class="string">tool</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">ssh</span> <span class="string">-i</span> <span class="string">~/.ssh/ubuntu3_id_rsa</span> <span class="string">-o</span> <span class="string">BatchMode=yes</span> <span class="string">-o</span> <span class="string">StrictHostKeyChecking=no</span> <span class="string">-o</span> <span class="string">UserKnownHostsFile=/dev/null</span> <span class="string">root@ubuntu3</span> <span class="string">date</span></span><br><span class="line">      <span class="attr">changed_when:</span> <span class="literal">False</span></span><br><span class="line">      <span class="attr">ignore_errors:</span> <span class="literal">True</span></span><br><span class="line">      </span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">ubuntu3</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Drop</span> <span class="string">SSH</span> <span class="string">connectivity</span> <span class="string">from</span> <span class="string">everywhere</span> <span class="string">else</span></span><br><span class="line">      <span class="attr">lineinfile:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/etc/hosts.deny</span></span><br><span class="line">        <span class="attr">line:</span> <span class="string">"sshd: ALL"</span></span><br><span class="line">        <span class="attr">create:</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">that</span> <span class="string">ssh</span> <span class="string">can</span> <span class="string">connect</span> <span class="string">to</span> <span class="string">ubuntu3</span> <span class="string">using</span> <span class="string">the</span> <span class="string">ssh</span> <span class="string">tool</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">ssh</span> <span class="string">-i</span> <span class="string">~/.ssh/ubuntu3_id_rsa</span> <span class="string">-o</span> <span class="string">BatchMode=yes</span> <span class="string">-o</span> <span class="string">StrictHostKeyChecking=no</span> <span class="string">-o</span> <span class="string">UserKnownHostsFile=/dev/null</span> <span class="string">root@ubuntu3</span> <span class="string">date</span></span><br><span class="line">      <span class="attr">changed_when:</span> <span class="literal">False</span></span><br><span class="line">      <span class="attr">ignore_errors:</span> <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">ubuntu-c,</span> <span class="string">centos1,</span> <span class="string">ubuntu1</span></span><br><span class="line">  <span class="attr">serial:</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Remove</span> <span class="string">specific</span> <span class="string">host</span> <span class="string">entries</span> <span class="string">in</span> <span class="string">/etc/hosts.allow</span> <span class="string">for</span> <span class="string">sshd</span></span><br><span class="line">      <span class="attr">lineinfile:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/etc/hosts.allow</span></span><br><span class="line">        <span class="attr">line:</span> <span class="string">"sshd: <span class="template-variable">{{ ansible_hostname }}</span>.diveinto.io"</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">absent</span></span><br><span class="line">      <span class="attr">delegate_to:</span> <span class="string">ubuntu3</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">ubuntu3</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Allow</span> <span class="string">SSH</span> <span class="string">connectivity</span> <span class="string">from</span> <span class="string">everywhere</span></span><br><span class="line">      <span class="attr">lineinfile:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">/etc/hosts.deny</span></span><br><span class="line">        <span class="attr">line:</span> <span class="string">"sshd: ALL"</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">absent</span></span><br><span class="line">        </span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><h3 id="5-7-魔法变量">5.7 魔法变量</h3><p>Ansible默认会提供一些内置的变量以实现一些特定的功能，这些变量不能由用户直接设置，我们称之为魔法变量，如：</p><ul><li>hostvars</li><li>inventory_hostname</li><li>inventory_hostname_short</li><li>groups</li><li>group_names</li></ul><p>参考文档：<a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/reference_appendices/special_variables.html">https://docs.ansible.com/ansible/latest/reference_appendices/special_variables.html</a></p><p>示例：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Using</span> <span class="string">template,</span> <span class="string">create</span> <span class="string">a</span> <span class="string">remote</span> <span class="string">file</span> <span class="string">that</span> <span class="string">contains</span> <span class="string">all</span> <span class="string">variables</span> <span class="string">available</span> <span class="string">to</span> <span class="string">the</span> <span class="string">play</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">templates/dump_variables</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/tmp/ansible_variables</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Fetch</span> <span class="string">the</span> <span class="string">templated</span> <span class="string">file</span> <span class="string">with</span> <span class="string">all</span> <span class="string">variables,</span> <span class="string">back</span> <span class="string">to</span> <span class="string">the</span> <span class="string">control</span> <span class="string">host</span></span><br><span class="line">      <span class="attr">fetch:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">/tmp/ansible_variables</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">"captured_variables/<span class="template-variable">{{ ansible_hostname }}</span>"</span></span><br><span class="line">        <span class="attr">flat:</span> <span class="literal">yes</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Clean</span> <span class="string">up</span> <span class="string">left</span> <span class="string">over</span> <span class="string">files</span></span><br><span class="line">      <span class="attr">file:</span> </span><br><span class="line">        <span class="attr">name:</span> <span class="string">/tmp/ansible_variables</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">absent</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>其中，templates/dump_variables的内容为：</p><figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line">PLAYBOOK VARS (Ansible vars):</span><br><span class="line"></span><br><span class="line">{{ vars | to_nice_yaml }}</span><br></pre></td></tr></tbody></table></figure><h3 id="5-8-块的使用">5.8 块的使用</h3><p>块可以将任务进行分组，并且可以块级别上应用任务变量，同时支持在块内进行异常处理</p><p>常用语法：</p><blockquote><p>- block: 定义块</p><p>rescue: 当出现异常时，执行的语句</p><p>always: 无论结果如何都要执行的语句</p></blockquote><p>示例如下：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">linux</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">A</span> <span class="string">block</span> <span class="string">of</span> <span class="string">modules</span> <span class="string">being</span> <span class="string">executed</span></span><br><span class="line">      <span class="attr">block:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="number">1</span> <span class="string">CentOS</span> <span class="string">only</span></span><br><span class="line">          <span class="attr">debug:</span></span><br><span class="line">            <span class="attr">msg:</span> <span class="string">Example</span> <span class="number">1</span> <span class="string">CentOS</span> <span class="string">only</span></span><br><span class="line">          <span class="attr">when:</span> <span class="string">ansible_distribution</span> <span class="string">==</span> <span class="string">'CentOS'</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="number">2</span> <span class="string">Ubuntu</span> <span class="string">only</span></span><br><span class="line">          <span class="attr">debug:</span></span><br><span class="line">            <span class="attr">msg:</span> <span class="string">Example</span> <span class="number">2</span> <span class="string">Ubuntu</span> <span class="string">only</span></span><br><span class="line">          <span class="attr">when:</span> <span class="string">ansible_distribution</span> <span class="string">==</span> <span class="string">'Ubuntu'</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Example</span> <span class="number">3</span> <span class="string">with</span> <span class="string">items</span></span><br><span class="line">          <span class="attr">debug:</span></span><br><span class="line">            <span class="attr">msg:</span> <span class="string">"Example 3 with items - <span class="template-variable">{{ item }}</span>"</span></span><br><span class="line">          <span class="attr">with_items:</span> [<span class="string">'x'</span>, <span class="string">'y'</span>, <span class="string">'z'</span>]</span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">patch</span> <span class="string">and</span> <span class="string">python-dns</span></span><br><span class="line">      <span class="attr">block:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">patch</span></span><br><span class="line">          <span class="attr">package:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">patch</span></span><br><span class="line">        </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">python-dnspython</span></span><br><span class="line">          <span class="attr">package:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">python-dnspython</span></span><br><span class="line">            </span><br><span class="line">      <span class="attr">rescue:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Rollback</span> <span class="string">python</span></span><br><span class="line">          <span class="attr">package:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">patch</span></span><br><span class="line">            <span class="attr">state:</span> <span class="string">absent</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Rollback</span> <span class="string">python-dnspython</span></span><br><span class="line">          <span class="attr">package:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">python-dnspython</span></span><br><span class="line">            <span class="attr">state:</span> <span class="string">absent</span></span><br><span class="line">            </span><br><span class="line">      <span class="attr">always:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">            <span class="attr">msg:</span> <span class="string">This</span> <span class="string">always</span> <span class="string">runs,</span> <span class="string">regardless</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><h3 id="5-9-Vault信息保护">5.9 Vault信息保护</h3><p>Ansible Vault是一项安全功能，用于加密或保护剧本或文件中的敏感信息，而不是明文保存</p><p><strong>加密和解密变量</strong></p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 加密变量</span></span><br><span class="line">ansible@ubuntu-c:~/diveintoansible/Ansible Playbooks, Deep Dive/Vault/01$ ansible-vault encrypt_string --ask-vault-pass --name 'ansible_become_pass' 'password'</span><br><span class="line">New Vault password: </span><br><span class="line">Confirm New Vault password: </span><br><span class="line">Encryption successful</span><br><span class="line">ansible_become_pass: !vault |</span><br><span class="line">          $ANSIBLE_VAULT;1.1;AES256</span><br><span class="line">          34396561636439353966346563616432643335646135656133313163613862383439656565363334</span><br><span class="line">          3263326331356230396662656636323365663830346461350a396436373862383237643739643134</span><br><span class="line">          32303234386534323634313635303163346466356361656238356530393734306665383737656264</span><br><span class="line">          6163376237306532630a393531323666626262363538616566626136356462353430336361653864</span><br><span class="line">          3239</span><br></pre></td></tr></tbody></table></figure><p>然后修改group_vars/ubuntu为：</p><figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line">ansible_become: true</span><br><span class="line">ansible_become_pass: !vault |</span><br><span class="line">          $ANSIBLE_VAULT<span class="comment">;1.1;AES256</span></span><br><span class="line">          34396561636439353966346563616432643335646135656133313163613862383439656565363334</span><br><span class="line">          3263326331356230396662656636323365663830346461350a396436373862383237643739643134</span><br><span class="line">          32303234386534323634313635303163346466356361656238356530393734306665383737656264</span><br><span class="line">          6163376237306532630a393531323666626262363538616566626136356462353430336361653864</span><br><span class="line">          3239</span><br></pre></td></tr></tbody></table></figure><p>然后执行下面命令：</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 解密变量</span></span><br><span class="line">ansible@ubuntu-c:~/diveintoansible/Ansible Playbooks, Deep Dive/Vault/01$ ansible --ask-vault-pass ubuntu -m ping -o</span><br><span class="line">Vault password: </span><br><span class="line">ubuntu1 | SUCCESS =&gt; {"ansible_facts": {"discovered_interpreter_python": "/usr/bin/python3"},"changed": false,"ping": "pong"}</span><br><span class="line">ubuntu2 | SUCCESS =&gt; {"ansible_facts": {"discovered_interpreter_python": "/usr/bin/python3"},"changed": false,"ping": "pong"}</span><br><span class="line">ubuntu3 | SUCCESS =&gt; {"ansible_facts": {"discovered_interpreter_python": "/usr/bin/python3"},"changed": false,"ping": "pong"}</span><br></pre></td></tr></tbody></table></figure><p><strong>加密和解密文件</strong></p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 加密文件</span></span><br><span class="line">ansible@ubuntu-c:~/diveintoansible/Ansible Playbooks, Deep Dive/Vault/02$ ansible-vault encrypt external_vault_vars.yaml </span><br><span class="line">New Vault password: </span><br><span class="line">Confirm New Vault password: </span><br><span class="line">Encryption successful</span><br></pre></td></tr></tbody></table></figure><p>剧本内容：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">linux</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">vars_files:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">external_vault_vars.yaml</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Show</span> <span class="string">external_vault_var</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">var:</span> <span class="string">external_vault_var</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>执行：</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~/diveintoansible/Ansible Playbooks, Deep Dive/Vault/02$ ansible-playbook --ask-vault-pass vault_playbook.yaml</span><br><span class="line">Vault password:</span><br></pre></td></tr></tbody></table></figure><p>解密：</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~/diveintoansible/Ansible Playbooks, Deep Dive/Vault/02$ ansible-vault decrypt external_vault_vars.yaml</span><br><span class="line">Vault password:</span><br><span class="line">Decryption successful</span><br></pre></td></tr></tbody></table></figure><p><strong>重新加密数据</strong></p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 加密文件</span></span><br><span class="line">ansible@ubuntu-c:~/diveintoansible/Ansible Playbooks, Deep Dive/Vault/02$ ansible-vault encrypt external_vault_vars.yaml </span><br><span class="line">New Vault password: </span><br><span class="line">Confirm New vault password: </span><br><span class="line">Encryption successful</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 重新加密文件</span></span><br><span class="line">ansible@ubuntu-c:~/diveintoansible/Ansible Playbooks, Deep Dive/Vault/02$ ansible-vault rekey external_vault_vars.yaml </span><br><span class="line">New Vault password: </span><br><span class="line">Confirm New Vault password: </span><br><span class="line">Rekey successful</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看加密文件</span></span><br><span class="line">ansible@ubuntu-c:~/diveintoansible/Ansible Playbooks, Deep Dive/Vault/02$ ansible-vault view external_vault_vars.yaml </span><br><span class="line">Vault password: </span><br><span class="line">external_vault_var: Example External Vault Var</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看加密文件(使用密码文件)</span></span><br><span class="line">ansible@ubuntu-c:~/diveintoansible/Ansible Playbooks, Deep Dive/Vault/02$ ansible-vault view --vault-password-file password_file external_vault_vars.yaml </span><br><span class="line">external_vault_var: Example External Vault Var</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看加密文件(使用密码文件)</span></span><br><span class="line">ansible@ubuntu-c:~/diveintoansible/Ansible Playbooks, Deep Dive/Vault/02$ ansible-vault view --vault-id @password_file external_vault_vars.yaml </span><br><span class="line">external_vault_var: Example External Vault Var</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 加密文件至命名valut变量 —— vars</span></span><br><span class="line">ansible@ubuntu-c:~/diveintoansible/Ansible Playbooks, Deep Dive/Vault/02$ ansible-vault encrypt --vault-id vars@prompt external_vault_vars.yaml </span><br><span class="line">New vault passowrd (vars): </span><br><span class="line">Confirm New vault password (vars): </span><br><span class="line">Encryption successful</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 加密变量至命名valut变量 —— ssh</span></span><br><span class="line">ansible@ubuntu-c:~/diveintoansible/Ansible Playbooks, Deep Dive/Vault/02$ ansible-vault encrypt_string --vault-id ssh@prompt --name 'ansible_become_pass' 'password'</span><br><span class="line">New vault password (ssh): </span><br><span class="line">Confirm new vault password (ssh): </span><br><span class="line">Encryption successful</span><br><span class="line">ansible_become_pass: !vault |</span><br><span class="line">          $ANSIBLE_VAULT;1.2;AES256;ssh</span><br><span class="line">          30373934396234613766353262633936373238643366326131653735393237663830326362623432</span><br><span class="line">          6564663637656537366163323763316139616238633433340a633436323664643635383465383064</span><br><span class="line">          35633963306665626237306566376666383130396333326366663661653666663535316638303839</span><br><span class="line">          6131396362313266300a386331336665376562663631316564306138333534383131643439663364</span><br><span class="line">          6432</span><br><span class="line">          </span><br></pre></td></tr></tbody></table></figure><p>使用加密的变量和文件</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~/diveintoansible/Ansible Playbooks, Deep Dive/Vault/02$ ansible-vault encrypt_string --vault-id ssh@prompt --name 'ansible_become_pass' 'password'</span><br><span class="line">New vault password (ssh): </span><br><span class="line">Confirm new vault password (ssh): </span><br><span class="line">Encryption successful</span><br><span class="line">ansible_become_pass: !vault |</span><br><span class="line">          $ANSIBLE_VAULT;1.2;AES256;ssh</span><br><span class="line">          30373934396234613766353262633936373238643366326131653735393237663830326362623432</span><br><span class="line">          6564663637656537366163323763316139616238633433340a633436323664643635383465383064</span><br><span class="line">          35633963306665626237306566376666383130396333326366663661653666663535316638303839</span><br><span class="line">          6131396362313266300a386331336665376562663631316564306138333534383131643439663364</span><br><span class="line">          6432ansible@ubuntu-c:~/diveintoansible/Ansible Playbooks, Deep Dive/Vault/02$ ^C</span><br><span class="line">ansible@ubuntu-c:~/diveintoansible/Ansible Playbooks, Deep Dive/Vault/02$ ansible-playbook --vault-id vars@prompt --vault-id ssh@prompt vault_playbook.yaml </span><br><span class="line">Vault password (vars): </span><br><span class="line">Vault password (ssh): </span><br><span class="line"></span><br><span class="line">PLAY [linux] *******************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *********************************************************************************</span><br><span class="line">ok: [centos2]</span><br><span class="line">ok: [centos1]</span><br><span class="line">ok: [centos3]</span><br><span class="line">ok: [ubuntu1]</span><br><span class="line">ok: [ubuntu2]</span><br><span class="line">ok: [ubuntu3]</span><br><span class="line"></span><br><span class="line">TASK [Show external_vault_var] *************************************************************************</span><br><span class="line">ok: [centos1] =&gt; {</span><br><span class="line">    "external_vault_var": "Example External Vault Var"</span><br><span class="line">}</span><br><span class="line">ok: [centos2] =&gt; {</span><br><span class="line">    "external_vault_var": "Example External Vault Var"</span><br><span class="line">}</span><br><span class="line">ok: [centos3] =&gt; {</span><br><span class="line">    "external_vault_var": "Example External Vault Var"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu1] =&gt; {</span><br><span class="line">    "external_vault_var": "Example External Vault Var"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu2] =&gt; {</span><br><span class="line">    "external_vault_var": "Example External Vault Var"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu3] =&gt; {</span><br><span class="line">    "external_vault_var": "Example External Vault Var"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PLAY RECAP *********************************************************************************************</span><br><span class="line">centos1                    : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">centos2                    : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">centos3                    : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">ubuntu1                    : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">ubuntu2                    : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">ubuntu3                    : ok=2    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br></pre></td></tr></tbody></table></figure><p>还可以加密剧本到命名vault变量，类似上述操作，在此不再赘述。</p><h2 id="6-构建Ansible-Playbooks">6. 构建Ansible Playbooks</h2><blockquote><p>使用includes和imports、Tags标签和Roles角色</p></blockquote><h3 id="6-1-使用includes和imports">6.1 使用includes和imports</h3><p>先准备tasks文件，如play1_task2.yaml:</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Play</span> <span class="number">1</span> <span class="bullet">-</span> <span class="string">Task</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">debug:</span></span><br><span class="line">    <span class="attr">msg:</span> <span class="string">Play</span> <span class="number">1</span> <span class="bullet">-</span> <span class="string">Task</span> <span class="number">2</span></span><br><span class="line"> </span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p><strong>include_tasks指令</strong></p><p>动态导入</p><p>使用include_tasks指令在下面的剧本文件中将play1_task2.yaml文件导入：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Play</span> <span class="number">1</span> <span class="bullet">-</span> <span class="string">Task</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">Play</span> <span class="number">1</span> <span class="bullet">-</span> <span class="string">Task</span> <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">include_tasks:</span> <span class="string">play1_task2.yaml</span></span><br><span class="line"> </span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>测试：</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~/diveintoansible/Structuring Ansible Playbooks/Using Include and Import/01$  ansible-playbook include_tasks_playbook.yaml </span><br><span class="line"></span><br><span class="line">PLAY [all] ***********************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ***********************************************************************************************************</span><br><span class="line">ok: [ubuntu-c]</span><br><span class="line">ok: [centos1]</span><br><span class="line">ok: [centos2]</span><br><span class="line">ok: [centos3]</span><br><span class="line">ok: [ubuntu1]</span><br><span class="line">ok: [ubuntu2]</span><br><span class="line">ok: [ubuntu3]</span><br><span class="line"></span><br><span class="line">TASK [Play 1 - Task 1] ***********************************************************************************************************</span><br><span class="line">ok: [ubuntu-c] =&gt; {</span><br><span class="line">    "msg": "Play 1 - Task 1"</span><br><span class="line">}</span><br><span class="line">ok: [centos1] =&gt; {</span><br><span class="line">    "msg": "Play 1 - Task 1"</span><br><span class="line">}</span><br><span class="line">ok: [centos2] =&gt; {</span><br><span class="line">    "msg": "Play 1 - Task 1"</span><br><span class="line">}</span><br><span class="line">ok: [centos3] =&gt; {</span><br><span class="line">    "msg": "Play 1 - Task 1"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu1] =&gt; {</span><br><span class="line">    "msg": "Play 1 - Task 1"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu2] =&gt; {</span><br><span class="line">    "msg": "Play 1 - Task 1"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu3] =&gt; {</span><br><span class="line">    "msg": "Play 1 - Task 1"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">TASK [include_tasks] *************************************************************************************************************</span><br><span class="line">included: /home/ansible/diveintoansible/Structuring Ansible Playbooks/Using Include and Import/01/play1_task2.yaml for ubuntu-c, centos1, centos2, centos3, ubuntu1, ubuntu2, ubuntu3</span><br><span class="line"></span><br><span class="line">TASK [Play 1 - Task 2] ***********************************************************************************************************</span><br><span class="line">ok: [ubuntu-c] =&gt; {</span><br><span class="line">    "msg": "Play 1 - Task 2"</span><br><span class="line">}</span><br><span class="line">ok: [centos1] =&gt; {</span><br><span class="line">    "msg": "Play 1 - Task 2"</span><br><span class="line">}</span><br><span class="line">ok: [centos2] =&gt; {</span><br><span class="line">    "msg": "Play 1 - Task 2"</span><br><span class="line">}</span><br><span class="line">ok: [centos3] =&gt; {</span><br><span class="line">    "msg": "Play 1 - Task 2"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu1] =&gt; {</span><br><span class="line">    "msg": "Play 1 - Task 2"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu2] =&gt; {</span><br><span class="line">    "msg": "Play 1 - Task 2"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu3] =&gt; {</span><br><span class="line">    "msg": "Play 1 - Task 2"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PLAY RECAP ***********************************************************************************************************************</span><br><span class="line">centos1                    : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">centos2                    : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">centos3                    : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">ubuntu-c                   : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">ubuntu1                    : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">ubuntu2                    : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">ubuntu3                    : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0 </span><br></pre></td></tr></tbody></table></figure><p><strong>import_tasks指令</strong></p><p>静态导入</p><p>使用import_tasks指令在下面的剧本文件中将play1_task2.yaml文件导入：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Play</span> <span class="number">1</span> <span class="bullet">-</span> <span class="string">Task</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">Play</span> <span class="number">1</span> <span class="bullet">-</span> <span class="string">Task</span> <span class="number">1</span></span><br><span class="line">        </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">import_tasks:</span> <span class="string">play1_task2.yaml</span></span><br><span class="line"> </span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>测试：</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~/diveintoansible/Structuring Ansible Playbooks/Using Include and Import/02$ ansible-playbook import_tasks_playbook.yaml </span><br><span class="line"></span><br><span class="line">PLAY [all] ***********************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ***********************************************************************************************************</span><br><span class="line">ok: [ubuntu-c]</span><br><span class="line">ok: [centos1]</span><br><span class="line">ok: [centos2]</span><br><span class="line">ok: [centos3]</span><br><span class="line">ok: [ubuntu1]</span><br><span class="line">ok: [ubuntu2]</span><br><span class="line">ok: [ubuntu3]</span><br><span class="line"></span><br><span class="line">TASK [Play 1 - Task 1] ***********************************************************************************************************</span><br><span class="line">ok: [ubuntu-c] =&gt; {</span><br><span class="line">    "msg": "Play 1 - Task 1"</span><br><span class="line">}</span><br><span class="line">ok: [centos1] =&gt; {</span><br><span class="line">    "msg": "Play 1 - Task 1"</span><br><span class="line">}</span><br><span class="line">ok: [centos2] =&gt; {</span><br><span class="line">    "msg": "Play 1 - Task 1"</span><br><span class="line">}</span><br><span class="line">ok: [centos3] =&gt; {</span><br><span class="line">    "msg": "Play 1 - Task 1"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu1] =&gt; {</span><br><span class="line">    "msg": "Play 1 - Task 1"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu2] =&gt; {</span><br><span class="line">    "msg": "Play 1 - Task 1"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu3] =&gt; {</span><br><span class="line">    "msg": "Play 1 - Task 1"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">TASK [Play 1 - Task 2] ***********************************************************************************************************</span><br><span class="line">ok: [ubuntu-c] =&gt; {</span><br><span class="line">    "msg": "Play 1 - Task 2"</span><br><span class="line">}</span><br><span class="line">ok: [centos1] =&gt; {</span><br><span class="line">    "msg": "Play 1 - Task 2"</span><br><span class="line">}</span><br><span class="line">ok: [centos2] =&gt; {</span><br><span class="line">    "msg": "Play 1 - Task 2"</span><br><span class="line">}</span><br><span class="line">ok: [centos3] =&gt; {</span><br><span class="line">    "msg": "Play 1 - Task 2"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu1] =&gt; {</span><br><span class="line">    "msg": "Play 1 - Task 2"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu2] =&gt; {</span><br><span class="line">    "msg": "Play 1 - Task 2"</span><br><span class="line">}</span><br><span class="line">ok: [ubuntu3] =&gt; {</span><br><span class="line">    "msg": "Play 1 - Task 2"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PLAY RECAP ***********************************************************************************************************************</span><br><span class="line">centos1                    : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">centos2                    : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">centos3                    : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">ubuntu-c                   : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">ubuntu1                    : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">ubuntu2                    : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">ubuntu3                    : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0  </span><br></pre></td></tr></tbody></table></figure><p><strong>静态导入vs动态导入</strong></p><table><thead><tr><th style="text-align:center">静态导入</th><th style="text-align:center">动态导入</th></tr></thead><tbody><tr><td style="text-align:center">在解析剧本时处理</td><td style="text-align:center">在剧本执行时处理</td></tr><tr><td style="text-align:center">每个任务将独立针对when条件执行</td><td style="text-align:center">when 语句执行一次，如果满足条件，则执行所有任务</td></tr><tr><td style="text-align:center">import指令</td><td style="text-align:center">include指令</td></tr></tbody></table><p>为了对比，分别创建import_tasks.yaml和include_tasks.yaml，其中：</p><p>import_task.yaml</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">set_fact:</span></span><br><span class="line">    <span class="attr">import_tasks_var:</span> <span class="string">foo</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">2nd</span> <span class="string">Task</span></span><br><span class="line">  <span class="attr">debug:</span> </span><br><span class="line">    <span class="attr">msg:</span> <span class="string">2nd</span> <span class="string">Task</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">3rd</span> <span class="string">Task</span></span><br><span class="line">  <span class="attr">debug:</span> </span><br><span class="line">    <span class="attr">msg:</span> <span class="string">3rd</span> <span class="string">Task</span></span><br><span class="line">    </span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>include_tasks.yaml</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">set_fact:</span></span><br><span class="line">    <span class="attr">include_tasks_var:</span> <span class="string">foo</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">2nd</span> <span class="string">Task</span></span><br><span class="line">  <span class="attr">debug:</span> </span><br><span class="line">    <span class="attr">msg:</span> <span class="string">2nd</span> <span class="string">Task</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">3rd</span> <span class="string">Task</span></span><br><span class="line">  <span class="attr">debug:</span> </span><br><span class="line">    <span class="attr">msg:</span> <span class="string">3rd</span> <span class="string">Task</span></span><br><span class="line">    </span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>比较import指令和include指令的剧本include_import_tasks_playbook.yaml：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">centos1</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line"></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">         <span class="attr">msg:</span> <span class="string">=====================</span> <span class="string">Testing</span> <span class="string">include_tasks</span> <span class="string">=====================</span></span><br><span class="line">     <span class="comment"># include_tasks is dynamic</span></span><br><span class="line">     <span class="comment"># The when statement is executed once, if the condition is met, all tasks are executed</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">include_tasks:</span> <span class="string">include_tasks.yaml</span></span><br><span class="line">       <span class="attr">when:</span> <span class="string">include_tasks_var</span> <span class="string">is</span> <span class="string">not</span> <span class="string">defined</span></span><br><span class="line"></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">         <span class="attr">msg:</span> <span class="string">=====================</span> <span class="string">Testing</span> <span class="string">import_tasks</span> <span class="string">======================</span></span><br><span class="line"></span><br><span class="line">     <span class="comment"># import_tasks is static</span></span><br><span class="line">     <span class="comment"># Each task that in the include will be independently executed against the when condition</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">import_tasks:</span> <span class="string">import_tasks.yaml</span></span><br><span class="line">       <span class="attr">when:</span> <span class="string">import_tasks_var</span> <span class="string">is</span> <span class="string">not</span> <span class="string">defined</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>测试：</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~/diveintoansible/Structuring Ansible Playbooks/Using Include and Import/03$ ansible-playbook include_import_tasks_playbook.yaml </span><br><span class="line"></span><br><span class="line">PLAY [centos1] *******************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ***********************************************************************************************************</span><br><span class="line">ok: [centos1]</span><br><span class="line"></span><br><span class="line">TASK [debug] *********************************************************************************************************************</span><br><span class="line">ok: [centos1] =&gt; {</span><br><span class="line">    "msg": "===================== Testing include_tasks ====================="</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">TASK [include_tasks] *************************************************************************************************************</span><br><span class="line">included: /home/ansible/diveintoansible/Structuring Ansible Playbooks/Using Include and Import/03/include_tasks.yaml for centos1</span><br><span class="line"></span><br><span class="line">TASK [set_fact] ******************************************************************************************************************</span><br><span class="line">ok: [centos1]</span><br><span class="line"></span><br><span class="line">TASK [2nd Task] ******************************************************************************************************************</span><br><span class="line">ok: [centos1] =&gt; {</span><br><span class="line">    "msg": "2nd Task"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">TASK [3rd Task] ******************************************************************************************************************</span><br><span class="line">ok: [centos1] =&gt; {</span><br><span class="line">    "msg": "3rd Task"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">TASK [debug] *********************************************************************************************************************</span><br><span class="line">ok: [centos1] =&gt; {</span><br><span class="line">    "msg": "===================== Testing import_tasks ======================"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">TASK [set_fact] ******************************************************************************************************************</span><br><span class="line">ok: [centos1]</span><br><span class="line"></span><br><span class="line">TASK [2nd Task] ******************************************************************************************************************</span><br><span class="line">skipping: [centos1]</span><br><span class="line"></span><br><span class="line">TASK [3rd Task] ******************************************************************************************************************</span><br><span class="line">skipping: [centos1]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ***********************************************************************************************************************</span><br><span class="line">centos1                    : ok=8    changed=0    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0</span><br></pre></td></tr></tbody></table></figure><p><strong>import_playbook指令</strong></p><p>先准备剧本文件，如imported_playbook.yaml:</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">centos1</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">set_fact:</span></span><br><span class="line">         <span class="attr">import_playbook_var:</span> <span class="literal">true</span></span><br><span class="line">         </span><br><span class="line">     <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">         <span class="attr">msg:</span> <span class="string">Playbook</span> <span class="string">executed</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>使用import_playbook指令在下面的剧本文件中将imported_playbook.yaml文件静态导入</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">import_playbook:</span> <span class="string">imported_playbook.yaml</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">import_playbook_var</span> <span class="string">is</span> <span class="string">not</span> <span class="string">defined</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>每个任务都会进行一次when条件的判断。</p><h3 id="6-2-使用tags">6.2 使用tags</h3><p>标签在处理大型剧本或剧本中包含其他剧本时非常有用，你可以运行部分配置而无需运行整个剧本</p><p>如：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">linux</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">linux</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">webapp</span></span><br><span class="line">  <span class="attr">vars_files:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">vars/logos.yaml</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">EPEL</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">epel-release</span></span><br><span class="line">        <span class="attr">update_cache:</span> <span class="literal">yes</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_distribution</span> <span class="string">==</span> <span class="string">'CentOS'</span></span><br><span class="line">      <span class="attr">tags:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">install-epel</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Nginx</span></span><br><span class="line">      <span class="attr">package:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line">      <span class="attr">tags:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">install-nginx</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line">      <span class="attr">notify:</span> <span class="string">Check</span> <span class="string">HTTP</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">tags:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Template</span> <span class="string">index.html-easter_egg.j2</span> <span class="string">to</span> <span class="string">index.html</span> <span class="string">on</span> <span class="string">target</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">index.html-easter_egg.j2</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">"<span class="template-variable">{{ nginx_root_location }}</span>/index.html"</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0644</span></span><br><span class="line">      <span class="attr">tags:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">deploy-app</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">unzip</span></span><br><span class="line">      <span class="attr">package:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">unzip</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Unarchive</span> <span class="string">playbook</span> <span class="string">stacker</span> <span class="string">game</span></span><br><span class="line">      <span class="attr">unarchive:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">playbook_stacker.zip</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">"<span class="template-variable">{{ nginx_root_location }}</span>"</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0755</span></span><br><span class="line">      <span class="attr">tags:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">deploy-app</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">HTTP</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">http://{{</span> <span class="string">ansible_default_ipv4.address</span> <span class="string">}}</span></span><br><span class="line">        <span class="attr">status_code:</span> <span class="number">200</span> </span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>执行时添加<code>--tags</code>可只运行部分任务，添加<code>--skip-tags</code>可不执行部分命令，<strong>always</strong>标签的任务总是会指向，可通过<code>--skip-tags "always"</code>指令跳过</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~/diveintoansible/Structuring Ansible Playbooks/Using Tags/03$ ansible-playbook nginx_playbook.yaml --tags "install-epel"</span><br><span class="line"></span><br><span class="line">ansible@ubuntu-c:~/diveintoansible/Structuring Ansible Playbooks/Using Tags/03$ ansible-playbook nginx_playbook.yaml --tags "install-nginx,restart-nginx"</span><br><span class="line"></span><br><span class="line">ansible@ubuntu-c:~/diveintoansible/Structuring Ansible Playbooks/Using Tags/03$ ansible-playbook nginx_playbook.yaml --skip-tags "deploy-app"</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure><p>除了给任务打tag外，也可以给剧本打tag，但是可能会影响facts变量的值，因为默认情况下facts变量指向default标签。</p><p><strong>特殊标签</strong>:</p><ul><li>tagged: 只有打了tag的任务才会执行</li><li>untagged: 打了tag的任务不会执行</li><li>all：运行所有任务，默认ansible 使用 --tags all运行</li></ul><p>如：</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 运行所有任务</span></span><br><span class="line">ansible@ubuntu-c:~/diveintoansible/Structuring Ansible Playbooks/Using Tags/04$ ansible-playbook nginx_playbook.yaml --tags "all"</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 只运行打了tag的任务</span></span><br><span class="line">ansible@ubuntu-c:~/diveintoansible/Structuring Ansible Playbooks/Using Tags/04$ ansible-playbook nginx_playbook.yaml --tags "tagged"</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 只运行没打tag的任务</span></span><br><span class="line">ansible@ubuntu-c:~/diveintoansible/Structuring Ansible Playbooks/Using Tags/04$ ansible-playbook nginx_playbook.yaml --tags "untagged"</span><br></pre></td></tr></tbody></table></figure><p>除了任务、剧本可以打标签外，导入也可以打标签，如下：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">ubuntu3</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">include_tasks:</span> <span class="string">include_tasks.yaml</span></span><br><span class="line">      <span class="attr">tags:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">include_tasks</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">import_tasks:</span> <span class="string">import_tasks.yaml</span></span><br><span class="line">      <span class="attr">tags:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">import_tasks</span></span><br><span class="line">        </span><br><span class="line"><span class="bullet">-</span> <span class="attr">import_playbook:</span> <span class="string">import_playbook.yaml</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">import_playbook</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><h3 id="6-3-使用roles">6.3 使用roles</h3><p>roles（角色）用于<strong>层次性，结构化</strong>地组织剧本，角色分别将变量、文件、任务、模块及处理器放置于单独的目录中，而在剧本中使用include指令导入。</p><p>使用角色的好处：</p><ul><li><p>代码复用</p></li><li><p>角色使大项目更加容易管理</p></li><li><p>角色按逻辑分组的结构，更易于分享</p></li><li><p>可以根据特定需求编写角色，如web server的角色，DNS角色或补丁角色</p></li><li><p>角色可以独立开发，由不同实体并行</p></li><li><p>模板、变量、文件、已指定目录和include被简化</p></li><li><p>角色可以依赖其他角色，因此提供自动包含</p></li></ul><p>简单的角色结构示例：</p><blockquote><p>roles/ \ansible所有的信息都放到此目录下面对应的目录中<br>└── example-role \角色名称<br>├── default \为当前角色设定默认变量时使用此目录，应当包含一个main.yml文件；<br>├── files \存放有copy或script等模块调用的文件，或压缩安装包等<br>├── handlers \此目录总应当包含一个main.yml文件，用于定义各角色用到的各handler<br>├── meta \应当包含一个main.yml，用于定义角色的特殊设定及其依赖关系<br>├── tasks \至少包含一个名为main.yml的文件，定义了此角色的任务列表，可使用include指令<br>├── templates \template模块会自动在此目录中寻找Jinja2模板文件<br>└── vars \应当包含一个main.yml文件，用于定义此角色用到的变量</p></blockquote><p><strong>将已有剧本改成角色结构</strong></p><p>有一个批量部署nginx应用的剧本，<strong>./nginx_playbook.yaml</strong>内容为：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">linux</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">linux</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">webapp</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">vars_files:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">vars/logos.yaml</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">EPEL</span></span><br><span class="line">      <span class="attr">yum:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">epel-release</span></span><br><span class="line">        <span class="attr">update_cache:</span> <span class="literal">yes</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_distribution</span> <span class="string">==</span> <span class="string">'CentOS'</span></span><br><span class="line">      <span class="attr">tags:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">install-epel</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Nginx</span></span><br><span class="line">      <span class="attr">package:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line">      <span class="attr">tags:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">install-nginx</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">service:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line">      <span class="attr">notify:</span> <span class="string">Check</span> <span class="string">HTTP</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">tags:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Template</span> <span class="string">index.html-easter_egg.j2</span> <span class="string">to</span> <span class="string">index.html</span> <span class="string">on</span> <span class="string">target</span></span><br><span class="line">      <span class="attr">template:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">templates/index.html-easter_egg.j2</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">"<span class="template-variable">{{ nginx_root_location }}</span>/index.html"</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0644</span></span><br><span class="line">      <span class="attr">tags:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">deploy-app</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">unzip</span></span><br><span class="line">      <span class="attr">package:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">unzip</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Unarchive</span> <span class="string">playbook</span> <span class="string">stacker</span> <span class="string">game</span></span><br><span class="line">      <span class="attr">unarchive:</span></span><br><span class="line">        <span class="attr">src:</span> <span class="string">playbook_stacker.zip</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">"<span class="template-variable">{{ nginx_root_location }}</span>"</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0755</span></span><br><span class="line">      <span class="attr">tags:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">deploy-app</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">HTTP</span> <span class="string">Service</span></span><br><span class="line">      <span class="attr">uri:</span></span><br><span class="line">        <span class="attr">url:</span> <span class="string">http://{{</span> <span class="string">ansible_default_ipv4.address</span> <span class="string">}}</span></span><br><span class="line">        <span class="attr">status_code:</span> <span class="number">200</span> </span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>另外，模板内容可参见Ansible课程代码</p><p>使用<strong>ansible-galaxy</strong>指令创建roles</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~/diveintoansible/Structuring Ansible Playbooks/Using Roles/02$ ansible-galaxy init nginx</span><br><span class="line">- Role nginx was created successfully</span><br><span class="line">ansible@ubuntu-c:~/diveintoansible/Structuring Ansible Playbooks/Using Roles/02$ find .</span><br><span class="line">.</span><br><span class="line">./ansible.cfg</span><br><span class="line">./files</span><br><span class="line">./files/playbook_stacker.zip</span><br><span class="line">./group_vars</span><br><span class="line">./group_vars/centos</span><br><span class="line">./group_vars/ubuntu</span><br><span class="line">./hosts</span><br><span class="line">./host_vars</span><br><span class="line">./host_vars/centos1</span><br><span class="line">./host_vars/ubuntu-c</span><br><span class="line">./nginx</span><br><span class="line">./nginx/defaults</span><br><span class="line">./nginx/defaults/main.yml</span><br><span class="line">./nginx/files</span><br><span class="line">./nginx/handlers</span><br><span class="line">./nginx/handlers/main.yml</span><br><span class="line">./nginx/meta</span><br><span class="line">./nginx/meta/main.yml</span><br><span class="line">./nginx/README.md</span><br><span class="line">./nginx/tasks</span><br><span class="line">./nginx/tasks/main.yml</span><br><span class="line">./nginx/templates</span><br><span class="line">./nginx/tests</span><br><span class="line">./nginx/tests/inventory</span><br><span class="line">./nginx/tests/test.yml</span><br><span class="line">./nginx/vars</span><br><span class="line">./nginx/vars/main.yml</span><br><span class="line">./nginx_playbook.yaml</span><br><span class="line">./templates</span><br><span class="line">./templates/index.html-ansible_managed.j2</span><br><span class="line">./templates/index.html-base.j2</span><br><span class="line">./templates/index.html-easter_egg.j2</span><br><span class="line">./templates/index.html-logos.j2</span><br><span class="line">./templates/index.html.j2</span><br><span class="line">./vars</span><br><span class="line">./vars/logos.yaml</span><br></pre></td></tr></tbody></table></figure><p>将<strong>nginx_playbook.yaml</strong>文件中handlers部分的内容写入<strong>nginx/handlers/main.yml</strong>，如下：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Check</span> <span class="string">HTTP</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">uri:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">http://{{</span> <span class="string">ansible_default_ipv4.address</span> <span class="string">}}</span></span><br><span class="line">    <span class="attr">status_code:</span> <span class="number">200</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>移动现有的模板进入<strong>nginx/templates</strong>文件夹</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~/diveintoansible/Structuring Ansible Playbooks/Using Roles/02$ mv templates/* nginx/templates/ &amp;&amp; rm -rf templates/</span><br></pre></td></tr></tbody></table></figure><p>移动现有文件进入<strong>nginx/files</strong>目录</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~/diveintoansible/Structuring Ansible Playbooks/Using Roles/02$ mv files/* nginx/files/ &amp;&amp; rm -rf files/</span><br></pre></td></tr></tbody></table></figure><p>复制现有变量内容到<strong>nginx/var/main.yml</strong>，进入文件删除多余的破折号和点</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~/diveintoansible/Structuring Ansible Playbooks/Using Roles/02$ cat vars/logos.yaml &gt;&gt; nginx/vars/main.yml</span><br><span class="line">ansible@ubuntu-c:~/diveintoansible/Structuring Ansible Playbooks/Using Roles/02$ rm -rf vars/</span><br></pre></td></tr></tbody></table></figure><p>将<strong>nginx_playbook.yaml</strong>文件中tasks部分的内容写入<strong>nginx/tasks/main.yml</strong>，并修改template部分，如下：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">EPEL</span></span><br><span class="line">  <span class="attr">yum:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">epel-release</span></span><br><span class="line">    <span class="attr">update_cache:</span> <span class="literal">yes</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line">  <span class="attr">when:</span> <span class="string">ansible_distribution</span> <span class="string">==</span> <span class="string">'CentOS'</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">install-epel</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">Nginx</span></span><br><span class="line">  <span class="attr">package:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">install-nginx</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Restart</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">restarted</span></span><br><span class="line">  <span class="attr">notify:</span> <span class="string">Check</span> <span class="string">HTTP</span> <span class="string">Service</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">always</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Template</span> <span class="string">index.html-easter_egg.j2</span> <span class="string">to</span> <span class="string">index.html</span> <span class="string">on</span> <span class="string">target</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">index.html-easter_egg.j2</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">"<span class="template-variable">{{ nginx_root_location }}</span>/index.html"</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="number">0644</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">deploy-app</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Install</span> <span class="string">unzip</span></span><br><span class="line">  <span class="attr">package:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">unzip</span></span><br><span class="line">    <span class="attr">state:</span> <span class="string">latest</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Unarchive</span> <span class="string">playbook</span> <span class="string">stacker</span> <span class="string">game</span></span><br><span class="line">  <span class="attr">unarchive:</span></span><br><span class="line">    <span class="attr">src:</span> <span class="string">playbook_stacker.zip</span></span><br><span class="line">    <span class="attr">dest:</span> <span class="string">"<span class="template-variable">{{ nginx_root_location }}</span>"</span></span><br><span class="line">    <span class="attr">mode:</span> <span class="number">0755</span></span><br><span class="line">  <span class="attr">tags:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">deploy-app</span></span><br><span class="line">    </span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>修改<strong>nginx_playbook.yaml</strong>为：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">linux</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">nginx</span></span><br><span class="line">    </span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>此时，文件结构变为：</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~/diveintoansible/Structuring Ansible Playbooks/Using Roles/02$ find .</span><br><span class="line">.</span><br><span class="line">./ansible.cfg</span><br><span class="line">./group_vars</span><br><span class="line">./group_vars/centos</span><br><span class="line">./group_vars/ubuntu</span><br><span class="line">./hosts</span><br><span class="line">./host_vars</span><br><span class="line">./host_vars/centos1</span><br><span class="line">./host_vars/ubuntu-c</span><br><span class="line">./nginx</span><br><span class="line">./nginx/.travis.yml</span><br><span class="line">./nginx/defaults</span><br><span class="line">./nginx/defaults/main.yml</span><br><span class="line">./nginx/files</span><br><span class="line">./nginx/files/playbook_stacker.zip</span><br><span class="line">./nginx/handlers</span><br><span class="line">./nginx/handlers/main.yml</span><br><span class="line">./nginx/meta</span><br><span class="line">./nginx/meta/main.yml</span><br><span class="line">./nginx/README.md</span><br><span class="line">./nginx/tasks</span><br><span class="line">./nginx/tasks/main.yml</span><br><span class="line">./nginx/templates</span><br><span class="line">./nginx/templates/index.html-ansible_managed.j2</span><br><span class="line">./nginx/templates/index.html-base.j2</span><br><span class="line">./nginx/templates/index.html-easter_egg.j2</span><br><span class="line">./nginx/templates/index.html-logos.j2</span><br><span class="line">./nginx/templates/index.html.j2</span><br><span class="line">./nginx/tests</span><br><span class="line">./nginx/tests/inventory</span><br><span class="line">./nginx/tests/test.yml</span><br><span class="line">./nginx/vars</span><br><span class="line">./nginx/vars/main.yml</span><br><span class="line">./nginx_playbook.yaml</span><br></pre></td></tr></tbody></table></figure><p>经过测试，发现可以正常运行。</p><p>上面的nginx角色还可以继续把webapp部分拆分出来做为独立的角色。</p><p>角色也可以覆盖参数，如下：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">linux</span></span><br><span class="line"> </span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">nginx</span></span><br><span class="line">    <span class="bullet">-</span> { <span class="attr">role:</span> <span class="string">webapp</span>, <span class="attr">target_dir:</span> <span class="string">"{%- if ansible_distribution == 'CentOS' -%}/usr/share/nginx/html{%- elif ansible_distribution == 'Ubuntu' -%}/var/www/html{%- endif %}"</span> }</span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p><strong>角色依赖</strong></p><p>可以在<strong>webapp/meta/main.yml</strong>文件最后为webapp角色添加对nginx角色的依赖：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="string">......</span> <span class="string">省略大量内容</span></span><br><span class="line"><span class="attr">dependencies:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nginx</span></span><br></pre></td></tr></tbody></table></figure><p>剧本内容变为：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">linux</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> { <span class="attr">role:</span> <span class="string">webapp</span>, <span class="attr">target_dir:</span> <span class="string">"{%- if ansible_distribution == 'CentOS' -%}/usr/share/nginx/html{%- elif ansible_distribution == 'Ubuntu' -%}/var/www/html{%- endif %}"</span> }</span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><h2 id="7-云服务、容器、Ansible">7. 云服务、容器、Ansible</h2><blockquote><p>AWS、Docker与Ansible</p></blockquote><h3 id="7-1-AWS与Ansible">7.1 AWS与Ansible</h3><p>使用Ansible在AWS中自动化部署实例</p><p>首先在AWS的EC2控制台中创建密钥对，然后去个人账号创建访问密钥，进入VPCs创建默认的VPC</p><p>然后在AWS的EC2控制台中创建实例，选定系统镜像</p><p>配置AWS模块</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~/diveintoansible/Using Ansible with Cloud Services and Containers/AWS with Ansible/01$ export AWS_ACCESS_KEY_ID="your_accesskey"</span><br><span class="line"></span><br><span class="line">ansible@ubuntu-c:~/diveintoansible/Using Ansible with Cloud Services and Containers/AWS with Ansible/01$ export AWS_SECRET_ACCESS_KEY="your_accesskey_secret"</span><br><span class="line"></span><br><span class="line">ansible@ubuntu-c:~/diveintoansible/Using Ansible with Cloud Services and Containers/AWS with Ansible/01$ sudo pip install boto boto3</span><br></pre></td></tr></tbody></table></figure><p><strong>ansible.cfg</strong>文件</p><figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">[defaults]</span></span><br><span class="line"><span class="attr">inventory</span>=hosts</span><br><span class="line"><span class="attr">host_key_checking</span>=<span class="literal">False</span></span><br><span class="line"><span class="attr">forks</span>=<span class="number">6</span></span><br></pre></td></tr></tbody></table></figure><p><strong>hosts</strong>文件</p><figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">[control]</span></span><br><span class="line">ubuntu-c</span><br><span class="line"></span><br><span class="line"><span class="section">[centos]</span></span><br><span class="line">centos<span class="section">[1:3]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[ubuntu]</span></span><br><span class="line">ubuntu<span class="section">[1:3]</span></span><br><span class="line"></span><br><span class="line"><span class="section">[linux:children]</span></span><br><span class="line">centos</span><br><span class="line">ubuntu</span><br></pre></td></tr></tbody></table></figure><p><strong>ec2_playbook.yaml</strong>文件</p><ul><li>在 AWS 中创建用于 SSH 访问和 HTTP 的安全组</li><li>预置一组实例</li><li>将所有实例公共 IP 添加到主机组</li><li></li></ul><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">connection:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">a</span> <span class="string">security</span> <span class="string">group</span> <span class="string">in</span> <span class="string">AWS</span> <span class="string">for</span> <span class="string">SSH</span> <span class="string">access</span> <span class="string">and</span> <span class="string">HTTP</span></span><br><span class="line">      <span class="attr">ec2_group:</span></span><br><span class="line">         <span class="attr">name:</span> <span class="string">ansible</span></span><br><span class="line">         <span class="attr">description:</span> <span class="string">Ansible</span> <span class="string">Security</span> <span class="string">Group</span></span><br><span class="line">         <span class="attr">region:</span> <span class="string">us-east-1</span></span><br><span class="line">         <span class="attr">rules:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">proto:</span> <span class="string">tcp</span></span><br><span class="line">              <span class="attr">from_port:</span> <span class="number">80</span></span><br><span class="line">              <span class="attr">to_port:</span> <span class="number">80</span></span><br><span class="line">              <span class="attr">cidr_ip:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">proto:</span> <span class="string">tcp</span></span><br><span class="line">              <span class="attr">from_port:</span> <span class="number">22</span></span><br><span class="line">              <span class="attr">to_port:</span> <span class="number">22</span></span><br><span class="line">              <span class="attr">cidr_ip:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Provision</span> <span class="string">a</span> <span class="string">set</span> <span class="string">of</span> <span class="string">instances</span></span><br><span class="line">      <span class="attr">ec2:</span></span><br><span class="line">         <span class="attr">key_name:</span> <span class="string">ansible</span></span><br><span class="line">         <span class="attr">group:</span> <span class="string">ansible</span></span><br><span class="line">         <span class="attr">instance_type:</span> <span class="string">t2.micro</span></span><br><span class="line">         <span class="attr">image:</span> <span class="string">ami-096fda3c22c1c990a</span></span><br><span class="line">         <span class="attr">region:</span> <span class="string">us-east-1</span></span><br><span class="line">         <span class="attr">wait:</span> <span class="literal">true</span></span><br><span class="line">         <span class="attr">exact_count:</span> <span class="number">20</span></span><br><span class="line">         <span class="attr">count_tag:</span></span><br><span class="line">            <span class="attr">Name:</span> <span class="string">AnsibleNginxWebservers</span></span><br><span class="line">         <span class="attr">instance_tags:</span></span><br><span class="line">            <span class="attr">Name:</span> <span class="string">Ansible</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">ec2</span></span><br><span class="line">      <span class="attr">ignore_errors:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Add</span> <span class="string">all</span> <span class="string">instance</span> <span class="string">public</span> <span class="string">IPs</span> <span class="string">to</span> <span class="string">host</span> <span class="string">group</span></span><br><span class="line">      <span class="attr">add_host:</span></span><br><span class="line">        <span class="attr">hostname:</span> <span class="string">"<span class="template-variable">{{ item.public_ip }}</span>"</span></span><br><span class="line">        <span class="attr">groups:</span> <span class="string">ansiblehosts</span></span><br><span class="line">      <span class="attr">with_items:</span> <span class="string">"<span class="template-variable">{{ ec2.instances }}</span>"</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Show</span> <span class="string">group</span></span><br><span class="line">      <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">var:</span> <span class="string">groups.ansiblehosts</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>使用AWS动态清单</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~/diveintoansible/Using Ansible with Cloud Services and Containers/AWS with Ansible/04$ mkdir inventory &amp;&amp; cd inventory</span><br><span class="line"></span><br><span class="line">ansible@ubuntu-c:~/diveintoansible/Using Ansible with Cloud Services and Containers/AWS with Ansible/04$ wget https://raw.githubusercontent.com/ansible/ansible/stable-2.9/contrib/inventory/ec2.py</span><br><span class="line"></span><br><span class="line">ansible@ubuntu-c:~/diveintoansible/Using Ansible with Cloud Services and Containers/AWS with Ansible/04$ wget https://raw.githubusercontent.com/ansible/ansible/stable-2.9/contrib/inventory/ec2.ini</span><br><span class="line"></span><br><span class="line">ansible@ubuntu-c:~/diveintoansible/Using Ansible with Cloud Services and Containers/AWS with Ansible/04$ chmod u+x ec2.py </span><br></pre></td></tr></tbody></table></figure><p>修改ec2.py文件，第1行的python变为python3，注释掉第172行内容，即<code># from ansible.module_utils import ec2 as ec2_utils</code></p><p>修改ec2.ini文件:<code>cache_max_go=0</code></p><p>配置：</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~/diveintoansible/Using Ansible with Cloud Services and Containers/AWS with Ansible/04$ export EC2_INI_PATH=inventory/ec2.ini</span><br></pre></td></tr></tbody></table></figure><p>修改ansible.cfg为：</p><figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">[defaults]</span></span><br><span class="line"><span class="attr">inventory</span>=inventory/ec2</span><br><span class="line"><span class="attr">host_key_checking</span>=<span class="literal">False</span></span><br><span class="line"><span class="attr">forks</span>=<span class="number">20</span></span><br><span class="line"><span class="attr">ansible_managed</span>=Managed by Ansible - file:{file} - host:{host} - uid:{uid}</span><br></pre></td></tr></tbody></table></figure><p>创建~./ssh/ansible.pem，将密钥复制到此处，并且设置权限为600</p><p>创建group_vars/tag_Name_Ansible：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="string">ansible_ssh_private_key_file:~./ssh/ansible.pem</span></span><br><span class="line"><span class="attr">ansible_user:</span> <span class="string">ec2-user</span></span><br><span class="line"><span class="attr">ansible_become:</span> <span class="literal">true</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>修改剧本内容为：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">connection:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">a</span> <span class="string">security</span> <span class="string">group</span> <span class="string">in</span> <span class="string">AWS</span> <span class="string">for</span> <span class="string">SSH</span> <span class="string">access</span> <span class="string">and</span> <span class="string">HTTP</span></span><br><span class="line">      <span class="attr">ec2_group:</span></span><br><span class="line">         <span class="attr">name:</span> <span class="string">ansible</span></span><br><span class="line">         <span class="attr">description:</span> <span class="string">Ansible</span> <span class="string">Security</span> <span class="string">Group</span></span><br><span class="line">         <span class="attr">region:</span> <span class="string">us-east-1</span></span><br><span class="line">         <span class="attr">rules:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">proto:</span> <span class="string">tcp</span></span><br><span class="line">              <span class="attr">from_port:</span> <span class="number">80</span></span><br><span class="line">              <span class="attr">to_port:</span> <span class="number">80</span></span><br><span class="line">              <span class="attr">cidr_ip:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">proto:</span> <span class="string">tcp</span></span><br><span class="line">              <span class="attr">from_port:</span> <span class="number">22</span></span><br><span class="line">              <span class="attr">to_port:</span> <span class="number">22</span></span><br><span class="line">              <span class="attr">cidr_ip:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Provision</span> <span class="string">a</span> <span class="string">set</span> <span class="string">of</span> <span class="string">instances</span></span><br><span class="line">      <span class="attr">ec2:</span></span><br><span class="line">         <span class="attr">key_name:</span> <span class="string">ansible</span></span><br><span class="line">         <span class="attr">group:</span> <span class="string">ansible</span></span><br><span class="line">         <span class="attr">instance_type:</span> <span class="string">t2.micro</span></span><br><span class="line">         <span class="attr">image:</span> <span class="string">ami-096fda3c22c1c990a</span></span><br><span class="line">         <span class="attr">region:</span> <span class="string">us-east-1</span></span><br><span class="line">         <span class="attr">wait:</span> <span class="literal">true</span></span><br><span class="line">         <span class="attr">exact_count:</span> <span class="number">20</span></span><br><span class="line">         <span class="attr">count_tag:</span></span><br><span class="line">            <span class="attr">Name:</span> <span class="string">AnsibleNginxWebservers</span></span><br><span class="line">         <span class="attr">instance_tags:</span></span><br><span class="line">            <span class="attr">Name:</span> <span class="string">Ansible</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">ec2</span></span><br><span class="line">      <span class="attr">ignore_errors:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Refresh</span> <span class="string">inventory</span> <span class="string">to</span> <span class="string">ensure</span> <span class="string">new</span> <span class="string">instances</span> <span class="string">exist</span> <span class="string">in</span> <span class="string">inventory</span></span><br><span class="line">      <span class="attr">meta:</span> <span class="string">refresh_inventory</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">tag_Name_Ansible</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> { <span class="attr">role:</span> <span class="string">webapp</span>, <span class="attr">target_dir:</span> <span class="string">/usr/share/nginx/html</span> }</span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>并将其改为角色结构，详细代码可查看提供的教程代码</p><p>测试：</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~/diveintoansible/Using Ansible with Cloud Services and Containers/AWS with Ansible/04$ ansible tag_Name_Ansible -m ping -o</span><br></pre></td></tr></tbody></table></figure><p>最终剧本为：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">connection:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">a</span> <span class="string">security</span> <span class="string">group</span> <span class="string">in</span> <span class="string">AWS</span> <span class="string">for</span> <span class="string">SSH</span> <span class="string">access</span> <span class="string">and</span> <span class="string">HTTP</span></span><br><span class="line">      <span class="attr">ec2_group:</span></span><br><span class="line">         <span class="attr">name:</span> <span class="string">ansible</span></span><br><span class="line">         <span class="attr">description:</span> <span class="string">Ansible</span> <span class="string">Security</span> <span class="string">Group</span></span><br><span class="line">         <span class="attr">region:</span> <span class="string">us-east-1</span></span><br><span class="line">         <span class="attr">rules:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">proto:</span> <span class="string">tcp</span></span><br><span class="line">              <span class="attr">from_port:</span> <span class="number">80</span></span><br><span class="line">              <span class="attr">to_port:</span> <span class="number">80</span></span><br><span class="line">              <span class="attr">cidr_ip:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">proto:</span> <span class="string">tcp</span></span><br><span class="line">              <span class="attr">from_port:</span> <span class="number">22</span></span><br><span class="line">              <span class="attr">to_port:</span> <span class="number">22</span></span><br><span class="line">              <span class="attr">cidr_ip:</span> <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span><span class="string">/0</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Provision</span> <span class="string">a</span> <span class="string">set</span> <span class="string">of</span> <span class="string">instances</span></span><br><span class="line">      <span class="attr">ec2:</span></span><br><span class="line">         <span class="attr">key_name:</span> <span class="string">ansible</span></span><br><span class="line">         <span class="attr">group:</span> <span class="string">ansible</span></span><br><span class="line">         <span class="attr">instance_type:</span> <span class="string">t2.micro</span></span><br><span class="line">         <span class="attr">image:</span> <span class="string">ami-096fda3c22c1c990a</span></span><br><span class="line">         <span class="attr">region:</span> <span class="string">us-east-1</span></span><br><span class="line">         <span class="attr">wait:</span> <span class="literal">true</span></span><br><span class="line">         <span class="attr">exact_count:</span> <span class="number">20</span></span><br><span class="line">         <span class="attr">count_tag:</span></span><br><span class="line">            <span class="attr">Name:</span> <span class="string">AnsibleNginxWebservers</span></span><br><span class="line">         <span class="attr">instance_tags:</span></span><br><span class="line">            <span class="attr">Name:</span> <span class="string">Ansible</span></span><br><span class="line">      <span class="attr">register:</span> <span class="string">ec2</span></span><br><span class="line">      <span class="attr">ignore_errors:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Refresh</span> <span class="string">inventory</span> <span class="string">to</span> <span class="string">ensure</span> <span class="string">new</span> <span class="string">instances</span> <span class="string">exist</span> <span class="string">in</span> <span class="string">inventory</span></span><br><span class="line">      <span class="attr">meta:</span> <span class="string">refresh_inventory</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">tag_Name_Ansible</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">    <span class="bullet">-</span> { <span class="attr">role:</span> <span class="string">webapp</span>, <span class="attr">target_dir:</span> <span class="string">/usr/share/nginx/html</span> }</span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">tag_Name_Ansible</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">debug:</span></span><br><span class="line">        <span class="attr">msg:</span> <span class="string">"Check http://<span class="template-variable">{{ ansible_host }}</span>"</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">pause:</span></span><br><span class="line">        <span class="attr">prompt:</span> <span class="string">"Verify service availability and continue to terminate"</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Remove</span> <span class="string">tagged</span> <span class="string">EC2</span> <span class="string">instances</span> <span class="string">from</span> <span class="string">security</span> <span class="string">group</span> <span class="string">by</span> <span class="string">setting</span> <span class="string">an</span> <span class="string">empty</span> <span class="string">group</span></span><br><span class="line">      <span class="attr">ec2:</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">running</span></span><br><span class="line">        <span class="attr">region:</span> <span class="string">"<span class="template-variable">{{ ec2_region }}</span>"</span></span><br><span class="line">        <span class="attr">instance_ids:</span> <span class="string">"<span class="template-variable">{{ ec2_id }}</span>"</span></span><br><span class="line">        <span class="attr">group_id:</span> <span class="string">""</span></span><br><span class="line">      <span class="attr">delegate_to:</span> <span class="string">localhost</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Terminate</span> <span class="string">EC2</span> <span class="string">instances</span></span><br><span class="line">      <span class="attr">ec2:</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">absent</span></span><br><span class="line">        <span class="attr">region:</span> <span class="string">"<span class="template-variable">{{ ec2_region }}</span>"</span></span><br><span class="line">        <span class="attr">instance_ids:</span> <span class="string">"<span class="template-variable">{{ ec2_id }}</span>"</span></span><br><span class="line">        <span class="attr">wait:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">delegate_to:</span> <span class="string">localhost</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">localhost</span></span><br><span class="line">  <span class="attr">connection:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Remove</span> <span class="string">ansible</span> <span class="string">security</span> <span class="string">group</span></span><br><span class="line">    <span class="attr">ec2_group:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">ansible</span></span><br><span class="line">      <span class="attr">region:</span> <span class="string">us-east-1</span></span><br><span class="line">      <span class="attr">state:</span> <span class="string">absent</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><h3 id="7-2-Docker与Ansible">7.2 Docker与Ansible</h3><p>配置Docker实验室</p><p>install_docker.sh脚本：</p><figure class="highlight sh"><table><tbody><tr><td class="code"><pre><span class="line">install_docker.sh sudo apt update</span><br><span class="line">sudo apt install -y docker.io</span><br><span class="line">pip3 install docker</span><br></pre></td></tr></tbody></table></figure><p>执行：</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~/diveintoansible/Using Ansible with Cloud Services and Containers/Docker with Ansible/01$ bash -x install_docker.sh</span><br></pre></td></tr></tbody></table></figure><p>设置环境变量envdocker</p><figure class="highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="built_in">export</span> DOCKER_HOST=tcp://docker:2375</span><br></pre></td></tr></tbody></table></figure><p>使之生效</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible@ubuntu-c:~/diveintoansible/Using Ansible with Cloud Services and Containers/Docker with Ansible/01$ source envdocker</span><br></pre></td></tr></tbody></table></figure><p>编写剧本 docker_playbook.yaml:</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">ubuntu-c</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Pull</span> <span class="string">images</span></span><br><span class="line">      <span class="attr">docker_host:</span> <span class="string">tcp://docker:2375</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">"<span class="template-variable">{{ item }}</span>"</span></span><br><span class="line">      <span class="attr">source:</span> <span class="string">pull</span></span><br><span class="line">      <span class="attr">with_items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">centos</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">ubuntu</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">nginx</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">wernight/funbox</span></span><br><span class="line">    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">a</span> <span class="string">customised</span> <span class="string">index.html</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/shared/index.html</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0644</span></span><br><span class="line">        <span class="attr">content:</span></span><br><span class="line">          <span class="string">Customised</span> <span class="string">page</span> <span class="string">for</span> <span class="string">nginxcustomised</span></span><br><span class="line">    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">a</span> <span class="string">customised</span> <span class="string">Dockerfile</span></span><br><span class="line">      <span class="attr">copy:</span></span><br><span class="line">        <span class="attr">dest:</span> <span class="string">/shared/Dockerfile</span></span><br><span class="line">        <span class="attr">mode:</span> <span class="number">0644</span></span><br><span class="line">        <span class="attr">content:</span></span><br><span class="line">          <span class="string">FROM</span> <span class="string">nginx</span></span><br><span class="line">          <span class="string">COPY</span> <span class="string">index.html</span> <span class="string">/usr/share/nginx/html/index.html</span></span><br><span class="line">    </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Build</span> <span class="string">a</span> <span class="string">customised</span> <span class="string">image</span></span><br><span class="line">      <span class="attr">docker_image:</span></span><br><span class="line">        <span class="attr">docker_host:</span> <span class="string">tcp://docker:2375</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">nginxcustomised:latest</span></span><br><span class="line">        <span class="attr">source:</span> <span class="string">build</span></span><br><span class="line">        <span class="attr">build:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/shared</span></span><br><span class="line">          <span class="attr">pull:</span> <span class="literal">yes</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">present</span></span><br><span class="line">        <span class="attr">force_source:</span> <span class="literal">yes</span></span><br><span class="line">        </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="string">an</span> <span class="string">nginxcustomised</span> <span class="string">container</span></span><br><span class="line">      <span class="attr">docker_container:</span></span><br><span class="line">        <span class="attr">docker_host:</span> <span class="string">tcp://docker:2375</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">containerwebserver</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginxcustomised:latest</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="number">80</span><span class="string">:80</span></span><br><span class="line">        <span class="attr">container_default_behavior:</span> <span class="string">no_defaults</span></span><br><span class="line">        <span class="attr">recreate:</span> <span class="literal">yes</span></span><br><span class="line">        </span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>其他例子：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">ubuntu-c</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Pull</span> <span class="string">python</span> <span class="string">image</span></span><br><span class="line">      <span class="attr">docker_image:</span></span><br><span class="line">        <span class="attr">docker_host:</span> <span class="string">tcp://docker:2375</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">python:3.8.5</span></span><br><span class="line">        <span class="attr">source:</span> <span class="string">pull</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Create</span> <span class="number">3</span> <span class="string">python</span> <span class="string">containers</span></span><br><span class="line">      <span class="attr">docker_container:</span></span><br><span class="line">        <span class="attr">docker_host:</span> <span class="string">tcp://docker:2375</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">"python<span class="template-variable">{{ item }}</span>"</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">python:3.8.5</span></span><br><span class="line">        <span class="attr">container_default_behavior:</span> <span class="string">no_defaults</span></span><br><span class="line">        <span class="attr">command:</span> <span class="string">sleep</span> <span class="string">infinity</span></span><br><span class="line">      <span class="attr">with_sequence:</span> <span class="number">1</span><span class="number">-3</span></span><br><span class="line">      </span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">containers</span></span><br><span class="line">  <span class="attr">gather_facts:</span> <span class="literal">False</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Ping</span> <span class="string">containers</span></span><br><span class="line">      <span class="attr">ping:</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p>其中，containers的配置为：</p><figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">[containers]</span></span><br><span class="line">python<span class="section">[1:3]</span> <span class="attr">ansible_connection</span>=docker ansible_python_interpreter=/usr/bin/python3</span><br></pre></td></tr></tbody></table></figure><p>终止并移除容器</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">ubuntu-c</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Remove</span> <span class="string">old</span> <span class="string">containers</span></span><br><span class="line">      <span class="attr">docker_container:</span></span><br><span class="line">        <span class="attr">docker_host:</span> <span class="string">tcp://docker:2375</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">"<span class="template-variable">{{ item }}</span>"</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">absent</span></span><br><span class="line">        <span class="attr">container_default_behavior:</span> <span class="string">no_defaults</span></span><br><span class="line">      <span class="attr">with_items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">containerwebserver</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">python1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">python2</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">python3</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Remove</span> <span class="string">images</span></span><br><span class="line">      <span class="attr">docker_image:</span></span><br><span class="line">        <span class="attr">docker_host:</span> <span class="string">tcp://docker:2375</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">"<span class="template-variable">{{ item }}</span>"</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">absent</span></span><br><span class="line">      <span class="attr">with_items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">centos</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">ubuntu</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">nginx</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">wernight/funbox</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">nginxcustomised</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">python:3.8.5</span></span><br><span class="line"></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Remove</span> <span class="string">files</span></span><br><span class="line">      <span class="attr">file:</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">"<span class="template-variable">{{ item }}</span>"</span></span><br><span class="line">        <span class="attr">state:</span> <span class="string">absent</span></span><br><span class="line">      <span class="attr">with_items:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/shared/Dockerfile</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/shared/index.html</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><h2 id="8-创建模块和插件">8. 创建模块和插件</h2><blockquote><p>创建自己的模块和插件</p></blockquote><h3 id="8-1-创建模块">8.1 创建模块</h3><p>下载ansible源码</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">git clone https://github.com/ansible/ansible.git</span><br></pre></td></tr></tbody></table></figure><p>使用开发工具Hacking去调试模块，如：</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">~/ansible/hacking/test_module -m ~/ansible/lib/ansible/modules/command.py -a hostname</span><br></pre></td></tr></tbody></table></figure><p>生成模块测试成功和失败报告</p><p><a target="_blank" rel="noopener" href="http://xn--icmp-4j1ir14k.sh">脚本icmp.sh</a></p><figure class="highlight sh"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">source</span> <span class="variable">$1</span>&gt;/dev/null 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line">TARGET=<span class="variable">${target:-127.0.0.1}</span></span><br><span class="line"></span><br><span class="line">ping -c 1 <span class="variable">${TARGET}</span> &gt;/dev/null 2&gt;/dev/null</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ $? == 0 ];</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"{\"changed\": true, \"rc\": 0}"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"{\"failed\": true, \"msg\": \"failed to ping\", \"rc\": 1}"</span></span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></tbody></table></figure><p>测试：</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">~ansible/hacking/test-module -m icmp.sh</span><br><span class="line">~ansible/hacking/test-module -m icmp.sh -a 'target=centos1'</span><br></pre></td></tr></tbody></table></figure><p>模块测试结果保存在 <strong>/home/ansible/.ansible_module_generated</strong> 中</p><p>模块输入的参数保存在**/home/ansible/.ansible_test_module_arguments** 中</p><p>两个文件中有数据的前提是使用了<code>source $1&gt;/dev/null 2&gt;&amp;1</code>捕获输入</p><p><strong>创建一个简单的ping模块</strong></p><p>在ansible工作目录下新建一个library文件夹，将icmp.sh放入library文件夹并去掉.sh文件后缀，就算创建了一个简单的ping模块</p><p>剧本内容为：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">linux</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Test</span> <span class="string">icmp</span> <span class="string">module</span></span><br><span class="line">      <span class="attr">icmp:</span></span><br><span class="line">        <span class="attr">target:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line"></span><br><span class="line"><span class="string">。。。</span></span><br></pre></td></tr></tbody></table></figure><p>如果想要将自定义模块发布到ansible源，需要遵循规范，可以参考：<a target="_blank" rel="noopener" href="http://docs.ansible.com/ansible/latest/dev_guide/developing_modules_general.html">http://docs.ansible.com/ansible/latest/dev_guide/developing_modules_general.html</a></p><p>官方给的模块模板内容如下：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Copyright: (c) 2018, Terry Jones &lt;terry.jones@example.org&gt;</span></span><br><span class="line"><span class="comment"># GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> (absolute_import, division, print_function)</span><br><span class="line">__metaclass__ = <span class="built_in">type</span></span><br><span class="line"></span><br><span class="line">DOCUMENTATION = <span class="string">r'''</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">module: my_test</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">short_description: This is my test module</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># If this is part of a collection, you need to use semantic versioning,</span></span><br><span class="line"><span class="string"># i.e. the version is of the form "2.5.0" and not "2.4".</span></span><br><span class="line"><span class="string">version_added: "1.0.0"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">description: This is my longer description explaining my test module.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">options:</span></span><br><span class="line"><span class="string">    name:</span></span><br><span class="line"><span class="string">        description: This is the message to send to the test module.</span></span><br><span class="line"><span class="string">        required: true</span></span><br><span class="line"><span class="string">        type: str</span></span><br><span class="line"><span class="string">    new:</span></span><br><span class="line"><span class="string">        description:</span></span><br><span class="line"><span class="string">            - Control to demo if the result of this module is changed or not.</span></span><br><span class="line"><span class="string">            - Parameter description can be a list as well.</span></span><br><span class="line"><span class="string">        required: false</span></span><br><span class="line"><span class="string">        type: bool</span></span><br><span class="line"><span class="string"># Specify this value according to your collection</span></span><br><span class="line"><span class="string"># in format of namespace.collection.doc_fragment_name</span></span><br><span class="line"><span class="string">extends_documentation_fragment:</span></span><br><span class="line"><span class="string">    - my_namespace.my_collection.my_doc_fragment_name</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">author:</span></span><br><span class="line"><span class="string">    - Your Name (@yourGitHubHandle)</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line">EXAMPLES = <span class="string">r'''</span></span><br><span class="line"><span class="string"># Pass in a message</span></span><br><span class="line"><span class="string">- name: Test with a message</span></span><br><span class="line"><span class="string">  my_namespace.my_collection.my_test:</span></span><br><span class="line"><span class="string">    name: hello world</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># pass in a message and have changed true</span></span><br><span class="line"><span class="string">- name: Test with a message and changed output</span></span><br><span class="line"><span class="string">  my_namespace.my_collection.my_test:</span></span><br><span class="line"><span class="string">    name: hello world</span></span><br><span class="line"><span class="string">    new: true</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># fail the module</span></span><br><span class="line"><span class="string">- name: Test failure of the module</span></span><br><span class="line"><span class="string">  my_namespace.my_collection.my_test:</span></span><br><span class="line"><span class="string">    name: fail me</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line">RETURN = <span class="string">r'''</span></span><br><span class="line"><span class="string"># These are examples of possible return values, and in general should use other names for return values.</span></span><br><span class="line"><span class="string">original_message:</span></span><br><span class="line"><span class="string">    description: The original name param that was passed in.</span></span><br><span class="line"><span class="string">    type: str</span></span><br><span class="line"><span class="string">    returned: always</span></span><br><span class="line"><span class="string">    sample: 'hello world'</span></span><br><span class="line"><span class="string">message:</span></span><br><span class="line"><span class="string">    description: The output message that the test module generates.</span></span><br><span class="line"><span class="string">    type: str</span></span><br><span class="line"><span class="string">    returned: always</span></span><br><span class="line"><span class="string">    sample: 'goodbye'</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ansible.module_utils.basic <span class="keyword">import</span> AnsibleModule</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_module</span>():</span></span><br><span class="line">    <span class="comment"># define available arguments/parameters a user can pass to the module</span></span><br><span class="line">    module_args = <span class="built_in">dict</span>(</span><br><span class="line">        name=<span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">'str'</span>, required=<span class="literal">True</span>),</span><br><span class="line">        new=<span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">'bool'</span>, required=<span class="literal">False</span>, default=<span class="literal">False</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># seed the result dict in the object</span></span><br><span class="line">    <span class="comment"># we primarily care about changed and state</span></span><br><span class="line">    <span class="comment"># changed is if this module effectively modified the target</span></span><br><span class="line">    <span class="comment"># state will include any data that you want your module to pass back</span></span><br><span class="line">    <span class="comment"># for consumption, for example, in a subsequent task</span></span><br><span class="line">    result = <span class="built_in">dict</span>(</span><br><span class="line">        changed=<span class="literal">False</span>,</span><br><span class="line">        original_message=<span class="string">''</span>,</span><br><span class="line">        message=<span class="string">''</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># the AnsibleModule object will be our abstraction working with Ansible</span></span><br><span class="line">    <span class="comment"># this includes instantiation, a couple of common attr would be the</span></span><br><span class="line">    <span class="comment"># args/params passed to the execution, as well as if the module</span></span><br><span class="line">    <span class="comment"># supports check mode</span></span><br><span class="line">    module = AnsibleModule(</span><br><span class="line">        argument_spec=module_args,</span><br><span class="line">        supports_check_mode=<span class="literal">True</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># if the user is working with this module in only check mode we do not</span></span><br><span class="line">    <span class="comment"># want to make any changes to the environment, just return the current</span></span><br><span class="line">    <span class="comment"># state with no modifications</span></span><br><span class="line">    <span class="keyword">if</span> module.check_mode:</span><br><span class="line">        module.exit_json(**result)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># manipulate or modify the state as needed (this is going to be the</span></span><br><span class="line">    <span class="comment"># part where your module will do what it needs to do)</span></span><br><span class="line">    result[<span class="string">'original_message'</span>] = module.params[<span class="string">'name'</span>]</span><br><span class="line">    result[<span class="string">'message'</span>] = <span class="string">'goodbye'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># use whatever logic you need to determine whether or not this module</span></span><br><span class="line">    <span class="comment"># made any modifications to your target</span></span><br><span class="line">    <span class="keyword">if</span> module.params[<span class="string">'new'</span>]:</span><br><span class="line">        result[<span class="string">'changed'</span>] = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># during the execution of the module, if there is an exception or a</span></span><br><span class="line">    <span class="comment"># conditional state that effectively causes a failure, run</span></span><br><span class="line">    <span class="comment"># AnsibleModule.fail_json() to pass in the message and the result</span></span><br><span class="line">    <span class="keyword">if</span> module.params[<span class="string">'name'</span>] == <span class="string">'fail me'</span>:</span><br><span class="line">        module.fail_json(msg=<span class="string">'You requested this to fail'</span>, **result)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># in the event of a successful module execution, you will want to</span></span><br><span class="line">    <span class="comment"># simple AnsibleModule.exit_json(), passing the key/value results</span></span><br><span class="line">    module.exit_json(**result)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    run_module()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></tbody></table></figure><p>因此，<a target="_blank" rel="noopener" href="http://xn--libraryicmpicmp-7j3x7wm6hd04eqyl2u1b43jkpihy4h.py">将library文件夹下的icmp替换为icmp.py</a>，简单的ping模块可以改为：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/python3</span></span><br><span class="line"></span><br><span class="line">ANSIBLE_METADATA = {</span><br><span class="line">    <span class="string">'metadata_version'</span>: <span class="string">'1.1'</span>,</span><br><span class="line">    <span class="string">'status'</span>: [<span class="string">'preview'</span>],</span><br><span class="line">    <span class="string">'supported_by'</span>: <span class="string">'community'</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">DOCUMENTATION = <span class="string">'''</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">module: icmp</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">short_description: simple module for icmp ping</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">version_added: "2.10"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">description:</span></span><br><span class="line"><span class="string">    - "simple module for icmp ping"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">options:</span></span><br><span class="line"><span class="string">    target:</span></span><br><span class="line"><span class="string">        description:</span></span><br><span class="line"><span class="string">            - The target to ping</span></span><br><span class="line"><span class="string">        required: true</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">author:</span></span><br><span class="line"><span class="string">    - James Spurin (@spurin)</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line">EXAMPLES = <span class="string">'''</span></span><br><span class="line"><span class="string"># Ping an IP</span></span><br><span class="line"><span class="string">- name: Ping an IP</span></span><br><span class="line"><span class="string">  icmp:</span></span><br><span class="line"><span class="string">    target: 127.0.0.1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Ping a host</span></span><br><span class="line"><span class="string">- name: Ping a host</span></span><br><span class="line"><span class="string">  icmp:</span></span><br><span class="line"><span class="string">    target: centos1</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line">RETURN = <span class="string">'''</span></span><br><span class="line"><span class="string">'''</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ansible.module_utils.basic <span class="keyword">import</span> AnsibleModule</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">run_module</span>():</span></span><br><span class="line">    <span class="comment"># define the available arguments/parameters that a user can pass to</span></span><br><span class="line">    <span class="comment"># the module</span></span><br><span class="line">    module_args = <span class="built_in">dict</span>(</span><br><span class="line">        target=<span class="built_in">dict</span>(<span class="built_in">type</span>=<span class="string">'str'</span>, required=<span class="literal">True</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># seed the result dict in the object</span></span><br><span class="line">    <span class="comment"># we primarily care about changed and state</span></span><br><span class="line">    <span class="comment"># change is if this module effectively modified the target</span></span><br><span class="line">    <span class="comment"># state will include any data that you want your module to pass back</span></span><br><span class="line">    <span class="comment"># for consumption, for example, in a subsequent task</span></span><br><span class="line">    result = <span class="built_in">dict</span>(</span><br><span class="line">        changed=<span class="literal">False</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># the AnsibleModule object will be our abstraction working with Ansible</span></span><br><span class="line">    <span class="comment"># this includes instantiation, a couple of common attr would be the</span></span><br><span class="line">    <span class="comment"># args/params passed to the execution, as well as if the module</span></span><br><span class="line">    <span class="comment"># supports check mode</span></span><br><span class="line">    module = AnsibleModule(</span><br><span class="line">        argument_spec=module_args,</span><br><span class="line">        supports_check_mode=<span class="literal">True</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># if the user is working with this module in only check mode we do not</span></span><br><span class="line">    <span class="comment"># want to make any changes to the environment, just return the current</span></span><br><span class="line">    <span class="comment"># state with no modifications</span></span><br><span class="line">    <span class="keyword">if</span> module.check_mode:</span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="comment"># manipulate or modify the state as needed (this is going to be the</span></span><br><span class="line">    <span class="comment"># part where your module will do what it needs to do)</span></span><br><span class="line">    ping_result = module.run_command(<span class="string">'ping -c 1 {}'</span>.<span class="built_in">format</span>(module.params[<span class="string">'target'</span>]))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># use whatever logic you need to determine whether or not this module</span></span><br><span class="line">    <span class="comment"># made any modifications to your target</span></span><br><span class="line">    <span class="keyword">if</span> module.params[<span class="string">'target'</span>]:</span><br><span class="line">        result[<span class="string">'debug'</span>] = ping_result</span><br><span class="line">        result[<span class="string">'rc'</span>] = ping_result[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">if</span> result[<span class="string">'rc'</span>]:</span><br><span class="line">          result[<span class="string">'failed'</span>] = <span class="literal">True</span></span><br><span class="line">          module.fail_json(msg=<span class="string">'failed to ping'</span>, **result)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">          result[<span class="string">'changed'</span>] = <span class="literal">True</span></span><br><span class="line">          module.exit_json(**result)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>():</span></span><br><span class="line">    run_module()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></tbody></table></figure><p>执行下面指令可以查看模板使用说明：</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible-doc -M library icmp</span><br></pre></td></tr></tbody></table></figure><h3 id="8-2-创建插件">8.2 创建插件</h3><p>ansible插件是增强ansible的核心功能的代码片段，ansible使用插件架构来实现丰富，灵活和可扩展的功能集。</p><p>Ansible提供了许多方便的插件，也轻松自定义的插件。</p><p>官方lookup插件的源码：</p><p><a target="_blank" rel="noopener" href="https://github.com/ansible/ansible/blob/devel/lib/ansible/plugins/lookup/items.py">https://github.com/ansible/ansible/blob/devel/lib/ansible/plugins/lookup/items.py</a></p><p>官方vars插件的源码：</p><p><a target="_blank" rel="noopener" href="https://github.com/ansible/ansible/blob/devel/lib/ansible/plugins/vars/host_group_vars.py">https://github.com/ansible/ansible/blob/devel/lib/ansible/plugins/vars/host_group_vars.py</a></p><p>开发插件的官方文档：</p><p><a target="_blank" rel="noopener" href="http://docs.ansible.com/ansible/latest/dev_guide/developing_plugins.html">http://docs.ansible.com/ansible/latest/dev_guide/developing_plugins.html</a></p><p>现有插件：</p><ul><li>Action插件</li><li>Cache插件</li><li>Callback插件</li><li>Connection插件</li><li>Filters插件</li><li>Lookup插件</li><li>Strategy插件</li><li>Shell插件</li><li>Test插件</li><li>Vars插件</li><li>inventory插件</li></ul><p><strong>自定义lookup插件实现排序遍历</strong></p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">mkdir lookup_plugins &amp;&amp; cd lookup_plugins</span><br><span class="line">wget https://raw.githubusercontent.com/ansible/ansible/devel/lib/ansible/plugins/lookup/items.py</span><br><span class="line">mv items.py sorted_items.py</span><br></pre></td></tr></tbody></table></figure><p>sorted_items.py内容为：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># (c) 2012, Michael DeHaan &lt;michael.dehaan@gmail.com&gt;</span></span><br><span class="line"><span class="comment"># (c) 2017 Ansible Project</span></span><br><span class="line"><span class="comment"># GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> (absolute_import, division, print_function)</span><br><span class="line">__metaclass__ = <span class="built_in">type</span></span><br><span class="line"></span><br><span class="line">DOCUMENTATION = <span class="string">"""</span></span><br><span class="line"><span class="string">    name: items</span></span><br><span class="line"><span class="string">    author: Michael DeHaan</span></span><br><span class="line"><span class="string">    version_added: historical</span></span><br><span class="line"><span class="string">    short_description: list of items</span></span><br><span class="line"><span class="string">    description:</span></span><br><span class="line"><span class="string">      - this lookup returns a list of items given to it, if any of the top level items is also a list it will flatten it, but it will not recurse</span></span><br><span class="line"><span class="string">    notes:</span></span><br><span class="line"><span class="string">      - this is the standard lookup used for loops in most examples</span></span><br><span class="line"><span class="string">      - check out the 'flattened' lookup for recursive flattening</span></span><br><span class="line"><span class="string">      - if you do not want flattening nor any other transformation look at the 'list' lookup.</span></span><br><span class="line"><span class="string">    options:</span></span><br><span class="line"><span class="string">      _terms:</span></span><br><span class="line"><span class="string">        description: list of items</span></span><br><span class="line"><span class="string">        required: True</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">EXAMPLES = <span class="string">"""</span></span><br><span class="line"><span class="string">- name: "loop through list"</span></span><br><span class="line"><span class="string">  ansible.builtin.debug:</span></span><br><span class="line"><span class="string">    msg: "An item: {{ item }}"</span></span><br><span class="line"><span class="string">  with_items:</span></span><br><span class="line"><span class="string">    - 1</span></span><br><span class="line"><span class="string">    - 2</span></span><br><span class="line"><span class="string">    - 3</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: add several users</span></span><br><span class="line"><span class="string">  ansible.builtin.user:</span></span><br><span class="line"><span class="string">    name: "{{ item }}"</span></span><br><span class="line"><span class="string">    groups: "wheel"</span></span><br><span class="line"><span class="string">    state: present</span></span><br><span class="line"><span class="string">  with_items:</span></span><br><span class="line"><span class="string">     - testuser1</span></span><br><span class="line"><span class="string">     - testuser2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: "loop through list from a variable"</span></span><br><span class="line"><span class="string">  ansible.builtin.debug:</span></span><br><span class="line"><span class="string">    msg: "An item: {{ item }}"</span></span><br><span class="line"><span class="string">  with_items: "{{ somelist }}"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: more complex items to add several users</span></span><br><span class="line"><span class="string">  ansible.builtin.user:</span></span><br><span class="line"><span class="string">    name: "{{ item.name }}"</span></span><br><span class="line"><span class="string">    uid: "{{ item.uid }}"</span></span><br><span class="line"><span class="string">    groups: "{{ item.groups }}"</span></span><br><span class="line"><span class="string">    state: present</span></span><br><span class="line"><span class="string">  with_items:</span></span><br><span class="line"><span class="string">     - { name: testuser1, uid: 1002, groups: "wheel, staff" }</span></span><br><span class="line"><span class="string">     - { name: testuser2, uid: 1003, groups: staff }</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">RETURN = <span class="string">"""</span></span><br><span class="line"><span class="string">  _raw:</span></span><br><span class="line"><span class="string">    description:</span></span><br><span class="line"><span class="string">      - once flattened list</span></span><br><span class="line"><span class="string">    type: list</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ansible.plugins.lookup <span class="keyword">import</span> LookupBase</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LookupModule</span>(<span class="params">LookupBase</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, terms, **kwargs</span>):</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> self._flatten(terms)</span><br></pre></td></tr></tbody></table></figure><p>lookup插件引用了下面地址的类方法</p><p><a target="_blank" rel="noopener" href="https://github.com/ansible/ansible/blob/devel/lib/ansible/plugins/lookup/">https://github.com/ansible/ansible/blob/devel/lib/ansible/plugins/lookup/</a><strong>init</strong>.py</p><p>其内容为：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># (c) 2012-2014, Michael DeHaan &lt;michael.dehaan@gmail.com&gt;</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This file is part of Ansible</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Ansible is free software: you can redistribute it and/or modify</span></span><br><span class="line"><span class="comment"># it under the terms of the GNU General Public License as published by</span></span><br><span class="line"><span class="comment"># the Free Software Foundation, either version 3 of the License, or</span></span><br><span class="line"><span class="comment"># (at your option) any later version.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Ansible is distributed in the hope that it will be useful,</span></span><br><span class="line"><span class="comment"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span><br><span class="line"><span class="comment"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span><br><span class="line"><span class="comment"># GNU General Public License for more details.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># You should have received a copy of the GNU General Public License</span></span><br><span class="line"><span class="comment"># along with Ansible.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Make coding more python3-ish</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> (absolute_import, division, print_function)</span><br><span class="line">__metaclass__ = <span class="built_in">type</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> abc <span class="keyword">import</span> abstractmethod</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ansible.errors <span class="keyword">import</span> AnsibleFileNotFound</span><br><span class="line"><span class="keyword">from</span> ansible.plugins <span class="keyword">import</span> AnsiblePlugin</span><br><span class="line"><span class="keyword">from</span> ansible.utils.display <span class="keyword">import</span> Display</span><br><span class="line"></span><br><span class="line">display = Display()</span><br><span class="line"></span><br><span class="line">__all__ = [<span class="string">'LookupBase'</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LookupBase</span>(<span class="params">AnsiblePlugin</span>):</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, loader=<span class="literal">None</span>, templar=<span class="literal">None</span>, **kwargs</span>):</span></span><br><span class="line"></span><br><span class="line">        <span class="built_in">super</span>(LookupBase, self).__init__()</span><br><span class="line"></span><br><span class="line">        self._loader = loader</span><br><span class="line">        self._templar = templar</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Backwards compat: self._display isn't really needed, just import the global display and use that.</span></span><br><span class="line">        self._display = display</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_basedir</span>(<span class="params">self, variables</span>):</span></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'role_path'</span> <span class="keyword">in</span> variables:</span><br><span class="line">            <span class="keyword">return</span> variables[<span class="string">'role_path'</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> self._loader.get_basedir()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_flatten</span>(<span class="params">terms</span>):</span></span><br><span class="line">        ret = []</span><br><span class="line">        <span class="keyword">for</span> term <span class="keyword">in</span> terms:</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(term, (<span class="built_in">list</span>, <span class="built_in">tuple</span>)):</span><br><span class="line">                ret.extend(term)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                ret.append(term)</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_combine</span>(<span class="params">a, b</span>):</span></span><br><span class="line">        results = []</span><br><span class="line">        <span class="keyword">for</span> x <span class="keyword">in</span> a:</span><br><span class="line">            <span class="keyword">for</span> y <span class="keyword">in</span> b:</span><br><span class="line">                results.append(LookupBase._flatten([x, y]))</span><br><span class="line">        <span class="keyword">return</span> results</span><br><span class="line"></span><br><span class="line"><span class="meta">    @staticmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_flatten_hash_to_list</span>(<span class="params">terms</span>):</span></span><br><span class="line">        ret = []</span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> terms:</span><br><span class="line">            ret.append({<span class="string">'key'</span>: key, <span class="string">'value'</span>: terms[key]})</span><br><span class="line">        <span class="keyword">return</span> ret</span><br><span class="line"></span><br><span class="line"><span class="meta">    @abstractmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span>(<span class="params">self, terms, variables=<span class="literal">None</span>, **kwargs</span>):</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        When the playbook specifies a lookup, this method is run.  The</span></span><br><span class="line"><span class="string">        arguments to the lookup become the arguments to this method.  One</span></span><br><span class="line"><span class="string">        additional keyword argument named ``variables`` is added to the method</span></span><br><span class="line"><span class="string">        call.  It contains the variables available to ansible at the time the</span></span><br><span class="line"><span class="string">        lookup is templated.  For instance::</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            "{{ lookup('url', 'https://toshio.fedorapeople.org/one.txt', validate_certs=True) }}"</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        would end up calling the lookup plugin named url's run method like this::</span></span><br><span class="line"><span class="string">            run(['https://toshio.fedorapeople.org/one.txt'], variables=available_variables, validate_certs=True)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Lookup plugins can be used within playbooks for looping.  When this</span></span><br><span class="line"><span class="string">        happens, the first argument is a list containing the terms.  Lookup</span></span><br><span class="line"><span class="string">        plugins can also be called from within playbooks to return their</span></span><br><span class="line"><span class="string">        values into a variable or parameter.  If the user passes a string in</span></span><br><span class="line"><span class="string">        this case, it is converted into a list.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Errors encountered during execution should be returned by raising</span></span><br><span class="line"><span class="string">        AnsibleError() with a message describing the error.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">        Any strings returned by this method that could ever contain non-ascii</span></span><br><span class="line"><span class="string">        must be converted into python's unicode type as the strings will be run</span></span><br><span class="line"><span class="string">        through jinja2 which has this requirement.  You can use::</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            from ansible.module_utils.common.text.converters import to_text</span></span><br><span class="line"><span class="string">            result_string = to_text(result_string)</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">find_file_in_search_path</span>(<span class="params">self, myvars, subdir, needle, ignore_missing=<span class="literal">False</span></span>):</span></span><br><span class="line">        <span class="string">'''</span></span><br><span class="line"><span class="string">        Return a file (needle) in the task's expected search path.</span></span><br><span class="line"><span class="string">        '''</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="string">'ansible_search_path'</span> <span class="keyword">in</span> myvars:</span><br><span class="line">            paths = myvars[<span class="string">'ansible_search_path'</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            paths = [self.get_basedir(myvars)]</span><br><span class="line"></span><br><span class="line">        result = <span class="literal">None</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            result = self._loader.path_dwim_relative_stack(paths, subdir, needle)</span><br><span class="line">        <span class="keyword">except</span> AnsibleFileNotFound:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> ignore_missing:</span><br><span class="line">                self._display.warning(<span class="string">"Unable to find '%s' in expected paths (use -vvvvv to see paths)"</span> % needle)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_deprecate_inline_kv</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="comment"># <span class="doctag">TODO:</span> place holder to deprecate in future version allowing for long transition period</span></span><br><span class="line">        <span class="comment"># self._display.deprecated('Passing inline k=v values embedded in a string to this lookup. Use direct ,k=v, k2=v2 syntax instead.', version='2.18')</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></tbody></table></figure><p>修改sorted_items.py最后一行返回有序列表：<code>return self._flatten(sorted(terms, key=str))</code>，并将所有的with_items修改为with_sorted_items。</p><p>创建一个剧本用于测试：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">centos1</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">loop</span> <span class="string">through</span> <span class="string">list</span></span><br><span class="line">       <span class="attr">debug:</span> </span><br><span class="line">         <span class="attr">msg:</span> <span class="string">"An item: <span class="template-variable">{{item}}</span>"</span></span><br><span class="line">       <span class="attr">with_sorted_items:</span></span><br><span class="line">         <span class="bullet">-</span> <span class="number">3</span></span><br><span class="line">         <span class="bullet">-</span> <span class="number">2</span></span><br><span class="line">         <span class="bullet">-</span> <span class="number">1</span></span><br><span class="line">         <span class="bullet">-</span> <span class="string">Z</span></span><br><span class="line">         <span class="bullet">-</span> <span class="string">A</span></span><br><span class="line">         <span class="bullet">-</span> <span class="string">M</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><p><strong>自定义filter插件实现字符串逆序+大写</strong></p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">mkdir filter_plugins &amp;&amp; cd filter_plugins</span><br><span class="line">wget https://raw.githubusercontent.com/ansible/ansible/devel/lib/ansible/plugins/filter/core.py</span><br><span class="line">mv core.py reverse_upper.py</span><br></pre></td></tr></tbody></table></figure><p>修改reverse_upper.py内容为：</p><figure class="highlight python"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment"># (c) 2012, Jeroen Hoekx &lt;jeroen@hoekx.be&gt;</span></span><br><span class="line"><span class="comment"># GNU General Public License v3.0+ (see COPYING or https://www.gnu.org/licenses/gpl-3.0.txt)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Make coding more python3-ish</span></span><br><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> (absolute_import, division, print_function)</span><br><span class="line">__metaclass__ = <span class="built_in">type</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"><span class="keyword">import</span> glob</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> ntpath</span><br><span class="line"><span class="keyword">import</span> os.path</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> shlex</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> uuid</span><br><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> collections.abc <span class="keyword">import</span> Mapping</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> Random, SystemRandom, shuffle</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> jinja2.filters <span class="keyword">import</span> pass_environment</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> ansible.errors <span class="keyword">import</span> AnsibleError, AnsibleFilterError, AnsibleFilterTypeError</span><br><span class="line"><span class="keyword">from</span> ansible.module_utils.six <span class="keyword">import</span> string_types, integer_types, reraise, text_type</span><br><span class="line"><span class="keyword">from</span> ansible.module_utils.common.text.converters <span class="keyword">import</span> to_bytes, to_native, to_text</span><br><span class="line"><span class="keyword">from</span> ansible.module_utils.common.collections <span class="keyword">import</span> is_sequence</span><br><span class="line"><span class="keyword">from</span> ansible.module_utils.common.yaml <span class="keyword">import</span> yaml_load, yaml_load_all</span><br><span class="line"><span class="keyword">from</span> ansible.parsing.ajson <span class="keyword">import</span> AnsibleJSONEncoder</span><br><span class="line"><span class="keyword">from</span> ansible.parsing.yaml.dumper <span class="keyword">import</span> AnsibleDumper</span><br><span class="line"><span class="keyword">from</span> ansible.template <span class="keyword">import</span> recursive_check_defined</span><br><span class="line"><span class="keyword">from</span> ansible.utils.display <span class="keyword">import</span> Display</span><br><span class="line"><span class="keyword">from</span> ansible.utils.encrypt <span class="keyword">import</span> passlib_or_crypt, PASSLIB_AVAILABLE</span><br><span class="line"><span class="keyword">from</span> ansible.utils.hashing <span class="keyword">import</span> md5s, checksum_s</span><br><span class="line"><span class="keyword">from</span> ansible.utils.unicode <span class="keyword">import</span> unicode_wrap</span><br><span class="line"><span class="keyword">from</span> ansible.utils.<span class="built_in">vars</span> <span class="keyword">import</span> merge_hash</span><br><span class="line"></span><br><span class="line">display = Display()</span><br><span class="line"></span><br><span class="line">UUID_NAMESPACE_ANSIBLE = uuid.UUID(<span class="string">'361E6D51-FAEC-444A-9079-341386DA8E2E'</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reverse_upper</span>(<span class="params">string</span>):</span></span><br><span class="line">    <span class="string">"""Reverse and upper string """</span></span><br><span class="line">    <span class="keyword">return</span> string[::-<span class="number">1</span>].upper()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FilterModule</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="string">''' Ansible core jinja2 filters '''</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">filters</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> {</span><br><span class="line">            <span class="string">'reverse_upper'</span>: reverse_upper,</span><br><span class="line">        }</span><br></pre></td></tr></tbody></table></figure><p>创建一个剧本用于测试：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="bullet">-</span></span><br><span class="line">  <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">Reverse</span> <span class="string">and</span> <span class="string">upper</span> <span class="string">ansible_distribution</span></span><br><span class="line">       <span class="attr">debug:</span> </span><br><span class="line">         <span class="attr">msg:</span> <span class="string">"Reverse and upper of ansible_distribution: <span class="template-variable">{{ ansible_distribution | reverse_upper }}</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></tbody></table></figure><h2 id="9-故障排除和最佳实践">9. 故障排除和最佳实践</h2><blockquote><p>故障排除和最佳实践</p></blockquote><h3 id="9-1-故障排除">9.1 故障排除</h3><p><strong>SSH连接错误</strong></p><p>模拟：从ubuntu-c连接ubuntu1后，修改ubuntu1主机上~/.ssh/authorized_keys的权限为777</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ssh ubuntu1</span><br><span class="line"></span><br><span class="line">chmod 777 ~/.ssh/authorized_keys</span><br><span class="line"></span><br><span class="line">exit</span><br></pre></td></tr></tbody></table></figure><p>此时，重新登录时SSH免密码登录失效，提示输入密码</p><p>解决：</p><ol><li><p>使用<code>ssh -v ubuntu1</code>查看有用信息，但还是提示输入登录ubuntu1的密码</p></li><li><p>在新窗口连接ubuntu1，输入root用户名和密码，登录ubuntu后，执行<code>/usr/sbin/sshd -d -p 1234</code></p></li><li><p>ubuntu-c主机执行<code>ssh ubuntu1 -p 1234</code>，然后<code>ssh -v ubuntu1</code>信息窗口会出现因为所有权模式身份验证拒绝错误，由此确认了问题所在。</p></li></ol><p><strong>剧本语法检查</strong></p><p>如：</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible-playbook xxx_playbook.yaml --syntax-check</span><br></pre></td></tr></tbody></table></figure><p><strong>每个任务都选择是否执行</strong></p><p>如：</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible-playbook xxx_playbook.yaml --step</span><br></pre></td></tr></tbody></table></figure><p><strong>指定开始执行的任务</strong></p><p>如：</p><figure class="highlight shell"><table><tbody><tr><td class="code"><pre><span class="line">ansible-playbook xxx_playbook.yaml --start-at-task="Install python-dnspython"</span><br></pre></td></tr></tbody></table></figure><p><strong>日志路径</strong></p><p>在ansible.cfg配置log_path，指定保存执行日志的文件，如：</p><figure class="highlight ini"><table><tbody><tr><td class="code"><pre><span class="line"><span class="section">[default]</span></span><br><span class="line"><span class="attr">inventory</span>=hosts</span><br><span class="line"><span class="attr">host_key_checking</span>=<span class="literal">False</span></span><br><span class="line"><span class="attr">forks</span>=<span class="number">6</span></span><br><span class="line"><span class="attr">log_path</span>=log.txt</span><br></pre></td></tr></tbody></table></figure><p><strong>详细程度</strong></p><p>详细程度有4级</p><ul><li>-v 1级 输出数据显示</li><li>-vv 2级 输入输出显示</li><li>-vvv 3级 获取提供的附加信息，用于连接到托管主机</li><li>-vvvv 4级 提供额外的详细信息，包括连接插件和脚本以及用户上下文</li></ul><p>如：</p><figure class="highlight yaml"><table><tbody><tr><td class="code"><pre><span class="line"><span class="string">ansible-playbook</span> <span class="string">-vvvv</span> <span class="string">xxx_playbook.yaml</span></span><br></pre></td></tr></tbody></table></figure><h3 id="9-2-最佳实践">9.2 最佳实践</h3><p>官方最佳实践：<a target="_blank" rel="noopener" href="https://docs.ansible.com/ansible/latest/tips_tricks/index.html">https://docs.ansible.com/ansible/latest/tips_tricks/index.html</a></p></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者:</span> <span class="post-copyright-info"><a href="https://xiongbinzou.github.io">小邹同学</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接:</span> <span class="post-copyright-info"><a href="https://xiongbinzou.github.io/posts/48635.html">https://xiongbinzou.github.io/posts/48635.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明:</span> <span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://xiongbinzou.github.io" target="_blank">小邹同学</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Ansible/">Ansible</a><a class="post-meta__tags" href="/tags/%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4/">自动化运维</a></div><div class="post_share"><div class="social-share" data-image="/pics/avatar.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload='this.media="all"'><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="/pics/reward/wechat.jpg" target="_blank"><img class="post-qr-code-img" src="/pics/reward/wechat.jpg" alt="微信"></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="/pics/reward/alipay.jpg" target="_blank"><img class="post-qr-code-img" src="/pics/reward/alipay.jpg" alt="支付宝"></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/24277.html"><img class="prev-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror='onerror=null,src="/img/404.jpg"' alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">SpringBoot+Vue全栈开发学习笔记</div></div></a></div><div class="next-post pull-right"><a href="/posts/34725.html"><img class="next-cover" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" onerror='onerror=null,src="/img/404.jpg"' alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Gitflow代码管理规范</div></div></a></div></nav><hr><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i> <span>评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Ansible%E7%AE%80%E4%BB%8B"><span class="toc-text">1. Ansible简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E5%87%86%E5%A4%87%E7%8E%AF%E5%A2%83"><span class="toc-text">2. 准备环境</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1-%E5%AE%89%E8%A3%85Docker"><span class="toc-text">2.1 安装Docker</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2-%E5%AE%89%E8%A3%85Ansible%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83"><span class="toc-text">2.2 安装Ansible实验环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3-%E9%85%8D%E7%BD%AE%E4%B8%BB%E6%9C%BA%E9%97%B4SSH%E5%85%8D%E5%AF%86%E7%A0%81%E8%BF%9E%E6%8E%A5"><span class="toc-text">2.3 配置主机间SSH免密码连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4-%E9%85%8D%E7%BD%AEAnsible%E8%AF%BE%E7%A8%8B%E7%9A%84%E4%BB%A3%E7%A0%81%E5%BA%93"><span class="toc-text">2.4 配置Ansible课程的代码库</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Ansible%E6%9E%B6%E6%9E%84%E5%92%8C%E8%AE%BE%E8%AE%A1"><span class="toc-text">3. Ansible架构和设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1-Ansible%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-text">3.1 Ansible配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2-Ansible%E6%B8%85%E5%8D%95"><span class="toc-text">3.2 Ansible清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3-Ansible%E6%A8%A1%E5%9D%97"><span class="toc-text">3.3 Ansible模块</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Ansible-Playbook%E4%BB%8B%E7%BB%8D"><span class="toc-text">4. Ansible Playbook介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-YAML"><span class="toc-text">4.1 YAML</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E5%88%9D%E8%AF%86%E5%89%A7%E6%9C%AC"><span class="toc-text">4.2 初识剧本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E5%89%A7%E6%9C%AC%E5%8F%98%E9%87%8F"><span class="toc-text">4.3 剧本变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E4%BD%BF%E7%94%A8%E5%92%8C%E8%87%AA%E5%AE%9A%E4%B9%89Facts%E5%8F%98%E9%87%8F"><span class="toc-text">4.4 使用和自定义Facts变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E5%89%A7%E6%9C%AC%E4%BD%BF%E7%94%A8Jinja2%E6%A8%A1%E6%9D%BF%E8%AF%AD%E8%A8%80"><span class="toc-text">4.5 剧本使用Jinja2模板语言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-%E5%89%A7%E6%9C%AC%E5%AE%9E%E9%99%85%E5%BA%94%E7%94%A8"><span class="toc-text">4.6 剧本实际应用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E6%B7%B1%E5%85%A5Ansible-Playbooks"><span class="toc-text">5. 深入Ansible Playbooks</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-%E5%89%A7%E6%9C%AC%E5%B8%B8%E7%94%A8%E6%A8%A1%E5%9D%97"><span class="toc-text">5.1 剧本常用模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-%E5%8A%A8%E6%80%81%E6%B8%85%E5%8D%95"><span class="toc-text">5.2 动态清单</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-3-Register%E5%92%8CWhen"><span class="toc-text">5.3 Register和When</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-4-%E5%BE%AA%E7%8E%AF%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-text">5.4 循环的使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-5-%E5%BC%82%E6%AD%A5%E3%80%81%E4%B8%B2%E8%A1%8C%E5%92%8C%E5%B9%B6%E8%A1%8C"><span class="toc-text">5.5 异步、串行和并行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-6-%E4%BB%BB%E5%8A%A1%E5%A7%94%E6%B4%BE"><span class="toc-text">5.6 任务委派</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-7-%E9%AD%94%E6%B3%95%E5%8F%98%E9%87%8F"><span class="toc-text">5.7 魔法变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-8-%E5%9D%97%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-text">5.8 块的使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-9-Vault%E4%BF%A1%E6%81%AF%E4%BF%9D%E6%8A%A4"><span class="toc-text">5.9 Vault信息保护</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-%E6%9E%84%E5%BB%BAAnsible-Playbooks"><span class="toc-text">6. 构建Ansible Playbooks</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#6-1-%E4%BD%BF%E7%94%A8includes%E5%92%8Cimports"><span class="toc-text">6.1 使用includes和imports</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-%E4%BD%BF%E7%94%A8tags"><span class="toc-text">6.2 使用tags</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-%E4%BD%BF%E7%94%A8roles"><span class="toc-text">6.3 使用roles</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-%E4%BA%91%E6%9C%8D%E5%8A%A1%E3%80%81%E5%AE%B9%E5%99%A8%E3%80%81Ansible"><span class="toc-text">7. 云服务、容器、Ansible</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#7-1-AWS%E4%B8%8EAnsible"><span class="toc-text">7.1 AWS与Ansible</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#7-2-Docker%E4%B8%8EAnsible"><span class="toc-text">7.2 Docker与Ansible</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-%E5%88%9B%E5%BB%BA%E6%A8%A1%E5%9D%97%E5%92%8C%E6%8F%92%E4%BB%B6"><span class="toc-text">8. 创建模块和插件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#8-1-%E5%88%9B%E5%BB%BA%E6%A8%A1%E5%9D%97"><span class="toc-text">8.1 创建模块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#8-2-%E5%88%9B%E5%BB%BA%E6%8F%92%E4%BB%B6"><span class="toc-text">8.2 创建插件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-%E6%95%85%E9%9A%9C%E6%8E%92%E9%99%A4%E5%92%8C%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-text">9. 故障排除和最佳实践</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#9-1-%E6%95%85%E9%9A%9C%E6%8E%92%E9%99%A4"><span class="toc-text">9.1 故障排除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#9-2-%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5"><span class="toc-text">9.2 最佳实践</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-image:url('data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7')"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2023 By 小邹同学</div><div class="framework-info"><span>框架</span> <a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题</span> <a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">你好，欢迎来到<a href="https://xiongbinzou.github.io">小邹同学的Secret Base</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i> <span>数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script src="/js/search/local-search.js"></script><script>var preloader={endLoading:()=>{document.body.style.overflow="auto",document.getElementById("loading-box").classList.add("loaded")},initLoading:()=>{document.body.style.overflow="",document.getElementById("loading-box").classList.remove("loaded")}};window.addEventListener("load",preloader.endLoading())</script><div class="js-pjax"><script>if(window.MathJax)MathJax.startup.document.state(0),MathJax.texReset(),MathJax.typeset();else{window.MathJax={tex:{inlineMath:[["$","$"],["\\(","\\)"]],tags:"ams"},chtml:{scale:1.2},options:{renderActions:{findScript:[10,t=>{for(const e of document.querySelectorAll('script[type^="math/tex"]')){const a=!!e.type.match(/; *mode=display/),n=new t.options.MathItem(e.textContent,t.inputJax[0],a),s=document.createTextNode("");e.parentNode.replaceChild(s,e),n.start={node:s,delim:"",n:0},n.end={node:s,delim:"",n:0},t.math.push(n)}},""],insertScript:[200,()=>{document.querySelectorAll("mjx-container:not([display])").forEach((t=>{const e=t.parentNode;"li"===e.nodeName.toLowerCase()?e.parentNode.classList.add("has-jax"):e.classList.add("has-jax")}))},"",!1]}}};const t=document.createElement("script");t.src="https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js",t.id="MathJax-script",t.async=!0,document.head.appendChild(t)}</script><script>(()=>{const e=document.querySelectorAll("#article-container .mermaid-wrap");if(e.length){window.runMermaid=()=>{window.loadMermaid=!0;const t="dark"===document.documentElement.getAttribute("data-theme")?"dark":"default";Array.from(e).forEach(((e,n)=>{const d=e.firstElementChild,r="mermaid-"+n,i="%%{init:{ 'theme':'"+t+"'}}%%\n"+d.textContent;mermaid.mermaidAPI.render(r,i,(e=>{d.insertAdjacentHTML("afterend",e)}))}))};const t=()=>{window.loadMermaid?runMermaid():getScript("https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js").then(runMermaid)};window.pjax?t():document.addEventListener("DOMContentLoaded",t)}})()</script><script>function loadValine(){function n(){new Valine(Object.assign({el:"#vcomment",appId:"WU7g4I4cNK7LYpz3RJVoz1YV-gzGzoHsz",appKey:"4MHXbgYuTwfEzqQofOeNVquO",avatar:"monsterid",serverURLs:"",emojiMaps:"",path:window.location.pathname,visitor:!1},null))}"function"==typeof Valine?n():getScript("https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js").then(n)}{function loadOtherComment(){loadValine()}setTimeout(loadValine,0)}</script></div><div class="aplayer no-destroy" data-id="5183531430" data-server="netease" data-type="playlist" data-fixed="true" data-mini="true" data-listfolded="false" data-order="random" data-preload="none" data-autoplay="false" muted></div><script id="canvas_nest" defer color="0,0,255" opacity="0.7" zindex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful=!0,POWERMODE.shake=!1,POWERMODE.mobile=!1,document.body.addEventListener("input",POWERMODE)</script></div><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({pluginRootPath:"live2dw/",pluginJsPath:"lib/",pluginModelPath:"assets/",tagMode:!1,log:!1,model:{jsonPath:"/live2dw/assets/hijiki.model.json"},display:{position:"left",width:150,height:190},mobile:{show:!1},react:{opacity:1}})</script></body></html>